---
title: "Frontal cortex-driven glycinergic inhibition of the intralaminar thalamus"
author: "Viktor Plattner"
output:
  html_notebook:
    number_sections: yes
    toc: yes
    toc_float: yes
  pdf_document:
    number_sections: yes
    toc: yes
    keep_tex: true
  html_document:
    number_sections: yes
    df_print: paged
    toc: yes
    toc_float: yes
spacing: single
fontsize: 12pt
always_allow_html: yes
---




<style type="text/css">

body{ /* Normal  */
      font-size: 14px;
      font-family: "Arial", Helvetica, sans-serif;
  }
td {  /* Table  */
  font-size: 12px;
}
h1.title {
  font-size: 38px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #4d4e4f;
}
h1 { /* Header 1 */
  font-size: 28px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #2c3a3e;
}
h2 { /* Header 2 */
  font-size: 22px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #2c3a3e;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #2c3a3e;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>



```{r setup, include=FALSE}
library(R.matlab)
library(tidyverse)
library(reshape2)
library(ggrepel)
library(DT)
library(ggpubr)
library(styler)
library(formatR)

library(bspec) ### power spectrum
library(WaveletComp) ### wavelet
library(diptest) ### to test distribution uni/multimodality (ISI)
library(exactRankTests) ### wilcox.test for ties
library(WaveletComp) ### wavelet
library(signal)

library(STAR)
library(see) #for half violinplot
library(gghalves) #for half violinplot

source(file.path("supplementary_functions", "CreateRecTibble.R"))

knitr::opts_chunk$set(tidy = TRUE, tidy.opts = list(width.cutoff=30))
```


<br><br>



# Firing rate of IL neurons during glycinergic fiber activation

In these experiments glycinergic fibers were photactivated while the firing rate of individual IL neurons was recorded. Some of the IL cells had very low baseline activity. In order to increase the firing rate of the IL neurons and to detect the effect of the glycinergic fiber activation a small tail pinch was applied. The firing rate of the recorded IL cells decreased during the glycinergic fiber activation. 


## Loading data


Loading AP and stimuli times from *stimulus* and from *baseline* data to **IL_stim_firing** and to **IL_baseline_firing** tables:

```{r, message=FALSE, warning=FALSE, tidy=TRUE}
IL_stim_firing <- CreateRecTibble(    
  AP_times = read_csv(file.path("data", "IL_MFR", "stimulus", "AP_times.csv")),  
  stim_times = read_csv(file.path("data", "IL_MFR","stimulus", "stim_times.csv"))
) 
IL_stim_firing %>% head()
```

```{r, message=FALSE, warning=FALSE}
IL_baseline_firing <- CreateRecTibble(
  AP_times = read_csv(file.path("data", "IL_MFR","baseline", "AP_times.csv")),
  stim_times = read_csv(file.path("data", "IL_MFR","baseline", "stim_times.csv"))
)
IL_stim_firing %>% head()
```

<br><br>

## Summary information 

Summary information of the *stimulus* and  *baseline* recording files:

* Variables:
  + file names (*file_name*)
  + number of channels in the raw recording files (*No_ch*)
  + number of APs (*No_AP_unit*, *No_AP_unit2*)
  + number of stimulus trains (*No_Stim*)
  + LFP sampling rate (*samp_rate_lfp*)
  + unit sampling rate (*samp_rate_unit*)
  + length of the recording (*rec_length*)
  + length of the stimulus trains (*No_trains*)
  + Are the lengths of the stimulus trains equal in the recording (*train_length_equal*)
  + starting time of the stimulus trains (*train_start*)
  + ending time of the stimulus trains (*train_end*)

```{r, message=FALSE,echo=FALSE }

info_stim <- read_csv(file.path("data", "IL_MFR", "stimulus", "file_info.csv"))
datatable(info_stim, 
          caption ="Summary table of the stimulus recording files (info_stim)", 
          rownames = TRUE, 
          options = list(pageLength = 50, scrollX=T, scrollY = "500px", dom = 't'))
```

<br>

```{r,message=FALSE,echo=FALSE}
info_baseline <- read_csv(file.path("data", "IL_MFR", "baseline","file_info.csv"))
datatable(info_baseline, 
          caption ="Summary table of the baseline recording files (info_baseline)",
          rownames = TRUE, 
          options = list(pageLength = 50, scrollX=T, scrollY="500px",dom = 't'))  
```
<br>

**CELL_INFO** table to store the cell categories. It was created manually using the information from the summary excel table (*Glicy_juxta-fm_exp_records_injection_sum.xls*)

* Variables
  + cell identification (*cell_id*). To find the recording file use the summary excel table
  + file names (*file_name*)
  + spontaneously active cells (*bl_activity*)
  + induced firing (*pinch*)
  + individually identified neurons (*ident*)
  + control cells (*control*)


```{r, echo=FALSE}
### CELL INFO to store categories (spontaneously active, induced firing, identified)
CELL_INFO <- info_baseline %>%
  select(file_name) %>%
  add_column(cell_id = substr(info_baseline$file_name, 1, 6), .before = "file_name") %>%
  mutate(bl_activity = T) %>%
  mutate(bl_activity = replace(
    bl_activity, 
    .$cell_id == "cell05" |
      .$cell_id == "cell10" |
      .$cell_id == "cell12" |
      .$cell_id == "cell13" |
      .$cell_id == "cell14" |
      .$cell_id == "cell15" |
      .$cell_id == "cell21" |
      .$cell_id == "cell24",
    F
  )) %>%
  mutate(pinch = T) %>%
  mutate(pinch = replace(
    pinch, 
    .$cell_id == "cell01" |
      .$cell_id == "cell06" |
      .$cell_id == "cell07" |
      .$cell_id == "cell08" |
      .$cell_id == "cell18" |
      .$cell_id == "cell19" |
      .$cell_id == "cell20" |
      .$cell_id == "cell21" |
      .$cell_id == "cell23" |
      .$cell_id == "cell24" |
      .$cell_id == "cell25" |
      .$cell_id == "cell26" |
      .$cell_id == "cell27" |
      .$cell_id == "cell28",
    F
  )) %>%
 mutate(ident = T) %>%
  mutate(ident = replace(
    ident,
    .$cell_id == "cell06" |
      .$cell_id == "cell07" |
      .$cell_id == "cell11" |
      .$cell_id == "cell12" |
      .$cell_id == "cell13" |
      .$cell_id == "cell14" |
      .$cell_id == "cell21" |
      .$cell_id == "cell22" |
      .$cell_id == "cell23" |
      .$cell_id == "cell24" |
      .$cell_id == "cell25" |
      .$cell_id == "cell26" |
      .$cell_id == "cell27",
    F
  )) %>% 
  mutate(control = F) %>% 
  mutate(control = replace(
    control,
    .$cell_id == "cell25" |
      .$cell_id == "cell26" |
      .$cell_id == "cell27" |
      .$cell_id == "cell28" |
      .$cell_id == "cell29",
    T)) %>% 
  mutate(position = "unknown") %>%
  mutate(position = replace(
    position,
    .$cell_id == "cell01" |
      .$cell_id == "cell02" |
      .$cell_id == "cell03" |
      .$cell_id == "cell10" |
      .$cell_id == "cell11" |
      .$cell_id == "cell14" |
      .$cell_id == "cell15",
    "IL")) %>%
  mutate(position = replace(
    position,
    .$cell_id == "cell20" |
      .$cell_id == "cell21" |
      .$cell_id == "cell22",
    "transient")) %>% 
  mutate(position = replace(
    position,
    .$cell_id == "cell08" |
      .$cell_id == "cell16" |
      .$cell_id == "cell17" |
      .$cell_id == "cell23" |
      .$cell_id == "cell24",
    "PF"))

datatable(CELL_INFO, 
          caption = "CELL_INFO table",
          rownames = TRUE, 
          options = list(pageLength = 50, scrollX=T, scrollY="500px",dom = 't'))  

#IL_stim_firing$file_name %>% unique() %>% length()
#info_stim$file_name %>% length()
```


<br><br>

## Calculations
### Firing rates

```{r, include=FALSE}
### CALCULATING --------

IL_stim_firing <- left_join(IL_stim_firing, 
                            info_stim %>% 
                              select(file_name,
                                     rec_length,
                                     train_starts,
                                     train_ends,
                                     train_length), 
                            by = "file_name")

### calculating stim start times 
start_times <- IL_stim_firing %>%
  group_by(file_name) %>%
  summarise(train_starts = unique(train_starts), train_ends = unique(train_ends)) %>%
  mutate(cell_id = substr(info_stim$file_name, 1, 6)) %>%
  group_by(cell_id) %>%
  summarise(train_starts = unique(train_starts)) %>%
  pull(train_starts) %>%
  strsplit(",") %>%
  set_names(substr(info_stim$file_name, 1, 6)) %>%
  lapply(as.numeric)

### calculating stim end times 
end_times <- IL_stim_firing %>%
  group_by(file_name) %>%
  summarise(train_starts = unique(train_starts), train_ends = unique(train_ends)) %>%
  mutate(cell_id = substr(info_stim$file_name, 1, 6)) %>%
  group_by(cell_id) %>%
  summarise(train_ends = unique(train_ends)) %>%
  pull(train_ends) %>%
  strsplit(",") %>%
  set_names(substr(info_stim$file_name, 1, 6)) %>%
  lapply(as.numeric)


cell_list <- substr(info_stim$file_name, 1, 6)
CELL_INFO$cell_id
```

```{r, include=FALSE}
### function to calculate the number of AP b/d/a stim. Arguments: data (IL_stim_firing table with rec_length and stimulus train information)
BDACalculator <- function(data, list) {
  cell_list <- list
  
    train_length <- data %>%
      dplyr::filter(substr(file_name, 1, 6) == cell_list) %>%
      select(train_length) %>%
      pull() %>%
      `[[`(1)
  
  
  
  if (
    (data %>%
      dplyr::filter(substr(file_name, 1, 6) == cell_list, signal_type == "AP") %>%
      select(unit_id) %>%
      unique() %>%
      pull() %>%
      length()) == 1
  ) {
    ### In case of one unit in the file:
    AP_times <- data %>%
      dplyr::filter(substr(file_name, 1, 6) == cell_list, signal_type == "AP") %>%
      select(signal_time) %>%
      pull()
    
    AP_numbers <- matrix(0, nrow = length(start_times[[cell_list]]), ncol = 3)
    colnames(AP_numbers) <- c("b", "d", "a")

    for (train_num in 1:length(start_times[[cell_list]])) {
      ### before
      AP_numbers[train_num, 1] <- length(AP_times[start_times[[cell_list]][train_num] - train_length
      < AP_times & AP_times < start_times[[cell_list]][train_num]])

      ### during
      AP_numbers[train_num, 2] <- length(AP_times[AP_times > start_times[[cell_list]][train_num] & AP_times < end_times[[cell_list]][train_num]])

      ### after
      AP_numbers[train_num, 3] <- length(AP_times[AP_times > end_times[[cell_list]][train_num] &
        AP_times < end_times[[cell_list]][train_num] + train_length])
    }
    
    melt(AP_numbers, varnames = c("train", "stim_cond"), value.name = "No_AP") %>%
      as.tibble() %>%
      add_column(cell_id = cell_list) %>% 
      add_column(train_length = train_length)
    
    
  } else { 
    ### in case of multiple units in the file:
    AP_times_1 <- data %>%
      dplyr::filter(substr(file_name, 1, 6) == cell_list, signal_type == "AP", unit_id == 1) %>%
      select(signal_time) %>%
      pull()
    
    AP_numbers_1 <- matrix(0, nrow = length(start_times[[cell_list]]), ncol = 3)
    colnames(AP_numbers_1) <- c("b", "d", "a")
    
    for (train_num in 1:length(start_times[[cell_list]])) {
      ### before
      AP_numbers_1[train_num, 1] <- length(AP_times_1[start_times[[cell_list]][train_num] - train_length
                                                  < AP_times_1 & AP_times_1 < start_times[[cell_list]][train_num]])
      
      ### during
      AP_numbers_1[train_num, 2] <- length(AP_times_1[AP_times_1 > start_times[[cell_list]][train_num] & 
                                                        AP_times_1 < end_times[[cell_list]][train_num]])
      
      ### after
      AP_numbers_1[train_num, 3] <- length(AP_times_1[AP_times_1 > end_times[[cell_list]][train_num] &
                                                        AP_times_1 < end_times[[cell_list]][train_num] + train_length])
    }
    
    
    AP_times_2 <- data %>%
      dplyr::filter(substr(file_name, 1, 6) == cell_list, signal_type == "AP", unit_id == 2) %>%
      select(signal_time) %>%
      pull()
    
    AP_numbers_2 <- matrix(0, nrow = length(start_times[[cell_list]]), ncol = 3)
    colnames(AP_numbers_2) <- c("b", "d", "a")
    
    for (train_num in 1:length(start_times[[cell_list]])) {
      ### before
      AP_numbers_2[train_num, 1] <- length(AP_times_2[start_times[[cell_list]][train_num] - train_length
                                                      < AP_times_2 & AP_times_2 < start_times[[cell_list]][train_num]])
      
      ### during
      AP_numbers_2[train_num, 2] <- length(AP_times_2[AP_times_2 > start_times[[cell_list]][train_num] & 
                                                        AP_times_2 < end_times[[cell_list]][train_num]])
      
      ### after
      AP_numbers_2[train_num, 3] <- length(AP_times_2[AP_times_2 > end_times[[cell_list]][train_num] &
                                                        AP_times_2 < end_times[[cell_list]][train_num] + train_length])
    }
    
    
    
    if (cell_list %>% substr(5,6) %>% as.numeric() %>% nchar() == 1) {
      new_name <- paste0(
        "cell0",
        cell_list %>% substr(5,6) %>% as.numeric() + 1
      )
    } 
      
    if (cell_list %>% substr(5,6) %>% as.numeric() %>% nchar() == 2) {
      new_name <- paste0(
        "cell",
        cell_list %>% substr(5,6) %>% as.numeric() + 1
      )
    }
    
    bind_rows(
      melt(AP_numbers_1, varnames = c("train", "stim_cond"), value.name = "No_AP") %>%
        as.tibble() %>%
        add_column(cell_id = cell_list) %>% 
        add_column(train_length = train_length),
      
      melt(AP_numbers_2, varnames = c("train", "stim_cond"), value.name = "No_AP") %>%
        as.tibble() %>%
        add_column(cell_id = new_name) %>% 
        add_column(train_length = train_length)
    )
   }#else

}#foo
```

**b_d_a_MFR**: Calculating the number of APs -using a custom made function (*BDACalculator*)- before during and after the stimulus trains (*b_d_a_MFR*). 

```{r}
b_d_a_MFR <- lapply(CELL_INFO$cell_id, BDACalculator, data = IL_stim_firing) %>% 
  bind_rows() %>%  
  mutate(FR = No_AP / train_length) %>%
  dplyr::group_by(stim_cond, cell_id) %>%
  summarise(MFR = mean(FR))
```

<br>
**sd_mean_isi**: Calculating the baseline MFR of the recorded IL cells from the *IL_baseline_firing* table using a custom made function (*SDMeanISI*). The results are stored in the *sd_mean_isi* table.

```{r, include=FALSE}
IL_baseline_firing <- left_join(IL_baseline_firing,
  info_baseline %>%
    select(file_name, rec_length),
  by = "file_name"
) %>%
  mutate(stim_cond = "baseline")

### function to calculate ISI mean and SD during baseline activity of the cells
SDMeanISI <- function(f_name) {


  # mean_isi <- IL_baseline_firing %>%
  #   dplyr::filter(file_name == f_name, signal_type == "AP") %>%
  #   select(signal_time) %>%
  #   pull() %>%
  #   diff() %>%
  #   mean() * 1000 %>%
  #   `names<-`(f_name)
  #
  # sd_isi <- IL_baseline_firing %>%
  #   dplyr::filter(file_name == f_name, signal_type == "AP") %>%
  #   select(signal_time) %>%
  #   pull() %>%
  #   diff() %>%
  #   sd() * 1000 %>%
  #   `names<-`(f_name)
  #
  # return(list(MFR = mean_isi,
  #             SDFR = sd_isi))

  tmp2 <- IL_baseline_firing %>%
    dplyr::filter(file_name == f_name, signal_type == "AP") %>%
    select(signal_time) %>%
    pull() %>%
    diff() %>%
    mean() * 1000 %>%
      tibble(mean_isi = .)
  tmp2 %>%
    mutate(sd_isi = IL_baseline_firing %>%
      dplyr::filter(file_name == f_name, signal_type == "AP") %>%
      select(signal_time) %>%
      pull() %>%
      diff() %>%
      sd() * 1000) %>%
    mutate(file_name = f_name)
}

sd_mean_isi <- lapply(info_baseline$file_name, SDMeanISI) %>% 
  bind_rows() %>% 
  as.tibble()

sd_mean_isi <- sd_mean_isi %>%
  mutate(cell_id = substr(sd_mean_isi$file_name, 1, 6)) %>%
  mutate(MFR = 1000 / mean_isi) %>%
  mutate(SD_FR = 1000 / sd_isi) %>%
  mutate(MFR_inc = MFR + SD_FR) %>%
  mutate(MFR_dec = MFR - SD_FR) %>%
  # mutate(MFR_inc = 1000/(mean_isi-sd_isi)) %>%
  # mutate(MFR_dec = 1000/(mean_isi+sd_isi)) %>%
  mutate(stim_cond = "baseline") %>%
  mutate(MFR_dec = replace(MFR_dec, sd_mean_isi$MFR_dec < 0, 0))
```
<br>

### Ranks (strength of inhibition)
**cellranks**: Calculating ranks based on the activity change from "*baseline*" to "*during stimulus*". If the activity change is negative (decreased MFR) the asigned rank is negative, if it is positive (increased MFR) the assigned rank is positive.

<br>

Calculating the firing rate change during stimulus (photoactivation of the glycinergic fibers) compared to baseline:

<br><br><br>

$$\mathbf{activity\_change} = \frac{during\_MFR - base\_MFR}{base\_MFR} * 100$$
<br>

```{r}
cellranks <- b_d_a_MFR %>% 
  group_by(stim_cond) %>%
  mutate(base_MFR = sd_mean_isi$MFR) %>% 
  mutate(activity_change = ((MFR-base_MFR)/base_MFR*100) %>% round(2)) %>% 
  dplyr::filter(stim_cond == "d") %>% 
  mutate(change_rank = ifelse(activity_change>0, 
                              rank(activity_change), 
                              -rank(-activity_change)) ) %>% 
  ungroup() %>% 
  left_join(CELL_INFO %>% 
              select(cell_id, control, pinch, position),
            by = "cell_id")
cellranks
```



**cellranks_before_stim**: Calculating ranks based on the activity change from "*before stimulus*" to "*during stimulus*". If the activity change is negative (decreased MFR) the asigned rank is negative, if it is positive (increased MFR) the assigned rank is positive.

<br>

Calculating the firing rate change during stimulus (photoactivation of the glycinergic fibers) compared to before stimulus:

<br><br><br>

$$\mathbf{activity\_change} = \frac{during\_MFR - before\_MFR}{before\_MFR} * 100$$
<br>



```{r}
cellranks_before_stim <- b_d_a_MFR %>% 
  spread(key = stim_cond,value = MFR) %>% 
  mutate(activity_change = ((d - b)/b*100) %>% round(2)) %>% 
  mutate(change_rank = ifelse(activity_change > 0, 
                              rank(activity_change), 
                              -rank(-activity_change))
         ) %>% 
  left_join(CELL_INFO %>% 
              select(cell_id, control, pinch, position),
            by = "cell_id")
cellranks_before_stim
```



<br><br>

### Data to plot
**TO_PLOT**: Combining *b_d_a_MFR* (firing rate of 29 IL neurons b/d/a stim) with *sd_mean_isi* table (baseline firing rate of the same 29 neurons), joining with CELL_INFO containing important information of the cells (baseline activity, identified, pinched, control) and with *cellranks* containing the ranks asigned to each cells based on the changes in MFR during the stimulus compared to baseline.

```{r, message=FALSE, warning=FALSE}
TO_PLOT <- bind_rows(
  sd_mean_isi %>%
    select(MFR, cell_id, stim_cond),
  b_d_a_MFR
) %>% left_join(CELL_INFO %>% 
                  select(-file_name),
                by = "cell_id") %>% 
  left_join(cellranks %>% 
              select(cell_id, change_rank, activity_change), 
            by = "cell_id")

datatable(TO_PLOT,
          caption = "TO_PLOT table",
          rownames = TRUE, 
          options = list(pageLength = 50, scrollX=T, scrollY="500px",dom = 't'))
```
<br><br>

## Plotting

### Baseline vs. "before" stimulus activity

Comparison of baseline and "before" stimulus firing rates in the case of spontaneously active and sponteneously inactive (pinch) neurons. Spontaneously inactive neurons showed significantly higher MFR before stiulus compared to baseline.

```{r, fig.width=10, echo = FALSE, warning=FALSE}
ggplot(
  data = TO_PLOT %>%
    dplyr::filter(
      control == F,
      stim_cond == "baseline" | stim_cond == "b"
    ),
  mapping = aes(
    x = forcats::fct_relevel(stim_cond, "baseline", "b"),
    y = MFR
  )
) +
  geom_boxplot(width = 0.2, alpha = 0.5) +
  geom_point(aes(fill = pinch),
    shape = 21,
    # fill = "#EB8104",
    # color = "white",
    size = 4
  ) +
  # stroke = 2) +
  geom_line(
    aes(group = cell_id, col = pinch)
  ) +
  theme(panel.background = element_rect(fill = 0)) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 20),
    text = element_text(size = 20)
  ) +
  xlab("Recording period") +
  facet_wrap(vars(pinch)) +
  stat_compare_means(method = "wilcox.test", paired = T) +
   geom_label_repel(
    data = TO_PLOT %>%
      dplyr::filter(
        control == F,
        stim_cond == "baseline"
      ),
    mapping = aes(label = cell_id),
    nudge_x = -.9,
    direction = "y",
    # hjust = 2,
    segment.size = .2
  )
 
```

<br><br>

### MFR before, during and after stimulus 

```{r, fig.width=14, fig.height=12 ,echo=FALSE, warning=FALSE}
ggplot(
  data = TO_PLOT %>%
    dplyr::filter(
      control == F,
      stim_cond == "b" | stim_cond == "d" | stim_cond == "a"
    ),
  mapping = aes(
    x = forcats::fct_relevel(stim_cond, "b", "d", "a"),
    y = MFR
  )
) +
  theme(panel.background = element_rect(fill = 0)) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 20),
    text = element_text(size = 20)
  ) +
  ggtitle("Pinch",) + 
  xlab("Recording period") +
  ylim(0, 35) +

  geom_boxplot(width = 0.2, alpha = 0.5) +
  geom_point(
    shape = 21,
    fill = "#EB8104",
    #color = "white",
    size = 4
  ) +
  # stroke = 2) +
  geom_line(
    aes(group = cell_id), 
    color = "#EB8104"
  ) +
  geom_label_repel(
    data =  TO_PLOT %>%
      dplyr::filter(
        control == F,
        stim_cond == "a"
      ),
    mapping = aes(label = cell_id),
    nudge_x = 0.15,
    direction = "y",
    hjust = -0.5,
    segment.size = .2
  ) +
  facet_wrap(vars(pinch))
```
<br><br>

### Strength of inhibition

Firing rate change **during** stimulus (photoactivation of the glycinergic fibers) compared to **baseline**:

```{r, fig.width=10, echo=FALSE,warning=FALSE}
ggplot(data = cellranks,
       mapping = aes(x = change_rank, y = activity_change)) +
  geom_point(data = cellranks %>% 
               dplyr::filter(control == F),size = 3) +
  geom_point(data = cellranks %>% 
               dplyr::filter(control == T), size = 3, col = "magenta") +
  ### label for negative values
  geom_text_repel(data = cellranks %>% 
                    dplyr::filter(activity_change < 0),
    aes(label = cell_id),
    direction = "y",
    angle = 90,
    hjust = .5,
    nudge_y = -2
    ) +
  
  ### label for positive values
  geom_text_repel(data = cellranks %>% 
                    dplyr::filter(activity_change > 0),
    aes(label = cell_id),
    direction = "x",
    angle = 0,
    hjust = .5,
    nudge_x = -1
    ) +
  geom_hline(yintercept = 0, col = "grey", lty = "dashed") +
  annotate("text", x = 27, y = -17, label = "Baseline activity", col = "gray") +
  geom_vline(xintercept = 0, col = "grey", lty = "dashed") +
  annotate("text", x = -2, y = 280, label = "Negative rank: FR decrease", col = "gray", angle = 90) +
  annotate("text", x = 2, y = 280, label = "Positive rank: FR increase", col = "gray", angle = 90) +
  theme_minimal() + 
  theme(
    axis.text = element_text(size = 20),
    text = element_text(size = 20)
  ) +
  ylim(-max(cellranks$activity_change),max(cellranks$activity_change))

```

<br><br>

Firing rate change **during** stimulus (photoactivation of the glycinergic fibers) compared to **before** stimulus:

```{r, fig.width=10, echo=FALSE,warning=FALSE}

ggplot(data = cellranks_before_stim,
       mapping = aes(x = change_rank, y = activity_change)) +
  geom_point(data = cellranks_before_stim %>% 
               dplyr::filter(control == F),size = 6,
             aes(col = position,
                 shape = pinch)
             ) +
  scale_color_manual(values = c("IL" = "green", "transient" = "blue", "PF" = "red", "unknown" = "black", "control" = "magenta")) + 
  scale_shape_manual(values = c("TRUE" = "+", "FALSE" = "-")) +
  geom_point(data = cellranks_before_stim %>%
               dplyr::filter(control == T), size = 3, col = "magenta") +
  ### label for negative values
  geom_text_repel(data = cellranks_before_stim %>% 
                    dplyr::filter(activity_change < 0),
    aes(label = cell_id),
    direction = "y",
    angle = 90,
    hjust = .5,
    nudge_y = -2
    ) +
  
  ### label for positive values
  geom_text_repel(data = cellranks_before_stim %>% 
                    dplyr::filter(activity_change > 0),
    aes(label = cell_id),
    direction = "x",
    angle = 0,
    hjust = .5,
    nudge_x = -1
    ) +
  geom_hline(yintercept = 0, col = "grey", lty = "dashed") +
  annotate("text", x = 27, y = -17, label = "Baseline activity", col = "gray") +
  geom_vline(xintercept = 0, col = "grey", lty = "dashed") +
  annotate("text", x = -2, y = 280, label = "Negative rank: FR decrease", col = "gray", angle = 90) +
  annotate("text", x = 2, y = 280, label = "Positive rank: FR increase", col = "gray", angle = 90) +
  theme_minimal() + 
  theme(
    axis.text = element_text(size = 20),
    text = element_text(size = 20)
  ) +
  xlab("Ranks") +
  ylab("Change in firing rate [%]") +
  ylim(-max(cellranks_before_stim$activity_change),max(cellranks_before_stim$activity_change)) 


```












<br><br>

Plotting the change in MFR from "*baseline*" to "*during stimulus*". Coloring based on the strength of the inhibition (*rank*)

```{r, fig.width=10, fig.height=12, echo=FALSE,warning=FALSE}
ggplot(
  data = TO_PLOT %>%
    dplyr::filter(
      control == F,
      stim_cond == "baseline" | stim_cond == "d"
    ),
  mapping = aes(
    x = forcats::fct_relevel(stim_cond, "baseline", "d", "a"),
    y = MFR
  )
) +
  geom_boxplot(width = 0.2, alpha = 0.5) +
  geom_point(aes(fill = change_rank),
    shape = 21,
    # fill = "#EB8104",
    # color = "white",
    size = 4
  ) +
  # stroke = 2) +
  geom_line(
    aes(group = cell_id, col = change_rank)
  ) +
  geom_label_repel(
    data = TO_PLOT %>%
      dplyr::filter(
        control == F,
        stim_cond == "baseline"
      ),
    mapping = aes(label = cell_id, col = change_rank),
    #nudge_x = -.1,
    direction = "y",
    hjust = 4,
    segment.size = .2
  ) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 20),
    text = element_text(size = 20)
  ) +
  xlab("Recording period") +
  labs(fill = "Rank" ,col = "Rank")

```


<br><br><br><br><br><br><br><br><br><br><br><br>


# Activity of PRF glycinergic cells during PFC photoactivation


```{r loading data, echo=FALSE, message=FALSE, warning=FALSE}
### LOADING RECORDINGS (tibble with AP and stim times) ###############
source(file.path("supplementary_functions", "CreateRecTibble.R"))
RECORDINGS <- CreateRecTibble(
  AP_times = read_csv(file.path("data", "cortical_stim", "AP_times.csv")),
  stim_times = read_csv(file.path("data", "cortical_stim", "stim_times.csv"))
)

### adding stimulus number within train
RECORDINGS <- RECORDINGS %>%
  mutate(stim_number = 0)

### calculating stimulus number within train 
initial_value <- RECORDINGS$stim_freq[1] %>% 
  `comment<-`("First value of stim_freq variable. When it changes stimulus counting restarts")

stim_counter <- 1 %>% 
  `comment<-`("Counts stimuli in a train")
index <- 1 %>% 
  `comment<-`("Tracks the position (index) of stim_freq")

RECORDINGS$stim_number[1] <- stim_counter
repeat{
  if (RECORDINGS$stim_freq[index + 1] == initial_value) {
    RECORDINGS$stim_number[index + 1] <- stim_counter + 1
    stim_counter <- stim_counter + 1
    index <- index + 1
  } else {
    initial_value <- RECORDINGS$stim_freq[index + 1]
    stim_counter <- 1
    RECORDINGS$stim_number[index + 1] <- stim_counter
    index <- index + 1
  }
  
  if (index == length(RECORDINGS$stim_number)) {
    break
  }
}

### replacing stim_number with NA at "AP"
RECORDINGS$stim_number[RECORDINGS$signal_type == "AP"] <- NA

### categorizing stimuli
RECORDINGS <- RECORDINGS %>%
  mutate(stim_freq_categ = stim_freq) %>%
  mutate(stim_freq_categ = replace(
    x = stim_freq_categ,
    list = (stim_freq_categ == 12 | stim_freq_categ == 8),
    values = 10
  )) %>%
  mutate(stim_freq_categ = replace(
    x = stim_freq_categ,
    list = (stim_freq_categ == 18),
    values = 20
  ))

```

* List of tibbles used to store data:
  + RECORDINGS tibble: stores AP and stim time stamps, number of stimuli in each train, stimulus frequency categories (eg. 8 10 and 12 Hz belong to 10 Hz category)
  + STIM_RESULTS: stores the data for PSTHs 



```{r message=FALSE, warning=FALSE, tidy=TRUE}
datatable(RECORDINGS, 
          caption ="RECORDINGS tibble", 
          rownames = TRUE, 
          options = list(pageLength = 50, scrollX=T, scrollY = "500px", dom = 't'))


```


# Spontaneous desynchronization of the FC slow oscillation 



```{r,  echo=FALSE,warning=FALSE,message=FALSE}
file_list <- list.files(
  path = "data",
  pattern = "*.mat", full.names = F, recursive = F
)

```


```{r}
file_to_load <- file_list[[1]]
filename <- as.character(substring(file_to_load, 1, nchar(file_to_load) - 4))
raw.rec <- readMat(file.path("data", file_to_load))

###takes the first AP (first row) and tells the index of point with the max value
points_to_peak <- which(raw.rec$ap[, , 1]$values[1, ] ==
    max(raw.rec$ap[, , 1]$values[1, ])) %>%
    as.numeric()

### time of the peak of the APs after its first point
raw.rec$ap[, , 1]$interval * points_to_peak

ap <- raw.rec$ap[, , 1]$times %>% as.double()
ap_peaks <- tibble(peak_times = (ap + c(raw.rec$ap[, , 1]$interval * points_to_peak)))


```


------- insert code here --------
 
(spont_desynchron_analysis.R), 7 recordings

# Terminals

## Loading data

```{r message=FALSE, warning=FALSE, tidy=TRUE}
file_path <- file.path('data',
                       'Emi_terminals',
                       'terminal_measures.csv' )  
TERMINALS <- read.table(file = file_path, sep = ';', header = T, na.string = 'na')
head(TERMINALS)

```

## Bouton area on different dendritic domains

```{r echo=FALSE, fig.width=10, message=FALSE, warning=FALSE}
ggplot(data = TERMINALS, mapping = aes(x = postion, y = b_area)) +
  geom_half_violin(position = position_nudge(x=-.15),
                  trim = F,
                  side = "l",
                  scale = "area",
                  draw_quantiles = c(0.5),
                  aes(fill = postion)) +
  geom_jitter(position = position_jitter(0.1))

```

## Area of boutons with *m2* and *unknown* origin

```{r fig.width=10, echo=FALSE, warning=FALSE, message=FALSE}
ggplot(data = TERMINALS,
       mapping = aes(x = origin, y = b_area)) +
  geom_half_violin(position = position_nudge(x=-.15),
                   trim = F,
                   side = "l",
                   scale = "count",
                   draw_quantiles = c(0.5)
                   #fill = alpha(0.1),
                   #aes(col = postion)
                   ) +
  geom_jitter(position = position_jitter(0.1),
              aes(col = postion)) +
  annotate("text",
           x = 0.7, 
           y = 1, 
           label = paste("n = ", 
                         TERMINALS %>%
                           group_by(origin) %>% 
                           summarise(n = length(b_area)) %>%
                           dplyr::filter(origin == "m2") %>% 
                           select(n) %>%
                           as.character())
           ) +
  annotate("text",
           x = 1.6, 
           y = 1, 
           label = paste("n = ", 
                         TERMINALS %>%
                           group_by(origin) %>% 
                           summarise(n = length(b_area)) %>%
                           dplyr::filter(origin == "unknown") %>% 
                           select(n) %>%
                           as.character())
  )
```

