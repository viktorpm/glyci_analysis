---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

# Spontaneous desynchronization


# IL inhibition


# Firing rate 

```{r}
library(tidyverse)
library(reshape2)
library(ggrepel)
source(file.path("supplementary_functions", "CreateRecTibble.R"))
```

```{r}
### LOADING DATA ------------

### stimulus data
IL_stim_firing <- CreateRecTibble(
  AP_times = read_csv(file.path("data", "IL_MFR", "stimulus", "AP_times.csv")),
  stim_times = read_csv(file.path("data", "IL_MFR","stimulus", "stim_times.csv"))
)
info_stim <- read_csv(file.path("data", "IL_MFR", "stimulus", "file_info.csv"))

### baseline data
IL_baseline_firing <- CreateRecTibble(
  AP_times = read_csv(file.path("data", "IL_MFR","baseline", "AP_times.csv")),
  stim_times = read_csv(file.path("data", "IL_MFR","baseline", "stim_times.csv"))
)
info_baseline <- read_csv(file.path("data", "IL_MFR", "baseline","file_info.csv"))
```

```{r}
### CELL INFO to store categories
CELL_INFO <- info_baseline %>% 
  select(file_name) %>% 
  add_column(cell_id = substr(info_baseline$file_name, 1,6), .before = "file_name") %>% 
  mutate(bl_activity = T) %>%
  mutate(bl_activity = replace(bl_activity, .$cell_id == "cell05"|
                                 .$cell_id == "cell10"|
                                 .$cell_id == "cell12"|
                                 .$cell_id == "cell13"|
                                 .$cell_id == "cell14"|
                                 .$cell_id == "cell15"|
                                 .$cell_id == "cell21"|
                                 .$cell_id == "cell22",
                               F)) %>% 
  mutate(pinch = T) %>% 
  mutate(pinch = replace(pinch, .$cell_id == "cell01"|
                           .$cell_id == "cell06"|
                           .$cell_id == "cell18"|
                           .$cell_id == "cell19"|
                           .$cell_id == "cell20"|
                           .$cell_id == "cell21"|
                           .$cell_id == "cell23"|
                           .$cell_id == "cell24"|
                           .$cell_id == "cell25"|
                           .$cell_id == "cell26"|
                           .$cell_id == "cell27"|
                           .$cell_id == "cell28",
                         F)) %>% 
  mutate(ident = F) %>% 
  mutate(ident = replace(ident, .$cell_id == "cell01"|
                           .$cell_id == "cell02"|
                           .$cell_id == "cell03"|
                           .$cell_id == "cell08"|
                           .$cell_id == "cell09"|
                           .$cell_id == "cell10"|
                           .$cell_id == "cell15"|
                           .$cell_id == "cell16"|
                           .$cell_id == "cell17"|
                           .$cell_id == "cell18"|
                           .$cell_id == "cell19"|
                           .$cell_id == "cell20"|
                           .$cell_id == "cell28"|
                           .$cell_id == "cell29",
                         T))



IL_stim_firing$file_name %>% unique() %>% length()
info_stim$file_name %>% length()
```

```{r}
### CALCULATING --------

IL_stim_firing <- left_join(IL_stim_firing, 
                            info_stim %>% 
                              select(file_name,
                                     rec_length,
                                     train_starts,
                                     train_ends,
                                     train_length), 
                            by = "file_name")

### calculating stim start times 
start_times <- IL_stim_firing %>%
  group_by(file_name) %>%
  summarise(train_starts = unique(train_starts), train_ends = unique(train_ends)) %>%
  mutate(cell_id = substr(info_stim$file_name, 1, 6)) %>%
  group_by(cell_id) %>%
  summarise(train_starts = unique(train_starts)) %>%
  pull(train_starts) %>%
  strsplit(",") %>%
  set_names(substr(info_stim$file_name, 1, 6)) %>%
  lapply(as.numeric)

### calculating stim end times 
end_times <- IL_stim_firing %>%
  group_by(file_name) %>%
  summarise(train_starts = unique(train_starts), train_ends = unique(train_ends)) %>%
  mutate(cell_id = substr(info_stim$file_name, 1, 6)) %>%
  group_by(cell_id) %>%
  summarise(train_ends = unique(train_ends)) %>%
  pull(train_ends) %>%
  strsplit(",") %>%
  set_names(substr(info_stim$file_name, 1, 6)) %>%
  lapply(as.numeric)


cell_list <- substr(info_stim$file_name, 1, 6)
CELL_INFO$cell_id
```

```{r}
### function to calculate #AP b/d/a stim 
foo <- function(data, list) {
  cell_list <- list
  
    train_length <- data %>%
      filter(substr(file_name, 1, 6) == cell_list) %>%
      select(train_length) %>%
      pull() %>%
      `[[`(1)
  
  
  
  if (
    (data %>%
      filter(substr(file_name, 1, 6) == cell_list, signal_type == "AP") %>%
      select(unit_id) %>%
      unique() %>%
      pull() %>%
      length()) == 1
  ) {
    ### In case of one unit in the file:
    AP_times <- data %>%
      filter(substr(file_name, 1, 6) == cell_list, signal_type == "AP") %>%
      select(signal_time) %>%
      pull()
    
    AP_numbers <- matrix(0, nrow = length(start_times[[cell_list]]), ncol = 3)
    colnames(AP_numbers) <- c("b", "d", "a")

    for (train_num in 1:length(start_times[[cell_list]])) {
      ### before
      AP_numbers[train_num, 1] <- length(AP_times[start_times[[cell_list]][train_num] - train_length
      < AP_times & AP_times < start_times[[cell_list]][train_num]])

      ### during
      AP_numbers[train_num, 2] <- length(AP_times[AP_times > start_times[[cell_list]][train_num] & AP_times < end_times[[cell_list]][train_num]])

      ### after
      AP_numbers[train_num, 3] <- length(AP_times[AP_times > end_times[[cell_list]][train_num] &
        AP_times < end_times[[cell_list]][train_num] + train_length])
    }
    
    melt(AP_numbers, varnames = c("train", "stim_cond"), value.name = "No_AP") %>%
      as.tibble() %>%
      add_column(cell_id = cell_list) %>% 
      add_column(train_length = train_length)
    
    
  } else { 
    ### in case of multiple units in the file:
    AP_times_1 <- data %>%
      filter(substr(file_name, 1, 6) == cell_list, signal_type == "AP", unit_id == 1) %>%
      select(signal_time) %>%
      pull()
    
    AP_numbers_1 <- matrix(0, nrow = length(start_times[[cell_list]]), ncol = 3)
    colnames(AP_numbers_1) <- c("b", "d", "a")
    
    for (train_num in 1:length(start_times[[cell_list]])) {
      ### before
      AP_numbers_1[train_num, 1] <- length(AP_times_1[start_times[[cell_list]][train_num] - train_length
                                                  < AP_times_1 & AP_times_1 < start_times[[cell_list]][train_num]])
      
      ### during
      AP_numbers_1[train_num, 2] <- length(AP_times_1[AP_times_1 > start_times[[cell_list]][train_num] & 
                                                        AP_times_1 < end_times[[cell_list]][train_num]])
      
      ### after
      AP_numbers_1[train_num, 3] <- length(AP_times_1[AP_times_1 > end_times[[cell_list]][train_num] &
                                                        AP_times_1 < end_times[[cell_list]][train_num] + train_length])
    }
    
    
    AP_times_2 <- data %>%
      filter(substr(file_name, 1, 6) == cell_list, signal_type == "AP", unit_id == 2) %>%
      select(signal_time) %>%
      pull()
    
    AP_numbers_2 <- matrix(0, nrow = length(start_times[[cell_list]]), ncol = 3)
    colnames(AP_numbers_2) <- c("b", "d", "a")
    
    for (train_num in 1:length(start_times[[cell_list]])) {
      ### before
      AP_numbers_2[train_num, 1] <- length(AP_times_2[start_times[[cell_list]][train_num] - train_length
                                                      < AP_times_2 & AP_times_2 < start_times[[cell_list]][train_num]])
      
      ### during
      AP_numbers_2[train_num, 2] <- length(AP_times_2[AP_times_2 > start_times[[cell_list]][train_num] & 
                                                        AP_times_2 < end_times[[cell_list]][train_num]])
      
      ### after
      AP_numbers_2[train_num, 3] <- length(AP_times_2[AP_times_2 > end_times[[cell_list]][train_num] &
                                                        AP_times_2 < end_times[[cell_list]][train_num] + train_length])
    }
    
    
    
    if (cell_list %>% substr(5,6) %>% as.numeric() %>% nchar() == 1) {
      new_name <- paste0(
        "cell0",
        cell_list %>% substr(5,6) %>% as.numeric() + 1
      )
    } 
      
    if (cell_list %>% substr(5,6) %>% as.numeric() %>% nchar() == 2) {
      new_name <- paste0(
        "cell",
        cell_list %>% substr(5,6) %>% as.numeric() + 1
      )
    }
    
    bind_rows(
      melt(AP_numbers_1, varnames = c("train", "stim_cond"), value.name = "No_AP") %>%
        as.tibble() %>%
        add_column(cell_id = cell_list) %>% 
        add_column(train_length = train_length),
      
      melt(AP_numbers_2, varnames = c("train", "stim_cond"), value.name = "No_AP") %>%
        as.tibble() %>%
        add_column(cell_id = new_name) %>% 
        add_column(train_length = train_length)
    )
   }#else

}#foo
```

```{r}

```




# Cortical stimulation
```{r, include = FALSE}
library(tidyverse)
library(reshape2)
library(ggrepel)
source(file.path("supplementary_functions", "CreateRecTibble.R"))
### source files from the utilities folder
walk(dir("utilities"), ~source(file.path("utilities", .x)))

RECORDINGS <- CreateRecTibble(
  AP_times = read_csv(file.path("data", "cortical_stim", "AP_times.csv")),
  stim_times = read_csv(file.path("data", "cortical_stim", "stim_times.csv"))
)


```




Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
