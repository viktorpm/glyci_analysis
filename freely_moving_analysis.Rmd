---
title: "Freely moving analysis"
author: "Viktor Plattner"
output:
  html_document:
    number_sections: yes
    df_print: paged
    toc: yes
    toc_float: yes
  pdf_document:
    number_sections: yes
    toc: yes
    keep_tex: true
  html_notebook:
    number_sections: yes
    toc: yes
    toc_float: yes
spacing: single
fontsize: 12pt
always_allow_html: yes
header-includes:
   - \usepackage{animate}
   
params:
  body_part:
    value: center
    choices:
      - center
      - head
      - tails
   
---
---




<style type="text/css">

body{ /* Normal  */
      font-size: 14px;
      font-family: "Arial", Helvetica, sans-serif;
  }
td {  /* Table  */
  font-size: 12px;
}
h1.title {
  font-size: 38px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #4d4e4f;
}
h1 { /* Header 1 */
  font-size: 28px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #2c3a3e;
}
h2 { /* Header 2 */
  font-size: 22px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #2c3a3e;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #2c3a3e;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>



```{r setup, include=FALSE}
### cheks all the used libraries in the project. Removes duplicates 
library(tidyverse)


### list of libraries mentioned in the R scripts of the project
liblist <- map(list.files(pattern = ".Rmd|.R"),
    ~ readLines(con = .x) %>% 
      grep(pattern = "library\\(", x = ., value = T)
) %>%
  unlist() %>%
  substr(start = 9,
         stop = regexpr(text = ., pattern = "\\)") - 1 %>% # regexpr: in case of multiple matches it only takes the first one
           as.vector()
  ) %>% `[` (!duplicated(.))

### list of installed packages
pkgs <- installed.packages() %>% 
  as_tibble() %>% 
  pull(1)

### packages that are needed but not installed
c(liblist[which(!liblist %in% pkgs)])

### installs uninstalled packages
install.packages(c(liblist[which(!liblist %in% pkgs)]))

### loads all libraries

lapply(liblist %>% as.list(), require, character.only = TRUE)

```


# Loading data

## Defining global constants

scale: pixels/mm <br>
fps: frame rate <br>
time_res: time between frames <br>

```{r}
scale <- 1.38 ### pixel/mm
fps <- 30 ### frame rate
time_res <- 1 / fps ### time between frames
library(imputeTS)


selected_animal <- "GIIFM22b"

```


## Loading stimulus times (frames)


```{r}
stims <- read.csv(file.path("data", "PnO_stim_rotation", "rotation_stims.csv")) %>%
  as_tibble() %>% 
   mutate(
    session = gsub(pattern = "(coords).*", replacement = "\\1", session),
    # session = ifelse(
    #   animal != "GIIFM24b", 
    #   yes = gsub(pattern = "(coords).*", replacement = "\\1", session),
    #   no = session
    # ),
    stim_length = end - start
    ) %>% 
  select(-stim_duration) %>%
  rename("stim_number" = stim.number) %>% 
  gather(key = "timing", value = "frame", start, end)
stims


```


## Loading coordinates


```{r message=F}
coords <- read.csv(file.path("data", "PnO_stim_rotation", "rotation_all.csv")) %>%
  as_tibble() %>% 
  mutate(
    animal =  gsub(pattern = ".*rotation", replacement = "", animal) %>% 
      str_remove_all(pattern = "\\\\") %>% str_remove(pattern = "fix"),
    session = gsub(pattern = "(coords).*", replacement = "\\1", session)
    # session = ifelse(
    #   animal != "GIIFM24b", 
    #   yes = gsub(pattern = "(coords).*", replacement = "\\1", session),
    #   no = session
    # )
    ) %>% 
  full_join(stims) %>% 
  dplyr::group_by(animal, session) %>%
  mutate(grp = cumsum(!is.na(stim_number))) %>%
  dplyr::group_by(grp) %>%
  mutate(
    stim = F,
    stim = replace(stim, first(timing) == "start" | timing == "end", T)
  ) %>%
  ungroup() %>% 
  group_by(animal, session, stim) %>%
  fill(stim_number) %>%
  fill(intensity) %>%
  select(-grp, -animal, -timing, -stim_length) %>%
  ungroup() %>% 
  group_by(animal, session) %>%
  dplyr::mutate(
    rec_time = (frame / fps) %>% round(digits = 2),
    stim_categ = case_when(
      stim == T ~ "stim",
      lead(stim, n = 252) == T ~ "before stim",
      lag(stim, n = 252) == T ~ "after stim",
      stim == F ~ "no stim"
    )
  ) %>% # length of the stimulus
  unite(col = "head", head1, head2, sep = "_") %>%
  unite(col = "center", center1, center2, sep = "_") %>%
  unite(col = "tail", tail1, tail2, sep = "_") %>%
  gather(
    key = "body_part",
    value = "coordinate",
    head, center, tail
  ) %>%
  tidyr::extract(col = coordinate, into = c("X", "Y"), regex = "([[:alnum:]]+)_([[:alnum:]]+)") %>%
  dplyr::mutate(
    X = ifelse(
      as.integer(X) == 0 & as.integer(Y) == 0,
      yes = NA,
      no = as.integer(X)
    ),
    Y = ifelse(
      as.integer(X) == 0 & as.integer(Y) == 0,
      yes = NA,
      no = as.integer(Y)
    )
  ) %>% 
  dplyr::group_by(animal, session, body_part) %>%
  dplyr::mutate(
    # X_interp = zoo::na.approx(X),
    # Y_interp = zoo::na.approx(Y),
    X_interp = imputeTS::na_interpolation(X) %>% round(),
    Y_interp = imputeTS::na_interpolation(Y) %>% round(),
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000,
    sec_counter = cumsum(ifelse(rec_time %% 1 == 0, 1, 0))
  ) %>%
  group_by(animal, session, body_part, sec_counter) %>%
  dplyr::mutate(speed_sec = sum(d_mm, na.rm = T)) %>%
  ungroup() %>%
  mutate(stim_number = replace(stim_number, is.na(stim_number), "no stim"))

coords


```

















Creating plot colors

```{r}
gg_color_hue <- function(n) {
  hues <- seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}

n <- 5
cols <- gg_color_hue(n)
```

## Plots


### Dealing with missing coordinates

Linear interpolation of missing values. The interpolated coordinates are used in the analysis


```{r fig.width=10, fig.height=10}
coords %>%
  dplyr::filter(animal == selected_animal ,body_part == params$body_part) %>%
  group_by(session, sec_counter) %>%
  mutate(d_sec = sum(d_mm, na.rm = T)) %>%
  ggplot(
    mapping = aes(x = X_interp, y = Y_interp, label = frame)
  ) +
  geom_point(
    aes(
      color = miss %>% as.character(), 
      shape = stim, 
      alpha = ifelse(miss == "1", 0.1 , 1)
      )
    ) +
  xlim(c(0, 1280)) +
  ylim(c(0, 720)) +
  facet_wrap(~session, ncol = 2) +
  scale_color_discrete(name = "Interpolated values")

```



### Plotting trajectories

```{r warning=FALSE, fig.width=10, fig.height=10}
coords %>%
  dplyr::filter(animal == selected_animal) %>%
  ggplot(
    mapping = aes(x = X_interp, y = Y_interp, label = frame)
  ) +
  geom_point(
    aes(shape = body_part, col = stim_number),
    size = 2,
    alpha = .1
  ) +
  geom_line(
    aes(group = frame, col = stim_number %>% as.character()),
    alpha = .1
  ) +
  scale_color_manual(
    values = c(cols[1], cols[2], cols[3], cols[4], cols[5], "black"),
    name = "Stimulus"
  ) +
  scale_shape(
    name = "Body part",
    labels = c("Center", "Head", "Tail")
  ) +
  xlim(c(0, 1280)) +
  ylim(c(0, 720)) +
  facet_wrap(~session, ncol = 2)
```

### Plotting speed in a 1 sec (30 frames) window

```{r message=FALSE, fig.width=10, fig.height=10}
coords %>%
  dplyr::filter(animal == selected_animal, body_part == params$body_part) %>%
  group_by(session, sec_counter) %>%
  mutate(d_sec = sum(d_mm, na.rm = T)) %>%
  ggplot(
    mapping = aes(x = X_interp, y = Y_interp, label = frame)
  ) +
  geom_point(aes(color = d_sec %>% scale(), alpha = stim)) +
  xlim(c(0, 1280)) +
  ylim(c(0, 720)) +
  facet_wrap(~session, ncol = 2)
```



### Distribution of the distance between points

Distribution of the difference between X and Y coordinates (by frame)

```{r, fig.width=10,fig.height=25, message=FALSE}
coords %>%
  #dplyr::filter(animal == "GIIFM24b") %>% 
  ggplot(mapping = aes(x = X_diff)) +
  stat_ecdf(aes(col = session), geom = "point") + 
  # geom_histogram(aes(fill = session)) +
  facet_grid(~animal ~ body_part,) 
  # scale_y_continuous(trans='log10') 
```

```{r message=FALSE}
coords %>% 
  group_by(animal, body_part) %>% 
  summarise(min = min(X_diff, na.rm = T), max = max(X_diff, na.rm = T)) %>% 
  DT::datatable()
```


```{r fig.width=10, fig.height=25}
coords %>%
  ggplot(mapping = aes(x = X_diff)) +
  # geom_boxplot() +
  geom_histogram(aes(fill = session), binwidth = 5) +
  facet_grid(animal ~ body_part, scales = "free") +
  scale_y_continuous(trans='log10') 
```

```{r message=FALSE}
coords %>% 
  group_by(animal, body_part) %>% 
  summarise(min = min(Y_diff, na.rm = T), max = max(Y_diff, na.rm = T)) %>%
  DT::datatable()
```

Distribution of distance

```{r fig.width=10, fig.height=25}
coords %>%
  # dplyr::filter(animal == "GIIFM24b") %>%
  ggplot(mapping = aes(x = d_mm)) +
  geom_histogram(aes(fill = session), binwidth = 5) +
  facet_grid(animal ~ body_part, scales = "free") +
  scale_y_continuous(trans='log10') 
  
```


### Instantaneous traveled distance

Center

```{r fig.width=10, fig.height=10}
coords %>%
  dplyr::filter(
    animal == selected_animal, 
    body_part == params$body_part,
    X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20) %>%
  ggplot(mapping = aes(x = rec_time, y = d_mm)) +
  geom_line(aes(color = stim, group = 1)) +
  # geom_line(aes(x = rec_time, y = Y_diff -130), alpha = .5) + 
  # geom_line(aes(x = rec_time, y = X_diff + 130), alpha = .5) + 
  facet_wrap(~session, scales = "free", ncol = 2)
```

Head

```{r fig.width=10, fig.height=10}
coords %>%
  dplyr::filter(
    animal == selected_animal, 
    body_part == "head",
    X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20) %>%
  ggplot(mapping = aes(x = rec_time, y = d_mm)) +
  geom_line(aes(color = stim, group = 1)) +
  # geom_line(aes(x = rec_time, y = Y_diff -130), alpha = .5) + 
  # geom_line(aes(x = rec_time, y = X_diff + 130), alpha = .5) + 
  facet_wrap(~session, scales = "free", ncol = 2)
```

Tail

```{r fig.width=10, fig.height=10}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "tail",
    X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20) %>%
  ggplot(mapping = aes(x = rec_time, y = d_mm)) +
  geom_line(aes(color = stim, group = 1)) +
  # geom_line(aes(x = rec_time, y = Y_diff -130), alpha = .5) + 
  # geom_line(aes(x = rec_time, y = X_diff + 130), alpha = .5) + 
  facet_wrap(~session, scales = "free", ncol = 2)
```



### Rolling mean of traveled distance

1 sec rolling window, mean calculated separately during stimulus (rolling window restarts with the beginning of stimuli)


```{r message=F, fig.width=10}
coords %>%
  dplyr::filter(
    animal == selected_animal, 
    body_part == params$body_part, 
    session == "video3coords",
    X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20) %>%
  dplyr::group_by(stim) %>%
  dplyr::mutate(mean_mps_roll = zoo::rollmean(x = d_mm, k = 30, fill = NA)) %>%
  ggplot(aes(x = rec_time, y = d_mm)) +
  #ylim(c(0, 100)) +
  geom_point(aes(alpha = stim)) +
  geom_line(aes(x = rec_time, y = mean_mps_roll, col = stim_categ, group = 1), size = 1) 
```

Center

```{r fig.width=10, fig.height=10}
coords %>%
  dplyr::filter(
    animal == selected_animal, 
    body_part == params$body_part,
    X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20
    ) %>%
  dplyr::group_by(session, stim) %>%
  dplyr::mutate(mean_mps_roll = zoo::rollmean(x = d_mm, k = 30, fill = NA)) %>%
  ggplot(aes(x = rec_time, y = d_mm)) +
  #ylim(c(0, 100)) +
  geom_point(aes(alpha = stim)) +
  geom_line(aes(x = rec_time, y = mean_mps_roll, col = stim_categ, group = 1), size = 1) +
  facet_wrap(~session, scales = "free", ncol = 2)
```


Head


```{r fig.width=10, fig.height=10}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "head",
    X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20) %>%
  dplyr::group_by(session, stim) %>%
  dplyr::mutate(mean_mps_roll = zoo::rollmean(x = d_mm, k = 30, fill = NA)) %>%
  ggplot(aes(x = rec_time, y = d_mm)) +
  #ylim(c(0, 100)) +
  geom_point(aes(alpha = stim)) +
  geom_line(aes(x = rec_time, y = mean_mps_roll, col = stim_categ, group = 1), size = 1) +
  facet_wrap(~session, scales = "free", ncol = 2)
```



Tail


```{r fig.width=10, fig.height=10}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "tail",
    X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20) %>%
  dplyr::group_by(session, stim) %>%
  dplyr::mutate(mean_mps_roll = zoo::rollmean(x = d_mm, k = 30, fill = NA)) %>%
  ggplot(aes(x = rec_time, y = d_mm)) +
  #ylim(c(0, 100)) +
  geom_point(aes(alpha = stim)) +
  geom_line(aes(x = rec_time, y = mean_mps_roll, col = stim_categ, group = 1), size = 1) +
  facet_wrap(~session, scales = "free", ncol = 2)
```



<!-- ```{r fig.width=10, fig.height=10} -->
<!-- coords %>% -->
<!--   dplyr::select(animal, session, frame,rec_time,stim_categ,body_part,d_mm,X_diff,Y_diff, stim_number) %>%  -->
<!--   mutate(stim_number = replace(stim_number, stim_number == "no stim", NA)) %>%  -->
<!--   dplyr::filter( -->
<!--     animal == "GIIFM19b", -->
<!--     body_part == params$body_part, -->
<!--     X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20, -->
<!--     stim_categ != "no stim") %>%  -->
<!--   group_by(session, stim_categ) %>%  -->
<!--   mutate(categ_timer = (row_number() / fps) %>% round(digits = 2)) %>%  -->
<!--   ungroup() %>%  -->
<!--   group_by(session) %>%  -->
<!--   mutate(stim_block_number = fill(stim_number)) %>%  -->



<!--   ggplot(aes(x= categ_timer, y = d_mm, group = stim_categ)) + -->
<!--   geom_line(aes(col = stim_categ)) + -->
<!--   facet_wrap(~session, ncol = 2, scales = "free") -->

<!-- ``` -->







## Calculating angles

### Toy data

```{r}
vectors <- tibble(
  body = c("cent", "h", "cent", "h", "cent", "h", "cent", "h"),
  frame = c(0, 0, 1, 1, 2, 2, 3, 3),
  X = c(750, 760, 770, 770, 755, 765, 755, 765),
  Y = c(500, 500, 500, 520, 510, 520, 510, 500)
)
vectors %>% arrange(body)
```


```{r}
ang <- function(a, b) {
  theta <- acos(sum(a * b) / (sqrt(sum(a * a)) * sqrt(sum(b * b))))
  return(theta * 180 / pi)
}

#ang(a = c(10, 0), b = c(10, 10))

vectors %>%
  group_by(frame) %>%
  summarise(dx = diff(X), dy = diff(Y)) %>%
  mutate(ldx = lead(dx), ldy = lead(dy)) %>%
  rowwise() %>%
  mutate(angle = ang(a = c(dx, dy), b = c(ldx, ldy))) %>%
  ungroup() %>%
  mutate(
    signed_angle = (atan2(dx, dy) - atan2(ldx, ldy)) * 180 / (pi)
  )
```


```{r}
matlib::angle(
  x = vectors %>%
    group_by(frame) %>%
    summarise(dx = diff(X), dy = diff(Y)) %>%
    dplyr::filter(frame == "0") %>%
    select(-1) %>% as.matrix() %>% as.vector(),
  y = vectors %>%
    group_by(frame) %>%
    summarise(dx = diff(X), dy = diff(Y)) %>%
    dplyr::filter(frame == "2") %>%
    select(-1) %>% as.matrix() %>% as.vector()
)
```


The dot product of two vectors x and y can be defined as:

$x \cdot y = ||x|| * ||y|| \cos(\theta) $

```{r}
vectors %>%
  ggplot(mapping = aes(x = X, y = Y)) +
  geom_point(aes(shape = body)) +
  geom_line(aes(group = frame, color = frame %>% as.character())) +
  geom_text_repel(aes(label = paste0(X, ",", Y), col = as.character(frame))) +
  xlim(750, 775) +
  ylim(500, 525)
```

## Real data (coords tibble)


### First three hed- center vectors

```{r}
coords %>%
  dplyr::filter(animal == "GIIFM19b") %>%
  dplyr::group_by(body_part) %>%
  slice(1:3) %>%
  dplyr::filter(body_part != "tail") %>%
  ggplot(
    mapping = aes(x = X, y = Y)
  ) +
  geom_point(aes(shape = body_part), size = 2) +
  geom_line(aes(group = frame, color = as.character(frame))) +
  geom_text_repel(aes(label = paste0(X, ",", Y), col = as.character(frame))) +
  geom_segment(aes(
    x = 210, xend = 255,
    y = 345, yend = 345
  ), linetype = "dashed", col = "red") +
  geom_segment(aes(
    x = 255, xend = 255,
    y = 345, yend = 364
  ), linetype = "dashed", col = "red")
```

### Distribution of angles

Because of the periodicity of tangent function unrealistic angles were introduced (jumps in data). Angles greater than 180 or smaller than -180 were subtracted from 360 and -360 respectively to get the correct angle.


```{r message=FALSE, fig.width=10, fig.height=10}
coords %>%
  dplyr::filter(animal == selected_animal, body_part != "tail") %>%
  dplyr::filter(body_part != "tail") %>%
  dplyr::group_by(animal, session, frame) %>%
  summarise(
    vectx = diff(X_interp),
    vecty = diff(Y_interp)
  ) %>%
  mutate(
    leadx = lead(vectx),
    leady = lead(vecty)
  ) %>%
  #rowwise() %>%
  mutate(
    signed_angle = (atan2(leadx, leady) - atan2(vectx, vecty)) * 180 / (pi)
  ) %>%
   mutate(
    signed_angle_corrected = case_when(
        signed_angle >= 180 ~ 360 - signed_angle,
        signed_angle %>% abs() < 180 ~ signed_angle,
        signed_angle <= -180 ~ -360 - signed_angle,
        signed_angle > -180 | signed_angle < 0 ~ signed_angle
      )) %>% 
  ggplot(aes(x = signed_angle_corrected)) +
  geom_histogram() +
  facet_wrap(~session, scales = "free")
```

### Signed angles 

```{r message=F, fig.width=10, fig.height=10}
coords %>%
  dplyr::filter(animal == selected_animal, body_part != "tail") %>%
  dplyr::group_by(session, frame) %>%
  #arrange(body_part) %>% 
  summarise(
    vectx = diff(X_interp),
    vecty = diff(Y_interp)
  ) %>%
  mutate(
    leadx = lead(vectx),
    leady = lead(vecty)
  ) %>%
  #rowwise() %>%
  mutate(
    signed_angle = (atan2(leadx, leady) - atan2(vectx, vecty)) * 180 / (pi)
  ) %>% 
  mutate(
    signed_angle_corrected = case_when(
        signed_angle >= 180 ~ 360 - signed_angle,
        signed_angle %>% abs() < 180 ~ signed_angle,
        signed_angle <= -180 ~ -360 - signed_angle,
        signed_angle > -180 | signed_angle < 0 ~ signed_angle
      )) %>% 

  add_column(
    rec_time = coords %>% dplyr::filter(animal == selected_animal, body_part == "head") %>% pull(rec_time),
    stim = coords %>% dplyr::filter(animal == selected_animal, body_part == "head") %>% pull(stim)
  ) %>%
  ggplot(aes(x = rec_time, y = signed_angle_corrected)) +
  geom_line(aes(col = stim, group = 1)) +
  facet_wrap(~session, scales = "free_x") 
  #xlim(0,1)

```


```{r}
coords %>%
  dplyr::filter(animal == selected_animal, session == "video0coords", body_part != "tail") %>% 
  dplyr::group_by(body_part) %>%
  dplyr::slice(1:25) %>% 
  ungroup() %>% 
  dplyr::group_by(frame) %>%
  summarise(
    vectx = diff(X_interp),
    vecty = diff(Y_interp)
  ) %>%
  mutate(
    leadx = lead(vectx),
    leady = lead(vecty)
  ) %>%
  #rowwise() %>%
  mutate(
    signed_angle = (atan2(leadx, leady) - atan2(vectx, vecty)) * 180 / (pi)
  ) 

```


### Plotting cumulative angles

```{r message=FALSE,fig.width=10, fig.height=10}
coords %>%
  dplyr::filter(animal == selected_animal, body_part != "tail") %>%
  dplyr::group_by(session, frame) %>%
  summarise(
    vectx = diff(X_interp),
    vecty = diff(Y_interp)
  ) %>%
  mutate(
    leadx = lead(vectx),
    leady = lead(vecty)
  ) %>%
  #rowwise() %>%
  mutate(
    signed_angle = (atan2(leadx, leady) - atan2(vectx, vecty)) * 180 / (pi) 
  ) %>%
   mutate(
    signed_angle_corrected = case_when(
        signed_angle >= 180 ~ 360 - signed_angle,
        signed_angle %>% abs() < 180 ~ signed_angle,
        signed_angle <= -180 ~ -360 - signed_angle,
        signed_angle > -180 | signed_angle < 0 ~ signed_angle
      )) %>% 
  add_column(
    rec_time = coords %>% dplyr::filter(animal == selected_animal, body_part == "head") %>% pull(rec_time),
    stim = coords %>% dplyr::filter(animal == selected_animal, body_part == "head") %>% pull(stim),
    stim_categ = coords %>% dplyr::filter(animal == selected_animal, body_part == "head") %>% pull(stim_categ),
    stim_number = coords %>% dplyr::filter(animal == selected_animal, body_part == "head") %>% pull(stim_number),
    Y_diff = coords %>% dplyr::filter(animal == selected_animal, body_part == "head") %>% pull(Y_diff),
    X_diff = coords %>% dplyr::filter(animal == selected_animal, body_part == "head") %>% pull(X_diff),
    d_mm = coords %>% dplyr::filter(animal == selected_animal, body_part == "head") %>% pull(d_mm),
  ) %>%
  group_by(session) %>%
  mutate(csum = cumsum(ifelse(is.na(signed_angle_corrected), 0, signed_angle_corrected)) %>% round(4)) %>%
 # dplyr::filter(session == "video2coords") %>%
  # group_by(session) %>%
  # gather(key = "stim_categ" , value = "stim_value", stim, before_stim) %>%
  ggplot(
    mapping = aes(x = rec_time, y = csum %>% scale())
  ) +
  geom_line(aes(col = stim, group = 1)) +
  facet_wrap(~session, scales = "free_x")

```



