---
title: "Freely moving analysis"
author: "Viktor Plattner"
output:
  html_document:
    number_sections: yes
    df_print: paged
    toc: yes
    toc_float: yes
  pdf_document:
    number_sections: yes
    toc: yes
    keep_tex: true
  html_notebook:
    number_sections: yes
    toc: yes
    toc_float: yes
spacing: single
fontsize: 12pt
always_allow_html: yes
header-includes:
   - \usepackage{animate}

params:
  selected_animal: "GIIFM20b"



knit: (
  function (inputFile, encoding) {
    
    
    rmarkdown::render(  
      input = inputFile,
      encoding = encoding,
      output_file = file.path(
        "notebook_html", 
        paste0("freely_moving_analysis_", 
        rmarkdown::yaml_front_matter(inputFile)$params$selected_animal,
        "_",
        Sys.Date(),
         ".html")
        ),
      envir = globalenv()
      )
    }
  )
---


<style type="text/css">

body{ /* Normal  */
      font-size: 14px;
      font-family: "Arial", Helvetica, sans-serif;
  }
td {  /* Table  */
  font-size: 12px;
}
h1.title {
  font-size: 38px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #4d4e4f;
}
h1 { /* Header 1 */
  font-size: 28px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #2c3a3e;
}
h2 { /* Header 2 */
  font-size: 22px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #2c3a3e;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #2c3a3e;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>


```{r setup, include=FALSE}
### cheks all the used libraries in the project. Removes duplicates
### list of libraries mentioned in the R scripts of the project
library(tidyverse)

liblist <- map(
  list.files(pattern = ".Rmd|.R"),
  ~ readLines(con = .x) %>%
    grep(pattern = "library\\(", x = ., value = T)
) %>%
  unlist() %>%
  substr(
    start = 9,
    stop = regexpr(text = ., pattern = "\\)") - 1 %>% # regexpr: in case of multiple matches it only takes the first one
      as.vector()
  ) %>%
  `[`(!duplicated(.))

### list of installed packages
pkgs <- installed.packages() %>%
  as_tibble() %>%
  pull(1)

### packages that are needed but not installed
c(liblist[which(!liblist %in% pkgs)])

### installs uninstalled packages
install.packages(c(liblist[which(!liblist %in% pkgs)]))

### loads all libraries
lapply(liblist %>% as.list(), require, character.only = TRUE)




### defining global constants, filters and plot scales

library(imputeTS)

scale <- 1.38 ### pixel/mm
fps <- 25 ### frame rate
standard_stim_length <- 10 ### this is the most commonly used stimulus length (in seconds)
around_stim_length <- fps * 8

time_res <- 1 / fps ### time between frames
ang_threshold <- 90
mouse_speed_mps <- 3.3



datapoint_to_plot <- 5

global_facet_theme <- theme(
  strip.text = element_text(size = 15),
  axis.text = element_text(size = 12),
  axis.title = element_text(size = 15)
)

xlim_mm <- c(0, 1280 / scale)
ylim_mm <- c(0, 720 / scale)

selected_animal <- params$selected_animal
selected_intensities <- c("1 mW", "5 mW", "10 mW")
control_animals <- c("GIIFM34b", "GIIFM35b", "GIIFM36b", "GIIFM37b")

`%!in%` <- Negate(`%in%`)




### custom functions used in the analysis



### removing junk animals from the data

RawDataFilter <- function(df) {
  # browser()
  df %>%
    dplyr::filter(
      stringr::str_detect(animal, pattern = "b")
    ) %>%
    as_tibble() %>%
    return()
}
```




# Loading and orginising data

## Global constants and scales 
<br>
These are defined in the "setup" chunk <br>

+ **scale**: 1.38 (pixels/mm) <br>
+ **fps**: `r fps` (frame rate) <br>
+ **time_res**: 1/**fps** (time between frames) <br>
+ **xlim_mm**, **ylim_mm**: pixels converted to mm 
+ **global_facet_theme**: plot text sizes
+ **datapoint_to_plot**: which datapoint to plot (frame %% datapoint_to_plot == 0)
+ **text_layer**: stimulus intensity in each session (used to create the text layer on plots, defined after "coords" was created)

<br>

**Current animal**: `r selected_animal`  
For the trajectories and traveled distance plots every `r datapoint_to_plot`th frame (data point) was used. <br>
The global angle threshold used in this file is `r ang_threshold`. Grater rotation angles between consecutive frames are replaced by zero

**Control animals**: GIIFM34b, GIIFM35b, GIIFM36b, GIIFM37b

<br>

## Loading stimulus times (frames)


```{r echo = FALSE}
stims <- read.csv(file.path("data", "PnO_stim_rotation", "rotation_stims.csv")) %>%
  as_tibble() %>%
  ### filter junk data
  dplyr::filter(
    stringr::str_detect(animal, pattern = "b")
  ) %>%
  ### creating unique session IDs
  mutate(
    intensity = paste0(intensity, " mW"),
    s2 = lag(session, default = "1"),
    s3 = ifelse(s2 == session, 0, 1),
    stim_length = end - start
  ) %>%
  group_by(animal) %>%
  mutate(
    session = cumsum(s3),
    session = paste0("session_", session)
  ) %>%
  select(-stim_duration, -s2, -s3) %>%
  rename("stim_number" = stim.number) %>%
  gather(key = "timing", value = "frame", start, end)
```


## Loading coordinates


```{r message=F, echo = FALSE, warning = FALSE}
coords <- read.csv(file.path("data", "PnO_stim_rotation", "rotation_all.csv")) %>%
  as_tibble() %>%
  ### filter junk data
  dplyr::filter(
    stringr::str_detect(animal, pattern = "b")
  ) %>%
  ### creating unique session IDs
  mutate(
    animal = gsub(pattern = ".*rotation", replacement = "", animal) %>%
      str_remove_all(pattern = "\\\\") %>% str_remove(pattern = "fix") %>% str_remove(pattern = "control"),
    s2 = lag(session, default = "1"),
    s3 = ifelse(s2 == session, 0, 1),
  ) %>%
  group_by(animal) %>%
  mutate(
    session = cumsum(s3),
    session = paste0("session_", session)
  ) %>%
  select(-s2, -s3) %>%
  ungroup() %>%
  full_join(stims) %>%
  dplyr::group_by(animal, session) %>%
  dplyr::mutate(
    stim_number = ifelse(timing == "end", NA, stim_number)
  ) %>%
  mutate(grp = cumsum(!is.na(stim_number))) %>%
  dplyr::group_by(animal, session, grp) %>%
  fill(timing) %>%
  mutate(
    stim_freq = replace(stim_freq, timing == "start", stim_freq[1]),
    stim_freq = replace(stim_freq, timing == "end", NA),
    stim_length = replace(stim_length, timing == "start", stim_length[1]),
    stim_length = replace(stim_length, timing == "end", NA),
    intensity = replace(intensity, timing == "start", intensity[1]),
    intensity = replace(intensity, timing == "end", NA),
    stim_number = replace(stim_number, timing == "start", stim_number[1]),
    stim_number = replace(stim_number, timing == "end", NA),
    stim_side = replace(stim_side, timing == "start", stim_side[1]),
    stim_side = replace(stim_side, timing == "end", NA),
    stim = F,
    stim = replace(stim, timing == "start", T)
  ) %>%
  ungroup() %>%
  group_by(animal, session) %>%
  dplyr::mutate(
    rec_time = (frame / fps) %>% round(digits = 2),
    stim_categ = case_when(
      stim == T ~ "stim",
      lead(stim, n = around_stim_length) == T ~ "before stim",
      lag(stim, n = around_stim_length) == T ~ "after stim",
      stim == F ~ "no stim"
    ),

    ### rigth before and after stim (1s)
    stim_categ2 = case_when(
      stim == T ~ "stim",
      lead(stim, n = fps) == T ~ "right before",
      lag(stim, n = fps) == T ~ "right after ",
      stim == F ~ "no stim"
    ),

    ### shift values to the beginning of the stimulus block to be able to fill missing values in the next step
    stim_block = ifelse(stim_categ == "no stim", F, T),
    stim_number = lead(stim_number, n = around_stim_length),
    intensity = lead(intensity, n = around_stim_length),
    stim_freq = lead(stim_freq, n = around_stim_length),
    stim_side = lead(stim_side, n = around_stim_length),

    ### rigth before and after stim (1s)
    stim_block2 = ifelse(stim_categ2 == "no stim", F, T),
    stim_number2 = lead(stim_number, n = fps),
    intensity2 = lead(intensity, n = fps),
    stim_freq2 = lead(stim_freq, n = fps),
    stim_side2 = lead(stim_side, n = fps),
  ) %>%
  ungroup() %>%
  group_by(animal, session, stim_block) %>%
  fill(stim_number) %>%
  fill(intensity) %>%
  fill(stim_freq) %>%
  fill(stim_side) %>%
  ### rigth before and after stim (1s)
  fill(stim_number2) %>%
  fill(intensity2) %>%
  fill(stim_freq2) %>%
  fill(stim_side2) %>%
  # dplyr::group_by(animal, session) %>%
  # mutate(
  #   center1 = replace(
  #     center1,
  #     abs(head1 - center1) > 75 | abs(head2 - center2) > 75 |
  #       abs(center1 - tail1) > 75 | abs(center2 - tail2) > 75,
  #     NA),
  #   center2 = replace(
  #     center2,
  #     abs(head1 - center1) > 75 | abs(head2 - center2) > 75 |
  #       abs(center1 - tail1) > 75 | abs(center2 - tail2) > 75,
  #     NA),
  #   head1 = replace(
  #     head1,
  #     abs(head1 - center1) > 75 | abs(head2 - center2) > 75 |
  #       abs(center1 - tail1) > 75 | abs(center2 - tail2) > 75,
  #     NA ),
  #   head2 = replace(
  #     head2,
  #     abs(head1 - center1) > 75 | abs(head2 - center2) > 75|
  #       abs(center1 - tail1) > 75 | abs(center2 - tail2) > 75,
  #     NA ),
  #   tail1 = replace(
  #     tail1,
  #     abs(head1 - center1) > 75 | abs(head2 - center2) > 75 |
  #       abs(center1 - tail1) > 75 | abs(center2 - tail2) > 75,
  #     NA ),
  #   tail2 = replace(
  #     tail2,
  #     abs(head1 - center1) > 75 | abs(head2 - center2) > 75|
  #       abs(center1 - tail1) > 75 | abs(center2 - tail2) > 75,
  #     NA )) %>%
  # fill(center1) %>%
  # fill(center2) %>%
  # fill(head1) %>%
  # fill(head2) %>%
  # fill(tail1) %>%
  # fill(tail2) %>%
  # ungroup() %>%
  #
  # dplyr::mutate(
  #   hc_x = abs(head1-center1),
  #   hc_y = abs(head2-center2),
  #   ct_x = abs(center1-tail1),
  #   ct_y = abs(center2-tail2)
  # ) %>%
  # ggplot(mapping = aes(x = ct_y)) +
  # geom_histogram() +
  # scale_y_log10() +
  # facet_wrap(~animal)
  #
  #
  # ) %>%
  # dplyr::filter(animal == "GIIFM21b", session == 3, stim_number == 3) %>%
  # View()


  # length of the stimulus
  unite(col = "head", head1, head2, sep = "_") %>%
  unite(col = "center", center1, center2, sep = "_") %>%
  unite(col = "tail", tail1, tail2, sep = "_") %>%
  gather(
    key = "body_part",
    value = "coordinate",
    head, center, tail
  ) %>%
  tidyr::extract(col = coordinate, into = c("X", "Y"), regex = "([[:alnum:]]+)_([[:alnum:]]+)") %>%
  dplyr::mutate(
    X = replace(X, miss == 0, NA),
    Y = replace(Y, miss == 0, NA)
  ) %>%
  # dplyr::group_by(animal, session) %>%
  # fill(X) %>%
  # fill(Y) %>%
  # ungroup() %>%
  # dplyr::filter(animal == "GIIFM21b", session == 3, stim_number == 3) %>% View()

  dplyr::group_by(animal, session, body_part) %>%
  ### this block calculates distances and speed across frames
  dplyr::mutate(
    X_interp = imputeTS::na_interpolation(X %>% as.integer()) %>% round(),
    Y_interp = imputeTS::na_interpolation(Y %>% as.integer()) %>% round(),
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),

    ### sometimes the tracking software looses the point and jumps back and forth between unrealistic numbers
    ### these are replaced by 0 (the animal did not change position between those frames)
    X_diff = ifelse(abs(X_diff) > 25, yes = 0, no = X_diff),
    Y_diff = ifelse(abs(Y_diff) > 25, yes = 0, no = Y_diff),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000,
    sec_counter = cumsum(ifelse(rec_time %% 1 == 0, 1, 0))
  ) %>%
  group_by(animal, session, body_part, sec_counter) %>%
  dplyr::mutate(speed_sec = sum(d_mm, na.rm = T)) %>%
  ungroup() %>%
  mutate(stim_number = replace(stim_number, is.na(stim_number), "no stim"))


coords
```

```{r}
lengths <- coords %>%
  dplyr::filter(
    body_part == "head",
    stim_categ != "no stim",
  ) %>%
  group_by(animal, session, stim_number) %>%
  count(stim_categ)

# lengths %>% dplyr::filter(animal != "GIIFM14b", stim_categ == "after stim") %>% View()
```




Saving separate csv files

```{r}
# tibble_list <- coords %>%
#   dplyr::filter(
#     str_detect(animal, pattern = "b")
#     ) %>%
#   rename(video = session) %>%
#   dplyr::group_split(animal, video)
#
#
# csv_name_list <- lapply(tibble_list, function(x){
#   paste0(x %>% pull(animal) %>% unique(), "_video_", x %>% pull(video) %>% unique(), ".csv")
# }) %>% unlist()
#
# mapply(write_csv, x = tibble_list, file = file.path("output_data", "separate_csv", csv_name_list))
#
#
#
# coords %>% names()
# coords %>%
#   select(session,animal,frame,stim_number,stim_categ, X, Y, body_part) %>%
#   # unite(col = "sess_anim", session, animal, sep = "_") %>%
#   unite(col = "coordinates", X, Y, sep = "_" ) %>%
#   tidyr::spread(key = body_part, value = coordinates)


# reshape(timevar = "body_part", direction = "wide") %>% View()


# reshape(idvar = "animal", timevar = "body_part", direction = "wide") %>% View()
#
#
#
# group_by(animal, session) %>%
# tidyr::spread(
#   key = body_part,
#   value = X) %>% View()
```















```{r echo = FALSE}
# In the "coords_all" table all the data can be found.
# Based on preliminary exploration of the data only animals with similar stimulus parameters were selected for further analysis (coords table)


# coords %>%
#   dplyr::group_by(animal,session) %>%
#   summarise(stim_length)
#
# coords %>%
#   dplyr::filter(animal == "GIIFM14b") %>% View()
```


Creating text layer to add intensity values to plots

```{r}
text_layer <- coords %>%
  dplyr::filter(
    animal == selected_animal,
    stim == T
  ) %>%
  group_by(session) %>%
  summarise(int_label = intensity %>% unique())
```






Creating plot colors

```{r}
gg_color_hue <- function(n) {
  hues <- seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}

n <- 6
cols <- gg_color_hue(n)
```


# Analysis (selected animal: `r selected_animal`)


## Checking tracking quality

Plotting X and Y positions vs time separately to see jumps in the tracking data and big separation between head-ceter-tail coordinates (unrealistically big mouse). The tracking software occasionally lost the animal and started to follow different points. If there are many of those the session cannot be analysed.


```{r warning=FALSE, fig.width=15, fig.height=10, echo = FALSE}

plt_xpos <- coords %>%
  dplyr::filter(animal == selected_animal) %>%
  ggplot(mapping = aes(x = rec_time, y = X %>% as.integer() )) +
  geom_line(aes(col = body_part)) +
  theme(legend.position = "none") +
  ylab("X position") +
  facet_wrap(~session, ncol = 1) +
  ggtitle("X position")



plt_ypos <- coords %>%
  dplyr::filter(animal == selected_animal) %>%
  ggplot(mapping = aes(x = rec_time, y = Y %>% as.integer())) +
  geom_line(aes(col = body_part)) +
  theme(legend.position = "none") +
  ylab("Y position") +
  facet_wrap(~session, ncol = 1) +
  ggtitle("Y position")

cowplot::plot_grid(plt_xpos, plt_ypos, ncol = 2)
```

## Dealing with missing coordinates

The tracking software occasionally lost the tracked points. To fill those gaps linear interpolation was applied. The figure below shows the interpolated values in red.
Note that only every 5th frame was used for the tracking and for the later analysis except for calculating the rotation angle.

```{r fig.width=10, fig.height=10, warning=FALSE, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    frame %% datapoint_to_plot == 0
  ) %>%
  group_by(session, sec_counter) %>%
  mutate(d_sec = sum(d_mm, na.rm = T)) %>%
  ggplot(
    mapping = aes(x = X_interp, y = Y_interp, label = frame)
  ) +
  geom_point(
    aes(
      color = miss %>% as.character(),
      shape = stim,
      alpha = ifelse(miss == "1", 0.1, 1)
    )
  ) +
  xlim(c(0, 1280)) +
  ylim(c(0, 720)) +
  facet_wrap(~session, ncol = 2) +
  scale_color_discrete(name = "Interpolated values") +
  geom_label(data = text_layer, aes(x = Inf, y = -Inf, hjust = 1.1, vjust = -0.5, label = paste0("Intensity: ", int_label))) +
  global_facet_theme
```



## Plotting trajectories

To show the animals trajectory during stimuli the head-center-tail body points were plotted. Colors correspond to the order of stimuli in each session. The black points represent the trajectory when there was no stimulus. For visualization purposes the number of plotted data points are different during the stimulus vs non-stimulus period (2 data points/sec vs 6 data points/sec respectively). For the statistical analysis similar data point rate was used for the two states.


```{r warning=FALSE, fig.width=10, fig.height=10, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    stim == T,
    frame %% 15 == 0
  ) %>%
  ggplot(
    mapping = aes(x = X_interp / scale, y = Y_interp / scale, label = frame)
  ) +

  ### drawing positions during no stimulus
  ### "coords" was filtered differently compared to the stimulus dataset (number of frames)
  geom_point(
    data = coords %>%
      dplyr::filter(
        animal == selected_animal,
        body_part == "center",
        stim == F,
        frame %% 5 == 0
      ),
    size = 1,
    alpha = 0.1
  ) +

  ### drawing positions during stimulus
  ### body parts are connected by lines
  geom_line(
    aes(group = frame, col = as.character(stim_number)),
  ) +
  geom_point(
    aes(shape = body_part, col = as.character(stim_number)),
    size = 2
  ) +
  xlim(c(0, 1280 / scale)) +
  ylim(c(0, 720 / scale)) +
  facet_wrap(~session, ncol = 2, ) +
  geom_label(data = text_layer, aes(x = Inf, y = -Inf, hjust = 1.1, vjust = -0.5, label = paste0("Intensity: ", int_label))) +
  labs(col = "Stimulus number", shape = "Body part") +
  xlab("X position [mm]") +
  ylab("Y position [mm]") +
  global_facet_theme
```


## Plotting speed in a 1 sec (`r fps` frames) window

Speed of the animal in 1 sec windows. Darker colors represent slower speed. 

```{r message=FALSE, fig.width=10, fig.height=10, echo = FALSE, warning=FALSE}
coords %>%
  dplyr::filter(animal == selected_animal, body_part == "center") %>%
  group_by(session, sec_counter) %>%
  mutate(d_sec = sum(d_mm, na.rm = T)) %>%
  ggplot(
    mapping = aes(x = X_interp, y = Y_interp, label = frame)
  ) +
  geom_point(aes(color = d_sec %>% scale(), alpha = stim)) +
  xlim(c(0, 1280)) +
  ylim(c(0, 720)) +
  facet_wrap(~session, ncol = 2) +
  geom_label(data = text_layer, aes(x = Inf, y = -Inf, hjust = 1.1, vjust = -0.5, label = paste0("Intensity: ", int_label))) +
  global_facet_theme
```



## Distribution of the distance between points

Cumulative distribution functions and histograms of the difference between consecutive X and Y coordinates and calculated traveled distances across frames. Most of the values are realistic but there are some big jumps probably due to errors in the tracking. The unrealistically big jumps were excluded from the analysis (when "coords" data frame was created).

```{r, message=F, warning=F,  fig.width=10,fig.height=25, message=FALSE, echo = FALSE}
coords %>%
  # dplyr::filter(X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20) %>%
  ggplot(mapping = aes(x = X_diff)) +
  stat_ecdf(
    aes(
      col = session %>% as.factor()
    ),
    geom = "point"
  ) +
  # geom_histogram(aes(fill = session)) +
  facet_grid(~animal ~ body_part) +
  global_facet_theme
# scale_y_continuous(trans='log10')
```

```{r message=FALSE}
coords %>%
  group_by(animal, body_part) %>%
  summarise(min = min(X_diff, na.rm = T), max = max(X_diff, na.rm = T)) %>%
  DT::datatable()
```


```{r message=F, warning=F, fig.width=10, fig.height=25, echo = FALSE}
coords %>%
  # dplyr::filter(X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20) %>%
  ggplot(mapping = aes(x = X_diff)) +
  # geom_boxplot() +
  geom_histogram(
    aes(
      fill = session %>% as.factor()
    ),
    binwidth = 5
  ) +
  facet_grid(animal ~ body_part, scales = "free") +
  scale_y_continuous(trans = "log10") +
  global_facet_theme
```

```{r message=FALSE}
coords %>%
  group_by(animal, body_part) %>%
  summarise(min = min(Y_diff, na.rm = T), max = max(Y_diff, na.rm = T)) %>%
  DT::datatable()
```

Distribution of distance

```{r message=F, warning=F, fig.width=10, fig.height=25, echo = FALSE}
coords %>%
  # dplyr::filter(X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20) %>%
  ggplot(mapping = aes(x = d_mm)) +
  geom_histogram(aes(fill = session %>% as.factor()), binwidth = 5) +
  facet_grid(animal ~ body_part, scales = "free") +
  global_facet_theme +
  scale_y_continuous(trans = "log10")
```


## Recalculating distances between tracked points after leaving out frames

```{r fig.width=10, fig.asp=1, echo = FALSE}

plt_xlim <- coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    # frame %% datapoint_to_plot == 0
  ) %>%
  dplyr::slice(1:11) %>%
  pull(X_interp) %>%
  range() + c(-1, 1)

plt_ylim <- coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    # frame %% datapoint_to_plot == 0
  ) %>%
  dplyr::slice(1:11) %>%
  pull(Y_interp) %>%
  range() + c(-1, 1)


plt1_path <- coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    # frame %% datapoint_to_plot == 0
  ) %>%
  dplyr::slice(1:11) %>%
  dplyr::arrange(frame) %>% ### to be used with geom_path
  ggplot(
    mapping = aes(x = X_interp, y = Y_interp)
  ) +
  geom_text(
    aes(
      color = frame %>% as.factor(),
      label = frame
    ),
    size = 6
  ) +
  geom_segment(
    aes(
      x = X_interp[1], xend = X_interp[2],
      y = Y_interp[1], yend = Y_interp[1]
    ),
    linetype = "dashed", col = "red"
  ) +
  geom_segment(
    aes(
      x = X_interp[2], xend = X_interp[2],
      y = Y_interp[1], yend = Y_interp[2]
    ),
    linetype = "dashed", col = "red"
  ) +
  geom_path(col = "gray", linetype = "dashed") +
  geom_label_repel(
    data = . %>% dplyr::slice(1:10),
    aes(
      x = X_interp + X_diff / 2,
      y = Y_interp + Y_diff / 2,
      label = d %>% round(4)
    ),
    direction = "x",
    nudge_x = -.7
  ) +
  theme(legend.position = "none") +
  xlim(plt_xlim) +
  ylim(plt_ylim) +
  coord_fixed(ratio = 1)


plt2_path <- coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    frame %% datapoint_to_plot == 0
  ) %>%
  # recalculates distances after frames were removed
  dplyr::group_by(session) %>%
  dplyr::mutate(
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000
  ) %>%
  ungroup() %>%
  dplyr::slice(1:3) %>%
  dplyr::arrange(frame) %>% ### to be used with geom_path
  ggplot(
    mapping = aes(x = X_interp, y = Y_interp)
  ) +
  geom_text(
    aes(
      color = frame %>% as.factor(),
      label = frame
    ),
    size = 6
  ) +
  geom_segment(
    aes(
      x = X_interp[1], xend = X_interp[2],
      y = Y_interp[1], yend = Y_interp[1]
    ),
    linetype = "dashed", col = "red"
  ) +
  geom_segment(
    aes(
      x = X_interp[2], xend = X_interp[2],
      y = Y_interp[1], yend = Y_interp[2]
    ),
    linetype = "dashed", col = "red"
  ) +
  geom_path(col = "gray", linetype = "dashed") +
  geom_label_repel(
    data = . %>% dplyr::slice(1:2),
    aes(
      x = X_interp + X_diff / 2,
      y = Y_interp + Y_diff / 2,
      label = d %>% round(4)
    ),
    direction = "x",
    nudge_x = -.7
  ) +
  theme(legend.position = "none") +
  xlim(plt_xlim) +
  ylim(plt_ylim) +
  coord_fixed(ratio = 1)

library(cowplot)

cowplot::plot_grid(plt1_path, plt2_path, ncol = 2)
```



## Instantaneous traveled distance

Plotting the traveled distance based on one of the three tracked body parts during stimulus and non-stimulus periods at the rate of 6 data point/sec.

### Center

```{r fig.width=10, fig.height=10, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    frame %% datapoint_to_plot == 0
  ) %>%
  
  ### recalculates distances after frames were removed
  dplyr::group_by(session) %>%
  dplyr::mutate(
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000
  ) %>%
  
  # dplyr::filter(X_diff < 125, X_diff > -125, Y_diff < 125, Y_diff > -125) %>%
  
  ### plotting
  ggplot(mapping = aes(x = rec_time, y = d_mm)) +
  geom_line(aes(color = stim, group = 1)) +
  # geom_line(aes(x = rec_time, y = Y_diff -130), alpha = .5) +
  # geom_line(aes(x = rec_time, y = X_diff + 130), alpha = .5) +
  facet_wrap(~session, scales = "free", ncol = 1) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label))) +
  ggtitle(paste0(selected_animal, " instantaneous traveled distance ", "(center)")) +
  global_facet_theme
```

### Head

```{r fig.width=10, fig.height=10, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "head",
    frame %% datapoint_to_plot == 0
  ) %>%
  
  ### recalculates distances after frames were removed
  dplyr::group_by(session) %>%
  dplyr::mutate(
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000
  ) %>%
  
  # dplyr::filter(X_diff < 125, X_diff > -125, Y_diff < 125, Y_diff > -125) %>%
  
  ### plotting
  ggplot(mapping = aes(x = rec_time, y = d_mm)) +
  geom_line(aes(color = stim, group = 1)) +
  # geom_line(aes(x = rec_time, y = Y_diff -130), alpha = .5) +
  # geom_line(aes(x = rec_time, y = X_diff + 130), alpha = .5) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label))) +
  facet_wrap(~session, scales = "free", ncol = 1) +
  ggtitle(paste0(selected_animal, " instantaneous traveled distance ", "(head)")) +
  global_facet_theme
```

### Tail

```{r fig.width=10, fig.height=10, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "tail",
    frame %% datapoint_to_plot == 0
  ) %>%
  
  ### recalculates distances after frames were removed
  dplyr::group_by(session) %>%
  dplyr::mutate(
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000
  ) %>%
  
  # dplyr::filter(X_diff < 125, X_diff > -125, Y_diff < 125, Y_diff > -125) %>%
  
  ### plotting
  ggplot(mapping = aes(x = rec_time, y = d_mm)) +
  geom_line(aes(color = stim, group = 1)) +
  # geom_line(aes(x = rec_time, y = Y_diff -130), alpha = .5) +
  # geom_line(aes(x = rec_time, y = X_diff + 130), alpha = .5) +
  facet_wrap(~session, scales = "free", ncol = 1) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label))) +
  ggtitle(paste0(selected_animal, " instantaneous traveled distance ", "(tail)")) +
  global_facet_theme
```



## Rolling mean of traveled distance

Plotting the mean traveled distance calculated in a rolling window (1 sec). The mean was calculated separately during stimulus (rolling window restarts with the beginning of stimuli). Colors represent different periods of the recording (no-stimulus, before stimulus, during stimulus, after stimulus). 


Defining line colors

```{r}
line_cols <- gg_color_hue(3)

group_colors <- c("no stim" = "gray30", "before stim" = line_cols[1], "stim" = line_cols[3], "after stim" = line_cols[2])
group_colors2 <- c("no stim" = "gray30", "right before" = line_cols[1], "stim" = line_cols[3], "right after" = line_cols[2])
```


### Example session

```{r message=F, fig.width=12, warning=F, echo = FALSE}

coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    session == "session_2",
    # X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20,
    frame %% datapoint_to_plot == 0
  ) %>%
  
  ### recalculates distances after frames were removed
  dplyr::group_by(animal, session, body_part) %>%
  dplyr::mutate(
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000
  ) %>%
  ungroup() %>%
  
  dplyr::filter(X_diff < 80, X_diff > -80, Y_diff < 80, Y_diff > -80) %>%
  dplyr::group_by(stim) %>%
  dplyr::mutate(mean_mps_roll = zoo::rollmean(x = d_mm, k = fps, fill = NA)) %>%
  
  ### plotting
  ggplot(aes(x = rec_time, y = d_mm)) +
  # ylim(c(0, 100)) +
  geom_point(aes(alpha = stim)) +
  geom_line(aes(x = rec_time, y = mean_mps_roll, col = stim_categ, group = 1), size = 1) +
  ggtitle(paste0(selected_animal, " mean traveled distance by stimulus period ", "(center)")) +
  scale_color_manual(values = group_colors)
```

### Center

```{r fig.width=12, fig.height=12, warning=FALSE, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    frame %% datapoint_to_plot == 0
  ) %>%
  
  ### recalculates distances after frames were removed
  dplyr::group_by(animal, session, body_part) %>%
  dplyr::mutate(
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000
  ) %>%
  ungroup() %>%
  
  dplyr::filter(X_diff < 80, X_diff > -80, Y_diff < 80, Y_diff > -80) %>%
  dplyr::group_by(session, stim) %>%
  dplyr::mutate(mean_mps_roll = zoo::rollmean(x = d_mm, k = fps, fill = NA)) %>%
  
  ### plotting
  ggplot(aes(x = rec_time, y = d_mm)) +
  # ylim(c(0, 100)) +
  geom_point(aes(alpha = stim)) +
  geom_line(aes(x = rec_time, y = mean_mps_roll, col = stim_categ, group = 1), size = 1) +
  facet_wrap(~session, scales = "free", ncol = 1) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label))) +
  ggtitle(paste0(selected_animal, " mean traveled distance by stimulus period ", "(center)")) +
  scale_color_manual(values = group_colors) +
  global_facet_theme
```


### Head


```{r fig.width=12, fig.height=12, warning=F, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "head",
    X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20,
    frame %% datapoint_to_plot == 0
  ) %>%
  
  ### recalculates distances after frames were removed
  dplyr::group_by(animal, session, body_part) %>%
  dplyr::mutate(
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000
  ) %>%
  ungroup() %>%
  
  dplyr::filter(X_diff < 80, X_diff > -80, Y_diff < 80, Y_diff > -80) %>%
  dplyr::group_by(session, stim) %>%
  dplyr::mutate(mean_mps_roll = zoo::rollmean(x = d_mm, k = fps, fill = NA)) %>%
  
  ### plotting
  ggplot(aes(x = rec_time, y = d_mm)) +
  # ylim(c(0, 100)) +
  geom_point(aes(alpha = stim)) +
  geom_line(aes(x = rec_time, y = mean_mps_roll, col = stim_categ, group = 1), size = 1) +
  facet_wrap(~session, scales = "free", ncol = 1) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label))) +
  ggtitle(paste0(selected_animal, " mean traveled distance by stimulus period ", "(head)")) +
  scale_color_manual(values = group_colors) +
  global_facet_theme
```



### Tail


```{r fig.width=12, fig.height=12, warning=FALSE, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "tail",
    frame %% datapoint_to_plot == 0
  ) %>%
  
  ### recalculates distances after frames were removed
  dplyr::group_by(animal, session, body_part) %>%
  dplyr::mutate(
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000
  ) %>%
  ungroup() %>%
  
  dplyr::filter(X_diff < 80, X_diff > -80, Y_diff < 80, Y_diff > -80) %>%
  dplyr::group_by(session, stim) %>%
  dplyr::mutate(mean_mps_roll = zoo::rollmean(x = d_mm, k = fps, fill = NA)) %>%
  
  ### plotting
  ggplot(aes(x = rec_time, y = d_mm)) +
  # ylim(c(0, 100)) +
  geom_point(aes(alpha = stim)) +
  geom_line(aes(x = rec_time, y = mean_mps_roll, col = stim_categ, group = 1), size = 1) +
  facet_wrap(~session, scales = "free", ncol = 1) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label))) +
  ggtitle(paste0(selected_animal, " mean traveled distance by stimulus period ", "(tail)")) +
  scale_color_manual(values = group_colors) +
  global_facet_theme
```



```{r fig.width=10, fig.height=10, include=FALSE, echo=FALSE, eval=FALSE}
coords %>%
  dplyr::select(animal, session, frame, rec_time, stim_categ, body_part, d_mm, X_diff, Y_diff, stim_number) %>%
  mutate(stim_number = replace(stim_number, stim_number == "no stim", NA)) %>%
  dplyr::filter(
    animal == "GIIFM22b",
    body_part == "center",
    X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20,
    stim_categ != "no stim"
  ) %>%
  group_by(session, stim_categ) %>%
  mutate(categ_timer = (row_number() / fps) %>% round(digits = 2)) %>%
  ungroup() %>%
  group_by(session) %>%
  mutate(stim_block_number = stim_number) %>%
  fill(stim_block_number, .direction = "down") %>%
  ggplot(aes(x = categ_timer, y = d_mm, group = stim_categ)) +
  geom_line(aes(col = stim_categ)) +
  facet_wrap(~session, ncol = 1, scales = "free") +
  global_facet_theme
```



## Mean traveled distance by individual stimuli within session (full length before and after the stimulus)

Plotting traveled distance during individual stimuli (4 to 6 repeats) within session. Traveled distance is averaged through the full duration of the stimulus (~10s) and `r around_stim_length / fps`s "before stimulus" and "after stimulus" duration. <br>

The same data is shown on the plots with different groupings: <br>

+ intensities are grouped together (colors), stimulus numbers are separated (panels) <br>
+ stimulus numbers are grouped together (colors), intensities are separated (panels) <br>


```{r message=F, fig.width=12, fig.height=8, warning=F, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    stim_categ != "no stim",
    intensity %in% selected_intensities,
    # session == "4",
    frame %% datapoint_to_plot == 0
  ) %>%
  dplyr::group_by(animal, session, body_part) %>%
  dplyr::mutate(
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000
  ) %>%
  ungroup() %>%
  dplyr::filter(X_diff < 80, X_diff > -80, Y_diff < 80, Y_diff > -80) %>%
  dplyr::group_by(stim) %>%
  dplyr::group_by(animal, intensity, stim_number, stim_categ) %>%
  dplyr::summarise(mean_d_mm = mean(d_mm, na.rm = T)) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      y = mean_d_mm
    )
  ) +
  geom_point(aes(fill = as.factor(intensity)), shape = 21, size = 4) +
  facet_wrap(~stim_number) +
  geom_line(aes(group = intensity)) +
  ggtitle(paste0(selected_animal, " mean traveled distance by individual stimuli within session ", "(center)")) +
  labs(
    fill = "Intensity",
    x = "Stimulus period",
    y = "Mean traveled distance"
  ) +
  global_facet_theme
```

```{r message=F, fig.width=12, fig.height=4, warning=F, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    stim_categ != "no stim",
    intensity %in% selected_intensities,
    # session == "4",
    X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20,
    frame %% datapoint_to_plot == 0
  ) %>%
  dplyr::group_by(animal, intensity, stim_number, stim_categ) %>%
  dplyr::summarise(mean_d_mm = mean(d_mm, na.rm = T)) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      y = mean_d_mm
    )
  ) +
  geom_point(aes(fill = stim_number), shape = 21, size = 4) +
  facet_wrap(~intensity) +
  geom_line(aes(group = stim_number)) +
  ggtitle(paste0(selected_animal, " mean traveled distance by individual stimuli within session ", "(center)")) +
  labs(
    fill = "Stimulus number",
    x = "Stimulus period",
    y = "Mean traveled distance"
  ) +
  global_facet_theme
```



## Mean traveled distance by individual stimuli within session (1s before and after the stimulus)


Plotting traveled distance during individual stimuli (5 or 6 repeats) within session. Traveled distance is averaged through the full duration of the stimulus (~8s) but only 1s "before stimulus" and 1s "after stimulus" duration. <br>


The same data is shown on the plots with different groupings: <br>

+ intensities are grouped together (colors), stimulus numbers are separated (panels) <br>
+ stimulus numbers are grouped together (colors), intensities are separated (panels) <br>


```{r message=F, fig.width=12, fig.height=8, warning=F, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    stim_categ2 != "no stim",
    intensity2 %in% selected_intensities,
    frame %% datapoint_to_plot == 0
  ) %>%
  dplyr::group_by(animal, intensity2, stim_number2, stim_categ2) %>%
  dplyr::summarise(mean_d_mm = mean(d_mm, na.rm = T)) %>%
  # dplyr::summarise(mean_mps_roll = zoo::rollmean(x = d_mm, k = fps, fill = NA))

  # dplyr::summarise(mean_d_mm = mean(d_mm, na.rm = T)) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ2, "right before", "stim", "right after"),
      y = mean_d_mm
    )
  ) +
  geom_point(aes(fill = as.factor(intensity2)), shape = 21, size = 4) +
  facet_wrap(~stim_number2) +
  geom_line(aes(group = intensity2)) +
  ggtitle(paste0(selected_animal, " mean traveled distance by individual stimuli within session ", "(center)")) +
  labs(
    fill = "Intensity",
    x = "Stimulus period",
    y = "Mean traveled distance"
  ) +
  global_facet_theme
```



```{r message=F, fig.width=12, fig.height=4, warning=F, echo = FALSE, out.width="100%"}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    stim_categ2 != "no stim",
    intensity2 %in% selected_intensities,
    frame %% datapoint_to_plot == 0
  ) %>%
  dplyr::group_by(animal, intensity2, stim_number2, stim_categ2) %>%
  dplyr::summarise(mean_d_mm = mean(d_mm, na.rm = T)) %>%
  # dplyr::summarise(mean_mps_roll = zoo::rollmean(x = d_mm, k = fps, fill = NA))

  # dplyr::summarise(mean_d_mm = mean(d_mm, na.rm = T)) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ2, "right before", "stim", "right after"),
      y = mean_d_mm
    )
  ) +
  geom_point(aes(fill = stim_number2 %>% as.factor()), shape = 21, size = 4) +
  facet_wrap(~intensity2) +
  geom_line(aes(group = stim_number2)) +
  ggtitle(paste0(selected_animal, " mean traveled distance by individual stimuli within session ", "(center)")) +
  labs(
    fill = "Stimulus number",
    x = "Stimulus period",
    y = "Mean traveled distance"
  ) +
  global_facet_theme
```



## Calculating angles

### Toy data

```{r}
vectors <- tibble(
  body = c("cent", "h", "cent", "h", "cent", "h", "cent", "h"),
  frame = c(0, 0, 1, 1, 2, 2, 3, 3),
  X = c(750, 760, 770, 770, 755, 765, 755, 765),
  Y = c(500, 500, 500, 520, 510, 520, 510, 500)
)
vectors %>% arrange(body)
```


```{r}
ang <- function(a, b) {
  theta <- acos(sum(a * b) / (sqrt(sum(a * a)) * sqrt(sum(b * b))))
  return(theta * 180 / pi)
}

# ang(a = c(10, 0), b = c(10, 10))

vectors %>%
  group_by(frame) %>%
  summarise(dx = diff(X), dy = diff(Y)) %>%
  mutate(ldx = lead(dx), ldy = lead(dy)) %>%
  # rowwise() %>%
  mutate(angle = ang(a = c(dx, dy), b = c(ldx, ldy))) %>%
  ungroup() %>%
  mutate(
    signed_angle = (atan2(dx, dy) - atan2(ldx, ldy)) * 180 / (pi)
  )
```


```{r}
matlib::angle(
  x = vectors %>%
    group_by(frame) %>%
    summarise(dx = diff(X), dy = diff(Y)) %>%
    dplyr::filter(frame == "0") %>%
    select(-1) %>% as.matrix() %>% as.vector(),
  y = vectors %>%
    group_by(frame) %>%
    summarise(dx = diff(X), dy = diff(Y)) %>%
    dplyr::filter(frame == "2") %>%
    select(-1) %>% as.matrix() %>% as.vector()
)
```


The dot product of two vectors x and y can be defined as:

$$x \cdot y = ||x|| * ||y|| \cos(\theta)$$

```{r}
vectors %>%
  ggplot(mapping = aes(x = X, y = Y)) +
  geom_point(aes(shape = body)) +
  geom_line(aes(group = frame, color = frame %>% as.character())) +
  geom_text_repel(aes(label = paste0(X, ",", Y), col = as.character(frame))) +
  xlim(750, 775) +
  ylim(500, 525)
```

### Real data (coords tibble)


#### First 10 head - center vectors

```{r echo = FALSE ,message=FALSE, warning=FALSE}
coords %>%
  dplyr::filter(animal == selected_animal) %>%
  dplyr::group_by(body_part) %>%
  slice(1:10) %>%
  dplyr::filter(body_part != "tail") %>%
  ggplot(
    mapping = aes(x = X, y = Y)
  ) +
  geom_point(aes(shape = body_part), size = 2) +
  geom_line(aes(group = frame, color = as.character(frame))) +
  geom_text_repel(aes(label = paste0(X, ",", Y), col = as.character(frame))) +
  geom_segment(
    data = coords %>%
      dplyr::filter(animal == selected_animal) %>%
      dplyr::group_by(body_part) %>%
      slice(1:10) %>%
      dplyr::filter(body_part != "tail", frame == 0),
    aes(
      x = X[1], xend = X[2],
      y = Y[1], yend = Y[1]
    ), linetype = "dashed", col = "red"
  ) +
  geom_segment(
    data = coords %>%
      dplyr::filter(animal == selected_animal) %>%
      dplyr::group_by(body_part) %>%
      slice(1:10) %>%
      dplyr::filter(body_part != "tail", frame == 0),
    aes(
      x = X[2], xend = X[2],
      y = Y[1], yend = Y[2]
    ), linetype = "dashed", col = "red"
  )
```

```{r eval=FALSE}
coords %>%
  dplyr::filter(animal == "GIIFM19b") %>%
  dplyr::group_by(body_part) %>%
  slice(1:3) %>%
  dplyr::filter(body_part != "tail", frame == 0) %>%
  pull(X)
```



#### Distribution of angles

Because of the periodicity of tangent function unrealistic angles were introduced (jumps in data). Angles greater than 180 or smaller than -180 were subtracted from 360 and -360 respectively to get the correct angle.

In the control animals (34, 35, 36, 37) there are unrealistically large angles between frames probably due to tracking problem (switch of head and tail/center coordinate). Those angles are replaced by 0!

mutate(signed_angle_corrected = ifelse(signed_angle_corrected %>% abs() > ang_treshold, 0, signed_angle_corrected))


```{r message=FALSE, fig.width=10, fig.height=10, warning=FALSE, echo = FALSE}
coords %>%
  dplyr::filter(animal == selected_animal, body_part != "tail") %>%
  dplyr::filter(body_part != "tail") %>%
  dplyr::group_by(animal, session, frame) %>%
  summarise(
    vectx = diff(X_interp),
    vecty = diff(Y_interp)
  ) %>%
  mutate(
    leadx = lead(vectx),
    leady = lead(vecty)
  ) %>%
  # rowwise() %>%
  mutate(
    signed_angle = (atan2(leadx, leady) - atan2(vectx, vecty)) * 180 / (pi)
  ) %>%
  mutate(
    signed_angle_corrected = case_when(
      signed_angle >= 180 ~ 360 - signed_angle,
      signed_angle %>% abs() < 180 ~ signed_angle,
      signed_angle <= -180 ~ -360 - signed_angle,
      signed_angle > -180 | signed_angle < 0 ~ signed_angle
    )
  ) %>%
  ### removing unrealistically large angles
  mutate(signed_angle_corrected = ifelse(signed_angle_corrected %>% abs() > ang_threshold, 0, signed_angle_corrected)) %>%
  ggplot(aes(x = signed_angle_corrected)) +
  geom_histogram() +
  facet_wrap(~session, scales = "free") +
  global_facet_theme
```

#### Calculating signed angles 

```{r message=F, warning=F, echo = FALSE}

angles <- coords %>%
  dplyr::filter(
    animal == selected_animal,
    # frame %% datapoint_to_plot == 0, ### here it's good to have all the data points to calculate the cumulative angles
    body_part != "tail"
  ) %>%
  dplyr::group_by(session, frame) %>%
  mutate(
    vectx = diff(X_interp),
    vecty = diff(Y_interp)
  ) %>%
  dplyr::group_by(session) %>%
  mutate(
    leadx = lead(vectx),
    leady = lead(vecty)
  ) %>%
  mutate(
    signed_angle = (atan2(leadx, leady) - atan2(vectx, vecty)) * 180 / (pi)
  )

corrected_angles <- coords %>%
  dplyr::filter(
    animal == selected_animal,
    # frame %% datapoint_to_plot == 0, ### here it's good to have all the data points to calculate the cumulative angles
    body_part != "tail"
  ) %>%
  dplyr::group_by(session, frame) %>%
  mutate(
    vectx = diff(X_interp),
    vecty = diff(Y_interp)
  ) %>%
  dplyr::group_by(session) %>%
  mutate(
    leadx = lead(vectx),
    leady = lead(vecty)
  ) %>%
  mutate(
    signed_angle = (atan2(leadx, leady) - atan2(vectx, vecty)) * 180 / (pi)
  ) %>%
  mutate(
    signed_angle_corrected = case_when(
      signed_angle >= 180 ~ 360 - signed_angle,
      signed_angle %>% abs() < 180 ~ signed_angle,
      signed_angle <= -180 ~ -360 - signed_angle,
      signed_angle > -180 | signed_angle < 0 ~ signed_angle
    )
  ) %>%
  ### removing unrealistically large angles
  mutate(signed_angle_corrected = ifelse(signed_angle_corrected %>% abs() > ang_threshold, 0, signed_angle_corrected))
```



```{r message=F, fig.width=10, fig.height=10, warning=FALSE}
corrected_angles %>%
  ggplot(aes(x = rec_time, y = signed_angle_corrected)) +
  geom_line(aes(col = stim, group = 1)) +
  facet_wrap(~session, scales = "free_x", ncol = 1) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label))) +
  ggtitle(paste0(selected_animal, " raw angles by stimulus period ")) +
  global_facet_theme
```


```{r include=FALSE}
coords %>%
  dplyr::filter(animal == selected_animal, session == "0", body_part != "tail") %>%
  dplyr::group_by(body_part) %>%
  dplyr::slice(1:50) %>%
  ungroup() %>%
  dplyr::group_by(frame) %>%
  summarise(
    vectx = diff(X_interp),
    vecty = diff(Y_interp)
  ) %>%
  mutate(
    leadx = lead(vectx),
    leady = lead(vecty)
  ) %>%
  # rowwise() %>%
  mutate(
    signed_angle = (atan2(leadx, leady) - atan2(vectx, vecty)) * 180 / (pi)
  ) %>%
  mutate(
    signed_angle_corrected = case_when(
      signed_angle >= 180 ~ 360 - signed_angle,
      signed_angle %>% abs() < 180 ~ signed_angle,
      signed_angle <= -180 ~ -360 - signed_angle,
      signed_angle > -180 | signed_angle < 0 ~ signed_angle
    )
  ) %>%
  ### removing unrealistically large angles
  mutate(signed_angle_corrected = ifelse(signed_angle_corrected %>% abs() > ang_threshold, 0, signed_angle_corrected))
```


#### Plotting cumulative angles


Cumulative signed rotation angles during the sessions. 

```{r message=FALSE,fig.width=10, fig.height=10}
corrected_angles %>%
  group_by(session) %>%
  dplyr::filter(body_part == "center") %>%
  mutate(csum = cumsum(ifelse(is.na(signed_angle_corrected), 0, signed_angle_corrected)) %>% round(4)) %>%
  # dplyr::filter(session == "video2coords") %>%
  # group_by(session) %>%
  # gather(key = "stim_categ" , value = "stim_value", stim, before_stim) %>%
  ggplot(
    mapping = aes(x = rec_time, y = csum %>% scale())
  ) +
  geom_line(aes(col = stim, group = 1)) +
  facet_wrap(~session, scales = "free_x", ncol = 1) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label))) +
  ggtitle(paste0(selected_animal, " cumulative angles by stimulus period ")) +
  global_facet_theme
```




```{r message=FALSE,fig.width=10, fig.height=10}

# !!!!! Observe the difference between "GIIFM22b" and "GIIFM14b". GIIFM14b is not working properly!!!!!!

corrected_angles %>%
  dplyr::filter(body_part == "center") %>%
  group_by(session) %>%
  mutate(csum = cumsum(ifelse(is.na(signed_angle_corrected), 0, signed_angle_corrected)) %>% round(4)) %>%
  ggplot(
    mapping = aes(x = rec_time, y = csum %>% scale())
  ) +
  geom_line(aes(col = stim_categ, group = 1)) +
  facet_wrap(~session, scales = "free_x", ncol = 1) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label))) +
  scale_color_manual(values = group_colors) +
  global_facet_theme
```


# Population analysis

## Rotation

### Calculating signed population angles

```{r message=FALSE, warning=FALSE, echo = FALSE}
corrected_angles_population <- coords %>%
  dplyr::filter(
    str_detect(string = animal, pattern = "b"),
    animal != "GIIFM14b",
    body_part != "tail"
  ) %>%
  dplyr::group_by(animal, session, frame) %>%
  mutate(
    vectx = diff(X_interp),
    vecty = diff(Y_interp),
  ) %>%
  group_by(animal, session) %>%
  mutate(
    leadx = lead(vectx),
    leady = lead(vecty)
  ) %>%
  mutate(
    signed_angle = (atan2(leadx, leady) - atan2(vectx, vecty)) * 180 / (pi)
  ) %>%
  mutate(
    signed_angle_corrected = case_when(
      signed_angle >= 180 ~ 360 - signed_angle,
      signed_angle %>% abs() < 180 ~ signed_angle,
      signed_angle <= -180 ~ -360 - signed_angle,
      signed_angle > -180 | signed_angle < 0 ~ signed_angle
    )
  ) %>%
  ### removing unrealistically large angles
  mutate(signed_angle_corrected = ifelse(signed_angle_corrected %>% abs() > ang_threshold, 0, signed_angle_corrected))
```



```{r message=FALSE,fig.width=17, fig.height=15, out.width="100%"}
corrected_angles_population %>%
  dplyr::filter(body_part == "head") %>%
  group_by(animal, session) %>%
  mutate(csum = cumsum(ifelse(is.na(signed_angle_corrected), 0, signed_angle_corrected)) %>% round(4)) %>%
  fill(intensity, .direction = "downup") %>%
  ggplot(
    mapping = aes(x = rec_time, y = csum %>% scale())
  ) +
  geom_line(aes(col = stim_categ, group = 1)) +
  # geom_text(
  #   data = coords$intensity %>% unique(),
  #   aes(label=intensity), check_overlap = T) +
  facet_grid(animal ~ session) + # factor(intensity, levels = gtools::mixedsort(intensity %>% unique())), scales = "free") +
  scale_color_manual(values = group_colors) +
  global_facet_theme +
  theme(
    axis.text.x = element_text(angle = 45),
  )

# forcats::fct_relevel(intensity, intensity %>% unique() %>% sort() %>% c())
# %>% factor(levels = gtools::mixedsort(intensity))
```


Mean rotation angle by session


```{r message=FALSE, fig.height=8, fig.width=10, echo = FALSE}

sem <- function(x) sd(x) / sqrt(length(x)) # Create own function

corrected_angles_population %>%
  dplyr::filter(
    animal %!in% c(control_animals, "GIIFM14b"),
    body_part == "head",
    stim_categ != "no stim"
    # str_detect(string = session, pattern = "1|2|3|4|5"), # session filter
  ) %>%
  dplyr::group_by(animal, session, stim_categ) %>%
  dplyr::summarise(
    sum_ang = sum(signed_angle_corrected, na.rm = T),
    mean_ang = mean(signed_angle_corrected, na.rm = T),
    med_ang = median(signed_angle_corrected, na.rm = T),
    sd_ang = sd(signed_angle_corrected, na.rm = T),
    sem_ang = sem(signed_angle_corrected)
  ) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      y = sum_ang # %>% scale()
    )
  ) +
  geom_point(aes(fill = animal), shape = 21, size = 4) +
  geom_line(aes(group = animal)) +
  facet_wrap(~session) +
  global_facet_theme +
  xlab("State") +
  ylab("Scaled sum angle")
```



Mean/sum rotation angle by session (control)


```{r message=FALSE, fig.height=8, fig.width=10, echo = FALSE}

sem <- function(x) sd(x) / sqrt(length(x)) # Create own function

corrected_angles_population %>%
  dplyr::filter(
    animal %in% control_animals,
    body_part == "head",
    stim_categ != "no stim"
    # str_detect(string = session, pattern = "1|2|3|4|5"), # session filter
  ) %>%
  dplyr::group_by(animal, session, stim_categ) %>%
  dplyr::summarise(
    sum_ang = sum(signed_angle_corrected, na.rm = T),
    mean_ang = mean(signed_angle_corrected, na.rm = T),
    med_ang = median(signed_angle_corrected, na.rm = T),
    sd_ang = sd(signed_angle_corrected, na.rm = T),
    sem_ang = sem(signed_angle_corrected)
  ) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      y = sum_ang # %>% scale()
    )
  ) +
  geom_point(aes(fill = animal), shape = 21, size = 4) +
  geom_line(aes(group = animal)) +
  facet_wrap(~session) +
  global_facet_theme +
  xlab("State") +
  ylab("Scaled sum angle")
```


Mean/sum rotation angle by intensity (stimulus and control)


```{r message=FALSE, fig.height=12, fig.width=15, echo = FALSE}
plt1_angle <- corrected_angles_population %>%
  dplyr::filter(
    animal %!in% c(control_animals, "GIIFM14b", "GIIFM17b"),
    body_part == "head",
    stim_categ != "no stim",
    # stim_side == "right"
  ) %>%
  dplyr::filter(intensity %in% selected_intensities) %>%
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::summarise(
    sum_ang = sum(signed_angle_corrected, na.rm = T),
    mean_ang = mean(signed_angle_corrected, na.rm = T),
    med_ang = median(signed_angle_corrected, na.rm = T),
    sd_ang = sd(signed_angle_corrected, na.rm = T),
    sem_ang = sem(signed_angle_corrected)
  ) %>%
  # dplyr::filter(intensity %in% c(1, 5, 10, 15)) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      y = sum_ang # %>% scale()
    )
  ) +
  geom_point(aes(fill = animal), shape = 21, size = 4) +
  geom_line(aes(group = animal)) +
  facet_wrap(~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique())), nrow = 3) +
  global_facet_theme +
  # ylim(-3.5, 2.5) +
  xlab("State") +
  ylab("Scaled sum angle") +
  ggtitle("Stimulus")

# facet_grid(~animal, ~intensity)
# geom_errorbar(aes(ymin = mean_ang - sem_ang, ymax = mean_ang + sem_ang, col = animal), width=.1)


plt2_angle <- corrected_angles_population %>%
  dplyr::filter(
    animal %in% control_animals,
    body_part == "head",
    stim_categ != "no stim",
    # stim_side == "right"
  ) %>%
  dplyr::filter(intensity %in% selected_intensities) %>%
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::summarise(
    sum_ang = sum(signed_angle_corrected, na.rm = T),
    mean_ang = mean(signed_angle_corrected, na.rm = T),
    med_ang = median(signed_angle_corrected, na.rm = T),
    sd_ang = sd(signed_angle_corrected, na.rm = T),
    sem_ang = sem(signed_angle_corrected)
  ) %>%
  # dplyr::filter(intensity %in% c(1, 5, 10, 15)) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      y = sum_ang # %>% scale()
    )
  ) +
  geom_point(aes(fill = animal), shape = 21, size = 4) +
  geom_line(aes(group = animal)) +
  facet_wrap(~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique())), nrow = 3, ) +
  global_facet_theme +
  # ylim(-3.5, 2.5) +
  xlab("State") +
  ylab("Scaled sum angle") +
  ggtitle("Control")


# facet_grid(~animal, ~intensity)
# geom_errorbar(aes(ymin = mean_ang - sem_ang, ymax = mean_ang + sem_ang, col = animal), width=.1)


cowplot::plot_grid(plt1_angle, plt2_angle, ncol = 2)
```

```{r message=FALSE, fig.height=8, fig.width=10, echo = FALSE}
corrected_angles_population %>%
  dplyr::filter(
    animal %!in% c(control_animals, "GIIFM14b"),
    body_part == "head",
    stim_categ != "no stim"
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ, stim_number) %>%
  dplyr::summarise(
    sum_ang = sum(signed_angle_corrected, na.rm = T),
    mean_ang = mean(signed_angle_corrected, na.rm = T),
    med_ang = median(signed_angle_corrected, na.rm = T),
    sd_ang = sd(signed_angle_corrected, na.rm = T),
    sem_ang = sem(signed_angle_corrected)
  ) %>%
  dplyr::filter(
    intensity %in% selected_intensities
  ) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      y = sum_ang
    )
  ) +
  geom_boxplot(aes(color = intensity %>% as.factor())) +
  geom_point(aes(color = intensity %>% as.factor()), position = position_jitterdodge(dodge.width = 0.7)) +
  # geom_point(aes(fill = intensity %>% as.factor()), shape = 21, size = 4) +
  # geom_line(aes(group = intensity %>% as.factor())) +
  facet_wrap(~animal) +
  global_facet_theme +
  xlab("State") +
  ylab("Scaled sum angle")


# facet_grid(~animal, ~intensity)
# geom_errorbar(aes(ymin = mean_ang - sem_ang, ymax = mean_ang + sem_ang, col = animal), width=.1)
```


Mean rotation angle before stimulus vs during stimulus

```{r message=FALSE, warning=FALSE, fig.width=17, fig.height=15, out.width="100%", echo = FALSE}

plt_ang_stim <- corrected_angles_population %>%
  dplyr::filter(
    animal %!in% c(control_animals, "GIIFM14b"),
    body_part == "head",
    stim_categ != "no stim",
    intensity %in% c(selected_intensities, "15 mW")
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ, stim_number) %>%
  dplyr::summarise(
    sum_ang = sum(signed_angle_corrected, na.rm = T),
    # mean_ang = mean(signed_angle_corrected, na.rm = T),
    # med_ang = median(signed_angle_corrected, na.rm = T),
    # sd_ang = sd(signed_angle_corrected, na.rm = T),
    # sem_ang = sem(signed_angle_corrected)
  ) %>%
  tidyr::spread(
    key = stim_categ, value = sum_ang
  ) %>%
  ggplot(
    mapping = aes(x = `before stim`, y = stim)
  ) +
  xlim(-1200, 1200) +
  ylim(-1200, 1200) +
  coord_fixed() +
  # geom_vline(xintercept = 5, alpha = .3) +
  # geom_hline(yintercept = 5, alpha = .3) +
  # geom_rect(xmin = 0, xmax = 5, ymin = 5, ymax = 10, fill = "green", alpha = 0.03) +
  # geom_rect(xmin = 5, xmax = 10, ymin = 0, ymax = 5, fill = "red", alpha = 0.03) +

  # geom_abline(slope = 1, intercept = 0, alpha = .3, lty = "dashed") +
  geom_vline(xintercept = 0, alpha = .3) +
  geom_hline(yintercept = 0, alpha = .3) +
  geom_point(size = 3) +
  # facet_wrap(~animal) +
  facet_grid(animal ~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))) +
  global_facet_theme +
  theme(
    axis.text.x = element_text(angle = 45)
  )

plt_ang_ctrl <- corrected_angles_population %>%
  dplyr::filter(
    animal %in% c(control_animals, "GIIFM14b"),
    body_part == "head",
    stim_categ != "no stim",
    intensity %in% c(selected_intensities, "15 mW")
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ, stim_number) %>%
  dplyr::summarise(
    sum_ang = sum(signed_angle_corrected, na.rm = T),
    # mean_ang = mean(signed_angle_corrected, na.rm = T),
    # med_ang = median(signed_angle_corrected, na.rm = T),
    # sd_ang = sd(signed_angle_corrected, na.rm = T),
    # sem_ang = sem(signed_angle_corrected)
  ) %>%
  tidyr::spread(
    key = stim_categ, value = sum_ang
  ) %>%
  ggplot(
    mapping = aes(x = `before stim`, y = stim)
  ) +
  xlim(-1200, 1200) +
  ylim(-1200, 1200) +
  coord_fixed() +
  # geom_vline(xintercept = 5, alpha = .3) +
  # geom_hline(yintercept = 5, alpha = .3) +
  # geom_rect(xmin = 0, xmax = 5, ymin = 5, ymax = 10, fill = "green", alpha = 0.03) +
  # geom_rect(xmin = 5, xmax = 10, ymin = 0, ymax = 5, fill = "red", alpha = 0.03) +

  # geom_abline(slope = 1, intercept = 0, alpha = .3, lty = "dashed") +
  geom_vline(xintercept = 0, alpha = .3) +
  geom_hline(yintercept = 0, alpha = .3) +
  geom_point(size = 3) +
  # facet_wrap(~animal) +
  facet_grid(animal ~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))) +
  global_facet_theme +
  theme(
    axis.text.x = element_text(angle = 45)
  )


cowplot::plot_grid(plt_ang_stim, plt_ang_ctrl, ncol = 2)
```


## Traveled distance

Mean traveled distance across sessions, by animals

```{r message=FALSE, fig.height=8, fig.width=10, echo = FALSE}

coords %>%
  dplyr::filter(
    str_detect(string = animal, pattern = "b"),
    body_part == "center",
    stim_categ != "no stim",
    intensity %in% c(selected_intensities, "15 mW"),
    animal %!in% c(control_animals, "GIIFM14b"),
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::summarise(mean_d_mm = mean(d_mm, na.rm = T)) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      y = mean_d_mm
    )
  ) +
  geom_point(aes(fill = animal %>% as.factor()), shape = 21, size = 4) +
  geom_line(aes(group = animal)) +
  facet_wrap(~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))) +
  ggpubr::stat_compare_means(
    method = "wilcox.test",
    paired = T,
    comparisons = list(c("before stim", "stim")),
    vjust = 1.5,
    hide.ns = F
  ) +
  ggpubr::stat_compare_means(
    method = "wilcox.test",
    paired = T,
    comparisons = list(c("stim", "after stim")),
    vjust = 1.5,
    hide.ns = F
  ) +
  global_facet_theme
```

Mean traveled distance across sessions, by animals (control)


```{r message=FALSE, fig.height=8, fig.width=10, echo = FALSE}

coords %>%
  dplyr::filter(
    str_detect(string = animal, pattern = "b"),
    body_part == "center",
    stim_categ != "no stim",
    intensity %in% c(selected_intensities, "15 mW"),
    animal %in% control_animals,
    # X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::summarise(mean_d_mm = mean(d_mm, na.rm = T)) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      y = mean_d_mm
    )
  ) +
  geom_point(aes(fill = animal %>% as.factor()), shape = 21, size = 4) +
  geom_line(aes(group = animal)) +
  facet_wrap(~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))) +
  ggpubr::stat_compare_means(
    method = "wilcox.test",
    paired = T,
    comparisons = list(c("before stim", "stim")),
    method.args = list(alternative = "two.sided"),
    vjust = 1.5,
    hide.ns = F
  ) +
  ggpubr::stat_compare_means(
    method = "wilcox.test",
    paired = T,
    comparisons = list(c("stim", "after stim")),
    method.args = list(alternative = "two.sided"),
    vjust = 1.5,
    hide.ns = F
  ) +
  global_facet_theme
```





```{r message=FALSE, fig.height=8, fig.width=10, echo = FALSE}
plt1_dist <- coords %>%
  dplyr::filter(
    str_detect(string = animal, pattern = "b"),
    body_part == "center",
    animal %!in% c(control_animals, "GIIFM14b"),
    stim_categ != "no stim",
    intensity %in% selected_intensities
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::summarise(
    sum_d_mm = sum(d_mm, na.rm = T),
    mean_d_mm = mean(d_mm, na.rm = T)
  ) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      y = mean_d_mm
    )
  ) +
  geom_boxplot(aes(color = intensity)) +
  geom_point(aes(color = intensity), position = position_jitterdodge(dodge.width = 0.7, jitter.width = 0.1)) +
  # facet_wrap(~animal) +
  theme(legend.position = "none") +
  ylim(0, 8) +
  xlab("Stimulus") +
  ylab("Travelled distance [mm]") +
  ggtitle("Stimulus") +
  global_facet_theme

plt2_dist <- coords %>%
  dplyr::filter(
    str_detect(string = animal, pattern = "b"),
    body_part == "center",
    animal %in% control_animals, # , "GIIFM14b"),
    stim_categ != "no stim",
    intensity %in% selected_intensities
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::summarise(
    sum_d_mm = sum(d_mm, na.rm = T),
    mean_d_mm = mean(d_mm, na.rm = T)
  ) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      y = mean_d_mm
    )
  ) +
  geom_boxplot(aes(color = intensity)) +
  geom_point(aes(color = intensity), position = position_jitterdodge(dodge.width = 0.7, jitter.width = 0.1)) +
  theme(
    axis.title.y = element_blank(),
    legend.position = "none"
  ) +
  ylim(0, 8) +
  xlab("Stimulus") +
  ggtitle("Control") +
  # facet_wrap(~animal) +
  global_facet_theme

cowplot::plot_grid(plt1_dist, plt2_dist, ncol = 2) %>%
  plot_grid(
    get_legend(
      plt1_dist +
        guides(color = guide_legend(nrow = 1)) +
        theme(legend.position = "bottom")
    ),
    ncol = 1,
    rel_heights = c(1, .1)
  )
```






Traveled distance before stimulus vs during stimulus (starting or stopping signal). If the traveled distance is greater during the stimulus (green area) photoactivation initiates movement, if it is smaller (red area) it slows down the animal.


```{r message=FALSE, warning=FALSE, fig.width=17, fig.height=15, out.width="100%", echo = FALSE}
coords %>%
  dplyr::filter(
    str_detect(string = animal, pattern = "b"),
    body_part == "center",
    animal %!in% c(control_animals, "GIIFM14b"),
    stim_categ != "no stim",
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ, stim_number) %>%
  dplyr::summarise(mean_d_mm = mean(d_mm, na.rm = T)) %>%
  tidyr::spread(
    stim_categ, mean_d_mm
  ) %>%
  dplyr::filter(intensity %in% c(selected_intensities, 15)) %>%
  ggplot(
    mapping = aes(x = `before stim`, y = stim)
  ) +
  xlim(0, 10) +
  ylim(0, 10) +
  coord_fixed() +
  geom_vline(xintercept = 5, alpha = .3) +
  geom_hline(yintercept = 5, alpha = .3) +
  geom_rect(xmin = 0, xmax = 5, ymin = 5, ymax = 10, fill = "green", alpha = 0.03) +
  geom_rect(xmin = 5, xmax = 10, ymin = 0, ymax = 5, fill = "red", alpha = 0.03) +

  # geom_abline(slope = 1, intercept = 0, alpha = .3) +
  geom_point(aes(col = factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))), size = 3) +
  facet_wrap(~animal) +
  global_facet_theme +
  theme(
    axis.text.x = element_text(angle = 45)
  )
```

```{r message=FALSE, warning=FALSE, fig.width=15, fig.height=10, echo = FALSE}
coords %>%
  dplyr::filter(
    body_part == "center",
    # animal == selected_animal,
    stim_categ != "no stim",
    intensity %in% selected_intensities
  ) %>%
  # group_by(animal, session) %>%
  # spread(stim_categ, d_mm)
  dplyr::group_by(animal, intensity, stim_categ, stim_number) %>%
  summarise(sum_d_mm = sum(d_mm)) %>%
  group_by(animal) %>%
  spread(stim_categ, sum_d_mm) %>%
  mutate(stim_bstim = stim - `before stim`) %>%
  ggplot(mapping = aes(x = `before stim`, y = stim_bstim)) +
  geom_point(aes(col = factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))), size = 3) +
  # geom_text(aes(label = stim_number, col = factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))), size = 6) +
  geom_line(aes(col = factor(intensity, levels = gtools::mixedsort(intensity %>% unique())))) +
  labs(col = "Intensity") +
  geom_hline(yintercept = 0, lty = "dashed", col = "gray30") +
  facet_wrap(~animal, scales = "free")
```


```{r message=FALSE, warning=FALSE, fig.width=15, fig.height=20 , echo = FALSE}
stim_bstim1 <- coords %>%
  dplyr::filter(
    body_part == "center",
    animal %!in% control_animals,
    stim_categ != "no stim",
    intensity %in% c(selected_intensities, 15),
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ, stim_number) %>%
  dplyr::summarise(sum_d_mm = sum(d_mm, na.rm = T)) %>%
  group_by(animal) %>%
  tidyr::spread(
    stim_categ, sum_d_mm
  ) %>%
  ggplot(
    mapping = aes(x = `before stim`, y = stim)
  ) +
  xlim(0, 3000) +
  ylim(0, 3000) +
  coord_fixed() +
  # geom_vline(xintercept = 5, alpha = .3) +
  # geom_hline(yintercept = 5, alpha = .3) +
  # geom_rect(xmin = 0, xmax = 5, ymin = 5, ymax = 10, fill = "green", alpha = 0.03) +
  # geom_rect(xmin = 5, xmax = 10, ymin = 0, ymax = 5, fill = "red", alpha = 0.03) +

  geom_abline(slope = 1, intercept = 0, alpha = .3) +
  geom_point(size = 3) +
  facet_grid(animal ~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))) +
  global_facet_theme +
  ggtitle("Stimulus") +
  theme(
    axis.text.x = element_text(angle = 45)
  )

stim_bstim2 <- coords %>%
  dplyr::filter(
    body_part == "center",
    animal %in% control_animals,
    stim_categ != "no stim",
    intensity %in% c(selected_intensities, 15),
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ, stim_number) %>%
  dplyr::summarise(sum_d_mm = sum(d_mm, na.rm = T)) %>%
  group_by(animal) %>%
  tidyr::spread(
    stim_categ, sum_d_mm
  ) %>%
  ggplot(
    mapping = aes(x = `before stim`, y = stim)
  ) +
  xlim(0, 3000) +
  ylim(0, 3000) +
  coord_fixed() +
  # geom_vline(xintercept = 5, alpha = .3) +
  # geom_hline(yintercept = 5, alpha = .3) +
  # geom_rect(xmin = 0, xmax = 5, ymin = 5, ymax = 10, fill = "green", alpha = 0.03) +
  # geom_rect(xmin = 5, xmax = 10, ymin = 0, ymax = 5, fill = "red", alpha = 0.03) +

  geom_abline(slope = 1, intercept = 0, alpha = .3) +
  geom_point(size = 3) +
  facet_grid(animal ~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))) +
  global_facet_theme +
  ggtitle("Control") +
  theme(
    axis.text.x = element_text(angle = 45)
  )


cowplot::plot_grid(stim_bstim1, stim_bstim2, ncol = 2)
```
