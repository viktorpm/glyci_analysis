---
title: "Freely moving analysis"
author: "Viktor Plattner"
output:
  html_document:
    number_sections: yes
    df_print: paged
    toc: yes
    toc_float: yes
  pdf_document:
    number_sections: yes
    toc: yes
    keep_tex: true
  html_notebook:
    number_sections: yes
    toc: yes
    toc_float: yes
spacing: single
fontsize: 12pt
always_allow_html: yes
header-includes:
   - \usepackage{animate}

params:
  selected_animal: "GIIFM37b"



knit: (
  function (inputFile, encoding) {
    
    
    rmarkdown::render(  
      input = inputFile,
      encoding = encoding,
      output_file = file.path(
        "notebook_html", 
        paste0("freely_moving_analysis_", 
        rmarkdown::yaml_front_matter(inputFile)$params$selected_animal ,
         ".html")
        ),
      envir = globalenv()
      )
    }
  )
---


<style type="text/css">

body{ /* Normal  */
      font-size: 14px;
      font-family: "Arial", Helvetica, sans-serif;
  }
td {  /* Table  */
  font-size: 12px;
}
h1.title {
  font-size: 38px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #4d4e4f;
}
h1 { /* Header 1 */
  font-size: 28px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #2c3a3e;
}
h2 { /* Header 2 */
  font-size: 22px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #2c3a3e;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #2c3a3e;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>


```{r setup, include=FALSE}
### cheks all the used libraries in the project. Removes duplicates
library(tidyverse)


### list of libraries mentioned in the R scripts of the project
liblist <- map(
  list.files(pattern = ".Rmd|.R"),
  ~ readLines(con = .x) %>%
    grep(pattern = "library\\(", x = ., value = T)
) %>%
  unlist() %>%
  substr(
    start = 9,
    stop = regexpr(text = ., pattern = "\\)") - 1 %>% # regexpr: in case of multiple matches it only takes the first one
      as.vector()
  ) %>%
  `[`(!duplicated(.))

### list of installed packages
pkgs <- installed.packages() %>%
  as_tibble() %>%
  pull(1)

### packages that are needed but not installed
c(liblist[which(!liblist %in% pkgs)])

### installs uninstalled packages
install.packages(c(liblist[which(!liblist %in% pkgs)]))

### loads all libraries

lapply(liblist %>% as.list(), require, character.only = TRUE)


### defining global constants, filters and plot scales

library(imputeTS)

scale <- 1.38 ### pixel/mm
fps <- 30 ### frame rate
time_res <- 1 / fps ### time between frames
ang_threshold <- 90

datapoint_to_plot <- 5

global_facet_theme <- theme(
  strip.text = element_text(size = 15),
  axis.text = element_text(size = 12),
  axis.title = element_text(size = 15)
)

xlim_mm <- c(0, 1280 / scale)
ylim_mm <- c(0, 720 / scale)

selected_animal <- params$selected_animal

`%!in%` <- Negate(`%in%`)

```




# Loading and orginising data

## Global constants and scales 
<br>
These are defined in the "setup" chunk <br>

+ **scale**: 1.38 (pixels/mm) <br>
+ **fps**: 30 (frame rate) <br>
+ **time_res**: 1/**fps** (time between frames) <br>
+ **xlim_mm**, **ylim_mm**: pixels converted to mm 
+ **global_facet_theme**: plot text sizes
+ **datapoint_to_plot**: which datapoint to plot (frame %% datapoint_to_plot == 0)
+ **text_layer**: stimulus intensity in each session (used to create the text layer on plots, defined after "coords" was created)

<br>

**Current animal**: `r selected_animal`  
For the trajectories and traveled distance plots every `r datapoint_to_plot`th frame (data point) was used.
The global angle threshold used in this file is `r ang_threshold`. Grater rotation angles between consecutive frames are replaced by zero

**Control animals**: GIIFM34b, GIIFM35b, GIIFM36b, GIIFM37b

<br>

## Loading stimulus times (frames)


```{r echo = FALSE}
stims <- read.csv(file.path("data", "PnO_stim_rotation", "rotation_stims.csv")) %>%
  as_tibble() %>%
  mutate(
    session = gsub(pattern = "(coords).*", replacement = "\\1", session) %>%
      str_remove_all(pattern = "[[:alpha:][:punct:]]"),

    # session = ifelse(
    #   animal != "GIIFM24b",
    #   yes = gsub(pattern = "(coords).*", replacement = "\\1", session),
    #   no = session
    # ),
    stim_length = end - start
  ) %>%
  select(-stim_duration) %>%
  rename("stim_number" = stim.number) %>%
  gather(key = "timing", value = "frame", start, end)
stims
```


## Loading coordinates


```{r message=F, echo = FALSE}
coords <- read.csv(file.path("data", "PnO_stim_rotation", "rotation_all.csv")) %>%
  as_tibble() %>%
  mutate(
    animal = gsub(pattern = ".*rotation", replacement = "", animal) %>%
      str_remove_all(pattern = "\\\\") %>% str_remove(pattern = "fix") %>% str_remove(pattern = "control"),
    session = gsub(pattern = "(coords).*", replacement = "\\1", session) %>% str_remove_all(pattern = "[[:alpha:][:punct:]]"),
    # session = ifelse(
    #   animal != "GIIFM24b",
    #   yes = gsub(pattern = "(coords).*", replacement = "\\1", session),
    #   no = session
    # )
  ) %>%
  full_join(stims) %>% 
  dplyr::group_by(animal, session) %>%
  mutate(grp = cumsum(!is.na(stim_number))) %>% 
  dplyr::group_by(grp) %>% 
  mutate(
    stim = F,
    stim = replace(stim, first(timing) == "start" | timing == "end", T)
  ) %>%
  
  # ungroup() %>%
  # group_by(animal, session, stim) %>%
  # fill(stim_number) %>%
  # fill(intensity) %>%
  # fill(stim_freq) %>% 
  # fill(stim_side) %>% 
  select(-grp, -timing, -stim_length) %>%
  
  ungroup() %>%
  group_by(animal, session) %>%
  dplyr::mutate(
    rec_time = (frame / fps) %>% round(digits = 2),
    stim_categ = case_when(
      stim == T ~ "stim",
      lead(stim, n = 250) == T ~ "before stim",
      lag(stim, n = 250) == T ~ "after stim",
      stim == F ~ "no stim"
    ),
    
    ### rigth before and after stim (1s)
    stim_categ2 = case_when(
      stim == T ~ "stim",
      lead(stim, n = 30) == T ~ "right before",
      lag(stim, n = 30) == T ~ "right after ",
      stim == F ~ "no stim"
    ),
    
    ### shift values to the beginning of the stimulus block to be able to fill missing values in the next step
    stim_block = ifelse(stim_categ == "no stim", F, T),
    stim_number = lead(stim_number, n = 250),
    intensity = lead(intensity, n = 250),
    stim_freq = lead(stim_freq, n = 250),  
    stim_side = lead(stim_side, n = 250),  
    
    ### rigth before and after stim (1s)
    stim_block2 = ifelse(stim_categ2 == "no stim", F, T),
    stim_number2 = lead(stim_number, n = 30),
    intensity2 = lead(intensity, n = 30),
    stim_freq2 = lead(stim_freq, n = 30),  
    stim_side2 = lead(stim_side, n = 30),  
    
  ) %>% 
  
  ungroup() %>%
  group_by(animal, session, stim_block) %>%
  fill(stim_number) %>%
  fill(intensity) %>%
  fill(stim_freq) %>%
  fill(stim_side) %>% 
  
  ### rigth before and after stim (1s)
  fill(stim_number2) %>%
  fill(intensity2) %>%
  fill(stim_freq2) %>%
  fill(stim_side2) %>% 
  
  
  # # repeating stim_number, intensity and stim_freq values in the whole stim_block
  # group_by(animal, session, stim_block) %>% 
  # fill(stim_number, .direction = "up") %>%  #### ELBASSZA A STIM NUMBERT!!!! ha a lead es a lag hosszabb mint a valodi stim length!! 250 vagy 252 nem mindegy
  # fill(intensity, .direction = "up") %>%
  # fill(stim_freq, .direction = "up") %>%
  # fill(stim_side, .direction = "up") %>%
  # fill(stim_number, .direction = "down") %>%
  # fill(intensity, .direction = "down") %>%
  # fill(stim_freq, .direction = "down") %>%
  # fill(stim_side, .direction = "down") %>%
    
  # length of the stimulus
  unite(col = "head", head1, head2, sep = "_") %>%
  unite(col = "center", center1, center2, sep = "_") %>%
  unite(col = "tail", tail1, tail2, sep = "_") %>%
  gather(
    key = "body_part",
    value = "coordinate",
    head, center, tail
  ) %>%
  tidyr::extract(col = coordinate, into = c("X", "Y"), regex = "([[:alnum:]]+)_([[:alnum:]]+)") %>%
  dplyr::mutate(
    X = ifelse(
      as.integer(X) == 0 & as.integer(Y) == 0,
      yes = NA,
      no = as.integer(X)
    ),
    Y = ifelse(
      as.integer(X) == 0 & as.integer(Y) == 0,
      yes = NA,
      no = as.integer(Y)
    )
  ) %>%
  dplyr::group_by(animal, session, body_part) %>%
  dplyr::mutate(
    # X_interp = zoo::na.approx(X),
    # Y_interp = zoo::na.approx(Y),
    X_interp = imputeTS::na_interpolation(X) %>% round(),
    Y_interp = imputeTS::na_interpolation(Y) %>% round(),
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000,
    sec_counter = cumsum(ifelse(rec_time %% 1 == 0, 1, 0))
  ) %>%
  group_by(animal, session, body_part, sec_counter) %>%
  dplyr::mutate(speed_sec = sum(d_mm, na.rm = T)) %>%
  ungroup() %>%
  mutate(stim_number = replace(stim_number, is.na(stim_number), "no stim"))



coords
```

```{r echo = FALSE}
# In the "coords_all" table all the data can be found.
# Based on preliminary exploration of the data only animals with similar stimulus parameters were selected for further analysis (coords table)


# coords %>%
#   dplyr::group_by(animal,session) %>%
#   summarise(stim_length)
#
# coords %>%
#   dplyr::filter(animal == "GIIFM14b") %>% View()
```


Creating text layer to add intensity values to plots

```{r}
text_layer <- coords %>%
  dplyr::filter(
    animal == selected_animal,
    stim == T
  ) %>%
  group_by(session) %>%
  summarise(int_label = intensity %>% unique())
```






Creating plot colors

```{r}
gg_color_hue <- function(n) {
  hues <- seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}

n <- 6
cols <- gg_color_hue(n)
```


# Analysis (selected animal: `r selected_animal`)

## Dealing with missing coordinates

The tracking software occasionally lost the tracked points. To fill those gaps linear interpolation was applied. The figure below shows the interpolated values in red.
Note that only every 5th frame was used for the tracking and for the later analysis except for calculating the rotation angle.

```{r fig.width=10, fig.height=10, warning=FALSE, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    frame %% datapoint_to_plot == 0
  ) %>%
  group_by(session, sec_counter) %>%
  mutate(d_sec = sum(d_mm, na.rm = T)) %>%
  ggplot(
    mapping = aes(x = X_interp, y = Y_interp, label = frame)
  ) +
  geom_point(
    aes(
      color = miss %>% as.character(),
      shape = stim,
      alpha = ifelse(miss == "1", 0.1, 1)
    )
  ) +
  xlim(c(0, 1280)) +
  ylim(c(0, 720)) +
  facet_wrap(~session, ncol = 2) +
  scale_color_discrete(name = "Interpolated values") +
  geom_label(data = text_layer, aes(x = Inf, y = -Inf, hjust = 1.1, vjust = -0.5, label = paste0("Intensity: ", int_label, " mW"))) +
  global_facet_theme
```



## Plotting trajectories

To show the animals trajectory during stimuli the head-center-tail body points were plotted. Colors correspond to the order of stimuli in each session. The black points represent the trajectory when there was no stimulus. For visualization purposes the number of plotted data points are different during the stimulus vs non-stimulus period (2 data points/sec vs 6 data points/sec respectively). For the statistical analysis similar data point rate was used for the two states.

```{r warning=FALSE, fig.width=10, fig.height=10, include=FALSE, echo=FALSE, eval=FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    frame %% 15 == 0
  ) %>%
  ggplot(
    mapping = aes(x = X_interp, y = Y_interp, label = frame)
  ) +
  geom_point(
    aes(shape = body_part, col = stim_number),
    size = 2,
    alpha = .1
  ) +
  geom_line(
    aes(group = frame, col = stim_number %>% as.character()),
    alpha = .1
  ) +
  scale_color_manual(
    values = c(cols[1], cols[2], cols[3], cols[4], cols[5], cols[6], "black"),
    name = "Stimulus"
  ) +
  scale_shape(
    name = "Body part",
    labels = c("Center", "Head", "Tail")
  ) +
  xlim(c(0, 1280)) +
  ylim(c(0, 720)) +
  facet_wrap(~session, ncol = 2) +
  geom_label(data = text_layer, aes(x = Inf, y = -Inf, hjust = 1.1, vjust = -0.5, label = paste0("Intensity: ", int_label, " mW"))) +
  global_facet_theme
```

```{r warning=FALSE, fig.width=10, fig.height=10, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    stim == T,
    frame %% 15 == 0
  ) %>%
  ggplot(
    mapping = aes(x = X_interp / scale, y = Y_interp / scale, label = frame)
  ) +

  ### drawing positions during no stimulus
  ### "coords" was filtered differently compared to the stimulus dataset (number of frames)
  geom_point(
    data = coords %>%
      dplyr::filter(
        animal == selected_animal,
        body_part == "center",
        stim == F,
        frame %% 5 == 0
      ),
    size = 1,
    alpha = 0.1
  ) +

  ### drawing positions during stimulus
  ### body parts are connected by lines
  geom_line(
    aes(group = frame, col = as.character(stim_number)),
  ) +
  geom_point(
    aes(shape = body_part, col = as.character(stim_number)),
    size = 2
  ) +
  xlim(c(0, 1280 / scale)) +
  ylim(c(0, 720 / scale)) +
  facet_wrap(~session, ncol = 2, ) +
  geom_label(data = text_layer, aes(x = Inf, y = -Inf, hjust = 1.1, vjust = -0.5, label = paste0("Intensity: ", int_label, " mW"))) +
  labs(col = "Stimulus number", shape = "Body part") +
  xlab("X position [mm]") +
  ylab("Y position [mm]") +
  global_facet_theme
```


## Plotting speed in a 1 sec (30 frames) window

Speed of the animal in 1 sec windows. Darker colors represent slower speed. 

```{r message=FALSE, fig.width=10, fig.height=10, echo = FALSE, warning=FALSE}
coords %>%
  dplyr::filter(animal == selected_animal, body_part == "center") %>%
  group_by(session, sec_counter) %>%
  mutate(d_sec = sum(d_mm, na.rm = T)) %>%
  ggplot(
    mapping = aes(x = X_interp, y = Y_interp, label = frame)
  ) +
  geom_point(aes(color = d_sec %>% scale(), alpha = stim)) +
  xlim(c(0, 1280)) +
  ylim(c(0, 720)) +
  facet_wrap(~session, ncol = 2) +
  geom_label(data = text_layer, aes(x = Inf, y = -Inf, hjust = 1.1, vjust = -0.5, label = paste0("Intensity: ", int_label, " mW"))) +
  global_facet_theme
```



## Distribution of the distance between points

Cumulative distribution functions and histograms of the difference between consecutive X and Y coordinates and calculated traveled distances across frames. Most of the values are realistic but there are some big jumps probably due to errors in the tracking. The unrealistically big jumps were excluded from the analysis.

```{r, message=F, warning=F,  fig.width=10,fig.height=25, message=FALSE, echo = FALSE}
coords %>%
  # dplyr::filter(X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20) %>%
  ggplot(mapping = aes(x = X_diff)) +
  stat_ecdf(
    aes(
      col = session
    ),
    geom = "point"
  ) +
  # geom_histogram(aes(fill = session)) +
  facet_grid(~animal ~ body_part) +
  global_facet_theme
# scale_y_continuous(trans='log10')
```

```{r message=FALSE}
coords %>%
  group_by(animal, body_part) %>%
  summarise(min = min(X_diff, na.rm = T), max = max(X_diff, na.rm = T)) %>%
  DT::datatable()
```


```{r message=F, warning=F, fig.width=10, fig.height=25, echo = FALSE}
coords %>%
  # dplyr::filter(X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20) %>%
  ggplot(mapping = aes(x = X_diff)) +
  # geom_boxplot() +
  geom_histogram(
    aes(
      fill = session
    ),
    binwidth = 5
  ) +
  facet_grid(animal ~ body_part, scales = "free") +
  scale_y_continuous(trans = "log10") +
  global_facet_theme
```

```{r message=FALSE}
coords %>%
  group_by(animal, body_part) %>%
  summarise(min = min(Y_diff, na.rm = T), max = max(Y_diff, na.rm = T)) %>%
  DT::datatable()
```

Distribution of distance

```{r message=F, warning=F, fig.width=10, fig.height=25, echo = FALSE}
coords %>%
  # dplyr::filter(X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20) %>%
  ggplot(mapping = aes(x = d_mm)) +
  geom_histogram(aes(fill = session), binwidth = 5) +
  facet_grid(animal ~ body_part, scales = "free") +
  global_facet_theme +
  scale_y_continuous(trans = "log10")
```


## Instantaneous traveled distance

Plotting the traveled distance based on one of the three tracked body parts during stimulus and non-stimulus periods at the rate of 6 data point/sec. 

Center

```{r fig.width=10, fig.height=10, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20,
    frame %% datapoint_to_plot == 0
  ) %>%
  ggplot(mapping = aes(x = rec_time, y = d_mm)) +
  geom_line(aes(color = stim, group = 1)) +
  # geom_line(aes(x = rec_time, y = Y_diff -130), alpha = .5) +
  # geom_line(aes(x = rec_time, y = X_diff + 130), alpha = .5) +
  facet_wrap(~session, scales = "free", ncol = 1) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label, " mW"))) +
  ggtitle(paste0(selected_animal, " instantaneous traveled distance ", "(center)")) +
  global_facet_theme
```

Head

```{r fig.width=10, fig.height=10, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "head",
    X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20,
    frame %% datapoint_to_plot == 0
  ) %>%
  ggplot(mapping = aes(x = rec_time, y = d_mm)) +
  geom_line(aes(color = stim, group = 1)) +
  # geom_line(aes(x = rec_time, y = Y_diff -130), alpha = .5) +
  # geom_line(aes(x = rec_time, y = X_diff + 130), alpha = .5) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label, " mW"))) +
  facet_wrap(~session, scales = "free", ncol = 1) +
  ggtitle(paste0(selected_animal, " instantaneous traveled distance ", "(head)")) +
  global_facet_theme
```

Tail

```{r fig.width=10, fig.height=10, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "tail",
    X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20,
    frame %% datapoint_to_plot == 0
  ) %>%
  ggplot(mapping = aes(x = rec_time, y = d_mm)) +
  geom_line(aes(color = stim, group = 1)) +
  # geom_line(aes(x = rec_time, y = Y_diff -130), alpha = .5) +
  # geom_line(aes(x = rec_time, y = X_diff + 130), alpha = .5) +
  facet_wrap(~session, scales = "free", ncol = 1) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label, " mW"))) +
  ggtitle(paste0(selected_animal, " instantaneous traveled distance ", "(tail)")) +
  global_facet_theme
```



## Rolling mean of traveled distance

Plotting the mean traveled distance calculated in a rolling window (1 sec). The mean was calculated separately during stimulus (rolling window restarts with the beginning of stimuli). Colors represent different periods of the recording (no-stimulus, before stimulus, during stimulus, after stimulus). 


Defining line colors

```{r}
line_cols <- gg_color_hue(3)

group_colors <- c("no stim" = "gray30", "before stim" = line_cols[1], "stim" = line_cols[3], "after stim" = line_cols[2])
group_colors2 <- c("no stim" = "gray30", "right before" = line_cols[1], "stim" = line_cols[3], "right after" = line_cols[2])

```



```{r message=F, fig.width=12, warning=F, echo = FALSE}

coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    session == "2",
    X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20,
    frame %% datapoint_to_plot == 0
  ) %>%
  dplyr::group_by(stim) %>%
  dplyr::mutate(mean_mps_roll = zoo::rollmean(x = d_mm, k = 30, fill = NA)) %>%
  ggplot(aes(x = rec_time, y = d_mm)) +
  # ylim(c(0, 100)) +
  geom_point(aes(alpha = stim)) +
  geom_line(aes(x = rec_time, y = mean_mps_roll, col = stim_categ, group = 1), size = 1) +
  ggtitle(paste0(selected_animal, " mean traveled distance by stimulus period ", "(center)")) +
  scale_color_manual(values = group_colors)
```

Center

```{r fig.width=12, fig.height=12, warning=FALSE, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20,
    frame %% datapoint_to_plot == 0
  ) %>%
  dplyr::group_by(session, stim) %>%
  dplyr::mutate(mean_mps_roll = zoo::rollmean(x = d_mm, k = 30, fill = NA)) %>%
  ggplot(aes(x = rec_time, y = d_mm)) +
  # ylim(c(0, 100)) +
  geom_point(aes(alpha = stim)) +
  geom_line(aes(x = rec_time, y = mean_mps_roll, col = stim_categ, group = 1), size = 1) +
  facet_wrap(~session, scales = "free", ncol = 1) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label, " mW"))) +
  ggtitle(paste0(selected_animal, " mean traveled distance by stimulus period ", "(center)")) +
  scale_color_manual(values = group_colors) +
  global_facet_theme
```


Head


```{r fig.width=12, fig.height=12, warning=F, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "head",
    X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20,
    frame %% datapoint_to_plot == 0
  ) %>%
  dplyr::group_by(session, stim) %>%
  dplyr::mutate(mean_mps_roll = zoo::rollmean(x = d_mm, k = 30, fill = NA)) %>%
  ggplot(aes(x = rec_time, y = d_mm)) +
  # ylim(c(0, 100)) +
  geom_point(aes(alpha = stim)) +
  geom_line(aes(x = rec_time, y = mean_mps_roll, col = stim_categ, group = 1), size = 1) +
  facet_wrap(~session, scales = "free", ncol = 1) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label, " mW"))) +
  ggtitle(paste0(selected_animal, " mean traveled distance by stimulus period ", "(head)")) +
  scale_color_manual(values = group_colors) +
  global_facet_theme
```



Tail


```{r fig.width=12, fig.height=12, warning=FALSE, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "tail",
    X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20,
    frame %% datapoint_to_plot == 0
  ) %>%
  dplyr::group_by(session, stim) %>%
  dplyr::mutate(mean_mps_roll = zoo::rollmean(x = d_mm, k = 30, fill = NA)) %>%
  ggplot(aes(x = rec_time, y = d_mm)) +
  # ylim(c(0, 100)) +
  geom_point(aes(alpha = stim)) +
  geom_line(aes(x = rec_time, y = mean_mps_roll, col = stim_categ, group = 1), size = 1) +
  facet_wrap(~session, scales = "free", ncol = 1) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label, " mW"))) +
  ggtitle(paste0(selected_animal, " mean traveled distance by stimulus period ", "(tail)")) +
  scale_color_manual(values = group_colors) +
  global_facet_theme
```



```{r fig.width=10, fig.height=10, include=FALSE, echo=FALSE, eval=FALSE}
coords %>%
  dplyr::select(animal, session, frame, rec_time, stim_categ, body_part, d_mm, X_diff, Y_diff, stim_number) %>%
  mutate(stim_number = replace(stim_number, stim_number == "no stim", NA)) %>%
  dplyr::filter(
    animal == "GIIFM22b",
    body_part == "center",
    X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20,
    stim_categ != "no stim"
  ) %>%
  group_by(session, stim_categ) %>%
  mutate(categ_timer = (row_number() / fps) %>% round(digits = 2)) %>%
  ungroup() %>%
  group_by(session) %>%
  mutate(stim_block_number = stim_number) %>%
  fill(stim_block_number, .direction = "down") %>%
  ggplot(aes(x = categ_timer, y = d_mm, group = stim_categ)) +
  geom_line(aes(col = stim_categ)) +
  facet_wrap(~session, ncol = 1, scales = "free") +
  global_facet_theme
```



## Mean traveled distance by individual stimuli within session (full length before and after the stimulus)

Plotting traveled distance during individual stimuli (5 or 6 repeats) within session. Traveled distance is averaged through the full duration of the stimulus (~8s) and similar "before stimulus" and "after stimulus" duration. <br>

The same data is shown on the plots with different groupings: <br>

+ intensities are grouped together (colors), stimulus numbers are separated (panels) <br>
+ stimulus numbers are grouped together (colors), intensities are separated (panels) <br>


```{r message=F, fig.width=12, fig.height=8, warning=F, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    stim_categ != "no stim",
    intensity %in% c(1, 5, 10),
    # session == "4",
    X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20,
    frame %% datapoint_to_plot == 0
  ) %>% 
  dplyr::group_by(animal, intensity, stim_number, stim_categ) %>%
  dplyr::summarise(mean_d_mm = mean(d_mm, na.rm = T)) %>% 

  # dplyr::summarise(mean_mps_roll = zoo::rollmean(x = d_mm, k = 30, fill = NA)) 
  
  # dplyr::summarise(mean_d_mm = mean(d_mm, na.rm = T)) %>% 
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      y = mean_d_mm
    )
  ) +
  geom_point(aes(fill = as.factor(intensity)), shape = 21, size = 4) +
  facet_wrap(~stim_number) +
  geom_line(aes(group = intensity)) +
  ggtitle(paste0(selected_animal, " mean traveled distance by individual stimuli within session ", "(center)")) +
  labs(
    fill = "Intensity",
    x = "Stimulus period",
    y = "Mean traveled distance") +
  global_facet_theme
```

```{r message=F, fig.width=12, fig.height=4, warning=F, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    stim_categ != "no stim",
    intensity %in% c(1, 5, 10),
    # session == "4",
    X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20,
    frame %% datapoint_to_plot == 0
  ) %>% 
  dplyr::group_by(animal, intensity, stim_number, stim_categ) %>%
  dplyr::summarise(mean_d_mm = mean(d_mm, na.rm = T)) %>% 

  # dplyr::summarise(mean_mps_roll = zoo::rollmean(x = d_mm, k = 30, fill = NA)) 
  
  # dplyr::summarise(mean_d_mm = mean(d_mm, na.rm = T)) %>% 
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      y = mean_d_mm
    )
  ) +
  geom_point(aes(fill = stim_number), shape = 21, size = 4) +
  facet_wrap(~intensity) +
  geom_line(aes(group = stim_number)) +
  ggtitle(paste0(selected_animal, " mean traveled distance by individual stimuli within session ", "(center)")) +
  labs(
    fill = "Stimulus number",
    x = "Stimulus period",
    y = "Mean traveled distance") +
  global_facet_theme

```



## Mean traveled distance by individual stimuli within session (1s before and after the stimulus)


Plotting traveled distance during individual stimuli (5 or 6 repeats) within session. Traveled distance is averaged through the full duration of the stimulus (~8s) but only 1s "before stimulus" and 1s "after stimulus" duration. <br>


The same data is shown on the plots with different groupings: <br>

+ intensities are grouped together (colors), stimulus numbers are separated (panels) <br>
+ stimulus numbers are grouped together (colors), intensities are separated (panels) <br>


```{r message=F, fig.width=12, fig.height=8, warning=F, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    stim_categ2 != "no stim",
    intensity2 %in% c(1, 5, 10),
    # session == "4",
    X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20,
    frame %% datapoint_to_plot == 0
  ) %>% 
  dplyr::group_by(animal, intensity2, stim_number2, stim_categ2) %>%
  dplyr::summarise(mean_d_mm = mean(d_mm, na.rm = T)) %>% 

  # dplyr::summarise(mean_mps_roll = zoo::rollmean(x = d_mm, k = 30, fill = NA)) 
  
  # dplyr::summarise(mean_d_mm = mean(d_mm, na.rm = T)) %>% 
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ2, "right before", "stim", "right after"),
      y = mean_d_mm
    )
  ) +
  geom_point(aes(fill = as.factor(intensity2)), shape = 21, size = 4) +
  facet_wrap(~stim_number2) +
  geom_line(aes(group = intensity2)) +
  ggtitle(paste0(selected_animal, " mean traveled distance by individual stimuli within session ", "(center)")) +
  labs(
    fill = "Intensity",
    x = "Stimulus period",
    y = "Mean traveled distance") +
  global_facet_theme
```



```{r message=F, fig.width=12, fig.height=4, warning=F, echo = FALSE, out.width="100%"}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    stim_categ2 != "no stim",
    intensity2 %in% c(1, 5, 10),
    # session == "4",
    X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20,
    frame %% datapoint_to_plot == 0
  ) %>% 
  dplyr::group_by(animal, intensity2, stim_number2, stim_categ2) %>%
  dplyr::summarise(mean_d_mm = mean(d_mm, na.rm = T)) %>% 

  # dplyr::summarise(mean_mps_roll = zoo::rollmean(x = d_mm, k = 30, fill = NA)) 
  
  # dplyr::summarise(mean_d_mm = mean(d_mm, na.rm = T)) %>% 
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ2, "right before", "stim", "right after"),
      y = mean_d_mm
    )
  ) +
  geom_point(aes(fill = stim_number2 %>% as.factor()), shape = 21, size = 4) +
  facet_wrap(~intensity2) +
  geom_line(aes(group = stim_number2)) +
  ggtitle(paste0(selected_animal, " mean traveled distance by individual stimuli within session ", "(center)")) +
  labs(
    fill = "Stimulus number",
    x = "Stimulus period",
    y = "Mean traveled distance") +
  global_facet_theme

```




















## Calculating angles

### Toy data

```{r}
vectors <- tibble(
  body = c("cent", "h", "cent", "h", "cent", "h", "cent", "h"),
  frame = c(0, 0, 1, 1, 2, 2, 3, 3),
  X = c(750, 760, 770, 770, 755, 765, 755, 765),
  Y = c(500, 500, 500, 520, 510, 520, 510, 500)
)
vectors %>% arrange(body)
```


```{r}
ang <- function(a, b) {
  theta <- acos(sum(a * b) / (sqrt(sum(a * a)) * sqrt(sum(b * b))))
  return(theta * 180 / pi)
}

# ang(a = c(10, 0), b = c(10, 10))

vectors %>%
  group_by(frame) %>%
  summarise(dx = diff(X), dy = diff(Y)) %>%
  mutate(ldx = lead(dx), ldy = lead(dy)) %>%
  # rowwise() %>%
  mutate(angle = ang(a = c(dx, dy), b = c(ldx, ldy))) %>%
  ungroup() %>%
  mutate(
    signed_angle = (atan2(dx, dy) - atan2(ldx, ldy)) * 180 / (pi)
  )
```


```{r}
matlib::angle(
  x = vectors %>%
    group_by(frame) %>%
    summarise(dx = diff(X), dy = diff(Y)) %>%
    dplyr::filter(frame == "0") %>%
    select(-1) %>% as.matrix() %>% as.vector(),
  y = vectors %>%
    group_by(frame) %>%
    summarise(dx = diff(X), dy = diff(Y)) %>%
    dplyr::filter(frame == "2") %>%
    select(-1) %>% as.matrix() %>% as.vector()
)
```


The dot product of two vectors x and y can be defined as:

$x \cdot y = ||x|| * ||y|| \cos(\theta) $

```{r}
vectors %>%
  ggplot(mapping = aes(x = X, y = Y)) +
  geom_point(aes(shape = body)) +
  geom_line(aes(group = frame, color = frame %>% as.character())) +
  geom_text_repel(aes(label = paste0(X, ",", Y), col = as.character(frame))) +
  xlim(750, 775) +
  ylim(500, 525)
```

### Real data (coords tibble)


#### First 10 head - center vectors

```{r echo = FALSE ,message=FALSE, warning=FALSE}
coords %>%
  dplyr::filter(animal == selected_animal) %>%
  dplyr::group_by(body_part) %>%
  slice(1:10) %>%
  dplyr::filter(body_part != "tail") %>%
  ggplot(
    mapping = aes(x = X, y = Y)
  ) +
  geom_point(aes(shape = body_part), size = 2) +
  geom_line(aes(group = frame, color = as.character(frame))) +
  geom_text_repel(aes(label = paste0(X, ",", Y), col = as.character(frame))) +
  geom_segment(
    data = coords %>%
      dplyr::filter(animal == selected_animal) %>%
      dplyr::group_by(body_part) %>%
      slice(1:10) %>%
      dplyr::filter(body_part != "tail", frame == 0),
    aes(
      x = X[1], xend = X[2],
      y = Y[1], yend = Y[1]
    ), linetype = "dashed", col = "red"
  ) +
  geom_segment(
    data = coords %>%
      dplyr::filter(animal == selected_animal) %>%
      dplyr::group_by(body_part) %>%
      slice(1:10) %>%
      dplyr::filter(body_part != "tail", frame == 0),
    aes(
      x = X[2], xend = X[2],
      y = Y[1], yend = Y[2]
    ), linetype = "dashed", col = "red"
  )
```

```{r eval=FALSE}
coords %>%
  dplyr::filter(animal == "GIIFM19b") %>%
  dplyr::group_by(body_part) %>%
  slice(1:3) %>%
  dplyr::filter(body_part != "tail", frame == 0) %>%
  pull(X)
```



#### Distribution of angles

Because of the periodicity of tangent function unrealistic angles were introduced (jumps in data). Angles greater than 180 or smaller than -180 were subtracted from 360 and -360 respectively to get the correct angle.

In the control animals (34, 35, 36, 37) there are unrealistically large angles between frames probably due to tracking problem (switch of head and tail/center coordinate). Those angles are replaced by 0!

mutate(signed_angle_corrected = ifelse(signed_angle_corrected %>% abs() > ang_treshold, 0, signed_angle_corrected))


```{r message=FALSE, fig.width=10, fig.height=10, warning=FALSE, echo = FALSE}
coords %>%
  dplyr::filter(animal == selected_animal, body_part != "tail") %>%
  dplyr::filter(body_part != "tail") %>%
  dplyr::group_by(animal, session, frame) %>%
  summarise(
    vectx = diff(X_interp),
    vecty = diff(Y_interp)
  ) %>%
  mutate(
    leadx = lead(vectx),
    leady = lead(vecty)
  ) %>%
  # rowwise() %>%
  mutate(
    signed_angle = (atan2(leadx, leady) - atan2(vectx, vecty)) * 180 / (pi)
  ) %>%
  mutate(
    signed_angle_corrected = case_when(
      signed_angle >= 180 ~ 360 - signed_angle,
      signed_angle %>% abs() < 180 ~ signed_angle,
      signed_angle <= -180 ~ -360 - signed_angle,
      signed_angle > -180 | signed_angle < 0 ~ signed_angle
    )
  ) %>%
  ### removing unrealistically large angles
  mutate(signed_angle_corrected = ifelse(signed_angle_corrected %>% abs() > ang_threshold, 0, signed_angle_corrected)) %>%
  ggplot(aes(x = signed_angle_corrected)) +
  geom_histogram() +
  facet_wrap(~session, scales = "free") +
  global_facet_theme
```

#### Signed angles 

```{r message=F, warning=F, echo = FALSE}

angles <- coords %>%
  dplyr::filter(
    animal == selected_animal,
    # frame %% datapoint_to_plot == 0, ### here it's good to have all the data points to calculate the cumulative angles
    body_part != "tail"
  ) %>%
  dplyr::group_by(session, frame) %>%
  mutate(
    vectx = diff(X_interp),
    vecty = diff(Y_interp)
  ) %>%
  dplyr::group_by(session) %>%
  mutate(
    leadx = lead(vectx),
    leady = lead(vecty)
  ) %>%
  mutate(
    signed_angle = (atan2(leadx, leady) - atan2(vectx, vecty)) * 180 / (pi)
  )

corrected_angles <- coords %>%
  dplyr::filter(
    animal == selected_animal,
    # frame %% datapoint_to_plot == 0, ### here it's good to have all the data points to calculate the cumulative angles
    body_part != "tail"
  ) %>%
  dplyr::group_by(session, frame) %>%
  mutate(
    vectx = diff(X_interp),
    vecty = diff(Y_interp)
  ) %>%
  dplyr::group_by(session) %>%
  mutate(
    leadx = lead(vectx),
    leady = lead(vecty)
  ) %>%
  mutate(
    signed_angle = (atan2(leadx, leady) - atan2(vectx, vecty)) * 180 / (pi)
  ) %>%
  mutate(
    signed_angle_corrected = case_when(
      signed_angle >= 180 ~ 360 - signed_angle,
      signed_angle %>% abs() < 180 ~ signed_angle,
      signed_angle <= -180 ~ -360 - signed_angle,
      signed_angle > -180 | signed_angle < 0 ~ signed_angle
    )
  ) %>%
  ### removing unrealistically large angles
  mutate(signed_angle_corrected = ifelse(signed_angle_corrected %>% abs() > ang_threshold, 0, signed_angle_corrected))
```



```{r message=F, fig.width=10, fig.height=10, warning=FALSE}
corrected_angles %>%
  ggplot(aes(x = rec_time, y = signed_angle_corrected)) +
  geom_line(aes(col = stim, group = 1)) +
  facet_wrap(~session, scales = "free_x", ncol = 1) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label, " mW"))) +
  ggtitle(paste0(selected_animal, " raw angles by stimulus period ")) +
  global_facet_theme
```


```{r include=FALSE}
coords %>%
  dplyr::filter(animal == selected_animal, session == "0", body_part != "tail") %>%
  dplyr::group_by(body_part) %>%
  dplyr::slice(1:50) %>%
  ungroup() %>%
  dplyr::group_by(frame) %>%
  summarise(
    vectx = diff(X_interp),
    vecty = diff(Y_interp)
  ) %>%
  mutate(
    leadx = lead(vectx),
    leady = lead(vecty)
  ) %>%
  # rowwise() %>%
  mutate(
    signed_angle = (atan2(leadx, leady) - atan2(vectx, vecty)) * 180 / (pi)
  ) %>%
  mutate(
    signed_angle_corrected = case_when(
      signed_angle >= 180 ~ 360 - signed_angle,
      signed_angle %>% abs() < 180 ~ signed_angle,
      signed_angle <= -180 ~ -360 - signed_angle,
      signed_angle > -180 | signed_angle < 0 ~ signed_angle
    )
  ) %>%
  ### removing unrealistically large angles
  mutate(signed_angle_corrected = ifelse(signed_angle_corrected %>% abs() > ang_threshold, 0, signed_angle_corrected))
```


#### Plotting cumulative angles


Cumulative signed rotation angles during the sessions. 

```{r message=FALSE,fig.width=10, fig.height=10}
corrected_angles %>%
  group_by(session) %>%
  dplyr::filter(body_part == "center") %>%
  mutate(csum = cumsum(ifelse(is.na(signed_angle_corrected), 0, signed_angle_corrected)) %>% round(4)) %>%
  # dplyr::filter(session == "video2coords") %>%
  # group_by(session) %>%
  # gather(key = "stim_categ" , value = "stim_value", stim, before_stim) %>%
  ggplot(
    mapping = aes(x = rec_time, y = csum %>% scale())
  ) +
  geom_line(aes(col = stim, group = 1)) +
  facet_wrap(~session, scales = "free_x", ncol = 1) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label, " mW"))) +
  ggtitle(paste0(selected_animal, " cumulative angles by stimulus period ")) +
  global_facet_theme
```




```{r message=FALSE,fig.width=10, fig.height=10}

# !!!!! Observe the difference between "GIIFM22b" and "GIIFM14b". GIIFM14b is not working properly!!!!!!

corrected_angles %>%
  dplyr::filter(body_part == "center") %>%
  group_by(session) %>%
  mutate(csum = cumsum(ifelse(is.na(signed_angle_corrected), 0, signed_angle_corrected)) %>% round(4)) %>%
  ggplot(
    mapping = aes(x = rec_time, y = csum %>% scale())
  ) +
  geom_line(aes(col = stim_categ, group = 1)) +
  facet_wrap(~session, scales = "free_x", ncol = 1) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label, " mW"))) +
  scale_color_manual(values = group_colors) +
  global_facet_theme
```


# Population analysis


```{r message=FALSE, warning=FALSE, echo = FALSE}
corrected_angles_population <- coords %>%
  dplyr::filter(
    str_detect(string = animal, pattern = "b"),
    animal != "GIIFM14b",
    body_part != "tail"
  ) %>%
  dplyr::group_by(animal, session, frame) %>%
  mutate(
    vectx = diff(X_interp),
    vecty = diff(Y_interp),
  ) %>%
  group_by(animal, session) %>%
  mutate(
    leadx = lead(vectx),
    leady = lead(vecty)
  ) %>%
  mutate(
    signed_angle = (atan2(leadx, leady) - atan2(vectx, vecty)) * 180 / (pi)
  ) %>%
  mutate(
    signed_angle_corrected = case_when(
      signed_angle >= 180 ~ 360 - signed_angle,
      signed_angle %>% abs() < 180 ~ signed_angle,
      signed_angle <= -180 ~ -360 - signed_angle,
      signed_angle > -180 | signed_angle < 0 ~ signed_angle
    )
  ) %>%
  ### removing unrealistically large angles
  mutate(signed_angle_corrected = ifelse(signed_angle_corrected %>% abs() > ang_threshold, 0, signed_angle_corrected))
```



```{r message=FALSE,fig.width=17, fig.height=15, out.width="100%"}
corrected_angles_population %>%
  dplyr::filter(body_part == "head") %>%
  group_by(animal, session) %>%
  mutate(csum = cumsum(ifelse(is.na(signed_angle_corrected), 0, signed_angle_corrected)) %>% round(4)) %>%
  ggplot(
    mapping = aes(x = rec_time, y = csum %>% scale())
  ) +
  geom_line(aes(col = stim_categ, group = 1)) +
  # geom_text(
  #   data = coords$intensity %>% unique(),
  #   aes(label=intensity), check_overlap = T) +
  facet_grid(animal ~ session %>% as.integer(), scales = "free") +
  scale_color_manual(values = group_colors) +
  global_facet_theme +
  theme(
    axis.text.x = element_text(angle = 45),
  ) 
```

Mean traveled distance across sessions, by animals

```{r message=FALSE, fig.height=8, fig.width=10, echo = FALSE}

coords %>%
  dplyr::filter(
    str_detect(string = animal, pattern = "b"),
    body_part == "center",
    stim_categ != "no stim",
    intensity %in% c(1, 5, 10, 15),
    animal %!in% c("GIIFM34b", "GIIFM35b", "GIIFM36b", "GIIFM37b", "GIIFM14b"),
    X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::summarise(mean_d_mm = mean(d_mm, na.rm = T)) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      y = mean_d_mm
    )
  ) +
  geom_point(aes(fill = animal %>% as.factor()), shape = 21, size = 4) +
  geom_line(aes(group = animal)) +
  facet_wrap(~intensity) +
  ggpubr::stat_compare_means(
    method = "wilcox.test",
    paired = T,
    comparisons = list(c("before stim", "stim")),
    vjust = 1.5,
    hide.ns = F
  ) +
  ggpubr::stat_compare_means(
    method = "wilcox.test",
    paired = T,
    comparisons = list(c("stim", "after stim")),
    vjust = 1.5,
    hide.ns = F
  ) +
  global_facet_theme
```

Mean traveled distance across sessions, by animals (control)


```{r message=FALSE, fig.height=8, fig.width=10, echo = FALSE}

coords %>%
  dplyr::filter(
    str_detect(string = animal, pattern = "b"),
    body_part == "center",
    stim_categ != "no stim",
    intensity %in% c(1, 5, 10, 15),
    animal %in% c("GIIFM34b", "GIIFM35b", "GIIFM36b", "GIIFM37b"),
    X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::summarise(mean_d_mm = mean(d_mm, na.rm = T)) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      y = mean_d_mm
    )
  ) +
  geom_point(aes(fill = animal %>% as.factor()), shape = 21, size = 4) +
  geom_line(aes(group = animal)) +
  facet_wrap(~intensity) +
  ggpubr::stat_compare_means(
    method = "wilcox.test",
    paired = T,
    comparisons = list(c("before stim", "stim")),
    vjust = 1.5,
    hide.ns = F
  ) +
  ggpubr::stat_compare_means(
    method = "wilcox.test",
    paired = T,
    comparisons = list(c("stim", "after stim")),
    vjust = 1.5,
    hide.ns = F
  ) +
  global_facet_theme
```



Mean rotation angle by session


```{r message=FALSE, fig.height=8, fig.width=10, echo = FALSE}

sem <- function(x) sd(x) / sqrt(length(x)) # Create own function

corrected_angles_population %>%
  dplyr::filter(
    animal %!in% c("GIIFM34b", "GIIFM35b", "GIIFM36b", "GIIFM37b", "GIIFM14b"),
    body_part == "head",
    stim_categ != "no stim"
    # str_detect(string = session, pattern = "1|2|3|4|5"), # session filter
  ) %>%
  dplyr::group_by(animal, session, stim_categ) %>%
  dplyr::summarise(
    sum_ang = sum(signed_angle_corrected, na.rm = T),
    mean_ang = mean(signed_angle_corrected, na.rm = T),
    med_ang = median(signed_angle_corrected, na.rm = T),
    sd_ang = sd(signed_angle_corrected, na.rm = T),
    sem_ang = sem(signed_angle_corrected)
  ) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      y = sum_ang # %>% scale()
    )
  ) +
  geom_point(aes(fill = animal), shape = 21, size = 4) +
  geom_line(aes(group = animal)) +
  facet_wrap(~ session %>% as.integer()) +
  global_facet_theme +
  xlab("State") +
  ylab("Scaled sum angle")
```



Mean rotation angle by session (control)


```{r message=FALSE, fig.height=8, fig.width=10, echo = FALSE}

sem <- function(x) sd(x) / sqrt(length(x)) # Create own function

corrected_angles_population %>%
  dplyr::filter(
    animal %in% c("GIIFM34b", "GIIFM35b", "GIIFM36b", "GIIFM37b"),
    body_part == "head",
    stim_categ != "no stim"
    # str_detect(string = session, pattern = "1|2|3|4|5"), # session filter
  ) %>%
  dplyr::group_by(animal, session, stim_categ) %>%
  dplyr::summarise(
    sum_ang = sum(signed_angle_corrected, na.rm = T),
    mean_ang = mean(signed_angle_corrected, na.rm = T),
    med_ang = median(signed_angle_corrected, na.rm = T),
    sd_ang = sd(signed_angle_corrected, na.rm = T),
    sem_ang = sem(signed_angle_corrected)
  ) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      y = sum_ang # %>% scale()
    )
  ) +
  geom_point(aes(fill = animal), shape = 21, size = 4) +
  geom_line(aes(group = animal)) +
  facet_wrap(~ session %>% as.integer()) +
  global_facet_theme +
  xlab("State") +
  ylab("Scaled sum angle")
```

Mean rotation angle by intensity


```{r message=FALSE, fig.height=8, fig.width=10, echo = FALSE}
corrected_angles_population %>%
  dplyr::filter(
    animal %!in% c("GIIFM34b", "GIIFM35b", "GIIFM36b", "GIIFM37b", "GIIFM14b", "GIIFM17b"),
    body_part == "head",
    stim_categ != "no stim",
    # stim_side == "right"
  ) %>%
  dplyr::filter(intensity %in% c(1, 5, 10)) %>%
  dplyr::group_by(animal, stim_categ) %>%
  dplyr::summarise(
    sum_ang = sum(signed_angle_corrected, na.rm = T),
    mean_ang = mean(signed_angle_corrected, na.rm = T),
    med_ang = median(signed_angle_corrected, na.rm = T),
    sd_ang = sd(signed_angle_corrected, na.rm = T),
    sem_ang = sem(signed_angle_corrected)
  ) %>%
  # dplyr::filter(intensity %in% c(1, 5, 10, 15)) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      y = sum_ang %>% scale()
    )
  ) +
  geom_point(aes(fill = animal), shape = 21, size = 4) +
  geom_line(aes(group = animal)) +
  # facet_wrap(~intensity) +
  global_facet_theme +
  xlab("State") +
  ylab("Scaled sum angle")


# facet_grid(~animal, ~intensity)
# geom_errorbar(aes(ymin = mean_ang - sem_ang, ymax = mean_ang + sem_ang, col = animal), width=.1)
```


Mean rotation angle by intensity (control)


```{r message=FALSE, fig.height=8, fig.width=10, echo = FALSE}
corrected_angles_population %>%
  dplyr::filter(
    animal %in% c("GIIFM34b", "GIIFM35b", "GIIFM36b", "GIIFM37b"),
    body_part == "head",
    stim_categ != "no stim",
    # stim_side == "right"
  ) %>%
  dplyr::filter(intensity %in% c(1, 5, 10)) %>%
  dplyr::group_by(animal, stim_categ) %>%
  dplyr::summarise(
    sum_ang = sum(signed_angle_corrected, na.rm = T),
    mean_ang = mean(signed_angle_corrected, na.rm = T),
    med_ang = median(signed_angle_corrected, na.rm = T),
    sd_ang = sd(signed_angle_corrected, na.rm = T),
    sem_ang = sem(signed_angle_corrected)
  ) %>%
  # dplyr::filter(intensity %in% c(1, 5, 10, 15)) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      y = sum_ang %>% scale()
    )
  ) +
  geom_point(aes(fill = animal), shape = 21, size = 4) +
  geom_line(aes(group = animal)) +
  # facet_wrap(~intensity) +
  global_facet_theme +
  xlab("State") +
  ylab("Scaled sum angle")


# facet_grid(~animal, ~intensity)
# geom_errorbar(aes(ymin = mean_ang - sem_ang, ymax = mean_ang + sem_ang, col = animal), width=.1)
```


```{r message=FALSE, fig.height=8, fig.width=10, echo = FALSE}
corrected_angles_population %>%
  dplyr::filter(
    animal %!in% c("GIIFM34b", "GIIFM35b", "GIIFM36b", "GIIFM37b", "GIIFM14b"),
    body_part == "head",
    stim_categ != "no stim"
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ, stim_number) %>%
  dplyr::summarise(
    sum_ang = sum(signed_angle_corrected, na.rm = T),
    mean_ang = mean(signed_angle_corrected, na.rm = T),
    med_ang = median(signed_angle_corrected, na.rm = T),
    sd_ang = sd(signed_angle_corrected, na.rm = T),
    sem_ang = sem(signed_angle_corrected)
  ) %>%
  dplyr::filter(
    intensity %in% c(1, 5, 10)
  ) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      y = sum_ang %>% scale()
    )
  ) +
  geom_boxplot(aes(color = intensity %>% as.factor())) +
  geom_point(aes(color = intensity %>% as.factor()), position = position_jitterdodge(dodge.width = 0.7)) +
  # geom_point(aes(fill = intensity %>% as.factor()), shape = 21, size = 4) +
  # geom_line(aes(group = intensity %>% as.factor())) +
  facet_wrap(~stim_number) +
  global_facet_theme +
  xlab("State") +
  ylab("Scaled sum angle")


# facet_grid(~animal, ~intensity)
# geom_errorbar(aes(ymin = mean_ang - sem_ang, ymax = mean_ang + sem_ang, col = animal), width=.1)
```



Traveled distance before stimulus vs during stimulus (starting or stopping signal). If the traveled distance is greater during the stimulus (green area) photoactivation initiates movement, if it is smaller (red area) it slows down the animal.


```{r message=FALSE, warning=FALSE, fig.width=17, fig.height=15, out.width="100%", echo = FALSE}
coords %>%
  dplyr::filter(
    str_detect(string = animal, pattern = "b"),
    body_part == "center",
    animal != "GIIFM14b",
    stim_categ != "no stim",
    X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ, stim_number) %>%
  dplyr::summarise(mean_d_mm = mean(d_mm, na.rm = T)) %>%
  tidyr::spread(
    stim_categ, mean_d_mm
  ) %>%
  dplyr::filter(intensity %in% c(1, 5, 10, 15)) %>%
  ggplot(
    mapping = aes(x = `before stim`, y = stim)
  ) +
  xlim(0, 10) +
  ylim(0, 10) +
  coord_fixed() +
  geom_vline(xintercept = 5, alpha = .3) +
  geom_hline(yintercept = 5, alpha = .3) +
  geom_rect(xmin = 0, xmax = 5, ymin = 5, ymax = 10, fill = "green", alpha = 0.03) +
  geom_rect(xmin = 5, xmax = 10, ymin = 0, ymax = 5, fill = "red", alpha = 0.03) +

  # geom_abline(slope = 1, intercept = 0, alpha = .3) +
  geom_point(aes(col = as.factor(intensity)), size = 3) +
  facet_grid(animal ~ stim_number) +
  global_facet_theme +
  theme(
    axis.text.x = element_text(angle = 45)
  )
```


Mean rotation angle before stimulus vs during stimulus (starting or stopping signal).

```{r message=FALSE, warning=FALSE, fig.width=17, fig.height=15, out.width="100%", echo = FALSE}

corrected_angles_population %>%
  dplyr::filter(
    animal %!in% c("GIIFM34b", "GIIFM35b", "GIIFM36b", "GIIFM37b", "GIIFM14b"),
    body_part == "head",
    stim_categ != "no stim"
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ, stim_number) %>%
  dplyr::summarise(
    # sum_ang = sum(signed_angle_corrected, na.rm = T),
    mean_ang = mean(signed_angle_corrected, na.rm = T),
    # med_ang = median(signed_angle_corrected, na.rm = T),
    # sd_ang = sd(signed_angle_corrected, na.rm = T),
    # sem_ang = sem(signed_angle_corrected)
  ) %>%
  tidyr::spread(
    key = stim_categ, value = mean_ang
  ) %>%
  ggplot(
    mapping = aes(x = `before stim`, y = stim)
  ) +
  xlim(-5, 5) +
  ylim(-5, 5) +
  coord_fixed() +
  # geom_vline(xintercept = 5, alpha = .3) +
  # geom_hline(yintercept = 5, alpha = .3) +
  # geom_rect(xmin = 0, xmax = 5, ymin = 5, ymax = 10, fill = "green", alpha = 0.03) +
  # geom_rect(xmin = 5, xmax = 10, ymin = 0, ymax = 5, fill = "red", alpha = 0.03) +

  # geom_abline(slope = 1, intercept = 0, alpha = .3) +
  geom_point(aes(col = as.factor(intensity)), size = 3) +
  facet_grid(animal ~ stim_number) +
  global_facet_theme +
  theme(
    axis.text.x = element_text(angle = 45)
  )
```
