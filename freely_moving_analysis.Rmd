---
title: "Freely moving analysis"
author: "Viktor Plattner"
output:
  html_document:
    number_sections: yes
    df_print: paged
    toc: yes
    toc_float: yes
  pdf_document:
    number_sections: yes
    toc: yes
    keep_tex: true
  html_notebook:
    number_sections: yes
    toc: yes
    toc_float: yes
spacing: single
fontsize: 12pt
always_allow_html: yes
header-includes:
   - \usepackage{animate}

params:
  selected_animal: "GIIFM18b"


knit: (
  function (inputFile, encoding) {
    
    rmarkdown::render(  
      input = inputFile,
      encoding = encoding,
      output_file = file.path(
        "notebook_html", 
        paste0("freely_moving_analysis_", 
        rmarkdown::yaml_front_matter(inputFile)$params$selected_animal,
        "_",
        Sys.Date(),
         ".html")
        ),
      envir = globalenv()
      )
    }
---

```{=html}
<style type="text/css">

body{ /* Normal  */
      font-size: 14px;
      font-family: "Arial", Helvetica, sans-serif;
  }
td {  /* Table  */
  font-size: 12px;
}
h1.title {
  font-size: 38px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #4d4e4f;
}
h1 { /* Header 1 */
  font-size: 28px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #2c3a3e;
}
h2 { /* Header 2 */
  font-size: 22px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #2c3a3e;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #2c3a3e;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>
```
```{r setup, include=FALSE}
### cheks all the used libraries in the project. Removes duplicates
### list of libraries mentioned in the R scripts of the project
library(tidyverse)

liblist <- map(
  list.files(pattern = ".Rmd|.R"),
  ~ readLines(con = .x) %>%
    grep(pattern = "library\\(", x = ., value = T)
) %>%
  unlist() %>%
  substr(
    start = 9,
    stop = regexpr(text = ., pattern = "\\)") - 1 %>% # regexpr: in case of multiple matches it only takes the first one
      as.vector()
  ) %>%
  `[`(!duplicated(.))

### list of installed packages
pkgs <- installed.packages() %>%
  as_tibble() %>%
  pull(1)

### packages that are needed but not installed
c(liblist[which(!liblist %in% pkgs)])

### installs uninstalled packages
install.packages(c(liblist[which(!liblist %in% pkgs)]))

### loads all libraries
lapply(liblist %>% as.list(), require, character.only = TRUE)




### defining global constants, filters and plot scales

library(imputeTS)

scale <- 1.38 ### pixel/mm
fps <- 25 ### frame rate
standard_stim_length <- 10 ### this is the most commonly used stimulus length (in seconds)
around_stim_length <- fps * 8

time_res <- 1 / fps ### time between frames
ang_threshold <- 90
mouse_speed_mps <- 3.3



datapoint_to_plot <- 5

global_facet_theme <- theme(
  strip.text = element_text(size = 15),
  axis.text = element_text(size = 12),
  axis.title = element_text(size = 15)
)

xlim_mm <- c(0, 1280 / scale)
ylim_mm <- c(0, 720 / scale)

selected_animal <- params$selected_animal
selected_intensities <- c("1 mW", "5 mW", "10 mW")
control_animals <- c("GIIFM34b", "GIIFM35b", "GIIFM36b", "GIIFM37b")

`%!in%` <- Negate(`%in%`)




### custom functions used in the analysis



### removing junk animals from the data

RawDataFilter <- function(df) {
  # browser()
  df %>%
    dplyr::filter(
      stringr::str_detect(animal, pattern = "b")
    ) %>%
    as_tibble() %>%
    return()
}
```

# Loading and orginising data

## Global constants and scales

<br> These are defined in the "setup" chunk <br>

-   **scale**: 1.38 (pixels/mm) <br>
-   **fps**: `r fps` (frame rate) <br>
-   **time_res**: 1/**fps** = `r 1/fps` (time between frames) <br>
-   **xlim_mm**, **ylim_mm**: pixels converted to mm (`r paste0(xlim_mm, ":", ylim_mm)`)
-   **global_facet_theme**: plot text sizes
-   **datapoint_to_plot**: which datapoint to plot *(frame %% datapoint_to_plot == 0)*
-   **text_layer**: stimulus intensity in each session (used to create the text layer on plots, defined after "coords" was created)

<br>

**Current animal**: `r selected_animal`\
<br> For the trajectories and traveled distance plots every `r datapoint_to_plot`th frame (data point) was used. <br> The global angle threshold used in this file is `r ang_threshold`. Grater rotation angles between consecutive frames are replaced by zero

**Control animals**: GIIFM34b, GIIFM35b, GIIFM36b, GIIFM37b

<br>

## Loading stimulus times (frames)

<br>

This sections loads the stimulus times from a csv file

```{r warning=F, message=F, echo=FALSE}
stims <- read.csv(file.path("data", "PnO_stim_rotation", "rotation_stims.csv")) %>%
  as_tibble() %>%
  ### filter junk data
  dplyr::filter(
    stringr::str_detect(animal, pattern = "b")
  ) %>%
  mutate(
    intensity = paste0(intensity, " mW"),
    stim_length = end - start
  ) %>%
  select(-stim_duration) %>%
  rename("stim_number" = stim.number) %>%
  gather(key = "timing", value = "frame", start, end)

stims %>%
  dplyr::filter(animal == selected_animal) %>%
  head(100)
```

## Loading coordinates

<br>

This sections loads the stimulus times from a csv file

```{r message=F, echo = FALSE, warning = FALSE}
coords_raw <- read.csv(file.path("data", "PnO_stim_rotation", "rotation_all.csv")) %>%
  as_tibble() %>%
  ### filter junk data
  dplyr::filter(
    stringr::str_detect(animal, pattern = "b")
  ) %>%
  mutate(
    animal = gsub(pattern = ".*rotation", replacement = "", animal) %>%
      str_remove_all(pattern = "\\\\") %>% str_remove(pattern = "fix") %>% str_remove(pattern = "control")
  ) %>%
  full_join(stims) %>%
  ### creating unique session IDs
  group_by(animal) %>%
  mutate(
    s2 = lag(session, default = "1"),
    s3 = ifelse(s2 == session, 0, 1),
    session = cumsum(s3),
    session = paste0("session_", session)
  ) %>%
  select(-s2, -s3) %>%
  ungroup() %>%
  dplyr::group_by(animal, session) %>%
  dplyr::mutate(
    stim_number = ifelse(timing == "end", NA, stim_number)
  ) %>%
  mutate(grp = cumsum(!is.na(stim_number))) %>%
  dplyr::group_by(animal, session, grp) %>%
  fill(timing) %>%
  mutate(
    stim_freq = replace(stim_freq, timing == "start", stim_freq[1]),
    stim_freq = replace(stim_freq, timing == "end", NA),
    stim_length = replace(stim_length, timing == "start", stim_length[1]),
    stim_length = replace(stim_length, timing == "end", NA),
    intensity = replace(intensity, timing == "start", intensity[1]),
    intensity = replace(intensity, timing == "end", NA),
    stim_number = replace(stim_number, timing == "start", stim_number[1]),
    stim_number = replace(stim_number, timing == "end", NA),
    stim_side = replace(stim_side, timing == "start", stim_side[1]),
    stim_side = replace(stim_side, timing == "end", NA),
    quality = replace(quality, timing == "start", quality[1]),
    quality = replace(quality, timing == "end", NA),
    stim = F,
    stim = replace(stim, timing == "start", T)
  ) %>%
  ungroup() %>%
  group_by(animal, session) %>%
  dplyr::mutate(
    rec_time = (frame / fps) %>% round(digits = 2),
    stim_categ = case_when(
      stim == T ~ "stim",
      lead(stim, n = around_stim_length) == T ~ "before stim",
      lag(stim, n = around_stim_length) == T ~ "after stim",
      stim == F ~ "no stim"
    ),

    ### shift values to the beginning of the stimulus block to be able to fill missing values in the next step
    stim_block = ifelse(stim_categ == "no stim", F, T),
    stim_number = lead(stim_number, n = around_stim_length),
    intensity = lead(intensity, n = around_stim_length),
    stim_freq = lead(stim_freq, n = around_stim_length),
    stim_side = lead(stim_side, n = around_stim_length),
    quality = lead(quality, n = around_stim_length)
  ) %>%
  ungroup() %>%
  group_by(animal, session, stim_block) %>%
  fill(stim_number) %>%
  fill(intensity) %>%
  fill(stim_freq) %>%
  fill(stim_side) %>%
  fill(quality) %>%
  # length of the stimulus
  unite(col = "head", head1, head2, sep = "_") %>%
  unite(col = "center", center1, center2, sep = "_") %>%
  unite(col = "tail", tail1, tail2, sep = "_") %>%
  gather(
    key = "body_part",
    value = "coordinate",
    head, center, tail
  ) %>%
  tidyr::extract(col = coordinate, into = c("X", "Y"), regex = "([[:alnum:]]+)_([[:alnum:]]+)") %>%
  dplyr::mutate(
    X = replace(X, miss == 0, NA),
    Y = replace(Y, miss == 0, NA)
  ) %>%
  dplyr::mutate(
    stim_number = replace(stim_number, is.na(stim_number), "no stim")
  )
```

<br> Filtering raw data <br>

```{r}
coords <- coords_raw %>%
  dplyr::filter(
    body_part != "tail",
    animal != "GIIFM14b",
  ) %>%
  ### this block calculates distances and speed across frames
  dplyr::group_by(animal, body_part, session) %>%
  dplyr::mutate(

    ### interpolating missing values
    X_interp = imputeTS::na_interpolation(X %>% as.integer()) %>% round(),
    Y_interp = imputeTS::na_interpolation(Y %>% as.integer()) %>% round(),
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),

    ### sometimes the tracking software looses the point and jumps back and forth between unrealistic numbers or starts to follow something else
    ### these points are replaced by 0 (the animal did not change position between those frames)
    ### outliers are defined as Q1 - 3*IQR, Q3 + 3*IQR

    X_diff = ifelse(
      test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
        X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
      yes = 0,
      no = X_diff
    ),
    Y_diff = ifelse(
      Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
        Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
      yes = 0,
      no = Y_diff
    ),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000,
    sec_counter = cumsum(ifelse(rec_time %% 1 == 0, 1, 0))
  ) %>%
  group_by(animal, session, body_part, sec_counter) %>%
  dplyr::mutate(speed_sec = sum(d_mm, na.rm = T)) %>%
  ungroup() %>%
  dplyr::filter(
    quality != "bad" | is.na(quality),
    stim_number %in% c("1", "2", "3", "4", "5", "no stim")
  )



coords %>%
  dplyr::filter(animal == selected_animal) %>%
  dplyr::group_by(session, body_part) %>%
  slice(1:5)
```

<br> Length of stimuli, number of repeats of each stimulus with a given intensity <br>

```{r message=F, warning=F, echo=F, include=F}
lengths <- coords %>%
  dplyr::filter(
    body_part == "head",
    stim_categ != "no stim",
  ) %>%
  group_by(animal, session, stim_number, intensity, quality) %>%
  count(stim_categ) %>%
  spread(stim_categ, n) %>%
  select(animal, session, stim_number, intensity, quality, `before stim`, stim, `after stim`)


n_repeat <- lengths %>%
  dplyr::group_by(animal, intensity) %>%
  dplyr::filter(intensity %in% selected_intensities) %>%
  summarise(length(stim_number))


# full_join(
#   lengths,
#   stims %>% spread(timing, frame) %>%
#     select(animal, session, stim_number, start, end) %>%
#     mutate(stim_number = stim_number %>% as.character())
# ) %>% write_csv(file.path("output_data", "stim_lengths.csv"))


# lengths %>% dplyr::filter(animal != "GIIFM14b", stim_categ == "after stim") %>% View()
```

```{r include=FALSE}

### Saving separate csv files

# tibble_list <- coords %>%
#   dplyr::filter(
#     str_detect(animal, pattern = "b")
#     ) %>%
#   rename(video = session) %>%
#   dplyr::group_split(animal, video)
#
#
# csv_name_list <- lapply(tibble_list, function(x){
#   paste0(x %>% pull(animal) %>% unique(), "_video_", x %>% pull(video) %>% unique(), ".csv")
# }) %>% unlist()
#
# mapply(write_csv, x = tibble_list, file = file.path("output_data", "separate_csv", csv_name_list))
#
#
#
# coords %>% names()
# coords %>%
#   select(session,animal,frame,stim_number,stim_categ, X, Y, body_part) %>%
#   # unite(col = "sess_anim", session, animal, sep = "_") %>%
#   unite(col = "coordinates", X, Y, sep = "_" ) %>%
#   tidyr::spread(key = body_part, value = coordinates)


# reshape(timevar = "body_part", direction = "wide") %>% View()


# reshape(idvar = "animal", timevar = "body_part", direction = "wide") %>% View()
#
#
#
# group_by(animal, session) %>%
# tidyr::spread(
#   key = body_part,
#   value = X) %>% View()
```

<br> Creating text layer to add intensity values to plots <br>

```{r}
text_layer <- coords %>%
  dplyr::filter(
    animal == selected_animal,
    stim == T
  ) %>%
  group_by(session) %>%
  summarise(int_label = intensity %>% unique())
```

<br> Creating plot colors <br>

```{r}
gg_color_hue <- function(n) {
  hues <- seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}

n <- 6
cols <- gg_color_hue(n)
```

# Analysis (selected animal: `r selected_animal`)

## Checking tracking quality

Plotting X and Y positions vs time separately to see jumps in the tracking data and big separation between head-ceter-tail coordinates (unrealistically big mouse). The tracking software occasionally lost the animal and started to follow different points. If there are many of those the session cannot be analysed.

```{r warning=FALSE, fig.width=15, fig.height=10, echo = FALSE}

plt_xpos <- coords %>%
  dplyr::filter(animal == selected_animal, body_part != "tail") %>%
  ggplot(mapping = aes(x = rec_time, y = X_interp %>% as.integer())) +
  geom_line(aes(col = body_part)) +
  theme(legend.position = "none") +
  ylab("X position") +
  facet_wrap(~session, ncol = 1) +
  ggtitle(paste0("X position: ", selected_animal))



plt_ypos <- coords %>%
  dplyr::filter(animal == selected_animal, body_part != "tail") %>%
  ggplot(mapping = aes(x = rec_time, y = Y %>% as.integer())) +
  geom_line(aes(col = body_part)) +
  theme(legend.position = "none") +
  ylab("Y position") +
  facet_wrap(~session, ncol = 1) +
  ggtitle(paste0("Y position: ", selected_animal))

cowplot::plot_grid(plt_xpos, plt_ypos, ncol = 2)
```

<br> Plotting head-center distances over time. Dashed lines represent the outlier threshold (+- 1.5\*IQR) <br>

```{r fig.width=10, fig.height=10, echo = FALSE, message=FALSE, warning=FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part != "tail"
  ) %>%
  dplyr::group_by(session, frame) %>%
  dplyr::mutate(
    dx = diff(X_interp),
    dy = diff(Y_interp),
    # ldx = lead(dx),
    # ldy = lead(dy),
    hc_d = sqrt(dx^2 + dy^2)
  ) %>%
  ungroup() %>%
  dplyr::filter(body_part == "center") %>%
  ggplot(
    mapping = aes(x = rec_time, y = hc_d)
  ) +
  geom_hline(
    aes(yintercept = quantile(hc_d, na.rm = T)["25%"] - 1.5 * IQR(hc_d, na.rm = T)),
    col = "gray50",
    lty = "dashed"
  ) +
  geom_hline(
    aes(yintercept = quantile(hc_d, na.rm = T)["75%"] + 1.5 * IQR(hc_d, na.rm = T)),
    col = "gray50",
    lty = "dashed"
  ) +
  geom_line(
    aes(col = stim, group = 1)
  ) +
  geom_label_repel(
    data = . %>%
      dplyr::filter(stim_number != "no stim", stim_categ == "stim") %>%
      dplyr::group_by(session, stim_number) %>%
      slice(1),
    aes(
      x = rec_time,
      y = mean(hc_d, na.rm = T),
      label = quality
    ),
    direction = "x",
    nudge_x = 1
  ) +
  facet_wrap(~session, ncol = 1, scales = "free_y") +
  coord_cartesian(
    ylim = c(20, 130)
  ) +
  global_facet_theme
```

<br> Histograms of head-center distances with boxplots and outliers. <br>

```{r fig.height=10, fig.width=10, message=FALSE, warning=FALSE, echo=FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part != "tail"
  ) %>%
  dplyr::group_by(session, frame) %>%
  dplyr::mutate(
    dx = diff(X_interp),
    dy = diff(Y_interp),
    # ldx = lead(dx),
    # ldy = lead(dy),
    hc_d = sqrt(dx^2 + dy^2)
  ) %>%
  ggplot(mapping = aes(x = hc_d / scale)) +
  geom_histogram() +
  geom_boxplot(aes(y = 1000), width = 300, outlier.colour = "magenta", col = "blue", alpha = 0.1) +
  facet_grid(session ~ body_part) +
  global_facet_theme
```

<br> Plotting first five head-center distances. <br>

```{r fig.width=10, fig.height=10, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    session == "session_3",
    body_part != "tail"
  ) %>%
  dplyr::group_by(session, frame) %>%
  # dplyr::arrange(body_part) %>%
  dplyr::mutate(
    dx = diff(X_interp),
    dy = diff(Y_interp),
    # ldx = lead(dx),
    # ldy = lead(dy),
    hc_d = sqrt(dx^2 + dy^2)
  ) %>%
  dplyr::group_by(body_part) %>%
  dplyr::slice(1:5) %>%
  ggplot(
    mapping = aes(x = X_interp, y = Y_interp, label = frame)
  ) +
  geom_line(
    aes(group = frame, col = frame %>% as.character()),
  ) +
  geom_point(
    aes(shape = body_part, col = frame %>% as.character()),
    size = 2
  ) +
  geom_label_repel(
    data = . %>% dplyr::filter(body_part == "head"),
    aes(
      x = X_interp + dx / 2,
      y = Y_interp + dy / 2,
      label = hc_d %>% round(4)
    ),
    direction = "x",
    nudge_x = -.7
  )
```

## Dealing with missing coordinates

The tracking software occasionally lost the tracked points. To fill those gaps linear interpolation was applied. The figure below shows the interpolated values in red. Note that only every 5th frame was used for the tracking and for the later analysis except for calculating the rotation angle.

```{r fig.width=10, fig.height=10, warning=FALSE, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    frame %% datapoint_to_plot == 0
  ) %>%
  group_by(session, sec_counter) %>%
  mutate(d_sec = sum(d_mm, na.rm = T)) %>%
  ggplot(
    mapping = aes(x = X_interp, y = Y_interp, label = frame)
  ) +
  geom_point(
    aes(
      color = miss %>% as.character(),
      shape = stim,
      alpha = ifelse(miss == "1", 0.1, 1)
    )
  ) +
  xlim(c(0, 1280)) +
  ylim(c(0, 720)) +
  facet_wrap(~session, ncol = 2) +
  scale_color_discrete(name = "Interpolated values") +
  geom_label(data = text_layer, aes(x = Inf, y = -Inf, hjust = 1.1, vjust = -0.5, label = paste0("Intensity: ", int_label))) +
  global_facet_theme
```

## Plotting trajectories

To show the animals trajectory during stimuli the head-center-tail body points were plotted. Colors correspond to the order of stimuli in each session. The black points represent the trajectory when there was no stimulus. For visualization purposes the number of plotted data points are different during the stimulus vs non-stimulus period (2 data points/sec vs 6 data points/sec respectively). For the statistical analysis similar data point rate was used for the two states.

```{r warning=FALSE, fig.width=10, fig.height=10, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    stim == T,
    frame %% 15 == 0
  ) %>%
  ggplot(
    mapping = aes(x = X_interp / scale, y = Y_interp / scale, label = frame)
  ) +

  ### drawing positions during no stimulus
  ### "coords" was filtered differently compared to the stimulus dataset (number of frames)
  geom_point(
    data = coords %>%
      dplyr::filter(
        animal == selected_animal,
        body_part == "center",
        stim == F,
        frame %% 5 == 0
      ),
    size = 1,
    alpha = 0.1
  ) +

  ### drawing positions during stimulus
  ### body parts are connected by lines
  geom_line(
    aes(group = frame, col = as.character(stim_number)),
  ) +
  geom_point(
    aes(shape = body_part, col = as.character(stim_number)),
    size = 2
  ) +
  xlim(c(0, 1280 / scale)) +
  ylim(c(0, 720 / scale)) +
  facet_wrap(~session, ncol = 2, ) +
  geom_label(data = text_layer, aes(x = Inf, y = -Inf, hjust = 1.1, vjust = -0.5, label = paste0("Intensity: ", int_label))) +
  labs(col = "Stimulus number", shape = "Body part") +
  xlab("X position [mm]") +
  ylab("Y position [mm]") +
  global_facet_theme
```

```{r message=FALSE, fig.width=10, fig.height=10, echo = FALSE, warning=FALSE, include=F}
## Plotting speed in a 1 sec (`r fps` frames) window

# Speed of the animal in 1 sec windows. Darker colors represent slower speed.


coords %>%
  dplyr::filter(animal == selected_animal, body_part == "center") %>%
  group_by(session, sec_counter) %>%
  mutate(d_sec = sum(d_mm, na.rm = T)) %>%
  ggplot(
    mapping = aes(x = X_interp, y = Y_interp, label = frame)
  ) +
  geom_point(aes(color = d_sec %>% scale(), alpha = stim)) +
  xlim(c(0, 1280)) +
  ylim(c(0, 720)) +
  facet_wrap(~session, ncol = 2) +
  geom_label(data = text_layer, aes(x = Inf, y = -Inf, hjust = 1.1, vjust = -0.5, label = paste0("Intensity: ", int_label))) +
  global_facet_theme
```

## Distribution of the distance between points

Cumulative distribution functions and histograms of the difference between consecutive X and Y coordinates and calculated traveled distances across frames. Most of the values are realistic but there are some big jumps probably due to errors in the tracking. The unrealistically big jumps were excluded from the analysis (when "coords" data frame was created). Here only the realistic differences are shown.

```{r, message=F, warning=F,  fig.width=10,fig.height=25, message=FALSE, echo = FALSE}
coords %>%
  dplyr::group_by(animal, body_part, session) %>%
  ggplot(mapping = aes(x = X_diff)) +
  stat_ecdf(
    aes(
      col = session %>% as.factor()
    ),
    geom = "point"
  ) +
  facet_grid(~animal ~ body_part) +
  global_facet_theme
```

```{r message=FALSE}
coords %>%
  group_by(animal, body_part, session) %>%
  dplyr::filter(animal == selected_animal) %>%
  summarise(min = min(X_diff, na.rm = T), max = max(X_diff, na.rm = T))
```

```{r message=F, warning=F, fig.width=10, fig.height=25, echo = FALSE}
coords %>%
  ggplot(mapping = aes(x = X_diff)) +
  geom_histogram(
    aes(
      fill = session %>% as.factor()
    ),
    binwidth = 5
  ) +
  scale_y_continuous(trans = "log10") +
  facet_grid(animal ~ body_part, scales = "free") +
  global_facet_theme
```

```{r message=FALSE}
coords %>%
  group_by(animal, body_part, session) %>%
  dplyr::filter(animal == selected_animal) %>%
  summarise(min = min(Y_diff, na.rm = T), max = max(Y_diff, na.rm = T))
```

Distribution of distance

```{r message=F, warning=F, fig.width=10, fig.height=25, echo = FALSE}
coords %>%
  ggplot(mapping = aes(x = d_mm)) +
  geom_histogram(aes(fill = session %>% as.factor()), binwidth = 5) +
  facet_grid(animal ~ body_part, scales = "free") +
  global_facet_theme +
  scale_y_continuous(trans = "log10")
```

## Recalculating distances between tracked points after leaving out frames

```{r fig.width=10, fig.asp=1, echo = FALSE}

plt_xlim <- coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    # frame %% datapoint_to_plot == 0
  ) %>%
  dplyr::slice(1:11) %>%
  pull(X_interp) %>%
  range() + c(-1, 1)

plt_ylim <- coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    # frame %% datapoint_to_plot == 0
  ) %>%
  dplyr::slice(1:11) %>%
  pull(Y_interp) %>%
  range() + c(-1, 1)


plt1_path <- coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    session == "session_1"
  ) %>%
  dplyr::slice(1:6) %>%
  dplyr::arrange(frame) %>% ### to be used with geom_path
  ggplot(
    mapping = aes(x = X_interp, y = Y_interp)
  ) +
  geom_text(
    aes(
      color = frame %>% as.factor(),
      label = frame
    ),
    size = 6
  ) +
  geom_segment(
    aes(
      x = X_interp[1], xend = X_interp[2],
      y = Y_interp[1], yend = Y_interp[1]
    ),
    linetype = "dashed", col = "red"
  ) +
  geom_segment(
    aes(
      x = X_interp[2], xend = X_interp[2],
      y = Y_interp[1], yend = Y_interp[2]
    ),
    linetype = "dashed", col = "red"
  ) +
  geom_path(col = "gray", linetype = "dashed") +
  geom_label_repel(
    data = . %>% dplyr::slice(1:5),
    aes(
      x = X_interp + X_diff / 2,
      y = Y_interp + Y_diff / 2,
      label = d %>% round(4)
    ),
    direction = "x",
    nudge_x = -.7
  ) +
  theme(legend.position = "none") +
  xlim(plt_xlim) +
  ylim(plt_ylim) +
  coord_fixed(ratio = 1)


plt2_path <- coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    session == "session_1",
    frame %% datapoint_to_plot == 0
  ) %>%
  ### recalculates distances after frames were removed
  dplyr::group_by(session) %>%
  dplyr::mutate(
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),
    X_diff = ifelse(
      test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
        X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
      yes = 0,
      no = X_diff
    ),
    Y_diff = ifelse(
      Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
        Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
      yes = 0,
      no = Y_diff
    ),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000
  ) %>%
  dplyr::slice(1:2) %>%
  dplyr::arrange(frame) %>% ### to be used with geom_path
  ggplot(
    mapping = aes(x = X_interp, y = Y_interp)
  ) +
  geom_text(
    aes(
      color = frame %>% as.factor(),
      label = frame
    ),
    size = 6
  ) +
  geom_segment(
    aes(
      x = X_interp[1], xend = X_interp[2],
      y = Y_interp[1], yend = Y_interp[1]
    ),
    linetype = "dashed", col = "red"
  ) +
  geom_segment(
    aes(
      x = X_interp[2], xend = X_interp[2],
      y = Y_interp[1], yend = Y_interp[2]
    ),
    linetype = "dashed", col = "red"
  ) +
  geom_path(col = "gray", linetype = "dashed") +
  geom_label_repel(
    data = . %>% dplyr::slice(1:1),
    aes(
      x = X_interp + X_diff / 2,
      y = Y_interp + Y_diff / 2,
      label = d %>% round(4)
    ),
    direction = "x",
    nudge_x = -.7
  ) +
  theme(legend.position = "none") +
  xlim(plt_xlim) +
  ylim(plt_ylim) +
  coord_fixed(ratio = 1)

library(cowplot)

cowplot::plot_grid(plt1_path, plt2_path, ncol = 2)
```

## Instantaneous traveled distance

Plotting the traveled distance based on one of the three tracked body parts during stimulus and non-stimulus periods at the rate of 6 data point/sec.

### Center

```{r fig.width=10, fig.height=10, echo = FALSE, warning=F}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    frame %% datapoint_to_plot == 0
  ) %>%
  ### recalculates distances after frames were removed
  dplyr::group_by(session) %>%
  dplyr::mutate(
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),
    X_diff = ifelse(
      test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
        X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
      yes = 0,
      no = X_diff
    ),
    Y_diff = ifelse(
      Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
        Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
      yes = 0,
      no = Y_diff
    ),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000
  ) %>%
  ### plotting
  ggplot(mapping = aes(x = rec_time, y = d_mm)) +
  geom_line(aes(color = stim, group = 1)) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label))) +
  facet_wrap(~session, scales = "free", ncol = 1) +
  ggtitle(paste0(selected_animal, " instantaneous traveled distance ", "(center)")) +
  global_facet_theme
```

### Head

```{r fig.width=10, fig.height=10, echo = FALSE, warning=FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "head",
    frame %% datapoint_to_plot == 0
  ) %>%
  ### recalculates distances after frames were removed
  dplyr::mutate(
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),
    X_diff = ifelse(
      test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
        X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
      yes = 0,
      no = X_diff
    ),
    Y_diff = ifelse(
      Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
        Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
      yes = 0,
      no = Y_diff
    ),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000
  ) %>%
  ### plotting
  ggplot(mapping = aes(x = rec_time, y = d_mm)) +
  geom_line(aes(color = stim, group = 1)) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label))) +
  facet_wrap(~session, scales = "free", ncol = 1) +
  ggtitle(paste0(selected_animal, " instantaneous traveled distance ", "(head)")) +
  global_facet_theme
```

## Rolling mean of traveled distance

Plotting the mean traveled distance calculated in a rolling window (1 sec). The mean was calculated separately during stimulus (rolling window restarts with the beginning of stimuli). Colors represent different periods of the recording (no-stimulus, before stimulus, during stimulus, after stimulus).

Defining line colors

```{r}
line_cols <- gg_color_hue(3)

group_colors <- c("no stim" = "gray30", "before stim" = line_cols[1], "stim" = line_cols[3], "after stim" = line_cols[2])
group_colors2 <- c("no stim" = "gray30", "right before" = line_cols[1], "stim" = line_cols[3], "right after" = line_cols[2])
```

### Example session

```{r message=F, fig.width=12, warning=F, echo = FALSE}

coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    session == "session_3",
    frame %% datapoint_to_plot == 0
  ) %>%
  ### recalculates distances after frames were removed
  dplyr::group_by(session) %>%
  dplyr::mutate(
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),
    X_diff = ifelse(
      test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
        X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
      yes = 0,
      no = X_diff
    ),
    Y_diff = ifelse(
      Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
        Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
      yes = 0,
      no = Y_diff
    ),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000
  ) %>%
  dplyr::group_by(stim) %>%
  dplyr::mutate(mean_mps_roll = zoo::rollmean(x = d_mm, k = fps, fill = NA)) %>%
  ### plotting
  ggplot(aes(x = rec_time, y = d_mm)) +
  geom_point(aes(alpha = stim)) +
  geom_line(aes(x = rec_time, y = mean_mps_roll, col = stim_categ, group = 1), size = .8) +
  ggtitle(paste0(selected_animal, " mean traveled distance by stimulus period ", "(center)")) +
  scale_color_manual(values = group_colors)
```

### Center

```{r fig.width=12, fig.height=12, warning=FALSE, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    frame %% datapoint_to_plot == 0
  ) %>%
  ### recalculates distances after frames were removed
  dplyr::group_by(session) %>%
  dplyr::mutate(
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),
    X_diff = ifelse(
      test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
        X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
      yes = 0,
      no = X_diff
    ),
    Y_diff = ifelse(
      Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
        Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
      yes = 0,
      no = Y_diff
    ),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000
  ) %>%
  dplyr::group_by(session, stim_categ) %>%
  dplyr::mutate(mean_mps_roll = zoo::rollmean(x = d_mm, k = fps, fill = NA)) %>%
  ### plotting
  ggplot(aes(x = rec_time, y = d_mm)) +
  geom_point(aes(alpha = stim)) +
  geom_line(aes(x = rec_time, y = mean_mps_roll, col = stim_categ, group = 1), size = 1) +
  facet_wrap(~session, scales = "free", ncol = 1) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label))) +
  ggtitle(paste0(selected_animal, " mean traveled distance by stimulus period ", "(center)")) +
  scale_color_manual(values = group_colors) +
  global_facet_theme
```

### Head

```{r fig.width=12, fig.height=12, warning=F, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "head",
    frame %% datapoint_to_plot == 0
  ) %>%
  ### recalculates distances after frames were removed
  dplyr::group_by(session) %>%
  dplyr::mutate(
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),
    X_diff = ifelse(
      test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
        X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
      yes = 0,
      no = X_diff
    ),
    Y_diff = ifelse(
      Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
        Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
      yes = 0,
      no = Y_diff
    ),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000
  ) %>%
  dplyr::group_by(session, stim_categ) %>%
  dplyr::mutate(mean_mps_roll = zoo::rollmean(x = d_mm, k = fps, fill = NA)) %>%
  ### plotting
  ggplot(aes(x = rec_time, y = d_mm)) +
  geom_point(aes(alpha = stim)) +
  geom_line(aes(x = rec_time, y = mean_mps_roll, col = stim_categ, group = 1), size = 1) +
  facet_wrap(~session, scales = "free", ncol = 1) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label))) +
  ggtitle(paste0(selected_animal, " mean traveled distance by stimulus period ", "(head)")) +
  scale_color_manual(values = group_colors) +
  global_facet_theme
```

```{r fig.width=10, fig.height=10, include=F, echo=F, eval=F}
coords %>%
  dplyr::select(animal, session, frame, rec_time, stim_categ, body_part, d_mm, X_diff, Y_diff, stim_number) %>%
  mutate(stim_number = replace(stim_number, stim_number == "no stim", NA)) %>%
  dplyr::filter(
    animal == "GIIFM22b",
    body_part == "center",
    # X_diff < 20, X_diff > -20, Y_diff < 20, Y_diff > -20,
    stim_categ != "no stim"
  ) %>%
  group_by(session, stim_categ) %>%
  mutate(categ_timer = (row_number() / fps) %>% round(digits = 2)) %>%
  ungroup() %>%
  group_by(session) %>%
  mutate(stim_block_number = stim_number) %>%
  fill(stim_block_number, .direction = "down") %>%
  ggplot(aes(x = categ_timer, y = d_mm, group = stim_categ)) +
  geom_line(aes(col = stim_categ)) +
  facet_wrap(~session, ncol = 1, scales = "free") +
  global_facet_theme
```

## Sum traveled distance by individual stimuli within session (full length before and after the stimulus)

Plotting traveled distance during individual stimuli (4 to 6 repeats) within sessions. Traveled distance is summed through the full duration of the stimulus (\~10s) and `r around_stim_length / fps`s "before stimulus". Traveled distance "after stimulus" is not included. <br>

The same data is shown on the plots with different groupings: <br>

-   intensities are grouped together (colors), stimulus numbers are separated (panels) <br>
-   stimulus numbers are grouped together (colors), intensities are separated (panels) <br>

```{r message=F, fig.width=12, fig.height=8, warning=F, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    stim_categ %!in% c("no stim", "after stim"),
    intensity %in% selected_intensities,
    frame %% datapoint_to_plot == 0
  ) %>%
  ### recalculates distances after frames were removed
  dplyr::group_by(session) %>%
  dplyr::mutate(
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),
    X_diff = ifelse(
      test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
        X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
      yes = 0,
      no = X_diff
    ),
    Y_diff = ifelse(
      Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
        Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
      yes = 0,
      no = Y_diff
    ),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000
  ) %>%
  dplyr::group_by(intensity, stim_number, stim_categ) %>%
  dplyr::summarise(sum_d = sum(d, na.rm = T)) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim"),
      y = sum_d
    )
  ) +
  geom_point(aes(fill = factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))), shape = 21, size = 4) +
  facet_wrap(~stim_number) +
  geom_line(aes(group = intensity)) +
  ggtitle(paste0(selected_animal, " sum traveled distance by individual stimuli within session ", "(center)")) +
  labs(
    fill = "Intensity",
    x = "Stimulus period",
    y = "Sum traveled distance [pixel]"
  ) +
  global_facet_theme
```

```{r message=F, fig.width=12, fig.height=4, warning=F, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    stim_categ %!in% c("no stim", "after stim"),
    intensity %in% selected_intensities,
    frame %% datapoint_to_plot == 0
  ) %>%
  ### recalculates distances after frames were removed
  dplyr::group_by(session) %>%
  dplyr::mutate(
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),
    X_diff = ifelse(
      test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
        X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
      yes = 0,
      no = X_diff
    ),
    Y_diff = ifelse(
      Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
        Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
      yes = 0,
      no = Y_diff
    ),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000
  ) %>%
  dplyr::group_by(intensity, stim_number, stim_categ) %>%
  dplyr::summarise(sum_d = sum(d, na.rm = T)) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim"),
      y = sum_d
    )
  ) +
  geom_point(aes(fill = stim_number), shape = 21, size = 4) +
  facet_wrap(~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))) +
  geom_line(aes(group = stim_number)) +
  ggtitle(paste0(selected_animal, " sum traveled distance by individual stimuli within session ", "(center)")) +
  labs(
    fill = "Stimulus number",
    x = "Stimulus period",
    y = "Sum traveled distance [pixel]"
  ) +
  global_facet_theme
```

## Sum traveled distance by individual stimuli within session (1s before and during the stimulus)

Plotting traveled distance during individual stimuli (4 to 6 repeats) within sessions. Traveled distance is summed through the last second of "before stimulus" category and through first second of the stimulus. Traveled distance "after stimulus" is not included. <br>

The same data is shown on the plots with different groupings: <br>

-   intensities are grouped together (colors), stimulus numbers are separated (panels) <br>
-   stimulus numbers are grouped together (colors), intensities are separated (panels) <br>

<br> The table shows the filtered data (1s before and 1s during stimulus) <br>

```{r message=F, warning=F, echo=F}
coords_1s_window <- bind_rows(
  ### before stim
  coords %>%
    dplyr::filter(
      frame %% datapoint_to_plot == 0,
      stim_categ == "before stim"
    ) %>%
    ### recalculates distances after frames were removed
    dplyr::group_by(animal, body_part, session) %>%
    dplyr::mutate(
      X_diff = c(diff(X_interp), NA) %>% round(4),
      Y_diff = c(diff(Y_interp), NA) %>% round(4),
      X_diff = ifelse(
        test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
          X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
        yes = 0,
        no = X_diff
      ),
      Y_diff = ifelse(
        Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
          Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
        yes = 0,
        no = Y_diff
      ),
      d = sqrt(X_diff^2 + Y_diff^2),
      d_mm = d / scale,
      speed_instant = d_mm / time_res,
      mmps = speed_instant * (1 / time_res),
      mps = (speed_instant * (1 / time_res)) / 1000
    ) %>%
    dplyr::group_by(animal, body_part, intensity, stim_categ, stim_number) %>%
    # dplyr::top_n(6),
    dplyr::slice(tail(row_number(), 6)),
  ### stim
  coords %>%
    dplyr::filter(
      frame %% datapoint_to_plot == 0,
      stim_categ == "stim"
    ) %>%
    ### recalculates distances after frames were removed
    dplyr::group_by(animal, body_part, session) %>%
    dplyr::mutate(
      X_diff = c(diff(X_interp), NA) %>% round(4),
      Y_diff = c(diff(Y_interp), NA) %>% round(4),
      X_diff = ifelse(
        test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
          X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
        yes = 0,
        no = X_diff
      ),
      Y_diff = ifelse(
        Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
          Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
        yes = 0,
        no = Y_diff
      ),
      d = sqrt(X_diff^2 + Y_diff^2),
      d_mm = d / scale,
      speed_instant = d_mm / time_res,
      mmps = speed_instant * (1 / time_res),
      mps = (speed_instant * (1 / time_res)) / 1000
    ) %>%
    dplyr::group_by(animal, body_part, intensity, stim_categ, stim_number) %>%
    dplyr::slice(1:6)
) %>% arrange(animal, body_part, session, stim_number, stim_categ)


coords_1s_window %>%
  dplyr::filter(
    animal == selected_animal,
    intensity %in% selected_intensities
  ) %>%
  select(session, animal, frame, rec_time, stim_categ, d, stim_number, intensity, body_part, X_diff, Y_diff) %>%
  head(50)
```

```{r message=F, warning=F, echo=F}
coords_8s_window <- bind_rows(
  ### before stim
  coords %>%
    dplyr::filter(
      frame %% datapoint_to_plot == 0,
      stim_categ == "before stim"
    ) %>%
    ### recalculates distances after frames were removed
    dplyr::group_by(animal, body_part, session) %>%
    dplyr::mutate(
      X_diff = c(diff(X_interp), NA) %>% round(4),
      Y_diff = c(diff(Y_interp), NA) %>% round(4),
      X_diff = ifelse(
        test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
          X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
        yes = 0,
        no = X_diff
      ),
      Y_diff = ifelse(
        Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
          Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
        yes = 0,
        no = Y_diff
      ),
      d = sqrt(X_diff^2 + Y_diff^2),
      d_mm = d / scale,
      speed_instant = d_mm / time_res,
      mmps = speed_instant * (1 / time_res),
      mps = (speed_instant * (1 / time_res)) / 1000
    ) %>%
    dplyr::group_by(animal, body_part, intensity, stim_categ, stim_number) %>%
    # dplyr::top_n(41),
    dplyr::slice(tail(row_number(), 41)),
  ### stim
  coords %>%
    dplyr::filter(
      frame %% datapoint_to_plot == 0,
      stim_categ == "stim"
    ) %>%
    ### recalculates distances after frames were removed
    dplyr::group_by(animal, body_part, session) %>%
    dplyr::mutate(
      X_diff = c(diff(X_interp), NA) %>% round(4),
      Y_diff = c(diff(Y_interp), NA) %>% round(4),
      X_diff = ifelse(
        test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
          X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
        yes = 0,
        no = X_diff
      ),
      Y_diff = ifelse(
        Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
          Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
        yes = 0,
        no = Y_diff
      ),
      d = sqrt(X_diff^2 + Y_diff^2),
      d_mm = d / scale,
      speed_instant = d_mm / time_res,
      mmps = speed_instant * (1 / time_res),
      mps = (speed_instant * (1 / time_res)) / 1000
    ) %>%
    dplyr::group_by(animal, body_part, intensity, stim_categ, stim_number) %>%
    dplyr::slice(1:41)
) %>% arrange(animal, body_part, session, stim_number, stim_categ)


coords_8s_window %>%
  dplyr::filter(
    animal == selected_animal,
    intensity %in% selected_intensities
  ) %>%
  select(session, animal, frame, rec_time, stim_categ, d, stim_number, intensity, body_part, X_diff, Y_diff) %>%
  head(200)
```

```{r message=F, fig.width=12, fig.height=8, warning=F, echo = FALSE}
coords_1s_window %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    intensity %in% selected_intensities,
  ) %>%
  dplyr::group_by(intensity, stim_number, stim_categ) %>%
  dplyr::summarise(sum_d = sum(d, na.rm = T)) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim"),
      y = sum_d
    )
  ) +
  geom_point(aes(fill = factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))), shape = 21, size = 4) +
  facet_wrap(~stim_number) +
  geom_line(aes(group = intensity)) +
  ggtitle(paste0(selected_animal, " sum traveled distance by individual stimuli within session ", "(center)")) +
  labs(
    fill = "Intensity",
    x = "Stimulus period",
    y = "Sum traveled distance [pixel]"
  ) +
  global_facet_theme
```

```{r message=F, fig.width=12, fig.height=4, warning=F, echo = FALSE}
coords_1s_window %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    intensity %in% selected_intensities
  ) %>%
  dplyr::group_by(intensity, stim_number, stim_categ) %>%
  dplyr::summarise(sum_d = sum(d, na.rm = T)) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim"),
      y = sum_d
    )
  ) +
  geom_point(aes(fill = stim_number %>% as.factor()), shape = 21, size = 4) +
  facet_wrap(~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))) +
  geom_line(aes(group = stim_number)) +
  ggtitle(paste0(selected_animal, " sum traveled distance by individual stimuli within session ", "(center)")) +
  labs(
    fill = "Stimulus number",
    x = "Stimulus period",
    y = "Sum traveled distance [pixel]"
  ) +
  global_facet_theme
```

## Calculating angles

### Toy data

```{r}
vectors <- tibble(
  body = c("cent", "h", "cent", "h", "cent", "h", "cent", "h"),
  frame = c(0, 0, 1, 1, 2, 2, 3, 3),
  X = c(750, 760, 770, 770, 755, 765, 755, 765),
  Y = c(500, 500, 500, 520, 510, 520, 510, 500)
)
vectors %>% arrange(body)
```

```{r}
ang <- function(a, b) {
  theta <- acos(sum(a * b) / (sqrt(sum(a * a)) * sqrt(sum(b * b))))
  return(theta * 180 / pi)
}

# ang(a = c(10, 0), b = c(10, 10))

vectors %>%
  group_by(frame) %>%
  summarise(dx = diff(X), dy = diff(Y)) %>%
  mutate(ldx = lead(dx), ldy = lead(dy)) %>%
  # rowwise() %>%
  mutate(angle = ang(a = c(dx, dy), b = c(ldx, ldy))) %>%
  ungroup() %>%
  mutate(
    signed_angle = (atan2(dx, dy) - atan2(ldx, ldy)) * 180 / (pi)
  )
```

```{r}
matlib::angle(
  x = vectors %>%
    group_by(frame) %>%
    summarise(dx = diff(X), dy = diff(Y)) %>%
    dplyr::filter(frame == "0") %>%
    select(-1) %>% as.matrix() %>% as.vector(),
  y = vectors %>%
    group_by(frame) %>%
    summarise(dx = diff(X), dy = diff(Y)) %>%
    dplyr::filter(frame == "2") %>%
    select(-1) %>% as.matrix() %>% as.vector()
)
```

The dot product of two vectors x and y can be defined as:

$$x \cdot y = ||x|| * ||y|| \cos(\theta)$$

```{r}
vectors %>%
  ggplot(mapping = aes(x = X, y = Y)) +
  geom_point(aes(shape = body)) +
  geom_line(aes(group = frame, color = frame %>% as.character())) +
  geom_text_repel(aes(label = paste0(X, ",", Y), col = as.character(frame))) +
  xlim(750, 775) +
  ylim(500, 525)
```

### Real data (coords tibble)

#### First 10 head - center vectors

```{r echo = FALSE ,message=FALSE, warning=FALSE}
coords %>%
  dplyr::filter(animal == selected_animal) %>%
  dplyr::group_by(body_part) %>%
  slice(1:10) %>%
  dplyr::filter(body_part != "tail") %>%
  ggplot(
    mapping = aes(x = X, y = Y)
  ) +
  geom_point(aes(shape = body_part), size = 2) +
  geom_line(aes(group = frame, color = as.character(frame))) +
  geom_text_repel(aes(label = paste0(X, ",", Y), col = as.character(frame))) +
  geom_segment(
    data = coords %>%
      dplyr::filter(animal == selected_animal) %>%
      dplyr::group_by(body_part) %>%
      slice(1:10) %>%
      dplyr::filter(body_part != "tail", frame == 0),
    aes(
      x = X[1], xend = X[2],
      y = Y[1], yend = Y[1]
    ), linetype = "dashed", col = "red"
  ) +
  geom_segment(
    data = coords %>%
      dplyr::filter(animal == selected_animal) %>%
      dplyr::group_by(body_part) %>%
      slice(1:10) %>%
      dplyr::filter(body_part != "tail", frame == 0),
    aes(
      x = X[2], xend = X[2],
      y = Y[1], yend = Y[2]
    ), linetype = "dashed", col = "red"
  )
```

```{r eval=FALSE}
coords %>%
  dplyr::filter(animal == "GIIFM19b") %>%
  dplyr::group_by(body_part) %>%
  slice(1:3) %>%
  dplyr::filter(body_part != "tail", frame == 0) %>%
  pull(X)
```

#### Distribution of angles

Because of the periodicity of tangent function unrealistic angles were introduced (jumps in data). Angles greater than 180 or smaller than -180 were subtracted from 360 and -360 respectively to get the correct angle.

In the control animals (34, 35, 36, 37) there are unrealistically large angles between frames probably due to tracking problem (switch of head and tail/center coordinate). Those angles are replaced by 0!

mutate(signed_angle_corrected = ifelse(signed_angle_corrected %\>% abs() \> ang_treshold, 0, signed_angle_corrected))

```{r message=FALSE, fig.width=10, fig.height=10, warning=FALSE, echo = FALSE}
coords %>%
  dplyr::filter(animal == selected_animal, body_part != "tail") %>%
  dplyr::filter(body_part != "tail") %>%
  dplyr::group_by(animal, session, frame) %>%
  summarise(
    vectx = diff(X_interp),
    vecty = diff(Y_interp)
  ) %>%
  mutate(
    leadx = lead(vectx),
    leady = lead(vecty)
  ) %>%
  mutate(
    signed_angle = (atan2(leadx, leady) - atan2(vectx, vecty)) * 180 / (pi)
  ) %>%
  mutate(
    signed_angle_corrected = case_when(
      signed_angle >= 180 ~ 360 - signed_angle,
      signed_angle %>% abs() < 180 ~ signed_angle,
      signed_angle <= -180 ~ -360 - signed_angle,
      signed_angle > -180 | signed_angle < 0 ~ signed_angle
    )
  ) %>%
  ### removing unrealistically large angles
  mutate(signed_angle_corrected = ifelse(signed_angle_corrected %>% abs() > ang_threshold, 0, signed_angle_corrected)) %>%
  ggplot(aes(x = signed_angle_corrected)) +
  geom_histogram() +
  facet_wrap(~session, scales = "free") +
  global_facet_theme
```

#### Calculating signed angles

```{r message=F, warning=F, echo = FALSE}

# angles <- coords %>%
#   dplyr::filter(
#     animal == selected_animal,
#     # frame %% datapoint_to_plot == 0, ### here it's good to have all the data points to calculate the cumulative angles
#     body_part != "tail"
#   ) %>%
#   dplyr::group_by(session, frame) %>%
#   mutate(
#     vectx = diff(X_interp),
#     vecty = diff(Y_interp)
#   ) %>%
#   dplyr::group_by(session) %>%
#   mutate(
#     leadx = lead(vectx),
#     leady = lead(vecty)
#   ) %>%
#   mutate(
#     signed_angle = (atan2(leadx, leady) - atan2(vectx, vecty)) * 180 / (pi)
#   )

corrected_angles <- coords %>%
  dplyr::filter(
    animal == selected_animal,
    # frame %% datapoint_to_plot == 0, ### here it's good to have all the data points to calculate the cumulative angles
    body_part != "tail"
  ) %>%
  dplyr::group_by(session, frame) %>%
  mutate(
    vectx = diff(X_interp),
    vecty = diff(Y_interp)
  ) %>%
  dplyr::group_by(session) %>%
  mutate(
    leadx = lead(vectx),
    leady = lead(vecty)
  ) %>%
  mutate(
    signed_angle = (atan2(leadx, leady) - atan2(vectx, vecty)) * 180 / (pi)
  ) %>%
  mutate(
    signed_angle_corrected = case_when(
      signed_angle >= 180 ~ 360 - signed_angle,
      signed_angle %>% abs() < 180 ~ signed_angle,
      signed_angle <= -180 ~ -360 - signed_angle,
      signed_angle > -180 | signed_angle < 0 ~ signed_angle
    )
  ) %>%
  ### removing unrealistically large angles
  mutate(signed_angle_corrected = ifelse(signed_angle_corrected %>% abs() > ang_threshold, 0, signed_angle_corrected))
```

```{r message=F, fig.width=10, fig.height=10, warning=FALSE}
corrected_angles %>%
  ggplot(aes(x = rec_time, y = signed_angle_corrected)) +
  geom_line(aes(col = stim, group = 1)) +
  facet_wrap(~session, scales = "free_x", ncol = 1) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label))) +
  ggtitle(paste0(selected_animal, " raw angles by stimulus period ")) +
  global_facet_theme
```

```{r message=F,  warning=FALSE}
corrected_angles %>%
  dplyr::filter(
    session == "session_3",
    body_part == "center",
    stim_number != "no stim"
  ) %>%
  dplyr::group_by(intensity, stim_number) %>% # View()
  dplyr::summarise(
    align_time = rec_time - rec_time[1],
    cumang = cumsum(signed_angle_corrected) %>% scale(),
    across(stim_categ)
  ) %>% # View()
  # dplyr::group_by(align_time) %>%
  # summarise(cumang = mean(cumang), across(stim_categ)) %>%
  ggplot(aes(x = align_time, y = cumang)) +
  geom_line(aes(group = stim_number, col = stim_categ))

#
# facet_wrap(~session, scales = "free_x", ncol = 1)
#
#
#   geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label))) +
#   ggtitle(paste0(selected_animal, " raw angles by stimulus period ")) +
#   global_facet_theme
```

#### Plotting cumulative angles

Cumulative signed rotation angles during the sessions.

```{r message=FALSE,fig.width=10, fig.height=10}
corrected_angles %>%
  group_by(session) %>%
  dplyr::filter(body_part == "center") %>%
  mutate(csum = cumsum(ifelse(is.na(signed_angle_corrected), 0, signed_angle_corrected)) %>% round(4)) %>%
  ggplot(
    mapping = aes(x = rec_time, y = csum %>% scale())
  ) +
  geom_line(aes(col = stim, group = 1)) +
  facet_wrap(~session, scales = "free_x", ncol = 1) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label))) +
  ggtitle(paste0(selected_animal, " cumulative angles by stimulus period ")) +
  global_facet_theme
```

```{r message=FALSE,fig.width=10, fig.height=10}
corrected_angles %>%
  dplyr::filter(body_part == "center") %>%
  group_by(session) %>%
  mutate(csum = cumsum(ifelse(is.na(signed_angle_corrected), 0, signed_angle_corrected)) %>% round(4)) %>%
  ggplot(
    mapping = aes(x = rec_time, y = csum %>% scale())
  ) +
  geom_line(aes(col = stim_categ, group = 1)) +
  facet_wrap(~session, scales = "free_x", ncol = 1) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label))) +
  scale_color_manual(values = group_colors) +
  global_facet_theme
```

# Population analysis

## Rotation

### Calculating signed population angles

```{r message=FALSE, warning=FALSE, echo = FALSE}
corrected_angles_population <- coords %>%
  dplyr::filter(
    body_part != "tail"
  ) %>%
  dplyr::group_by(animal, session, frame) %>%
  mutate(
    vectx = diff(X_interp),
    vecty = diff(Y_interp),
  ) %>%
  group_by(animal, session) %>%
  mutate(
    leadx = lead(vectx),
    leady = lead(vecty)
  ) %>%
  mutate(
    signed_angle = (atan2(leadx, leady) - atan2(vectx, vecty)) * 180 / (pi)
  ) %>%
  mutate(
    signed_angle_corrected = case_when(
      signed_angle >= 180 ~ 360 - signed_angle,
      signed_angle %>% abs() < 180 ~ signed_angle,
      signed_angle <= -180 ~ -360 - signed_angle,
      signed_angle > -180 | signed_angle < 0 ~ signed_angle
    )
  ) %>%
  ### removing unrealistically large angles
  mutate(
    signed_angle_corrected = ifelse(
      signed_angle_corrected %>% abs() > ang_threshold,
      0,
      signed_angle_corrected
    )
  ) %>%
  ### adding ipsi or contra rotation variable
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::mutate(
    ipsicontra = case_when(
      sum(signed_angle_corrected, na.rm = T) > 0 & stim_side == "left" & stim_categ == "stim" ~ "ipsi",
      sum(signed_angle_corrected, na.rm = T) > 0 & stim_side == "right" & stim_categ == "stim" ~ "contra",
      sum(signed_angle_corrected, na.rm = T) < 0 & stim_side == "left" & stim_categ == "stim" ~ "contra",
      sum(signed_angle_corrected, na.rm = T) < 0 & stim_side == "right" & stim_categ == "stim" ~ "ipsi",
    )
  )
```

```{r message=FALSE,fig.width=15, fig.height=15, out.width="100%"}
corrected_angles_population %>%
  dplyr::filter(body_part == "head") %>%
  group_by(animal, session) %>%
  mutate(csum = cumsum(ifelse(is.na(signed_angle_corrected), 0, signed_angle_corrected)) %>% round(4)) %>%
  fill(intensity, .direction = "downup") %>%
  ggplot(
    mapping = aes(x = rec_time, y = csum %>% scale())
  ) +
  geom_line(aes(col = stim_categ, group = 1)) +
  # geom_text(
  #   data = coords$intensity %>% unique(),
  #   aes(label=intensity), check_overlap = T) +
  facet_grid(animal ~ session) + # factor(intensity, levels = gtools::mixedsort(intensity %>% unique())), scales = "free") +
  scale_color_manual(values = group_colors) +
  global_facet_theme +
  theme(
    axis.text.x = element_text(angle = 45),
  )
```

```{r message=F, fig.width=15, fig.height=15, warning=FALSE}
corrected_angles_population %>%
  dplyr::filter(
    animal %!in% c(control_animals),
    body_part == "center",
    stim_number != "no stim",
    intensity %in% selected_intensities,
    stim_categ != "after stim"
  ) %>%
  dplyr::group_by(animal, intensity, stim_number) %>%
  dplyr::summarise(
    align_time = rec_time - rec_time[1],
    cumang = cumsum(signed_angle_corrected) %>% scale(),
    across(stim_categ)
  ) %>%
  # dplyr::group_by(align_time) %>%
  # summarise(cumang = mean(signed_angle_corrected) )%>%
  ggplot(aes(x = align_time, y = cumang)) +
  geom_line(aes(group = stim_number, col = stim_categ)) +
  facet_grid(animal ~ intensity, scales = "free_x")
#
# corrected_angles_population %>%
#   dplyr::filter(
#     animal %!in% c(control_animals),
#     body_part == "center",
#     stim_number != "no stim",
#     intensity %in% selected_intensities,
#     stim_categ != "after stim"
#   ) %>%
#   dplyr::group_by(animal, intensity, stim_number, stim_categ) %>%
#   dplyr::filter(first(stim_categ == "stim")) %>%
```

Mean/sum rotation angle by session

```{r message=FALSE, fig.height=8, fig.width=10, echo = FALSE}

sem <- function(x) sd(x) / sqrt(length(x)) # Create own function

corrected_angles_population %>%
  dplyr::filter(
    body_part == "head",
    stim_categ != "no stim"
  ) %>%
  dplyr::group_by(animal, session, stim_categ) %>%
  dplyr::summarise(
    sum_ang = sum(signed_angle_corrected, na.rm = T),
    mean_ang = mean(signed_angle_corrected, na.rm = T),
    med_ang = median(signed_angle_corrected, na.rm = T),
    sd_ang = sd(signed_angle_corrected, na.rm = T),
    sem_ang = sem(signed_angle_corrected)
  ) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      y = sum_ang # %>% scale()
    )
  ) +
  geom_point(aes(fill = animal), shape = 21, size = 4) +
  geom_line(aes(group = animal)) +
  facet_wrap(~session) +
  global_facet_theme +
  xlab("State") +
  ylab("Scaled sum angle")
```

Mean/sum rotation angle by session (control)

```{r message=FALSE, fig.height=8, fig.width=10, echo = FALSE}

sem <- function(x) sd(x) / sqrt(length(x)) # Create own function

corrected_angles_population %>%
  dplyr::filter(
    animal %in% control_animals,
    body_part == "head",
    stim_categ != "no stim"
    # str_detect(string = session, pattern = "1|2|3|4|5"), # session filter
  ) %>%
  dplyr::group_by(animal, session, stim_categ) %>%
  dplyr::summarise(
    sum_ang = sum(signed_angle_corrected, na.rm = T),
    mean_ang = mean(signed_angle_corrected, na.rm = T),
    med_ang = median(signed_angle_corrected, na.rm = T),
    sd_ang = sd(signed_angle_corrected, na.rm = T),
    sem_ang = sem(signed_angle_corrected)
  ) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      y = sum_ang # %>% scale()
    )
  ) +
  geom_point(aes(fill = animal), shape = 21, size = 4) +
  geom_line(aes(group = animal)) +
  facet_wrap(~session) +
  global_facet_theme +
  xlab("State") +
  ylab("Scaled sum angle")
```

Mean/sum rotation angle by intensity (stimulus and control)

```{r message=FALSE, fig.height=12, fig.width=15, echo = FALSE}
plt1_angle <- corrected_angles_population %>%
  dplyr::filter(
    animal %!in% c(control_animals, "GIIFM14b"),
    body_part == "head",
    stim_categ != "no stim",
    # stim_side == "left"
  ) %>%
  dplyr::filter(intensity %in% selected_intensities) %>%
  dplyr::group_by(animal, stim_side, intensity, stim_categ) %>%
  dplyr::summarise(
    sum_ang = sum(signed_angle_corrected, na.rm = T),
    mean_ang = mean(signed_angle_corrected, na.rm = T),
    med_ang = median(signed_angle_corrected, na.rm = T),
    sd_ang = sd(signed_angle_corrected, na.rm = T),
    sem_ang = sem(signed_angle_corrected)
  ) %>%
  dplyr::mutate(
    ipsicontra = case_when(
      sum_ang > 0 & stim_side == "left" & stim_categ == "stim" ~ "ipsi",
      sum_ang > 0 & stim_side == "right" & stim_categ == "stim" ~ "contra",
      sum_ang < 0 & stim_side == "left" & stim_categ == "stim" ~ "contra",
      sum_ang < 0 & stim_side == "right" & stim_categ == "stim" ~ "ipsi",
    )
  ) %>%
  dplyr::group_by(animal, intensity) %>%
  fill(ipsicontra, .direction = "up") %>%
  View()
# dplyr::filter(
#   sum_ang[stim_categ == "stim"] > 0) %>%
ggplot(
  mapping = aes(
    x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
    y = mean_ang %>% abs() # sum_ang %>% abs() # / max(sum_ang %>% abs()) # %>% scale()
  )
) +
  geom_point(aes(fill = animal), shape = 21, size = 4) +
  geom_line(aes(group = animal)) +
  ggpubr::stat_compare_means(
    method = "wilcox.test",
    paired = T,
    method.args = list(alternative = "less"),
    comparisons = list(c("before stim", "stim")),
    vjust = 1.5,
    hide.ns = F
    # label.y = 3000
  ) +
  ggpubr::stat_compare_means(
    method = "wilcox.test",
    paired = T,
    method.args = list(alternative = "greater"),
    comparisons = list(c("stim", "after stim")),
    vjust = 1.5,
    hide.ns = F
    # label.y = 3000
  ) +
  facet_grid(~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))) +
  global_facet_theme +
  expand_limits(y = c(-3, 3)) +
  # xlab("State") +
  # ylab("Scaled sum angle") +
  ggtitle("Stimulus") +
  theme(aspect.ratio = 1)

# facet_grid(~animal, ~intensity)
# geom_errorbar(aes(ymin = mean_ang - sem_ang, ymax = mean_ang + sem_ang, col = animal), width=.1)


plt2_angle <- corrected_angles_population %>%
  dplyr::filter(
    animal %in% control_animals,
    body_part == "head",
    stim_categ != "no stim",
    # stim_side == "right"
  ) %>%
  dplyr::filter(intensity %in% selected_intensities) %>%
  dplyr::group_by(animal, stim_side, intensity, stim_categ) %>%
  dplyr::summarise(
    sum_ang = sum(signed_angle_corrected, na.rm = T),
    max_sum_ang = sum_ang %>% max(),
    mean_ang = mean(signed_angle_corrected, na.rm = T),
    med_ang = median(signed_angle_corrected, na.rm = T),
    sd_ang = sd(signed_angle_corrected, na.rm = T),
    sem_ang = sem(signed_angle_corrected)
  ) %>%
  dplyr::mutate(
    max_sum_ang = replace(max_sum_ang, max_sum_ang == "stim", NA)
  ) %>%
  fill(max_sum_ang) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      y = mean_ang %>% abs() # sum_ang %>% abs() # / max(sum_ang %>% abs())# %>% scale()
    )
  ) +
  geom_point(aes(fill = animal), shape = 21, size = 4) +
  geom_line(aes(group = animal)) +
  ggpubr::stat_compare_means(
    method = "wilcox.test",
    paired = T,
    method.args = list(alternative = "less"),
    comparisons = list(c("before stim", "stim")),
    vjust = 1.5,
    hide.ns = F
    # label.y = 3000
  ) +
  ggpubr::stat_compare_means(
    method = "wilcox.test",
    paired = T,
    method.args = list(alternative = "greater"),
    comparisons = list(c("stim", "after stim")),
    vjust = 1.5,
    hide.ns = F
    # label.y = 3000
  ) +
  facet_wrap(~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique())), ncol = 3) +
  global_facet_theme +
  expand_limits(y = c(-3, 3)) +
  # xlab("State") +
  # ylab("Scaled sum angle") +
  ggtitle("Control") +
  theme(aspect.ratio = 1)


# facet_grid(~animal, ~intensity)
# geom_errorbar(aes(ymin = mean_ang - sem_ang, ymax = mean_ang + sem_ang, col = animal), width=.1)


cowplot::plot_grid(plt1_angle, plt2_angle, nrow = 2)
```

Mean rotation angle before stimulus vs during stimulus

```{r message=FALSE, warning=FALSE, fig.width=17, fig.height=15, out.width="100%", echo = FALSE}

plt_ang_stim <- corrected_angles_population %>%
  dplyr::filter(
    animal %!in% c(control_animals, "GIIFM14b"),
    body_part == "head",
    stim_categ != "no stim",
    intensity %in% c(selected_intensities, "15 mW")
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ, stim_number) %>%
  dplyr::summarise(
    sum_ang = sum(signed_angle_corrected, na.rm = T),
    # mean_ang = mean(signed_angle_corrected, na.rm = T),
    # med_ang = median(signed_angle_corrected, na.rm = T),
    # sd_ang = sd(signed_angle_corrected, na.rm = T),
    # sem_ang = sem(signed_angle_corrected)
  ) %>%
  tidyr::spread(
    key = stim_categ, value = sum_ang
  ) %>%
  ggplot(
    mapping = aes(x = `before stim`, y = stim)
  ) +
  xlim(-1200, 1200) +
  ylim(-1200, 1200) +
  coord_fixed() +
  geom_vline(xintercept = 0, alpha = .3) +
  geom_hline(yintercept = 0, alpha = .3) +
  geom_point(size = 3) +
  facet_grid(animal ~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))) +
  global_facet_theme +
  theme(
    axis.text.x = element_text(angle = 45)
  )

plt_ang_ctrl <- corrected_angles_population %>%
  dplyr::filter(
    animal %in% c(control_animals, "GIIFM14b"),
    body_part == "head",
    stim_categ != "no stim",
    intensity %in% c(selected_intensities, "15 mW")
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ, stim_number) %>%
  dplyr::summarise(
    sum_ang = sum(signed_angle_corrected, na.rm = T),
    # mean_ang = mean(signed_angle_corrected, na.rm = T),
    # med_ang = median(signed_angle_corrected, na.rm = T),
    # sd_ang = sd(signed_angle_corrected, na.rm = T),
    # sem_ang = sem(signed_angle_corrected)
  ) %>%
  tidyr::spread(
    key = stim_categ, value = sum_ang
  ) %>%
  ggplot(
    mapping = aes(x = `before stim`, y = stim)
  ) +
  xlim(-1200, 1200) +
  ylim(-1200, 1200) +
  coord_fixed() +
  geom_vline(xintercept = 0, alpha = .3) +
  geom_hline(yintercept = 0, alpha = .3) +
  geom_point(size = 3) +
  facet_grid(animal ~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))) +
  global_facet_theme +
  theme(
    axis.text.x = element_text(angle = 45)
  )


cowplot::plot_grid(plt_ang_stim, plt_ang_ctrl, ncol = 2)
```

## Traveled distance

```{r}
# saving the mean of the "before stim" "sum traveled distance" of all the animals (by intensity) for normalization

mean_sum_d_1mW <- coords_1s_window %>%
  dplyr::filter(
    frame %% datapoint_to_plot == 0,
    body_part == "center",
    intensity %in% selected_intensities
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::summarise(sum_d = sum(d, na.rm = T)) %>%
  dplyr::group_by(intensity, stim_categ) %>%
  dplyr::summarise(mean_sum_d = mean(sum_d)) %>%
  dplyr::filter(
    stim_categ == "before stim",
    intensity == "1 mW"
  ) %>%
  pull(mean_sum_d)

mean_sum_d_5mW <- coords_1s_window %>%
  dplyr::filter(
    frame %% datapoint_to_plot == 0,
    body_part == "center",
    intensity %in% selected_intensities
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::summarise(sum_d = sum(d, na.rm = T)) %>%
  dplyr::group_by(intensity, stim_categ) %>%
  dplyr::summarise(mean_sum_d = mean(sum_d)) %>%
  dplyr::filter(
    stim_categ == "before stim",
    intensity == "5 mW"
  ) %>%
  pull(mean_sum_d)

mean_sum_d_10mW <- coords_1s_window %>%
  dplyr::filter(
    frame %% datapoint_to_plot == 0,
    body_part == "center",
    intensity %in% selected_intensities
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::summarise(sum_d = sum(d, na.rm = T)) %>%
  dplyr::group_by(intensity, stim_categ) %>%
  dplyr::summarise(mean_sum_d = mean(sum_d)) %>%
  dplyr::filter(
    stim_categ == "before stim",
    intensity == "10 mW"
  ) %>%
  pull(mean_sum_d)


coords_1s_window %>%
  dplyr::filter(
    frame %% datapoint_to_plot == 0,
    body_part == "center",
    intensity %in% selected_intensities
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::summarise(sum_d = sum(d, na.rm = T)) %>%
  dplyr::group_by(intensity, stim_categ) %>%
  dplyr::summarise(
    mean_sum_d = mean(sum_d),
    sd_sum_d = sd(sum_d)
  )
```

Sum traveled distance across sessions at different intensities by animals (stimulus and control) <br> 1 second before stimulus, first second of stimulation

```{r message=FALSE, fig.height=15, fig.width=17, echo = FALSE}

norm_ref <- coords_1s_window %>%
  dplyr::filter(
    str_detect(string = animal, pattern = "b"),
    body_part == "center",
    stim_categ != "no stim",
    intensity %in% c(selected_intensities),
    animal %!in% c(control_animals, "GIIFM14b"),
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::summarise(
    sum_d = sum(d, na.rm = T)
  ) %>%
  pull(sum_d) %>%
  max()


plt_pop_dist_stim <- coords_1s_window %>%
  dplyr::filter(
    str_detect(string = animal, pattern = "b"),
    body_part == "center",
    stim_categ != "no stim",
    intensity %in% c(selected_intensities),
    animal %!in% c(control_animals, "GIIFM14b"),
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::summarise(
    sum_d = sum(d, na.rm = T),
    mean_d = mean(d, na.rm = T),
    max_sum_d = sum_d %>% max()
  ) %>%
  dplyr::mutate(
    max_sum_d = replace(max_sum_d, stim_categ == "stim", NA),
    mean_sum_d = case_when(
      intensity == "1 mW" ~ mean_sum_d_1mW,
      intensity == "5 mW" ~ mean_sum_d_5mW,
      intensity == "10 mW" ~ mean_sum_d_10mW,
    )
  ) %>%
  fill(max_sum_d) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim"),
      y = mean_d # /mean_sum_d  #norm_ref # # norm_ref #
    )
  ) +
  geom_point(aes(fill = animal %>% as.factor()), shape = 21, size = 4) +
  geom_line(aes(group = animal)) +
  facet_wrap(~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique())), ncol = 1) +
  ggpubr::stat_compare_means(
    method = "wilcox.test",
    paired = T,
    method.args = list(alternative = "less"),
    comparisons = list(c("before stim", "stim")),
    vjust = 1.5,
    hide.ns = F
  ) +
  # ggpubr::stat_compare_means(
  #   method = "wilcox.test",
  #   paired = T,
  #   comparisons = list(c("stim", "after stim")),
  #   vjust = 1.5,
  #   hide.ns = F
  # ) +
  expand_limits(y = c(0, 50)) +
  global_facet_theme +
  theme(aspect.ratio = 1) +
  theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text = element_text(size = 12),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black")
  )



plt_pop_dist_ctrl <- coords_1s_window %>%
  dplyr::filter(
    str_detect(string = animal, pattern = "b"),
    body_part == "center",
    stim_categ != "no stim",
    intensity %in% c(selected_intensities),
    animal %in% control_animals,
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::summarise(
    sum_d = sum(d, na.rm = T),
    mean_d = mean(d, na.rm = T),
    max_sum_d = sum_d %>% max()
  ) %>%
  dplyr::mutate(
    max_sum_d = replace(max_sum_d, stim_categ == "stim", NA),
    mean_sum_d = case_when(
      intensity == "1 mW" ~ mean_sum_d_1mW,
      intensity == "5 mW" ~ mean_sum_d_5mW,
      intensity == "10 mW" ~ mean_sum_d_10mW,
    )
  ) %>%
  fill(max_sum_d) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim"),
      y = mean_d # /mean_sum_d / norm_ref # max_sum_d # norm_ref #
    )
  ) +
  geom_point(aes(fill = animal %>% as.factor()), shape = 21, size = 4) +
  geom_line(aes(group = animal)) +
  facet_wrap(~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique())), ncol = 1) +
  ggpubr::stat_compare_means(
    method = "wilcox.test",
    paired = T,
    comparisons = list(c("before stim", "stim")),
    method.args = list(alternative = "less"),
    vjust = 1.5,
    hide.ns = F
  ) +
  # ggpubr::stat_compare_means(
  #   method = "wilcox.test",
  #   paired = T,
  #   comparisons = list(c("stim", "after stim")),
  #   method.args = list(alternative = "two.sided"),
  #   vjust = 1.5,
  #   hide.ns = F
  # ) +
  expand_limits(y = c(0, 50)) +
  global_facet_theme +
  theme(aspect.ratio = 1) +
  theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text = element_text(size = 12),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black")
  )

# sum_trav_dist_norm_by_before_mean
cowplot::plot_grid(plt_pop_dist_stim, plt_pop_dist_ctrl, ncol = 2)
```

Sum traveled distance across sessions at different intensities by animals (stimulus and control) <br> 8 second before stimulus, first 8 second of stimulation (8 because some "before stim" periods are only 8 seconds long)

```{r message=FALSE, fig.height=15, fig.width=17, echo = FALSE}

norm_ref <- coords_8s_window %>%
  dplyr::filter(
    str_detect(string = animal, pattern = "b"),
    body_part == "center",
    stim_categ != "no stim",
    intensity %in% c(selected_intensities),
    animal %!in% c(control_animals, "GIIFM14b"),
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::summarise(
    sum_d = sum(d, na.rm = T)
  ) %>%
  pull(sum_d) %>%
  max()


plt_pop_dist_stim <- coords_8s_window %>%
  dplyr::filter(
    str_detect(string = animal, pattern = "b"),
    body_part == "center",
    stim_categ != "no stim",
    intensity %in% c(selected_intensities),
    animal %!in% c(control_animals, "GIIFM14b"),
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::summarise(
    sum_d = sum(d, na.rm = T),
    max_sum_d = sum_d %>% max()
  ) %>%
  dplyr::mutate(
    max_sum_d = replace(max_sum_d, stim_categ == "stim", NA)
  ) %>%
  fill(max_sum_d) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim"),
      y = sum_d / norm_ref # max_sum_d # norm_ref #
    )
  ) +
  geom_point(aes(fill = animal %>% as.factor()), shape = 21, size = 4) +
  geom_line(aes(group = animal)) +
  facet_wrap(~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique())), ncol = 1) +
  ggpubr::stat_compare_means(
    method = "wilcox.test",
    paired = T,
    method.args = list(alternative = "less"),
    comparisons = list(c("before stim", "stim")),
    vjust = 1.5,
    hide.ns = F
  ) +
  # ggpubr::stat_compare_means(
  #   method = "wilcox.test",
  #   paired = T,
  #   comparisons = list(c("stim", "after stim")),
  #   vjust = 1.5,
  #   hide.ns = F
  # ) +
  expand_limits(y = c(0, 1)) +
  global_facet_theme +
  theme(aspect.ratio = 1)




plt_pop_dist_ctrl <- coords_8s_window %>%
  dplyr::filter(
    str_detect(string = animal, pattern = "b"),
    body_part == "center",
    stim_categ != "no stim",
    intensity %in% c(selected_intensities),
    animal %in% control_animals,
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::summarise(
    sum_d = sum(d, na.rm = T),
    max_sum_d = sum_d %>% max()
  ) %>%
  dplyr::mutate(
    max_sum_d = replace(max_sum_d, stim_categ == "stim", NA)
  ) %>%
  fill(max_sum_d) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim"),
      y = sum_d / norm_ref # max_sum_d # norm_ref #
    )
  ) +
  geom_point(aes(fill = animal %>% as.factor()), shape = 21, size = 4) +
  geom_line(aes(group = animal)) +
  facet_wrap(~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique())), ncol = 1) +
  ggpubr::stat_compare_means(
    method = "wilcox.test",
    paired = T,
    comparisons = list(c("before stim", "stim")),
    method.args = list(alternative = "less"),
    vjust = 1.5,
    hide.ns = F
  ) +
  # ggpubr::stat_compare_means(
  #   method = "wilcox.test",
  #   paired = T,
  #   comparisons = list(c("stim", "after stim")),
  #   method.args = list(alternative = "two.sided"),
  #   vjust = 1.5,
  #   hide.ns = F
  # ) +
  expand_limits(y = c(0, 1)) +
  global_facet_theme +
  theme(aspect.ratio = 1)


cowplot::plot_grid(plt_pop_dist_stim, plt_pop_dist_ctrl, ncol = 2)
```

```{r fig.width=18, fig.height=8}

norm_ref <- coords_1s_window %>%
  dplyr::filter(
    body_part == "center",
    stim_categ != "no stim",
    intensity %in% c(selected_intensities),
    animal %!in% c(control_animals, "GIIFM14b"),
  ) %>%
  dplyr::group_by(intensity, stim_categ) %>%
  dplyr::summarise(
    sum_d = sum(d, na.rm = T)
  ) %>%
  pull(sum_d) %>%
  max()


library(plotrix)
cowplot::plot_grid(
  coords_1s_window %>%
    dplyr::filter(
      body_part == "center",
      stim_categ != "no stim",
      intensity %in% c(selected_intensities),
      animal %!in% c(control_animals, "GIIFM14b"),
    ) %>%
    dplyr::group_by(intensity, stim_categ) %>%
    dplyr::summarise(
      sum_d = sum(d, na.rm = T),
      mean_d = mean(d, na.rm = T),
      sd_d = sd(d, na.rm = T),
      sem = plotrix::std.error(d, na.rm = T),
      max_sum_d = sum_d %>% max()
    ) %>%
    dplyr::mutate(
      max_sum_d = replace(max_sum_d, stim_categ == "stim", NA)
    ) %>%
    fill(max_sum_d) %>%
    ggplot(
      mapping = aes(
        x = forcats::fct_relevel(stim_categ, "before stim", "stim"),
        y = mean_d
      )
    ) +
    geom_point(aes(fill = intensity %>% as.factor()), shape = 21, size = 4) +
    geom_line(aes(group = intensity)) +
    # geom_errorbar(aes(ymin=mean_d-sem, ymax=mean_d+sem), width=.1,
    #               position=position_dodge(0.05)) +
    ggpubr::stat_compare_means(
      method = "wilcox.test",
      paired = T,
      method.args = list(alternative = "less"),
      comparisons = list(c("before stim", "stim")),
      vjust = 1.5,
      hide.ns = F
    ) +
    expand_limits(y = c(0, 1)) +
    global_facet_theme +
    ggtitle("Stimulus"),
  coords_1s_window %>%
    dplyr::filter(
      body_part == "center",
      stim_categ != "no stim",
      intensity %in% c(selected_intensities),
      animal %in% c(control_animals, "GIIFM14b"),
    ) %>%
    dplyr::group_by(intensity, stim_categ) %>%
    dplyr::summarise(
      sum_d = sum(d, na.rm = T),
      mean_d = mean(d, na.rm = T),
      sd_d = sd(d, na.rm = T),
      sem = plotrix::std.error(d, na.rm = T),
      max_sum_d = sum_d %>% max()
    ) %>%
    dplyr::mutate(
      max_sum_d = replace(max_sum_d, stim_categ == "stim", NA)
    ) %>%
    fill(max_sum_d) %>%
    ggplot(
      mapping = aes(
        x = forcats::fct_relevel(stim_categ, "before stim", "stim"),
        y = sum_d / norm_ref
      )
    ) +
    geom_point(aes(fill = intensity %>% as.factor()), shape = 21, size = 4) +
    geom_line(aes(group = intensity)) +
    # geom_errorbar(aes(ymin=mean_d-sem, ymax=mean_d+sem), width=.1,
    #               position=position_dodge(0.05)) +
    ggpubr::stat_compare_means(
      method = "wilcox.test",
      paired = T,
      method.args = list(alternative = "less"),
      comparisons = list(c("before stim", "stim")),
      vjust = 1.5,
      hide.ns = F
    ) +
    expand_limits(y = c(0, 1)) +
    global_facet_theme +
    ggtitle("Control"),
  ncol = 2
)
```

```{r fig.height=25, fig.width=15}
coords_1s_window %>%
  dplyr::filter(
    animal %!in% control_animals,
    body_part == "center",
    intensity %in% selected_intensities
  ) %>%
  dplyr::group_by(animal, intensity, stim_number, stim_categ) %>%
  dplyr::summarise(sum_d = sum(d, na.rm = T)) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim"),
      y = sum_d
    )
  ) +
  geom_point(aes(fill = stim_number %>% as.factor()), shape = 21, size = 4) +
  facet_grid(animal ~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))) +
  geom_line(aes(group = stim_number)) +
  # ggtitle(paste0(selected_animal, " sum traveled distance by individual stimuli within session ", "(center)")) +
  labs(
    fill = "Stimulus number",
    x = "Stimulus period",
    y = "Sum traveled distance [pixel]"
  ) +
  global_facet_theme
```

Combining 1 sec before stim and stim division to 1st and last 9 sec tables. In control cases if I normalize with the period length the "last_part" drops. The reason is that the animal moves at a constant rate so dividing the mean traveled distance will decrease the mean.

```{r fig.width=15}
bind_rows(
  ### before stim 1 sec
  coords_1s_window %>%
    dplyr::filter(
      stim_categ == "before stim",
      body_part == "center"
    ) %>%
    dplyr::mutate(
      stim_division = "before_stim",
      stim_div_length = 1
    ),
  ### stim devided to first_part (1s) and last part (9s)
  coords %>%
    dplyr::filter(
      frame %% datapoint_to_plot == 0,
      stim_categ == "stim",
      body_part == "center"
      # animal %!in% control_animals,
      # body_part == "center",
      # intensity %in% selected_intensities
    ) %>%
    ### recalculates distances after frames were removed
    dplyr::group_by(animal, body_part, session) %>%
    dplyr::mutate(
      X_diff = c(diff(X_interp), NA) %>% round(4),
      Y_diff = c(diff(Y_interp), NA) %>% round(4),
      X_diff = ifelse(
        test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
          X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
        yes = 0,
        no = X_diff
      ),
      Y_diff = ifelse(
        Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
          Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
        yes = 0,
        no = Y_diff
      ),
      d = sqrt(X_diff^2 + Y_diff^2),
      d_mm = d / scale,
      speed_instant = d_mm / time_res,
      mmps = speed_instant * (1 / time_res),
      mps = (speed_instant * (1 / time_res)) / 1000
    ) %>%
    dplyr::ungroup() %>%
    dplyr::group_by(animal, body_part, session, stim_number) %>%
    dplyr::mutate(
      stim_division = ifelse(rec_time <= min(rec_time) + 1, yes = "first_part", no = "last_part"),
      # stim_div_length = ifelse(rec_time <= min(rec_time) + 1, yes = 1, no = 9)
    )
) %>%
  dplyr::group_by(animal, body_part, session, stim_number, stim_division) %>%
  dplyr::mutate(stim_div_length = length(stim_division)) %>%
  ungroup() %>%
  # arrange(animal, session, stim_number, rec_time) %>% View()



  dplyr::group_by(animal, body_part, intensity, stim_categ, stim_division, across(stim_div_length)) %>% # stim_number,
  dplyr::summarise(
    sum_d = sum(d, na.rm = T),
    mean_d = mean(d, na.rm = T),
    max_sum_d = sum_d %>% max()
  ) %>%
  dplyr::mutate(
    max_sum_d = replace(max_sum_d, stim_categ == "stim", NA),
    mean_sum_d = case_when(
      intensity == "1 mW" ~ mean_sum_d_1mW,
      intensity == "5 mW" ~ mean_sum_d_5mW,
      intensity == "10 mW" ~ mean_sum_d_10mW,
    )
  ) %>%
  dplyr::filter(
    animal %!in% control_animals,
    intensity %in% selected_intensities
  ) %>%
  ungroup() %>%
  fill(max_sum_d, .direction = "down") %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_division, "before_stim", "first_part", "last_part"),
      y = mean_d # / stim_div_length #/mean_sum_d
    )
  ) +
  geom_point(aes(fill = animal %>% as.factor()), shape = 21, size = 4) +
  facet_wrap(~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique())), nrow = 1) +
  # facet_grid(animal ~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))) +
  geom_line(aes(group = animal)) +
  ggpubr::stat_compare_means(
    method = "wilcox.test",
    paired = T,
    comparisons = list(c("before_stim", "first_part")),
    method.args = list(alternative = "less"),
    vjust = 1.6,
    hide.ns = F
  ) +
  ggpubr::stat_compare_means(
    method = "wilcox.test",
    paired = T,
    comparisons = list(c("first_part", "last_part")),
    method.args = list(alternative = "greater"),
    vjust = 1.6,
    hide.ns = F
  ) +
  ggpubr::stat_compare_means(
    method = "wilcox.test", label.y = 55,
    paired = T,
    comparisons = list(c("before_stim", "last_part")),
    method.args = list(alternative = "less"),
    vjust = 1.7,
    hide.ns = F
  ) +
  expand_limits(y = c(0, 60)) +
  global_facet_theme +
  theme(aspect.ratio = 1) +
  theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text = element_text(size = 12),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black")
  ) -> plt_pop_dist_stim

# sum_trav_dist_norm_by_before_mean

cowplot::plot_grid(plt_pop_dist_stim, plt_pop_dist_ctrl, nrow = 2)
```

<br> Traveled distance before stimulus vs during stimulus (starting or stopping signal). If the traveled distance is greater during the stimulus photoactivation initiates movement, if it is smaller it slows down the animal.

```{r message=FALSE, warning=FALSE, fig.width=15, fig.height=15, echo = FALSE}
coords_1s_window %>%
  dplyr::filter(
    body_part == "center",
    animal %!in% c(control_animals, "GIIFM14b"),
    stim_categ != "no stim",
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ, stim_number) %>%
  dplyr::summarise(sum_d = sum(d, na.rm = T)) %>%
  tidyr::spread(
    stim_categ, sum_d
  ) %>%
  dplyr::filter(intensity %in% c(selected_intensities, 15)) %>%
  ggplot(
    mapping = aes(x = `before stim`, y = stim)
  ) +
  xlim(-50, 300) +
  ylim(-50, 300) +
  coord_fixed() +
  geom_vline(xintercept = 5, alpha = .3) +
  geom_hline(yintercept = 5, alpha = .3) +
  # geom_rect(xmin = 0, xmax = 5, ymin = 5, ymax = 10, fill = "green", alpha = 0.03) +
  # geom_rect(xmin = 5, xmax = 10, ymin = 0, ymax = 5, fill = "red", alpha = 0.03) +

  # geom_abline(slope = 1, intercept = 0, alpha = .3) +
  geom_point(aes(col = factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))), size = 3) +
  facet_wrap(~animal) +
  global_facet_theme +
  theme(
    axis.text.x = element_text(angle = 45)
  )
```

```{r message=FALSE, warning=FALSE, fig.width=15, fig.height=10, echo = FALSE}
coords_1s_window %>%
  dplyr::filter(
    body_part == "center",
    # animal == selected_animal,
    stim_categ != "no stim",
    intensity %in% selected_intensities
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ, stim_number) %>%
  summarise(sum_d = sum(d)) %>%
  group_by(animal) %>%
  spread(stim_categ, sum_d) %>%
  mutate(`stim-bstim` = stim - `before stim`) %>%
  ggplot(mapping = aes(x = `before stim`, y = `stim-bstim`)) +
  geom_point(aes(col = factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))), size = 3) +
  # geom_text(aes(label = stim_number, col = factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))), size = 6) +
  # geom_line(aes(col = factor(intensity, levels = gtools::mixedsort(intensity %>% unique())))) +
  labs(col = "Intensity") +
  geom_hline(yintercept = 0, lty = "dashed", col = "gray30") +
  facet_wrap(~animal, scales = "free")
```

```{r message=FALSE, warning=FALSE, fig.width=15, fig.height=20 , echo = FALSE}
stim_bstim1 <- coords_1s_window %>%
  dplyr::filter(
    body_part == "center",
    animal %!in% control_animals,
    stim_categ != "no stim",
    intensity %in% c(selected_intensities, 15),
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ, stim_number) %>%
  dplyr::summarise(sum_d = sum(d, na.rm = T)) %>%
  group_by(animal) %>%
  tidyr::spread(
    stim_categ, sum_d
  ) %>%
  ggplot(
    mapping = aes(x = `before stim`, y = stim)
  ) +
  xlim(0, 400) +
  ylim(0, 400) +
  coord_fixed() +
  geom_abline(slope = 1, intercept = 0, alpha = .3) +
  geom_point(size = 3) +
  facet_grid(animal ~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))) +
  global_facet_theme +
  ggtitle("Stimulus") +
  theme(
    axis.text.x = element_text(angle = 45)
  )

stim_bstim2 <- coords_1s_window %>%
  dplyr::filter(
    body_part == "center",
    animal %in% control_animals,
    stim_categ != "no stim",
    intensity %in% c(selected_intensities, 15),
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ, stim_number) %>%
  dplyr::summarise(sum_d = sum(d, na.rm = T)) %>%
  group_by(animal) %>%
  tidyr::spread(
    stim_categ, sum_d
  ) %>%
  ggplot(
    mapping = aes(x = `before stim`, y = stim)
  ) +
  xlim(0, 400) +
  ylim(0, 400) +
  coord_fixed() +
  geom_abline(slope = 1, intercept = 0, alpha = .3) +
  geom_point(size = 3) +
  facet_grid(animal ~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))) +
  global_facet_theme +
  ggtitle("Control") +
  theme(
    axis.text.x = element_text(angle = 45)
  )


cowplot::plot_grid(stim_bstim1, stim_bstim2, ncol = 2)
```
