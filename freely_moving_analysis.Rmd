---
title: "Freely moving analysis"
author: "Viktor Plattner"
output:
  html_notebook:
    number_sections: yes
    toc: yes
    toc_float: yes
  pdf_document:
    number_sections: yes
    toc: yes
    keep_tex: true
  html_document:
    number_sections: yes
    df_print: paged
    toc: yes
    toc_float: yes
spacing: single
fontsize: 12pt
always_allow_html: yes
---




<style type="text/css">

body{ /* Normal  */
      font-size: 14px;
      font-family: "Arial", Helvetica, sans-serif;
  }
td {  /* Table  */
  font-size: 12px;
}
h1.title {
  font-size: 38px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #4d4e4f;
}
h1 { /* Header 1 */
  font-size: 28px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #2c3a3e;
}
h2 { /* Header 2 */
  font-size: 22px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #2c3a3e;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #2c3a3e;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>


# Loading data

Defining global constants

scale: pixels/mm
fps: frame rate
time_res: time between frames

```{r}
scale <- 1.38 ### pixel/mm
fps <- 30 ### frame rate
time_res <- 1 / fps ### time between frames
```


### Loading stimulus times (frames)

```{r}
stims <- read.csv(file.path("data", "turning", "GIIFM19",  "GIIFM19Frames_20201116.csv")) %>% 
  as_tibble() %>%
  mutate(session = str_remove(session, "_"),
         stim_length = end-start) %>% 
  rename("stim_number" = stim.number) %>% 
  gather(key = "timing", value = "frame", start, end)
stims
```

### Loading coordinates

```{r warning=FALSE, message=FALSE}
coords <- read.csv(file.path("data", "turning", "GIIFM19.csv")) %>%
  as_tibble() %>%
  mutate(session = str_remove(session, pattern = ".dat")) %>%
  full_join(stims) %>% 
  dplyr::group_by(session) %>% 
  mutate(grp = cumsum(!is.na(stim_number))) %>% 
  dplyr::group_by(grp) %>%
  # dplyr::group_by(grp = cumsum(!is.na(stim_number))) %>% 
  mutate(stim = F,
         stim = replace(stim, first(timing) == "start" | timing == "end", T)) %>%
  ungroup(grp) %>% 
  group_by(stim) %>% 
  fill(stim_number) %>% 
  fill(intensity) %>% 
  select(-grp, -animal, -timing, -stim_length) %>%
  ungroup(stim) %>% 
  group_by(session) %>% 
  dplyr::mutate(
    rec_time = (frame / fps) %>% round(digits = 2),
    segments = cumsum(ifelse(rec_time %% 9 == 0 & stim != T, 1, 0)),
    before_stim = lead(stim, n = 250)) %>% # length of the stimulus
  unite(col = "head", head1, head2, sep = "_") %>%
  unite(col = "center", center1, center2, sep = "_") %>%
  unite(col = "tail", tail1, tail2, sep = "_") %>%
  gather(
    key = "body_part",
    value = "coordinate",
    head, center, tail
  ) %>%
  tidyr::extract(col = coordinate, into = c("X", "Y"), regex = "([[:alnum:]]+)_([[:alnum:]]+)") %>%
  dplyr::mutate(
    X = ifelse(
      as.integer(X) == 0 & as.integer(Y) == 0, 
      yes = NA,
      no = as.integer(X)),
    Y = ifelse(
      as.integer(X) == 0 & as.integer(Y) == 0, 
      yes = NA,
      no = as.integer(Y))) %>%
  dplyr::group_by(body_part) %>%
  mutate(
    X_diff = c(diff(X), NA),
    Y_diff = c(diff(Y), NA)
  ) %>%
  dplyr::mutate(
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale
  ) %>%
  dplyr::mutate(
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000,
    sec_counter = cumsum(ifelse(rec_time %% 1 == 0, 1, 0))
  ) %>%
  group_by(sec_counter, body_part) %>%
  dplyr::mutate(speed_sec = sum(d_mm, na.rm = T)) %>%
  ungroup() %>% 
  mutate(stim_number = replace(stim_number, is.na(stim_number), "no stim" ))

coords
```


creating plot colors

```{r}
gg_color_hue <- function(n) {
  hues <- seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}

n <- 5
cols <- gg_color_hue(n)
```

### Plotting trajectories

```{r warning=FALSE}
coords %>%
  ggplot(
    mapping = aes(x = X, y = Y, label = frame)
  ) +
  geom_point(aes(shape = body_part), size = 2) +
  geom_line(aes(group = frame, col = stim_number %>% as.character())) +
  scale_color_manual(
    values = c(cols[1], cols[2], cols[3], cols[4], cols[5], "black"),
    name = "Stimulus"
  ) +
  scale_shape(
    name = "Body part",
    labels = c("Center", "Head", "Tail")
  ) +
  xlim(c(0,1280)) +
  ylim(c(0,720)) +
  facet_wrap(~ session)
```

```{r}
coords %>% 
  dplyr::filter(body_part == "center") %>%
  group_by(session, sec_counter) %>% 
  mutate(d_sec = sum(d_mm)) %>% 

  ggplot(
    mapping = aes(x = X, y = Y, label = frame)
  ) +
  geom_point(aes(color = d_sec %>% scale(), size = stim)) +
  # geom_line(aes(group = frame, col = stim_number %>% as.character())) +
  # scale_color_manual(
  #   values = c(cols[1], cols[2], cols[3], cols[4], cols[5], "black"),
  #   name = "Stimulus"
  # ) +
  # scale_shape(
  #   name = "Body part",
  #   labels = c("Center", "Head", "Tail")
  # ) +
  xlim(c(0,1280)) +
  ylim(c(0,720)) +
  facet_wrap(~ session)
```



```{r}
coords %>%
  ggplot(mapping = aes(x = Y_diff)) +
  geom_histogram() +
  facet_wrap(~ body_part)

```

```{r}
coords %>%
  dplyr::filter(body_part == "head") %>% 
  ggplot(mapping = aes(x = rec_time, y = d_mm)) +
  geom_line(aes(color = stim, group = 1)) + 
  # geom_line(data = as_tibble(spline(coords$rec_time, coords$d_mm)), aes(x=x, y=y)) +
  ylim(c(0,100)) + 
  #scale_color_discrete(na.translate=F) +
  facet_wrap(~ session, scales = "free_x")
```

```{r}
coords %>% 
  dplyr::group_by(session, stim) %>% 
  dplyr::mutate(mean_mps_roll = zoo::rollmean(x = d_mm, k = 30,fill = NA)) %>% 
  ggplot(aes(x = rec_time, y = d_mm)) +
  ylim(c(0,100)) +
  geom_point(aes(color = stim)) +
  geom_line(aes(x = rec_time, y = mean_mps_roll)) + 
  facet_wrap(~ session, scales = "free_x")
  

```


```{r}
coords %>% 
  dplyr::group_by(session, stim, segments = 50) %>% 
  summarise(mean(d_mm, na.rm = T))
  
```

