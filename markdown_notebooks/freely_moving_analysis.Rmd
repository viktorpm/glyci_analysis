---
title: "Freely moving analysis"
author: "Viktor Plattner"
output:
  html_document:
    css: styles.css
    number_sections: yes
    df_print: paged
    toc: yes
    toc_float: yes
  pdf_document:
    number_sections: yes
    toc: yes
    keep_tex: true
spacing: single
fontsize: 12pt
always_allow_html: yes
header-includes:
   - \usepackage{animate}

params:
  SELECTED_ANIMAL: "GIIFM18b"
  SELECTED_CONTROL: "GIIFM36b"


knit: (
  function (inputFile, encoding) {
    
    rmarkdown::render(  
      input = inputFile,
      encoding = encoding,
      output_file = file.path(
        "notebook_html", 
        paste0("freely_moving_analysis_", 
        rmarkdown::yaml_front_matter(inputFile)$params$SELECTED_ANIMAL,
        "_",
        Sys.Date(),
         ".html")
        ),
      envir = globalenv()
      )
    }
---


```{r setup, include=FALSE}
source(file.path("..","supplementary_functions","md_analysis_setup_script.R"))
# Brief explanation of the sourced script:
# - Loads `tidyverse` for data manipulation and visualization.
# - Defines custom operators/functions for enhanced R capabilities.
# - Dynamically loads additional libraries based on patterns in `.Rmd`/.R` files.
# - Sets a global theme for ggplot objects.
# - Includes custom functions for data filtering and recalculating distances/speeds.

# Define global constants and settings
SCALE <- 1.6 # pixel/mm
FPS <- 25 # frame rate
STANDARD_STIM_LENGTH <- 10 # Default stimulus length in seconds
AROUND_STIM_LENGTH <- FPS * 8 # Stimulus length around default
TIME_RES <- 1 / FPS # Time between frames
ANG_THRESHOLD <- 90 # Angle threshold
MOUSE_SPEED_MPS <- 3.3 # Mouse speed in meters per second
DATAPOINT_TO_PLOT <- 5 # Data points to plot
XLIM_MM <- c(0, 1280 / SCALE) # X-axis limits
YLIM_MM <- c(0, 720 / SCALE) # Y-axis limits
SELECTED_ANIMAL <- params$SELECTED_ANIMAL
SELECTED_CONTROL <- params$SELECTED_CONTROL
SELECTED_INTENSITIES <- c("1 mW", "5 mW", "10 mW")
CONTROL_ANIMALS <- c("GIIFM34b", "GIIFM35b", "GIIFM36b", "GIIFM37b")
DOC_TITLE = "Pno stimulus freely moving analysis"
```



# Loading and orginising data

## Global constants and scales

<br> These are defined in the "setup" chunk <br>

-   **SCALE**: `r SCALE`` (pixels/mm) <br>
-   **FPS**: `r FPS` (frame rate) <br>
-   **TIME_RES**: 1/**FPS** = `r 1/FPS` (time between frames) <br>
-   **XLIM_MM**, **YLIM_MM**: pixels converted to mm (`r paste0(XLIM_MM, ":", YLIM_MM)`)
-   **global_facet_theme**: plot text sizes
-   **DATAPOINT_TO_PLOT**: which datapoint to plot *(frame %% DATAPOINT_TO_PLOT == 0)*
-   **text_layer**: stimulus intensity in each session (used to create the text layer on plots, defined after "coords" was created)

<br>

**Current animal**: `r SELECTED_ANIMAL`\
<br> For the trajectories and traveled distance plots every `r DATAPOINT_TO_PLOT`th frame (data point) was used. <br> The global angle threshold used in this file is `r ANG_THRESHOLD`. Grater rotation angles between consecutive frames are replaced by zero

**Control animals**: GIIFM34b, GIIFM35b, GIIFM36b, GIIFM37b

<br>

## Loading stimulus times (frames)

<br>

This sections loads the stimulus times from a csv file. Data was cleaned using the **CleaningData.R** script

```{r warning=F, message=F, echo=FALSE}
stims <- read.csv(
  file.path("data", "PnO_stim_rotation", "rotation_stims_cleaned.csv")
) %>%
  as_tibble() %>%
  mutate(
    intensity = paste0(intensity, " mW"),
    stim_length = end - start
  ) %>%
  select(-stim_duration) %>%
  rename("stim_number" = stim.number) %>%
  gather(key = "timing", value = "frame", start, end)
# ### to get the proper length later!!!!!!!!!!!!!!!!!!!!!
# dplyr::mutate(
#   frame = ifelse(timing == "end", frame + 1, frame)
# )

stims %>%
  dplyr::filter(animal == SELECTED_ANIMAL) %>%
  head(100)
```

## Loading coordinates

<br>

This sections loads the stimulus times from a csv file

```{r message=F, echo = FALSE, warning = FALSE}
coords_raw <- read.csv(
  file.path("data", "PnO_stim_rotation", "rotation_all_cleaned.csv")
) %>%
  as_tibble() %>%
  mutate(
    animal = gsub(pattern = ".*rotation", replacement = "", animal) %>%
      str_remove_all(pattern = "\\\\") %>%
      str_remove(pattern = "fix") %>% str_remove(pattern = "control")
    # ### frame is 0 indexed turning it to 1 indexed to avoid confusion
    # frame = frame + 1
  ) %>%
  full_join(stims) %>%
  ### creating unique session IDs
  group_by(animal) %>%
  mutate(
    s2 = lag(session, default = "1"),
    s3 = ifelse(s2 == session, 0, 1),
    session = cumsum(s3),
    session = paste0("session_", session)
  ) %>%
  select(-s2, -s3) %>%
  ungroup() %>%
  dplyr::group_by(animal, session) %>%
  dplyr::mutate(
    stim_number = ifelse(timing == "end", NA, stim_number)
  ) %>%
  mutate(grp = cumsum(!is.na(stim_number))) %>%
  dplyr::group_by(animal, session, grp) %>%
  fill(timing) %>%
  mutate(
    stim_freq = replace(stim_freq, timing == "start", stim_freq[1]),
    stim_freq = replace(stim_freq, timing == "end", NA),
    stim_length = replace(stim_length, timing == "start", stim_length[1]),
    stim_length = replace(stim_length, timing == "end", NA),
    intensity = replace(intensity, timing == "start", intensity[1]),
    intensity = replace(intensity, timing == "end", NA),
    stim_number = replace(stim_number, timing == "start", stim_number[1]),
    stim_number = replace(stim_number, timing == "end", NA),
    stim_side = replace(stim_side, timing == "start", stim_side[1]),
    stim_side = replace(stim_side, timing == "end", NA),
    quality = replace(quality, timing == "start", quality[1]),
    quality = replace(quality, timing == "end", NA),
    stim = F,
    stim = replace(stim, timing == "start", T)
  ) %>%
  ungroup() %>%
  group_by(animal, session) %>%
  dplyr::mutate(
    rec_time = (frame / FPS) %>% round(digits = 2),
    stim_categ = case_when(
      stim == T ~ "stim",
      lead(stim, n = AROUND_STIM_LENGTH) == T ~ "before stim",
      lag(stim, n = AROUND_STIM_LENGTH) == T ~ "after stim",
      stim == F ~ "no stim"
    ),

    # shift values to the beginning of the stimulus block ...
    # ... to be able to fill missing values in the next step
    stim_block = ifelse(stim_categ == "no stim", F, T),
    stim_number = lead(stim_number, n = AROUND_STIM_LENGTH),
    intensity = lead(intensity, n = AROUND_STIM_LENGTH),
    stim_freq = lead(stim_freq, n = AROUND_STIM_LENGTH),
    stim_side = lead(stim_side, n = AROUND_STIM_LENGTH),
    quality = lead(quality, n = AROUND_STIM_LENGTH)
  ) %>%
  ungroup() %>%
  group_by(animal, session, stim_block) %>%
  fill(stim_number) %>%
  fill(intensity) %>%
  fill(stim_freq) %>%
  fill(stim_side) %>%
  fill(quality) %>%
  # length of the stimulus
  unite(col = "head", head1, head2, sep = "_") %>%
  unite(col = "center", center1, center2, sep = "_") %>%
  unite(col = "tail", tail1, tail2, sep = "_") %>%
  gather(
    key = "body_part",
    value = "coordinate",
    head, center, tail
  ) %>%
  tidyr::extract(
    col = coordinate, into = c("X", "Y"),
    regex = "([[:alnum:]]+)_([[:alnum:]]+)"
  ) %>%
  dplyr::mutate(
    X = replace(X, miss == 0, NA),
    Y = replace(Y, miss == 0, NA)
  ) %>%
  dplyr::mutate(
    stim_number = replace(stim_number, is.na(stim_number), "no stim")
  )
```

<br> Filtering raw data <br>

```{r}
coords <- coords_raw %>%
  dplyr::filter(
    body_part != "tail",
    animal %!in% c("GIIFM14b", "GIIFM17b"),
  ) %>%
  # this block calculates distances and speed across frames
  dplyr::group_by(animal, body_part, session) %>%
  dplyr::mutate(

    # interpolating missing values
    X_interp = imputeTS::na_interpolation(X %>% as.integer()) %>% round(),
    Y_interp = imputeTS::na_interpolation(Y %>% as.integer()) %>% round(),
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),

    # sometimes the tracking software looses the point and jumps...
    # ...back and forth between unrealistic numbers...
    # ...or starts to follow something else
    # these points are replaced by 0...
    # ...(the animal did not change position between those frames)
    # outliers are defined as Q1 - 3*IQR, Q3 + 3*IQR

    X_diff = ifelse(
      test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
        X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
      yes = 0,
      no = X_diff
    ),
    Y_diff = ifelse(
      Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
        Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
      yes = 0,
      no = Y_diff
    ),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / SCALE,
    speed_instant = d_mm / TIME_RES,
    mmps = speed_instant * (1 / TIME_RES),
    mps = (speed_instant * (1 / TIME_RES)) / 1000,
    sec_counter = cumsum(ifelse(rec_time %% 1 == 0, 1, 0))
  ) %>%
  group_by(animal, session, body_part, sec_counter) %>%
  dplyr::mutate(speed_sec = sum(d_mm, na.rm = T)) %>%
  ungroup() %>%
  # removing "bad" quality stimuli (repeats)
  dplyr::filter(
    quality != "bad" | is.na(quality),
    stim_number %in% c("1", "2", "3", "4", "5", "no stim")
  ) %>%
  ungroup() %>%
  dplyr::group_by(animal, body_part, session) %>%
  # adding the number of repeats in each session, (-1 to remove "no stim")
  dplyr::mutate(
    No_repeats = stim_number %>% unique() %>% length() - 1
  ) %>%
  ungroup() %>%
  # adding the number of repeats in each intensity group
  # (no -1 as "intensity" variable doesn't run through the session)
  dplyr::group_by(animal, body_part, intensity) %>%
  dplyr::mutate(
    No_repeats_intensity = stim_number %>% unique() %>% length()
  )



coords %>%
  dplyr::filter(animal == SELECTED_ANIMAL) %>%
  dplyr::group_by(session, body_part) %>%
  slice(1:5)
```


```{r}
coords_down_sapmpled <- coords %>%
  dplyr::filter(
    frame %% DATAPOINT_TO_PLOT == 0
  ) %>%
  # this block calculates distances and speed across frames
  dplyr::group_by(animal, body_part, session) %>%
  dplyr::mutate(

    # interpolating missing values
    X_interp = imputeTS::na_interpolation(X %>% as.integer()) %>% round(),
    Y_interp = imputeTS::na_interpolation(Y %>% as.integer()) %>% round(),
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),

    # sometimes the tracking software looses the point and jumps...
    # ...back and forth between unrealistic numbers...
    # ...or starts to follow something else
    # these points are replaced by 0...
    # ...(the animal did not change position between those frames)
    # outliers are defined as Q1 - 3*IQR, Q3 + 3*IQR

    X_diff = ifelse(
      test = X_diff < quantile(
        X_diff,
        na.rm = T
      )["25%"] - 3 * IQR(X_diff, na.rm = T) |
        X_diff > quantile(
          X_diff,
          na.rm = T
        )["75%"] + 3 * IQR(X_diff, na.rm = T),
      yes = 0,
      no = X_diff
    ),
    Y_diff = ifelse(
      Y_diff < quantile(
        Y_diff,
        na.rm = T
      )["25%"] - 3 * IQR(Y_diff, na.rm = T) |
        Y_diff > quantile(
          Y_diff,
          na.rm = T
        )["75%"] + 3 * IQR(Y_diff, na.rm = T),
      yes = 0,
      no = Y_diff
    ),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / SCALE,
    speed_instant = d_mm / TIME_RES,
    mmps = speed_instant * (1 / TIME_RES),
    mps = (speed_instant * (1 / TIME_RES)) / 1000,
    sec_counter = cumsum(ifelse(rec_time %% 1 == 0, 1, 0))
  )

coords_down_sapmpled %>%
  dplyr::filter(animal == SELECTED_ANIMAL) %>%
  dplyr::group_by(session, body_part) %>%
  slice(1:5)
```


<br> Length of stimuli, number of repeats of each stimulus with a given intensity <br>

```{r message=F, warning=F, echo=F, include=F}
lengths <- coords %>%
  dplyr::filter(
    body_part == "head",
    stim_categ != "no stim",
  ) %>%
  group_by(animal, session, stim_number, intensity, quality) %>%
  count(stim_categ) %>%
  spread(stim_categ, n) %>%
  select(
    animal, session, stim_number,
    intensity, quality, `before stim`,
    stim, `after stim`
  )


n_repeat <- lengths %>%
  dplyr::group_by(animal, intensity) %>%
  dplyr::filter(intensity %in% SELECTED_INTENSITIES) %>%
  summarise(length(stim_number))
```

```{r include=FALSE}
# Saving separate csv files

# tibble_list <- coords %>%
#   dplyr::filter(
#     str_detect(animal, pattern = "b")
#     ) %>%
#   rename(video = session) %>%
#   dplyr::group_split(animal, video)
#
#
# csv_name_list <- lapply(tibble_list, function(x){
#   paste0(x %>% pull(animal) %>%
#   unique(), "_video_", x %>% pull(video) %>% unique(), ".csv")
# }) %>% unlist()
#
# mapply(
#   write_csv, x = tibble_list,
#   file = file.path("output_data", "separate_csv", csv_name_list)
#   )
#
#
#
# coords %>% names()
# coords %>%
#   select(session,animal,frame,stim_number,stim_categ, X, Y, body_part) %>%
#   # unite(col = "sess_anim", session, animal, sep = "_") %>%
#   unite(col = "coordinates", X, Y, sep = "_" ) %>%
#   tidyr::spread(key = body_part, value = coordinates)


# reshape(timevar = "body_part", direction = "wide") %>% View()


# reshape(
#   idvar = "animal", timevar = "body_part",
#   direction = "wide"
#   ) %>% View()
#
#
#
# group_by(animal, session) %>%
# tidyr::spread(
#   key = body_part,
#   value = X) %>% View()
```

<br> Creating text layer to add intensity values to plots <br>

```{r}
text_layer <- coords %>%
  dplyr::filter(
    animal == SELECTED_ANIMAL, # SELECTED_CONTROL
    stim == T
  ) %>%
  group_by(session) %>%
  summarise(int_label = intensity %>% unique())

text_layer_ctrl <- coords %>%
  dplyr::filter(
    animal == SELECTED_CONTROL,
    stim == T
  ) %>%
  group_by(session) %>%
  summarise(int_label = intensity %>% unique())
```

<br> Creating plot colors <br>

```{r}
gg_color_hue <- function(n) {
  hues <- seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}

n <- 6
cols <- gg_color_hue(n)
```

# Analysis (selected animal: `r SELECTED_ANIMAL`)

## Checking tracking quality

Plotting X and Y positions vs time separately to see jumps in the tracking data and big separation between head-ceter-tail coordinates (unrealistically big mouse). The tracking software occasionally lost the animal and started to follow different points. If there are many of those the session cannot be analysed.

```{r warning=FALSE, fig.width=15, fig.height=10, echo = FALSE}
plt_xpos <- coords %>%
  dplyr::filter(animal == SELECTED_ANIMAL, body_part != "tail") %>%
  ggplot(mapping = aes(x = rec_time, y = X_interp %>% as.integer())) +
  geom_line(aes(col = body_part)) +
  theme(legend.position = "none") +
  ylab("X position") +
  facet_wrap(~session, ncol = 1) +
  ggtitle(paste0("X position: ", SELECTED_ANIMAL))



plt_ypos <- coords %>%
  dplyr::filter(animal == SELECTED_ANIMAL, body_part != "tail") %>%
  ggplot(mapping = aes(x = rec_time, y = Y %>% as.integer())) +
  geom_line(aes(col = body_part)) +
  theme(legend.position = "none") +
  ylab("Y position") +
  facet_wrap(~session, ncol = 1) +
  ggtitle(paste0("Y position: ", SELECTED_ANIMAL))

cowplot::plot_grid(plt_xpos, plt_ypos, ncol = 2)
```

<br> Plotting head-center distances over time. Dashed lines represent the outlier threshold (+- 1.5\*IQR) <br>

```{r fig.width=10, fig.height=10, echo = FALSE, message=FALSE, warning=FALSE}
coords %>%
  dplyr::filter(
    animal == SELECTED_ANIMAL,
    body_part != "tail"
  ) %>%
  dplyr::group_by(session, frame) %>%
  dplyr::mutate(
    dx = diff(X_interp),
    dy = diff(Y_interp),
    # ldx = lead(dx),
    # ldy = lead(dy),
    hc_d = sqrt(dx^2 + dy^2)
  ) %>%
  ungroup() %>%
  dplyr::filter(body_part == "center") %>%
  ggplot(
    mapping = aes(x = rec_time, y = hc_d)
  ) +
  geom_hline(
    aes(
      yintercept = quantile(
        hc_d,
        na.rm = T
      )["25%"] - 1.5 * IQR(hc_d, na.rm = T)
    ),
    col = "gray50",
    lty = "dashed"
  ) +
  geom_hline(
    aes(yintercept = quantile(
      hc_d,
      na.rm = T
    )["75%"] + 1.5 * IQR(hc_d, na.rm = T)),
    col = "gray50",
    lty = "dashed"
  ) +
  geom_line(
    aes(col = stim, group = 1)
  ) +
  geom_label_repel(
    data = . %>%
      dplyr::filter(stim_number != "no stim", stim_categ == "stim") %>%
      dplyr::group_by(session, stim_number) %>%
      slice(1),
    aes(
      x = rec_time,
      y = mean(hc_d, na.rm = T),
      label = quality
    ),
    direction = "x",
    nudge_x = 1
  ) +
  facet_wrap(~session, ncol = 1, scales = "free_y") +
  coord_cartesian(
    ylim = c(20, 130)
  ) +
  global_facet_theme
```

<br> Histograms of head-center distances with boxplots and outliers. <br>

```{r fig.height=10, fig.width=10, message=FALSE, warning=FALSE, echo=FALSE}
coords %>%
  dplyr::filter(
    animal == SELECTED_ANIMAL,
    body_part != "tail"
  ) %>%
  dplyr::group_by(session, frame) %>%
  dplyr::mutate(
    dx = diff(X_interp),
    dy = diff(Y_interp),
    # ldx = lead(dx),
    # ldy = lead(dy),
    hc_d = sqrt(dx^2 + dy^2)
  ) %>%
  ggplot(mapping = aes(x = hc_d / SCALE)) +
  geom_histogram() +
  geom_boxplot(
    aes(y = 1000),
    width = 300,
    outlier.colour = "magenta", col = "blue", alpha = 0.1
  ) +
  facet_grid(session ~ body_part) +
  global_facet_theme
```

<br> Plotting first five head-center distances. <br>

```{r fig.width=10, fig.height=10, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == SELECTED_ANIMAL,
    session == "session_3",
    body_part != "tail"
  ) %>%
  dplyr::group_by(session, frame) %>%
  # dplyr::arrange(body_part) %>%
  dplyr::mutate(
    dx = diff(X_interp),
    dy = diff(Y_interp),
    # ldx = lead(dx),
    # ldy = lead(dy),
    hc_d = sqrt(dx^2 + dy^2)
  ) %>%
  dplyr::group_by(body_part) %>%
  dplyr::slice(1:5) %>%
  ggplot(
    mapping = aes(x = X_interp, y = Y_interp, label = frame)
  ) +
  geom_line(
    aes(group = frame, col = frame %>% as.character()),
  ) +
  geom_point(
    aes(shape = body_part, col = frame %>% as.character()),
    size = 2
  ) +
  geom_label_repel(
    data = . %>% dplyr::filter(body_part == "head"),
    aes(
      x = X_interp + dx / 2,
      y = Y_interp + dy / 2,
      label = hc_d %>% round(4)
    ),
    direction = "x",
    nudge_x = -.7
  )
```

## Dealing with missing coordinates

The tracking software occasionally lost the tracked points. To fill those gaps linear interpolation was applied. The figure below shows the interpolated values in red. Note that only every 5th frame was used for the tracking and for the later analysis except for calculating the rotation angle.

```{r fig.width=10, fig.height=10, warning=FALSE, echo = FALSE}
coords %>%
  dplyr::filter(
    animal == SELECTED_ANIMAL,
    body_part == "center",
    frame %% DATAPOINT_TO_PLOT == 0
  ) %>%
  group_by(session, sec_counter) %>%
  mutate(d_sec = sum(d_mm, na.rm = T)) %>%
  ggplot(
    mapping = aes(x = X_interp, y = Y_interp, label = frame)
  ) +
  geom_point(
    aes(
      color = miss %>% as.character(),
      shape = stim,
      alpha = ifelse(miss == "1", 0.1, 1)
    )
  ) +
  xlim(c(0, 1280)) +
  ylim(c(0, 720)) +
  facet_wrap(~session, ncol = 2) +
  scale_color_discrete(name = "Interpolated values") +
  geom_label(
    data = text_layer,
    aes(
      x = Inf, y = -Inf, hjust = 1.1, vjust = -0.5,
      label = paste0("Intensity: ", int_label)
    )
  ) +
  global_facet_theme
```

## Plotting trajectories

```{r}
plt_taject_stim_baseline <- coords %>%
  dplyr::filter(
    animal == SELECTED_ANIMAL,
    intensity == "5 mW",
    stim == F,
    frame %% DATAPOINT_TO_PLOT == 0
  ) %>%
  ggplot(
    mapping = aes(
      x = X_interp, # / SCALE,
      y = Y_interp, # / SCALE,
      label = frame
    )
  ) +
  geom_path(
    aes(group = frame, col = as.character(stim_number)),
    arrow = grid::arrow(
      ends = "first",
      type = "closed",
      angle = 10,
      length = unit(3, "mm")
    )
  ) +
  xlim(c(0, 1280)) + # / SCALE)) +
  ylim(c(0, 720)) + # / SCALE)) +
  coord_fixed() +
  labs(col = "Stimulus number") +
  xlab("X position [pixel]") +
  ylab("Y position [pixel]") +
  ggtitle(paste0(SELECTED_ANIMAL, " baseline trajectory")) +
  global_facet_theme +
  theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text = element_text(size = 12),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.position = "none"
  )


plt_taject_stim_stim <- coords %>%
  dplyr::filter(
    animal == SELECTED_ANIMAL,
    intensity == "5 mW",
    stim == T,
    frame %% DATAPOINT_TO_PLOT == 0
  ) %>%
  ggplot(
    mapping = aes(
      x = X_interp, # / SCALE,
      y = Y_interp, # / SCALE,
      label = frame
    )
  ) +
  geom_path(
    aes(group = frame, col = as.character(stim_number)),
    arrow = grid::arrow(
      ends = "first",
      type = "closed",
      angle = 10,
      length = unit(3, "mm")
    )
  ) +
  xlim(c(0, 1280)) + # / SCALE)) +
  ylim(c(0, 720)) + # / SCALE)) +
  coord_fixed() +
  labs(col = "Stimulus number") +
  xlab("X position [pixel]") +
  ylab("Y position [pixel]") +
  ggtitle(paste0(SELECTED_ANIMAL, " stimulus trajectory")) +
  global_facet_theme +
  theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text = element_text(size = 12),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.position = "none"
  )


plt_taject_ctrl_baseline <- coords %>%
  dplyr::filter(
    animal == SELECTED_CONTROL,
    intensity == "5 mW",
    stim == F,
    frame %% DATAPOINT_TO_PLOT == 0
  ) %>%
  ggplot(
    mapping = aes(
      x = X_interp, # / SCALE,
      y = Y_interp, # / SCALE,
      label = frame
    )
  ) +
  geom_path(
    aes(group = frame),
    arrow = grid::arrow(
      ends = "first",
      type = "closed",
      angle = 10,
      length = unit(3, "mm")
    )
  ) +
  xlim(c(0, 1280)) + # / SCALE)) +
  ylim(c(0, 720)) + # / SCALE)) +
  coord_fixed() +
  labs(col = "Stimulus number") +
  xlab("X position [pixel]") +
  ylab("Y position [pixel]") +
  ggtitle(paste0(SELECTED_CONTROL, " baseline trajectory")) +
  global_facet_theme +
  theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text = element_text(size = 12),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.position = "none"
  )


plt_taject_ctrl_stim <- coords %>%
  dplyr::filter(
    animal == SELECTED_CONTROL,
    intensity == "5 mW",
    stim == T,
    frame %% DATAPOINT_TO_PLOT == 0
  ) %>%
  ggplot(
    mapping = aes(
      x = X_interp, # / SCALE,
      y = Y_interp, # / SCALE,
      label = frame
    )
  ) +
  geom_path(
    aes(group = frame, col = as.character(stim_number)),
    arrow = grid::arrow(
      ends = "first",
      type = "closed",
      angle = 10,
      length = unit(3, "mm")
    )
  ) +
  xlim(c(0, 1280)) + # / SCALE)) +
  ylim(c(0, 720)) + # / SCALE)) +
  coord_fixed() +
  labs(col = "Stimulus number") +
  xlab("X position [pixel]") +
  ylab("Y position [pixel]") +
  ggtitle(paste0(SELECTED_CONTROL, " stim trajectory")) +
  global_facet_theme +
  theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text = element_text(size = 12),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.position = "none"
  )


#### with facet wrap

plt_taject_stim_wrap <- coords %>%
  dplyr::filter(
    animal == SELECTED_ANIMAL,
    intensity == "5 mW",
    frame %% DATAPOINT_TO_PLOT == 0
  ) %>%
  ggplot(
    mapping = aes(
      x = X_interp, # / SCALE,
      y = Y_interp, # / SCALE,
      label = frame
    )
  ) +
  geom_path(
    aes(group = frame),
    arrow = grid::arrow(
      ends = "first",
      type = "closed",
      angle = 10,
      length = unit(3, "mm")
    )
  ) +
  xlim(c(0, 1280)) + # / SCALE)) +
  ylim(c(0, 720)) + # / SCALE)) +
  coord_fixed() +
  labs(col = "Stimulus number") +
  xlab("X position [pixel]") +
  ylab("Y position [pixel]") +
  ggtitle(paste0(SELECTED_ANIMAL, " trajectory")) +
  facet_wrap(~stim) +
  global_facet_theme +
  theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text = element_text(size = 12),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.position = "none"
  )

plt_taject_ctrl_wrap <- coords %>%
  dplyr::filter(
    animal == SELECTED_CONTROL,
    intensity == "5 mW",
    frame %% DATAPOINT_TO_PLOT == 0
  ) %>%
  ggplot(
    mapping = aes(
      x = X_interp, # / SCALE,
      y = Y_interp, # / SCALE,
      label = frame
    )
  ) +
  geom_path(
    aes(group = frame),
    arrow = grid::arrow(
      ends = "first",
      type = "closed",
      angle = 10,
      length = unit(3, "mm")
    )
  ) +
  xlim(c(0, 1280)) + # / SCALE)) +
  ylim(c(0, 720)) + # / SCALE)) +
  coord_fixed() +
  labs(col = "Stimulus number") +
  xlab("X position [pixel]") +
  ylab("Y position [pixel]") +
  ggtitle(paste0(SELECTED_CONTROL, " trajectory")) +
  facet_wrap(~stim) +
  global_facet_theme +
  theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text = element_text(size = 12),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.position = "none"
  )
```

### Figure 7/E & S6/G
Baseline trajectory: only before and after the stimulus, not the whole session

```{r fig.width=15}
cowplot::plot_grid(
  plt_taject_stim_wrap, 
  plt_taject_ctrl_wrap, 
  nrow = 2
  )
```


## Sum traveled distance by individual stimuli within session (1s before and during the stimulus)

Plotting traveled distance during individual stimuli (4 to 6 repeats) within sessions. Traveled distance is summed through the last second of "before stimulus" category and through first second of the stimulus. Traveled distance "after stimulus" is also included. <br>

The same data is shown on the plots with different groupings: <br>

-   intensities are grouped together (colors), stimulus numbers are separated (panels) <br>
-   stimulus numbers are grouped together (colors), intensities are separated (panels) <br>

<br> The table shows the filtered data (1s before and 1s during stimulus) <br>

```{r message=F, warning=F, echo=F}
coords_1s_window <- bind_rows(
  ### before stim
  coords %>%
    dplyr::filter(
      frame %% DATAPOINT_TO_PLOT == 0,
      stim_categ == "before stim"
    ) %>%
    ### recalculates distances after frames were removed
    dplyr::group_by(animal, body_part, session) %>%
    dplyr::mutate(
      X_diff = c(diff(X_interp), NA) %>% round(4),
      Y_diff = c(diff(Y_interp), NA) %>% round(4),
      X_diff = ifelse(
        test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
          X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
        yes = 0,
        no = X_diff
      ),
      Y_diff = ifelse(
        Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
          Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
        yes = 0,
        no = Y_diff
      ),
      d = sqrt(X_diff^2 + Y_diff^2),
      d_mm = d / SCALE,
      speed_instant = d_mm / TIME_RES,
      mmps = speed_instant * (1 / TIME_RES),
      mps = (speed_instant * (1 / TIME_RES)) / 1000
    ) %>%
    dplyr::group_by(animal, body_part, intensity, stim_categ, stim_number) %>%
    # dplyr::top_n(6),
    dplyr::slice(tail(row_number(), 6)),
  ### stim
  coords %>%
    dplyr::filter(
      frame %% DATAPOINT_TO_PLOT == 0,
      stim_categ == "stim"
    ) %>%
    ### recalculates distances after frames were removed
    dplyr::group_by(animal, body_part, session) %>%
    dplyr::mutate(
      X_diff = c(diff(X_interp), NA) %>% round(4),
      Y_diff = c(diff(Y_interp), NA) %>% round(4),
      X_diff = ifelse(
        test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
          X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
        yes = 0,
        no = X_diff
      ),
      Y_diff = ifelse(
        Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
          Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
        yes = 0,
        no = Y_diff
      ),
      d = sqrt(X_diff^2 + Y_diff^2),
      d_mm = d / SCALE,
      speed_instant = d_mm / TIME_RES,
      mmps = speed_instant * (1 / TIME_RES),
      mps = (speed_instant * (1 / TIME_RES)) / 1000
    ) %>%
    dplyr::group_by(animal, body_part, intensity, stim_categ, stim_number) %>%
    dplyr::slice(1:6),
  ### after stim
  coords %>%
    dplyr::filter(
      frame %% DATAPOINT_TO_PLOT == 0,
      stim_categ == "after stim"
    ) %>%
    ### recalculates distances after frames were removed
    dplyr::group_by(animal, body_part, session) %>%
    dplyr::mutate(
      X_diff = c(diff(X_interp), NA) %>% round(4),
      Y_diff = c(diff(Y_interp), NA) %>% round(4),
      X_diff = ifelse(
        test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
          X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
        yes = 0,
        no = X_diff
      ),
      Y_diff = ifelse(
        Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
          Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
        yes = 0,
        no = Y_diff
      ),
      d = sqrt(X_diff^2 + Y_diff^2),
      d_mm = d / SCALE,
      speed_instant = d_mm / TIME_RES,
      mmps = speed_instant * (1 / TIME_RES),
      mps = (speed_instant * (1 / TIME_RES)) / 1000
    ) %>%
    dplyr::group_by(animal, body_part, intensity, stim_categ, stim_number) %>%
    # dplyr::top_n(6),
    dplyr::slice(head(row_number(), 6))
  
) %>% arrange(animal, body_part, session, stim_number, stim_categ)


coords_1s_window %>%
  dplyr::filter(
    animal == SELECTED_ANIMAL,
    intensity %in% SELECTED_INTENSITIES
  ) %>%
  select(session, animal, frame, rec_time, stim_categ, d, stim_number, intensity, body_part, X_diff, Y_diff) %>%
  arrange(animal, body_part, session, stim_number, rec_time) %>%
  head(800) 
```

```{r message=F, warning=F, echo=F}
coords_8s_window <- bind_rows(
  ### before stim
  coords %>%
    dplyr::filter(
      frame %% DATAPOINT_TO_PLOT == 0,
      stim_categ == "before stim"
    ) %>%
    ### recalculates distances after frames were removed
    dplyr::group_by(animal, body_part, session) %>%
    dplyr::mutate(
      X_diff = c(diff(X_interp), NA) %>% round(4),
      Y_diff = c(diff(Y_interp), NA) %>% round(4),
      X_diff = ifelse(
        test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
          X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
        yes = 0,
        no = X_diff
      ),
      Y_diff = ifelse(
        Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
          Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
        yes = 0,
        no = Y_diff
      ),
      d = sqrt(X_diff^2 + Y_diff^2),
      d_mm = d / SCALE,
      speed_instant = d_mm / TIME_RES,
      mmps = speed_instant * (1 / TIME_RES),
      mps = (speed_instant * (1 / TIME_RES)) / 1000
    ) %>%
    dplyr::group_by(animal, body_part, intensity, stim_categ, stim_number) %>%
    # dplyr::top_n(41),
    dplyr::slice(tail(row_number(), 41)),
  ### stim
  coords %>%
    dplyr::filter(
      frame %% DATAPOINT_TO_PLOT == 0,
      stim_categ == "stim"
    ) %>%
    ### recalculates distances after frames were removed
    dplyr::group_by(animal, body_part, session) %>%
    dplyr::mutate(
      X_diff = c(diff(X_interp), NA) %>% round(4),
      Y_diff = c(diff(Y_interp), NA) %>% round(4),
      X_diff = ifelse(
        test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
          X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
        yes = 0,
        no = X_diff
      ),
      Y_diff = ifelse(
        Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
          Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
        yes = 0,
        no = Y_diff
      ),
      d = sqrt(X_diff^2 + Y_diff^2),
      d_mm = d / SCALE,
      speed_instant = d_mm / TIME_RES,
      mmps = speed_instant * (1 / TIME_RES),
      mps = (speed_instant * (1 / TIME_RES)) / 1000
    ) %>%
    dplyr::group_by(animal, body_part, intensity, stim_categ, stim_number) %>%
    dplyr::slice(1:41),
  ### after stim
  coords %>%
    dplyr::filter(
      frame %% DATAPOINT_TO_PLOT == 0,
      stim_categ == "after stim"
    ) %>%
    ### recalculates distances after frames were removed
    dplyr::group_by(animal, body_part, session) %>%
    dplyr::mutate(
      X_diff = c(diff(X_interp), NA) %>% round(4),
      Y_diff = c(diff(Y_interp), NA) %>% round(4),
      X_diff = ifelse(
        test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
          X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
        yes = 0,
        no = X_diff
      ),
      Y_diff = ifelse(
        Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
          Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
        yes = 0,
        no = Y_diff
      ),
      d = sqrt(X_diff^2 + Y_diff^2),
      d_mm = d / SCALE,
      speed_instant = d_mm / TIME_RES,
      mmps = speed_instant * (1 / TIME_RES),
      mps = (speed_instant * (1 / TIME_RES)) / 1000
    ) %>%
    dplyr::group_by(animal, body_part, intensity, stim_categ, stim_number) %>%
    # dplyr::top_n(41),
    dplyr::slice(head(row_number(), 41)),
) %>% arrange(animal, body_part, session, stim_number, stim_categ)


coords_8s_window %>%
  dplyr::filter(
    animal == SELECTED_ANIMAL,
    intensity %in% SELECTED_INTENSITIES
  ) %>%
  select(session, animal, frame, rec_time, stim_categ, d, stim_number, intensity, body_part, X_diff, Y_diff) %>%
  arrange(rec_time) 
  head(200)
```


## Calculating angles

### Toy data

```{r}
vectors <- tibble(
  body = c("cent", "h", "cent", "h", "cent", "h", "cent", "h"),
  frame = c(0, 0, 1, 1, 2, 2, 3, 3),
  X = c(750, 760, 770, 770, 755, 765, 755, 765),
  Y = c(500, 500, 500, 520, 510, 520, 510, 500)
)
vectors %>% arrange(body)
```

```{r}
ang <- function(a, b) {
  theta <- acos(sum(a * b) / (sqrt(sum(a * a)) * sqrt(sum(b * b))))
  return(theta * 180 / pi)
}

# ang(a = c(10, 0), b = c(10, 10))

vectors %>%
  group_by(frame) %>%
  summarise(dx = diff(X), dy = diff(Y)) %>%
  mutate(ldx = lead(dx), ldy = lead(dy)) %>%
  # rowwise() %>%
  mutate(angle = ang(a = c(dx, dy), b = c(ldx, ldy))) %>%
  ungroup() %>%
  mutate(
    signed_angle = (atan2(dx, dy) - atan2(ldx, ldy)) * 180 / (pi)
  )
```

```{r}
matlib::angle(
  x = vectors %>%
    group_by(frame) %>%
    summarise(dx = diff(X), dy = diff(Y)) %>%
    dplyr::filter(frame == "0") %>%
    select(-1) %>% as.matrix() %>% as.vector(),
  y = vectors %>%
    group_by(frame) %>%
    summarise(dx = diff(X), dy = diff(Y)) %>%
    dplyr::filter(frame == "2") %>%
    select(-1) %>% as.matrix() %>% as.vector()
)
```

The dot product of two vectors x and y can be defined as:

$$x \cdot y = ||x|| * ||y|| \cos(\theta)$$

```{r}
vectors %>%
  ggplot(mapping = aes(x = X, y = Y)) +
  geom_point(aes(shape = body)) +
  geom_line(aes(group = frame, color = frame %>% as.character())) +
  geom_text_repel(aes(label = paste0(X, ",", Y), col = as.character(frame))) +
  xlim(750, 775) +
  ylim(500, 525)
```

### Real data (coords tibble)

#### First 10 head - center vectors

```{r echo = FALSE ,message=FALSE, warning=FALSE}
coords %>%
  dplyr::filter(animal == SELECTED_ANIMAL) %>%
  dplyr::group_by(body_part) %>%
  slice(1:10) %>%
  dplyr::filter(body_part != "tail") %>%
  ggplot(
    mapping = aes(x = X, y = Y)
  ) +
  geom_point(aes(shape = body_part), size = 2) +
  geom_line(aes(group = frame, color = as.character(frame))) +
  geom_text_repel(aes(label = paste0(X, ",", Y), col = as.character(frame))) +
  geom_segment(
    data = coords %>%
      dplyr::filter(animal == SELECTED_ANIMAL) %>%
      dplyr::group_by(body_part) %>%
      slice(1:10) %>%
      dplyr::filter(body_part != "tail", frame == 0),
    aes(
      x = X[1], xend = X[2],
      y = Y[1], yend = Y[1]
    ), linetype = "dashed", col = "red"
  ) +
  geom_segment(
    data = coords %>%
      dplyr::filter(animal == SELECTED_ANIMAL) %>%
      dplyr::group_by(body_part) %>%
      slice(1:10) %>%
      dplyr::filter(body_part != "tail", frame == 0),
    aes(
      x = X[2], xend = X[2],
      y = Y[1], yend = Y[2]
    ), linetype = "dashed", col = "red"
  )
```

```{r eval=FALSE}
coords %>%
  dplyr::filter(animal == "GIIFM19b") %>%
  dplyr::group_by(body_part) %>%
  slice(1:3) %>%
  dplyr::filter(body_part != "tail", frame == 0) %>%
  pull(X)
```

#### Distribution of angles

Because of the periodicity of tangent function unrealistic angles were introduced (jumps in data). Angles greater than 180 or smaller than -180 were subtracted from 360 and -360 respectively to get the correct angle.

In the control animals (34, 35, 36, 37) there are unrealistically large angles between frames probably due to tracking problem (switch of head and tail/center coordinate). Those angles are replaced by 0!

mutate(signed_angle_corrected = ifelse(signed_angle_corrected %\>% abs() \> ang_treshold, 0, signed_angle_corrected))

```{r message=FALSE, fig.width=10, fig.height=10, warning=FALSE, echo = FALSE}
coords %>%
  dplyr::filter(animal == SELECTED_ANIMAL, body_part != "tail") %>%
  dplyr::filter(body_part != "tail") %>%
  dplyr::group_by(animal, session, frame) %>%
  summarise(
    vectx = diff(X_interp),
    vecty = diff(Y_interp)
  ) %>%
  mutate(
    leadx = lead(vectx),
    leady = lead(vecty)
  ) %>%
  mutate(
    signed_angle = (atan2(leadx, leady) - atan2(vectx, vecty)) * 180 / (pi)
  ) %>%
  mutate(
    signed_angle_corrected = case_when(
      signed_angle >= 180 ~ 360 - signed_angle,
      signed_angle %>% abs() < 180 ~ signed_angle,
      signed_angle <= -180 ~ -360 - signed_angle,
      signed_angle > -180 | signed_angle < 0 ~ signed_angle
    )
  ) %>%
  ### removing unrealistically large angles
  mutate(signed_angle_corrected = ifelse(signed_angle_corrected %>% abs() > ANG_THRESHOLD, 0, signed_angle_corrected)) %>%
  ggplot(aes(x = signed_angle_corrected)) +
  geom_histogram() +
  facet_wrap(~session, scales = "free") +
  global_facet_theme
```

#### Calculating signed angles

```{r message=F, warning=F, echo = FALSE}
corrected_angles <- coords %>%
  dplyr::filter(
    animal == SELECTED_ANIMAL,
    # frame %% DATAPOINT_TO_PLOT == 0, ### here it's good to have all the data points to calculate the cumulative angles
    body_part != "tail"
  ) %>%
  dplyr::group_by(session, frame) %>%
  mutate(
    vectx = diff(X_interp),
    vecty = diff(Y_interp)
  ) %>%
  dplyr::group_by(session) %>%
  mutate(
    leadx = lead(vectx),
    leady = lead(vecty)
  ) %>%
  mutate(
    signed_angle = (atan2(leadx, leady) - atan2(vectx, vecty)) * 180 / (pi)
  ) %>%
  mutate(
    signed_angle_corrected = case_when(
      signed_angle >= 180 ~ 360 - signed_angle,
      signed_angle %>% abs() < 180 ~ signed_angle,
      signed_angle <= -180 ~ -360 - signed_angle,
      signed_angle > -180 | signed_angle < 0 ~ signed_angle
    )
  ) %>%
  ### removing unrealistically large angles
  mutate(signed_angle_corrected = ifelse(signed_angle_corrected %>% abs() > ANG_THRESHOLD, 0, signed_angle_corrected))
```


#### Plotting cumulative angles

Cumulative signed rotation angles during the sessions.


```{r}
line_cols <- gg_color_hue(3)
group_colors <- c(
  "no stim" = "gray30", "before stim" = line_cols[1],
  "stim" = line_cols[3], "after stim" = line_cols[2]
)
```


```{r message=FALSE,fig.width=10, fig.height=10}
corrected_angles %>%
  dplyr::filter(body_part == "center") %>%
  group_by(session) %>%
  mutate(csum = cumsum(ifelse(is.na(signed_angle_corrected), 0, signed_angle_corrected)) %>% round(4)) %>%
  ggplot(
    mapping = aes(x = rec_time, y = csum %>% scale())
  ) +
  geom_line(aes(col = stim_categ, group = 1)) +
  facet_wrap(~session, scales = "free_x", ncol = 1) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label))) +
  scale_color_manual(values = group_colors) +
  global_facet_theme
```

# Population analysis

## Rotation

Calculating signed population angles

```{r message=FALSE, warning=FALSE, echo = FALSE}
corrected_angles_population <- coords %>%
  dplyr::filter(
    ### remove session 6, 15 mW: not according to protocol
    animal != "GIIFM20b" | session != "session_6",
    body_part != "tail"
  ) %>%
  dplyr::group_by(animal, session, frame) %>%
  mutate(
    vectx = diff(X_interp),
    vecty = diff(Y_interp),
  ) %>%
  group_by(animal, session) %>%
  mutate(
    leadx = lead(vectx),
    leady = lead(vecty)
  ) %>%
  mutate(
    signed_angle = (atan2(leadx, leady) - atan2(vectx, vecty)) * 180 / (pi)
  ) %>%
  mutate(
    signed_angle_corrected = case_when(
      signed_angle >= 180 ~ 360 - signed_angle,
      signed_angle %>% abs() < 180 ~ signed_angle,
      signed_angle <= -180 ~ -360 - signed_angle,
      signed_angle > -180 | signed_angle < 0 ~ signed_angle
    )
  ) %>%
  ### removing unrealistically large angles
  mutate(
    signed_angle_corrected = ifelse(
      signed_angle_corrected %>% abs() > ANG_THRESHOLD,
      0,
      signed_angle_corrected
    )
  ) %>%
  ### adding ipsi or contra rotation variable
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::mutate(
    ipsicontra = case_when(
      sum(signed_angle_corrected, na.rm = T) > 0 & stim_side == "left" & stim_categ == "stim" ~ "ipsi",
      sum(signed_angle_corrected, na.rm = T) > 0 & stim_side == "right" & stim_categ == "stim" ~ "contra",
      sum(signed_angle_corrected, na.rm = T) < 0 & stim_side == "left" & stim_categ == "stim" ~ "contra",
      sum(signed_angle_corrected, na.rm = T) < 0 & stim_side == "right" & stim_categ == "stim" ~ "ipsi",
    )
  )
```


### Figure 7/F & S6/J
Mean/sum rotation angle by intensity (stimulus and control)

```{r message=FALSE, fig.height=12, fig.width=15, echo = FALSE}
plt1_angle <- corrected_angles_population %>%
  dplyr::filter(
    # animal == "GIIFM19b",
    animal %!in% c(CONTROL_ANIMALS, "GIIFM14b", "GIIFM17b"),
    body_part == "head",
    stim_categ != "no stim",
    # stim_side == "left"
  ) %>%
  dplyr::filter(intensity %in% c(SELECTED_INTENSITIES, "15 mW")) %>%
  dplyr::group_by(animal, stim_side, intensity, stim_categ) %>%
  dplyr::summarise(
    sum_ang = sum(signed_angle_corrected, na.rm = T),
    mean_ang = mean(signed_angle_corrected, na.rm = T),
    med_ang = median(signed_angle_corrected, na.rm = T),
    sd_ang = sd(signed_angle_corrected, na.rm = T),
    sem_ang = sem(signed_angle_corrected),
    all_stim_categ_length_row = length(signed_angle_corrected),
    mean_ang_manual = sum_ang / all_stim_categ_length_row
  ) %>%
  dplyr::mutate(
    ipsicontra = case_when(
      sum_ang > 0 & stim_side == "left" & stim_categ == "stim" ~ "ipsi",
      sum_ang > 0 & stim_side == "right" & stim_categ == "stim" ~ "contra",
      sum_ang < 0 & stim_side == "left" & stim_categ == "stim" ~ "contra",
      sum_ang < 0 & stim_side == "right" & stim_categ == "stim" ~ "ipsi",
    )
  ) %>%
  dplyr::group_by(animal, intensity) %>%
  fill(ipsicontra, .direction = "up") %>% # write.csv(file = file.path("output_data","to_publish","Emivel","PnO_mean_No_rotation_per_second_stim.csv"))
  # dplyr::filter(
  #   sum_ang[stim_categ == "stim"] > 0) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      # * 25: number of frames in a second. To get the mean rotation angle per second. /360: mean portion of one full circle per second
      y = ((mean_ang * 25) %>% abs()) / 360 # %>% abs() /360  # sum_ang %>% abs() # / max(sum_ang %>% abs()) # %>% scale()
    )
  ) +
  geom_point(aes(fill = animal), shape = 21, size = 4) +
  geom_line(aes(group = animal)) +
  ggpubr::stat_compare_means(
    method = "wilcox.test",
    paired = T,
    method.args = list(alternative = "less"),
    comparisons = list(c("before stim", "stim")),
    vjust = 1.5,
    hide.ns = F
    # label.y = 3000
  ) +
  ggpubr::stat_compare_means(
    method = "wilcox.test",
    paired = T,
    method.args = list(alternative = "greater"),
    comparisons = list(c("stim", "after stim")),
    vjust = 1.5,
    hide.ns = F
    # label.y = 3000
  ) +
  facet_grid(~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))) +
  global_facet_theme +
  expand_limits(y = c(0, 4 * 25 / 360)) +
  # xlab("State") +
  # ylab("Scaled sum angle") +
  ggtitle("Stimulus") +
  theme(aspect.ratio = 1) +
  theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text = element_text(size = 12),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black")
  )


plt2_angle <- corrected_angles_population %>%
  dplyr::filter(
    animal %in% CONTROL_ANIMALS,
    body_part == "head",
    stim_categ != "no stim",
    # stim_side == "right"
  ) %>%
  dplyr::filter(intensity %in% c(SELECTED_INTENSITIES, "15 mW")) %>%
  dplyr::group_by(animal, stim_side, intensity, stim_categ) %>%
  dplyr::summarise(
    sum_ang = sum(signed_angle_corrected, na.rm = T),
    max_sum_ang = sum_ang %>% max(),
    mean_ang = mean(signed_angle_corrected, na.rm = T),
    med_ang = median(signed_angle_corrected, na.rm = T),
    sd_ang = sd(signed_angle_corrected, na.rm = T),
    sem_ang = sem(signed_angle_corrected),
    all_stim_categ_length_row = length(signed_angle_corrected),
    mean_ang_manual = sum_ang / all_stim_categ_length_row
  ) %>%
  dplyr::mutate(
    max_sum_ang = replace(max_sum_ang, max_sum_ang == "stim", NA)
  ) %>%
  fill(max_sum_ang) %>% # write.csv(file = file.path("output_data","to_publish","Emivel","PnO_mean_No_rotation_per_second_control.csv"))
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      # * 25: number of frames in a second. To get the mean rotation angle per second. /360: mean portion of one full circle per second
      y = ((mean_ang * 25) %>% abs()) / 360 # %>% abs() / 360  # sum_ang %>% abs() # / max(sum_ang %>% abs())# %>% scale()
    )
  ) +
  geom_point(aes(fill = animal), shape = 21, size = 4) +
  geom_line(aes(group = animal)) +
  ggpubr::stat_compare_means(
    method = "wilcox.test",
    paired = T,
    method.args = list(alternative = "less"),
    comparisons = list(c("before stim", "stim")),
    vjust = 1.5,
    hide.ns = F
    # label.y = 3000
  ) +
  ggpubr::stat_compare_means(
    method = "wilcox.test",
    paired = T,
    method.args = list(alternative = "greater"),
    comparisons = list(c("stim", "after stim")),
    vjust = 1.5,
    hide.ns = F
    # label.y = 3000
  ) +
  facet_wrap(~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique())), ncol = 4) +
  global_facet_theme +
  expand_limits(y = c(0, 4 * 25 / 360)) +
  # xlab("State") +
  # ylab("Scaled sum angle") +
  ggtitle("Control") +
  theme(aspect.ratio = 1) +
  theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text = element_text(size = 12),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black")
  )

cowplot::plot_grid(
  plt1_angle, plt2_angle, 
  nrow = 2,
  labels = paste0(DOC_TITLE, ", ", "mean rotation angle by intensity")
  )

# plt1_angle$data %>%
#   dplyr::group_by(intensity,stim_categ) %>%
#   dplyr::summarise(
#     mean(((mean_ang * 25)  %>% abs()) /360),
#     sd(((mean_ang * 25)  %>% abs()) /360),
#     median(((mean_ang * 25)  %>% abs()) /360))


# plt2_angle$data %>%
#   dplyr::group_by(intensity,stim_categ) %>%
#   dplyr::summarise(
#     mean(((mean_ang * 25)  %>% abs()) /360),
#     sd(((mean_ang * 25)  %>% abs()) /360),
#     median(((mean_ang * 25)  %>% abs()) /360))
```

### Figure 7/H


```{r}
corrected_angles_population %>%
  dplyr::filter(
    animal %!in% c(CONTROL_ANIMALS, "GIIFM14b", "GIIFM17b"),
    body_part == "head",
    stim_categ != "no stim",
  ) %>%
  dplyr::filter(intensity %in% c(SELECTED_INTENSITIES, "15 mW")) %>%
  dplyr::group_by(animal, stim_side, stim_categ) %>%
  dplyr::summarise(
    sum_ang = sum(signed_angle_corrected, na.rm = T),
    mean_ang = mean(signed_angle_corrected, na.rm = T),
    med_ang = median(signed_angle_corrected, na.rm = T),
    sd_ang = sd(signed_angle_corrected, na.rm = T),
    sem_ang = sem(signed_angle_corrected)
  ) %>%
  dplyr::mutate(
    ipsicontra = case_when(
      sum_ang > 0 & stim_side == "left" & stim_categ == "stim" ~ "ipsi",
      sum_ang > 0 & stim_side == "right" & stim_categ == "stim" ~ "contra",
      sum_ang < 0 & stim_side == "left" & stim_categ == "stim" ~ "contra",
      sum_ang < 0 & stim_side == "right" & stim_categ == "stim" ~ "ipsi",
    )
  ) %>%
  dplyr::group_by(animal) %>%
  fill(ipsicontra, .direction = "up") %>%
  ungroup() %>%
  dplyr::mutate(
    sum_ang_ipsicontra = ifelse(ipsicontra == "contra", sum_ang %>% abs(), -(sum_ang %>% abs())),
    mean_ang_ipsicontra = ifelse(ipsicontra == "contra", mean_ang %>% abs(), -(mean_ang %>% abs()))
  ) %>% # write.csv(file = file.path("output_data","to_publish","Emivel","PnO_mean_No_rotation_per_second_all_intensities_ipsicontra.csv"))
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      y = (mean_ang_ipsicontra * 25) / 360 # sum_ang %>% abs() /360  # sum_ang %>% abs() # / max(sum_ang %>% abs()) # %>% scale()
    )
  ) +
  geom_point(aes(fill = animal), shape = 21, size = 4) +
  geom_line(aes(group = animal)) +
  geom_hline(yintercept = 0, col = "gray") +
  annotate(geom = "text", x = 3, hjust = -0.15, y = -0.02, label = "ipsilateral", col = "gray") +
  annotate(geom = "text", x = 3, hjust = -0.15, y = 0.02, label = "contralateral", col = "gray") +
  global_facet_theme +
  expand_limits(y = c(-0.2, 0.2), x = c(0, 4)) +
  # xlab("State") +
  # ylab("Scaled sum angle") +
  ggtitle("Stimulus") +
  theme(aspect.ratio = 1) +
  theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text = element_text(size = 12),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black")
  )


# corrected_angles_population %>%
#   dplyr::filter(
#     animal %!in% c(CONTROL_ANIMALS, "GIIFM14b", "GIIFM17b"),
#     body_part == "head",
#     stim_categ != "no stim",
#   ) %>%
#   dplyr::filter(intensity %in% c(SELECTED_INTENSITIES, "15 mW")) %>%
#   dplyr::group_by(animal, stim_side, stim_categ) %>%
#   dplyr::summarise(
#     sum_ang = sum(signed_angle_corrected, na.rm = T),
#     mean_ang = mean(signed_angle_corrected, na.rm = T),
#     med_ang = median(signed_angle_corrected, na.rm = T),
#     sd_ang = sd(signed_angle_corrected, na.rm = T),
#     sem_ang = sem(signed_angle_corrected)
#   ) %>%
#   dplyr::mutate(
#     ipsicontra = case_when(
#       sum_ang > 0 & stim_side == "left" & stim_categ == "stim" ~ "ipsi",
#       sum_ang > 0 & stim_side == "right" & stim_categ == "stim" ~ "contra",
#       sum_ang < 0 & stim_side == "left" & stim_categ == "stim" ~ "contra",
#       sum_ang < 0 & stim_side == "right" & stim_categ == "stim" ~ "ipsi",
#     )
#   ) %>%
#   dplyr::group_by(animal) %>%
#   fill(ipsicontra, .direction = "up") %>%
#   ungroup() %>%
#   dplyr::mutate(
#     sum_ang_ipsicontra = ifelse(ipsicontra == "contra", sum_ang %>% abs(), -(sum_ang %>% abs())),
#     mean_ang_ipsicontra = ifelse(ipsicontra == "contra", mean_ang %>% abs(), -(mean_ang %>% abs()))
#   ) %>% 
#   dplyr::group_by(stim_categ,ipsicontra) %>% 
#   dplyr::summarise(
#     mean = mean((mean_ang_ipsicontra * 25) / 360)
#   )

```





```{r fig.width=15}
generate_angle_dose_plot <- function(include_control) {
  corrected_angles_population %>%
    dplyr::filter(
      if (include_control) {
        animal %in% CONTROL_ANIMALS
      } else {
        animal %!in% CONTROL_ANIMALS
      },
      body_part == "head",
      stim_categ != "no stim",
      # stim_side == "left"
    ) %>%
    dplyr::filter(intensity %in% c(SELECTED_INTENSITIES, "15 mW")) %>%
    dplyr::group_by(animal, intensity, stim_categ) %>%
    dplyr::summarise(
      sum_ang = sum(signed_angle_corrected, na.rm = T),
      mean_ang = mean(signed_angle_corrected, na.rm = T),
      med_ang = median(signed_angle_corrected, na.rm = T),
      sd_ang = sd(signed_angle_corrected, na.rm = T),
      sem_ang = sem(signed_angle_corrected)
    ) %>%
    dplyr::filter(
      stim_categ == "stim"
    ) %>% # write.csv(file = file.path("output_data","to_publish","Emivel","PnO_dose_intensity_rotation_control.csv"))

    ggplot(
      mapping = aes(
        x = forcats::fct_relevel(intensity, "1 mW", "5 mW", "10 mW", "15 mW"),
        y = ((mean_ang * 25) %>% abs()) / 360
      )
    ) +
    geom_point(aes(fill = animal), shape = 21, size = 4) +
    geom_boxplot(alpha = 0) +
    ggpubr::stat_compare_means(
      method = "wilcox.test",
      paired = F,
      method.args = list(alternative = "two.sided"),
      comparisons = list(c("1 mW", "5 mW"), c("1 mW", "10 mW"), c("1 mW", "15 mW")),
      vjust = 1.5,
      hide.ns = F
      # label.y = 3000
    ) +
    global_facet_theme +
    expand_limits(y = c(0, 0.2)) +
    # xlab("State") +
    # ylab("Scaled sum angle") +
    # ggtitle("Stimulus") +
    theme(aspect.ratio = 1) +
    theme(
      axis.title.x = element_text(size = 12),
      axis.title.y = element_text(size = 12),
      axis.text = element_text(size = 12),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(colour = "black")
    ) +
    if (include_control) {
      ggtitle("Control")
    } else {
      ggtitle("Stimulus")
    }
}

# Generate plots for both control and non-control groups
plt_ang_dose_ctrl <- generate_angle_dose_plot(TRUE)
plt_ang_dose_stim <- generate_angle_dose_plot(FALSE)


cowplot::plot_grid(
  plt_ang_dose_stim, plt_ang_dose_ctrl, 
  ncol = 2,
  labels = paste0(DOC_TITLE, ", ", "mean rotation angle dose dependency")
  )
```

## Traveled distance

```{r}
# saving the mean of the "before stim" "sum traveled distance" of all the animals (by intensity) for normalization

mean_sum_d_1mW <- coords_1s_window %>%
  dplyr::filter(
    frame %% DATAPOINT_TO_PLOT == 0,
    body_part == "center",
    intensity %in% SELECTED_INTENSITIES
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::summarise(sum_d = sum(d, na.rm = T)) %>%
  dplyr::group_by(intensity, stim_categ) %>%
  dplyr::summarise(mean_sum_d = mean(sum_d)) %>%
  dplyr::filter(
    stim_categ == "before stim",
    intensity == "1 mW"
  ) %>%
  pull(mean_sum_d)

mean_sum_d_5mW <- coords_1s_window %>%
  dplyr::filter(
    frame %% DATAPOINT_TO_PLOT == 0,
    body_part == "center",
    intensity %in% SELECTED_INTENSITIES
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::summarise(sum_d = sum(d, na.rm = T)) %>%
  dplyr::group_by(intensity, stim_categ) %>%
  dplyr::summarise(mean_sum_d = mean(sum_d)) %>%
  dplyr::filter(
    stim_categ == "before stim",
    intensity == "5 mW"
  ) %>%
  pull(mean_sum_d)

mean_sum_d_10mW <- coords_1s_window %>%
  dplyr::filter(
    frame %% DATAPOINT_TO_PLOT == 0,
    body_part == "center",
    intensity %in% SELECTED_INTENSITIES
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::summarise(sum_d = sum(d, na.rm = T)) %>%
  dplyr::group_by(intensity, stim_categ) %>%
  dplyr::summarise(mean_sum_d = mean(sum_d)) %>%
  dplyr::filter(
    stim_categ == "before stim",
    intensity == "10 mW"
  ) %>%
  pull(mean_sum_d)

mean_sum_d_15mW <- coords_1s_window %>%
  dplyr::filter(
    frame %% DATAPOINT_TO_PLOT == 0,
    body_part == "center",
    intensity %in% c(SELECTED_INTENSITIES, "15 mW")
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::summarise(sum_d = sum(d, na.rm = T)) %>%
  dplyr::group_by(intensity, stim_categ) %>%
  dplyr::summarise(mean_sum_d = mean(sum_d)) %>%
  dplyr::filter(
    stim_categ == "before stim",
    intensity == "15 mW"
  ) %>%
  pull(mean_sum_d)


coords_1s_window %>%
  dplyr::filter(
    frame %% DATAPOINT_TO_PLOT == 0,
    body_part == "center",
    intensity %in% c(SELECTED_INTENSITIES, "15 mW")
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::summarise(sum_d = sum(d, na.rm = T)) %>%
  dplyr::group_by(intensity, stim_categ) %>%
  dplyr::summarise(
    mean_sum_d = mean(sum_d),
    sd_sum_d = sd(sum_d)
  )
```


### Figure S6/A, H

Combining 1 sec before stim and stim division to 1st and last 9 sec tables. In control cases if I normalize with the period length the "last_part" drops. The reason is that the animal moves at a constant rate so dividing the mean traveled distance will decrease the mean.

```{r fig.width=15}
generate_pop_dist_summary_plot <- function(include_control) {
  bind_rows(
    ### before stim 1 sec
    coords_1s_window %>%
      dplyr::filter(
        stim_categ == "before stim",
        body_part == "center"
      ) %>%
      dplyr::mutate(
        stim_division = "before_stim",
        stim_div_length = 1
      ),
    ### stim devided to first_part (1s) and last part (9s)
    coords %>%
      dplyr::filter(
        frame %% DATAPOINT_TO_PLOT == 0,
        stim_categ == "stim",
        body_part == "center"
      ) %>%
      ### recalculates distances after frames were removed
      dplyr::group_by(animal, body_part, session) %>%
      dplyr::mutate(
        X_diff = c(diff(X_interp), NA) %>% round(4),
        Y_diff = c(diff(Y_interp), NA) %>% round(4),
        X_diff = ifelse(
          test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
            X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
          yes = 0,
          no = X_diff
        ),
        Y_diff = ifelse(
          Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
            Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
          yes = 0,
          no = Y_diff
        ),
        d = sqrt(X_diff^2 + Y_diff^2),
        d_mm = d / SCALE,
        speed_instant = d_mm / TIME_RES,
        mmps = speed_instant * (1 / TIME_RES),
        mps = (speed_instant * (1 / TIME_RES)) / 1000
      ) %>%
      dplyr::ungroup() %>%
      dplyr::group_by(animal, body_part, session, stim_number) %>%
      dplyr::mutate(
        stim_division = ifelse(rec_time <= min(rec_time) + 1, yes = "first_part", no = "last_part"),
        # stim_div_length = ifelse(rec_time <= min(rec_time) + 1, yes = 1, no = 9)
      )
  ) %>%
    dplyr::filter(
      animal != "GIIFM20b" | session != "session_6"
    ) %>%
    arrange(animal, session, stim_number, rec_time) %>%
    dplyr::group_by(animal, intensity, stim_categ, stim_division) %>%
    dplyr::mutate(
      stim_div_length_row = length(stim_division)
    ) %>%
    dplyr::group_by(
      animal, intensity, stim_categ, stim_division, across(stim_div_length_row)
    ) %>%
    dplyr::summarise(
      sum_d = sum(d, na.rm = T),
      mean_d = mean(d, na.rm = T),
      max_sum_d = sum_d %>% max()
    ) %>%
    dplyr::mutate(
      max_sum_d = replace(max_sum_d, stim_categ == "stim", NA),
      mean_sum_d = case_when(
        intensity == "1 mW" ~ mean_sum_d_1mW,
        intensity == "5 mW" ~ mean_sum_d_5mW,
        intensity == "10 mW" ~ mean_sum_d_10mW,
        intensity == "15 mW" ~ mean_sum_d_15mW,
      )
    ) %>%
    dplyr::filter(
      if (include_control) {
        animal %in% CONTROL_ANIMALS
      } else {
        animal %!in% CONTROL_ANIMALS
      },
      intensity %in% c(SELECTED_INTENSITIES, "15 mW")
      # manually removing one line causing problem (in GIIFM20b 15 mW stim was repeated in two sessions, session 6 was not following protocol)
      # stim_div_length_row %!in% c(188 , 12)
    ) %>%
    ungroup() %>%
    fill(max_sum_d, .direction = "down") %>%  # write.csv(file = file.path("output_data", "to_publish", "Emivel", "Pno_traveled_distance_initiation_control.csv"))
    ### plotting
    ggplot(
      mapping = aes(
        x = forcats::fct_relevel(stim_division, "before_stim", "first_part", "last_part"),
        ### *6 to convert to mm/sec (6 rows represent one second)
        y = mean_d * 6 / SCALE # (sum_d/stim_div_length_row)/SCALE/10 # in [cm/sec] # mean_d/SCALE # / stim_div_length #/mean_sum_d
      )
    ) +
    geom_point(aes(fill = animal %>% as.factor()), shape = 21, size = 4) +
    facet_wrap(~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique())), nrow = 1) +
    # facet_grid(animal ~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))) +
    geom_line(aes(group = animal)) +
    ggpubr::stat_compare_means(
      method = "wilcox.test",
      paired = T,
      comparisons = list(c("before_stim", "first_part")),
      method.args = list(alternative = "less"),
      vjust = 1.6,
      hide.ns = F
    ) +
    ggpubr::stat_compare_means(
      method = "wilcox.test",
      paired = T,
      comparisons = list(c("first_part", "last_part")),
      method.args = list(alternative = "greater"),
      vjust = 1.6,
      hide.ns = F
    ) +
    ggpubr::stat_compare_means(
      method = "wilcox.test",
      label.y = 35 * 6,
      paired = T,
      comparisons = list(c("before_stim", "last_part")),
      method.args = list(alternative = "less"),
      vjust = 1.7,
      hide.ns = F
    ) +
    expand_limits(y = c(0, 40 * 6)) +
    global_facet_theme +
    theme(aspect.ratio = 1) +
    theme(
      axis.title.x = element_text(size = 12),
      axis.title.y = element_text(size = 12),
      axis.text = element_text(size = 12),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(colour = "black")
    ) +
    if (include_control) {
      ggtitle("Control")
    } else {
      ggtitle("Stimulus")
    }
}

plt_pop_dist_sum_stim <- generate_pop_dist_summary_plot(FALSE)
plt_pop_dist_sum_ctrl <- generate_pop_dist_summary_plot(TRUE)

cowplot::plot_grid(
  plt_pop_dist_sum_stim, plt_pop_dist_sum_ctrl,
  nrow = 2,
  labels = paste0(DOC_TITLE, ", ", "traveled distance"),
  label_size = 11
  )
```



```{r fig.width=15}
generate_distance_dose_plot <- function(include_control) {
  coords %>%
    dplyr::filter(
      frame %% DATAPOINT_TO_PLOT == 0,
      stim_categ == "stim",
      body_part == "center"
      # animal %!in% CONTROL_ANIMALS,
      # body_part == "center",
      # intensity %in% SELECTED_INTENSITIES
    ) %>%
    ### recalculates distances after frames were removed
    dplyr::group_by(animal, body_part, session) %>%
    dplyr::mutate(
      X_diff = c(diff(X_interp), NA) %>% round(4),
      Y_diff = c(diff(Y_interp), NA) %>% round(4),
      X_diff = ifelse(
        test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
          X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
        yes = 0,
        no = X_diff
      ),
      Y_diff = ifelse(
        Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
          Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
        yes = 0,
        no = Y_diff
      ),
      d = sqrt(X_diff^2 + Y_diff^2),
      d_mm = d / SCALE,
      speed_instant = d_mm / TIME_RES,
      mmps = speed_instant * (1 / TIME_RES),
      mps = (speed_instant * (1 / TIME_RES)) / 1000
    ) %>%
    ### session_6 was removed
    dplyr::filter(
      animal != "GIIFM20b" | session != "session_6"
    ) %>%
    dplyr::filter(
      if (include_control) {
        animal %in% CONTROL_ANIMALS
      } else {
        animal %!in% CONTROL_ANIMALS
      },
      intensity %in% c(SELECTED_INTENSITIES, "15 mW")
    ) %>%
    dplyr::group_by(animal, intensity) %>% # dplyr::filter(animal == "GIIFM18b", intensity == "1 mW") %>% pull(d) %>% sum(na.rm = T) / 250
    # dplyr::mutate(nrows=length(intensity)) %>%
    dplyr::summarise(
      mean_d = mean(d, na.rm = T),
      sum_d_norm = sum(d, na.rm = T) / 250,
      nrows = length(intensity)
    ) %>% # write.csv(file = file.path("output_data","to_publish","Emivel","dose_intensity_diff_trav_dist.csv"))
    ggplot(
      aes(x = forcats::fct_relevel(intensity, "1 mW", "5 mW", "10 mW", "15 mW"), y = mean_d * 6)
    ) +
    geom_point(aes(fill = animal), shape = 21, size = 4) +
    geom_boxplot(alpha = 0) +
    expand_limits(y = c(0, 60 * 6)) +
    ggpubr::stat_compare_means(
      method = "wilcox.test",
      paired = F,
      comparisons = list(c("1 mW", "5 mW"), c("1 mW", "10 mW"), c("1 mW", "15 mW")),
      method.args = list(alternative = "two.sided"),
      vjust = 1.6,
      hide.ns = F
    ) +
    global_facet_theme +
    theme(aspect.ratio = 1) +
    theme(
      axis.title.x = element_text(size = 12),
      axis.title.y = element_text(size = 12),
      axis.text = element_text(size = 12),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(colour = "black")
    ) +
    if (include_control) {
      ggtitle("Control")
    } else {
      ggtitle("Stimulus")
    }
}

plt_distance_dose_ctrl <- generate_distance_dose_plot(TRUE)
plt_distance_dose_stim <- generate_distance_dose_plot(FALSE)


cowplot::plot_grid(
  plt_distance_dose_stim, plt_distance_dose_ctrl, 
  ncol = 2,
  labels = paste0(DOC_TITLE, ", ", "traveled distance dose dependency") 
  )
```





