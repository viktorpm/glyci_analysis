---
title: "Halo freely moving analysis"
author: "Viktor Plattner"
output:
  html_document:
    number_sections: yes
    df_print: paged
    toc: yes
    toc_float: yes
  pdf_document:
    number_sections: yes
    toc: yes
    keep_tex: true
  html_notebook:
    number_sections: yes
    toc: yes
    toc_float: yes
spacing: single
fontsize: 12pt
always_allow_html: yes
header-includes:
   - \usepackage{animate}

params:
  selected_animal: "FM1"
  selected_control: "FM1"


knit: (
  function (inputFile, encoding) {
    
    rmarkdown::render(  
      input = inputFile,
      encoding = encoding,
      output_file = file.path(
        "notebook_html", 
        paste0("freely_moving_analysis_", 
        rmarkdown::yaml_front_matter(inputFile)$params$selected_animal,
        "_",
        Sys.Date(),
         ".html")
        ),
      envir = globalenv()
      )
    }
---

```{=html}
<style type="text/css">

body{ /* Normal  */
      font-size: 14px;
      font-family: "Arial", Helvetica, sans-serif;
  }
td {  /* Table  */
  font-size: 12px;
}
h1.title {
  font-size: 38px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #4d4e4f;
}
h1 { /* Header 1 */
  font-size: 28px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #2c3a3e;
}
h2 { /* Header 2 */
  font-size: 22px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #2c3a3e;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Arial", Helvetica, sans-serif;
  color: #2c3a3e;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>
```


```{r setup, include=FALSE}
source(file.path("..","supplementary_functions","md_analysis_setup_script.R"))
# Brief explanation of the sourced script:
# - Loads `tidyverse` for data manipulation and visualization.
# - Defines custom operators/functions for enhanced R capabilities.
# - Dynamically loads additional libraries based on patterns in `.Rmd`/.R` files.
# - Sets a global theme for ggplot objects.
# - Includes custom functions for data filtering and recalculating distances/speeds.

# Define global constants and settings
scale <- 4 # pixel/mm
fps <- 25 # frame rate
standard_stim_length <- 10 # Default stimulus length in seconds
around_stim_length <- fps * 8 # Stimulus length around default
time_res <- 1 / fps # Time between frames
ang_threshold <- 90 # Angle threshold
mouse_speed_mps <- 3.3 # Mouse speed in meters per second
datapoint_to_plot <- 5 # Data points to plot
xlim_mm <- c(0, 1280 / scale) # X-axis limits
ylim_mm <- c(0, 720 / scale) # Y-axis limits
selected_animal <- params$selected_animal
selected_control <- params$selected_control
selected_intensities <- c("1 mW", "5 mW", "10 mW")
control_animals <- c("")
title <- "Halo freely moving analysis"
```


```{r warning=F, message=F, echo=FALSE}
stims_halo <- read.csv(
  file.path("data", "PnO_stim_halo", "pno_halo_stims.csv")
) %>%
  as_tibble() %>%
  mutate(
    intensity = paste0(intensity, " mW"),
    stim_length = end - start,
    animal = animal %>% str_sub(-3,-1)
  ) %>%
  select(-stim_duration) %>%
  rename("stim_number" = stim.number) %>%
  gather(key = "timing", value = "frame", start, end)

```



```{r message=F, echo = FALSE, warning = FALSE}
coords_raw_halo <- read.csv(
  file.path("data", "PnO_stim_halo", "pno_halo.csv")
) %>%
  as_tibble() %>%
  mutate(
    animal = session %>% substr(1, 3) %>% str_to_upper(),
  ) %>%
  full_join(stims_halo) %>%
  ### creating unique session IDs
  group_by(animal) %>%
  mutate(
    s2 = lag(session, default = "1"),
    s3 = ifelse(s2 == session, 0, 1),
    session = cumsum(s3),
    session = paste0("session_", session)
  ) %>%
  select(-s2, -s3) %>%
  ungroup() %>%
  dplyr::group_by(animal, session) %>%
  dplyr::mutate(
    stim_number = ifelse(timing == "end", NA, stim_number)
  ) %>%
  mutate(grp = cumsum(!is.na(stim_number))) %>%
  dplyr::group_by(animal, session, grp) %>%
  fill(timing) %>%
  mutate(
    stim_freq = replace(stim_freq, timing == "start", stim_freq[1]),
    stim_freq = replace(stim_freq, timing == "end", NA),
    stim_length = replace(stim_length, timing == "start", stim_length[1]),
    stim_length = replace(stim_length, timing == "end", NA),
    intensity = replace(intensity, timing == "start", intensity[1]),
    intensity = replace(intensity, timing == "end", NA),
    stim_number = replace(stim_number, timing == "start", stim_number[1]),
    stim_number = replace(stim_number, timing == "end", NA),
    stim_side = replace(stim_side, timing == "start", stim_side[1]),
    stim_side = replace(stim_side, timing == "end", NA),
    quality = replace(quality, timing == "start", quality[1]),
    quality = replace(quality, timing == "end", NA),
    stim = F,
    stim = replace(stim, timing == "start", T)
  ) %>%
  ungroup() %>%
  group_by(animal, session) %>%
  dplyr::mutate(
    rec_time = (frame / fps) %>% round(digits = 2),
    stim_categ = case_when(
      stim == T ~ "stim",
      lead(stim, n = around_stim_length) == T ~ "before stim",
      lag(stim, n = around_stim_length) == T ~ "after stim",
      stim == F ~ "no stim"
    ),

    # shift values to the beginning of the stimulus block ...
    # ... to be able to fill missing values in the next step
    stim_block = ifelse(stim_categ == "no stim", F, T),
    stim_number = lead(stim_number, n = around_stim_length),
    intensity = lead(intensity, n = around_stim_length),
    stim_freq = lead(stim_freq, n = around_stim_length),
    stim_side = lead(stim_side, n = around_stim_length),
    quality = lead(quality, n = around_stim_length)
  ) %>%
  ungroup() %>%
  group_by(animal, session, stim_block) %>%
  fill(stim_number) %>%
  fill(intensity) %>%
  fill(stim_freq) %>%
  fill(stim_side) %>%
  fill(quality) %>%
  # length of the stimulus
  unite(col = "head", head1, head2, sep = "_") %>%
  unite(col = "center", center1, center2, sep = "_") %>%
  unite(col = "tail", tail1, tail2, sep = "_") %>%
  gather(
    key = "body_part",
    value = "coordinate",
    head, center, tail
  ) %>%
  tidyr::extract(
    col = coordinate, into = c("X", "Y"),
    regex = "([[:alnum:]]+)_([[:alnum:]]+)"
  ) %>%
  dplyr::mutate(
    X = replace(X, miss == 0, NA),
    Y = replace(Y, miss == 0, NA)
  ) %>%
  dplyr::mutate(
    stim_number = replace(stim_number, is.na(stim_number), "no stim")
  )
```


```{r}
coords_halo <- coords_raw_halo %>%
  dplyr::filter(
    body_part != "tail",
  ) %>%
  # this block calculates distances and speed across frames
  dplyr::group_by(animal, body_part, session) %>%
  dplyr::mutate(

    # interpolating missing values
    X_interp = imputeTS::na_interpolation(X %>% as.integer()) %>% round(),
    Y_interp = imputeTS::na_interpolation(Y %>% as.integer()) %>% round(),
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),

    # sometimes the tracking software looses the point and jumps...
    # ...back and forth between unrealistic numbers...
    # ...or starts to follow something else
    # these points are replaced by 0...
    # ...(the animal did not change position between those frames)
    # outliers are defined as Q1 - 3*IQR, Q3 + 3*IQR

    X_diff = ifelse(
      test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
        X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
      yes = 0,
      no = X_diff
    ),
    Y_diff = ifelse(
      Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
        Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
      yes = 0,
      no = Y_diff
    ),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000,
    sec_counter = cumsum(ifelse(rec_time %% 1 == 0, 1, 0))
  ) %>%
  group_by(animal, session, body_part, sec_counter) %>%
  dplyr::mutate(speed_sec = sum(d_mm, na.rm = T)) %>%
  ungroup() %>%
  # removing "bad" quality stimuli (repeats)
  dplyr::filter(
    quality != "bad" | is.na(quality),
    stim_number %in% c("1", "2", "3", "4", "5", "no stim")
  ) %>%
  ungroup() %>%
  dplyr::group_by(animal, body_part, session) %>%
  # adding the number of repeats in each session, (-1 to remove "no stim")
  dplyr::mutate(
    No_repeats = stim_number %>% unique() %>% length() - 1
  ) %>%
  ungroup() %>%
  # adding the number of repeats in each intensity group
  # (no -1 as "intensity" variable doesn't run through the session)
  dplyr::group_by(animal, body_part, intensity) %>%
  dplyr::mutate(
    No_repeats_intensity = stim_number %>% unique() %>% length()
  )



coords_halo %>%
  dplyr::filter(animal == selected_animal) %>%
  dplyr::group_by(session, body_part) %>%
  slice(1:5)
```



```{r}
coords_halo_down_sapmpled <- coords_halo %>%
  dplyr::filter(
    frame %% datapoint_to_plot == 0
  ) %>%
  # this block calculates distances and speed across frames
  dplyr::group_by(animal, body_part, session) %>%
  dplyr::mutate(

    # interpolating missing values
    X_interp = imputeTS::na_interpolation(X %>% as.integer()) %>% round(),
    Y_interp = imputeTS::na_interpolation(Y %>% as.integer()) %>% round(),
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),

    # sometimes the tracking software looses the point and jumps...
    # ...back and forth between unrealistic numbers...
    # ...or starts to follow something else
    # these points are replaced by 0...
    # ...(the animal did not change position between those frames)
    # outliers are defined as Q1 - 3*IQR, Q3 + 3*IQR

    X_diff = ifelse(
      test = X_diff < quantile(
        X_diff,
        na.rm = T
      )["25%"] - 3 * IQR(X_diff, na.rm = T) |
        X_diff > quantile(
          X_diff,
          na.rm = T
        )["75%"] + 3 * IQR(X_diff, na.rm = T),
      yes = 0,
      no = X_diff
    ),
    Y_diff = ifelse(
      Y_diff < quantile(
        Y_diff,
        na.rm = T
      )["25%"] - 3 * IQR(Y_diff, na.rm = T) |
        Y_diff > quantile(
          Y_diff,
          na.rm = T
        )["75%"] + 3 * IQR(Y_diff, na.rm = T),
      yes = 0,
      no = Y_diff
    ),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000,
    sec_counter = cumsum(ifelse(rec_time %% 1 == 0, 1, 0))
  )

coords_halo_down_sapmpled %>%
  dplyr::filter(animal == selected_animal) %>%
  dplyr::group_by(session, body_part) %>%
  slice(1:5)
```


```{r message=F, warning=F, echo=F, include=F}
lengths <- coords_halo %>%
  dplyr::filter(
    body_part == "head",
    stim_categ != "no stim",
  ) %>%
  group_by(animal, session, stim_number, intensity, quality) %>%
  count(stim_categ) %>%
  spread(stim_categ, n) %>%
  select(
    animal, session, stim_number,
    intensity, quality, `before stim`,
    stim, `after stim`
  )


n_repeat <- lengths %>%
  dplyr::group_by(animal, intensity) %>%
  dplyr::filter(intensity %in% selected_intensities) %>%
  summarise(length(stim_number))
```



```{r}
text_layer <- coords_halo %>%
  dplyr::filter(
    animal == selected_animal, # selected_control
    stim == T
  ) %>%
  group_by(session) %>%
  summarise(int_label = intensity %>% unique())

text_layer_ctrl <- coords_halo %>%
  dplyr::filter(
    animal == selected_control,
    stim == T
  ) %>%
  group_by(session) %>%
  summarise(int_label = intensity %>% unique())
```

<br> Creating plot colors <br>

```{r}
gg_color_hue <- function(n) {
  hues <- seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}

n <- 6
cols <- gg_color_hue(n)
```


```{r warning=FALSE, fig.width=15, fig.height=10, echo = FALSE}
plt_xpos <- coords_halo %>%
  dplyr::filter(animal == selected_animal, body_part != "tail") %>%
  ggplot(mapping = aes(x = rec_time, y = X_interp %>% as.integer())) +
  geom_line(aes(col = body_part)) +
  theme(legend.position = "none") +
  ylab("X position") +
  facet_wrap(~session, ncol = 1) +
  ggtitle(paste0("X position: ", selected_animal))



plt_ypos <- coords_halo %>%
  dplyr::filter(animal == selected_animal, body_part != "tail") %>%
  ggplot(mapping = aes(x = rec_time, y = Y %>% as.integer())) +
  geom_line(aes(col = body_part)) +
  theme(legend.position = "none") +
  ylab("Y position") +
  facet_wrap(~session, ncol = 1) +
  ggtitle(paste0("Y position: ", selected_animal))

cowplot::plot_grid(plt_xpos, plt_ypos, ncol = 2)
```



```{r fig.width=10, fig.height=10, echo = FALSE, message=FALSE, warning=FALSE}
coords_halo %>%
  dplyr::filter(
    animal == selected_animal,
    body_part != "tail"
  ) %>%
  dplyr::group_by(session, frame) %>%
  dplyr::mutate(
    dx = diff(X_interp),
    dy = diff(Y_interp),
    # ldx = lead(dx),
    # ldy = lead(dy),
    hc_d = sqrt(dx^2 + dy^2)
  ) %>%
  ungroup() %>%
  dplyr::filter(body_part == "center") %>%
  ggplot(
    mapping = aes(x = rec_time, y = hc_d)
  ) +
  geom_hline(
    aes(
      yintercept = quantile(
        hc_d,
        na.rm = T
      )["25%"] - 1.5 * IQR(hc_d, na.rm = T)
    ),
    col = "gray50",
    lty = "dashed"
  ) +
  geom_hline(
    aes(yintercept = quantile(
      hc_d,
      na.rm = T
    )["75%"] + 1.5 * IQR(hc_d, na.rm = T)),
    col = "gray50",
    lty = "dashed"
  ) +
  geom_line(
    aes(col = stim, group = 1)
  ) +
  geom_label_repel(
    data = . %>%
      dplyr::filter(stim_number != "no stim", stim_categ == "stim") %>%
      dplyr::group_by(session, stim_number) %>%
      slice(1),
    aes(
      x = rec_time,
      y = mean(hc_d, na.rm = T),
      label = quality
    ),
    direction = "x",
    nudge_x = 1
  ) +
  facet_wrap(~session, ncol = 1, scales = "free_y") +
  coord_cartesian(
    ylim = c(20, 130)
  ) +
  global_facet_theme
```


```{r echo=, fig.height=10, fig.width=15, warning=FALSE}
plt_traject_stim <- coords_halo %>%
  dplyr::filter(
    animal == selected_animal,
    # intensity %in% selected_intensities,
    stim == T,
    frame %% 5 == 0
  ) %>%
  ggplot(
    mapping = aes(
      x = X_interp, # / scale,
      y = Y_interp, # / scale,
      label = frame
    )
  ) +

  ### drawing positions during no stimulus
  ### "coords_halo" was filtered differently compared to the stimulus dataset (number of frames)
  geom_point(
    data = coords_halo %>%
      dplyr::filter(
        animal == selected_animal,
        # intensity %in% c(selected_intensities, NA),
        body_part == "center",
        stim == F,
        frame %% 5 == 0
      ),
    size = 1,
    alpha = 0.1
  ) +

  ### drawing positions during stimulus
  ### body parts are connected by lines
  # geom_line(
  #   aes(group = frame, col = as.character(stim_number)),
  # ) +
  geom_path(
    aes(group = frame, col = as.character(stim_number)),
    arrow = grid::arrow(
      ends = "first",
      type = "closed",
      angle = 10,
      length = unit(3, "mm")
    )
  ) +
  # geom_point(
  #   aes(shape = body_part, col = as.character(stim_number)),
  #   size = 2
  # ) +
  xlim(c(0, 1280)) + # / scale)) +
  ylim(c(0, 720)) + # / scale)) +
  coord_fixed() +
  facet_wrap(~session, nrow = 1) +
  geom_label(
    data = text_layer %>% dplyr::filter(int_label %in% selected_intensities),
    aes(
      x = Inf, y = -Inf,
      hjust = 1.1, vjust = -0.5,
      label = paste0("Intensity: ", int_label)
    )
  ) +
  labs(col = "Stimulus number", shape = "Body part") +
  xlab("X position [pixel]") +
  ylab("Y position [pixel]") +
  ggtitle(paste0(selected_animal, " trajectory")) +
  global_facet_theme +
  theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text = element_text(size = 12),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.position = "bottom"
  )


plt_traject_ctrl <- coords_halo %>%
  dplyr::filter(
    animal == selected_control,
    intensity %in% selected_intensities,
    stim == T,
    frame %% 5 == 0
  ) %>%
  ggplot(
    mapping = aes(
      x = X_interp, # / scale,
      y = Y_interp, # / scale,
      label = frame
    )
  ) +

  ### drawing positions during no stimulus
  ### "coords_halo" was filtered differently compared to the stimulus dataset (number of frames)
  geom_point(
    data = coords_halo %>%
      dplyr::filter(
        animal == selected_control,
        intensity %in% c(selected_intensities, NA),
        body_part == "center",
        stim == F,
        frame %% 5 == 0
      ),
    size = 1,
    alpha = 0.1
  ) +

  ### drawing positions during stimulus
  ### body parts are connected by lines
  # geom_line(
  #   aes(group = frame, col = as.character(stim_number)),
  # ) +
  geom_path(
    aes(group = frame, col = as.character(stim_number)),
    arrow = grid::arrow(
      ends = "first",
      type = "closed",
      angle = 10,
      length = unit(3, "mm")
    )
  ) +
  # geom_point(
  #   aes(shape = body_part, col = as.character(stim_number)),
  #   size = 2
  # ) +
  xlim(c(0, 1280)) + # / scale)) +
  ylim(c(0, 720)) + # / scale)) +
  coord_fixed() +
  facet_wrap(~session, nrow = 1) +
  geom_label(
    data = text_layer_ctrl %>% dplyr::filter(int_label %in% selected_intensities),
    aes(
      x = Inf, y = -Inf,
      hjust = 1.1, vjust = -0.5,
      label = paste0("Intensity: ", int_label)
    )
  ) +
  labs(col = "Stimulus number", shape = "Body part") +
  xlab("X position [pixel]") +
  ylab("Y position [pixel]") +
  ggtitle(paste0(selected_control, " trajectory")) +
  global_facet_theme +
  theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text = element_text(size = 12),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.position = "bottom"
  )
```

```{r}
cowplot::plot_grid(plt_traject_stim, plt_traject_ctrl, nrow = 2)
```

```{r}
plt_taject_stim_baseline <- coords_halo %>%
  dplyr::filter(
    animal == selected_animal,
    intensity == "5 mW",
    stim == F,
    frame %% datapoint_to_plot == 0
  ) %>%
  ggplot(
    mapping = aes(
      x = X_interp, # / scale,
      y = Y_interp, # / scale,
      label = frame
    )
  ) +
  geom_path(
    aes(group = frame, col = as.character(stim_number)),
    arrow = grid::arrow(
      ends = "first",
      type = "closed",
      angle = 10,
      length = unit(3, "mm")
    )
  ) +
  xlim(c(0, 1280)) + # / scale)) +
  ylim(c(0, 720)) + # / scale)) +
  coord_fixed() +
  # geom_label(
  #   data = text_layer %>% dplyr::filter(int_label %in% selected_intensities),
  #   aes(
  #     x = Inf, y = -Inf,
  #     hjust = 1.1, vjust = -0.5,
  #     label = paste0("Intensity: ", int_label))) +
  labs(col = "Stimulus number") +
  xlab("X position [pixel]") +
  ylab("Y position [pixel]") +
  ggtitle(paste0(selected_animal, " baseline trajectory")) +
  global_facet_theme +
  theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text = element_text(size = 12),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.position = "none"
  )


plt_taject_stim_stim <- coords_halo %>%
  dplyr::filter(
    animal == selected_animal,
    intensity == "5 mW",
    stim == T,
    frame %% datapoint_to_plot == 0
  ) %>%
  ggplot(
    mapping = aes(
      x = X_interp, # / scale,
      y = Y_interp, # / scale,
      label = frame
    )
  ) +
  geom_path(
    aes(group = frame, col = as.character(stim_number)),
    arrow = grid::arrow(
      ends = "first",
      type = "closed",
      angle = 10,
      length = unit(3, "mm")
    )
  ) +
  xlim(c(0, 1280)) + # / scale)) +
  ylim(c(0, 720)) + # / scale)) +
  coord_fixed() +
  # geom_label(
  #   data = text_layer %>% dplyr::filter(int_label %in% selected_intensities),
  #   aes(
  #     x = Inf, y = -Inf,
  #     hjust = 1.1, vjust = -0.5,
  #     label = paste0("Intensity: ", int_label))) +
  labs(col = "Stimulus number") +
  xlab("X position [pixel]") +
  ylab("Y position [pixel]") +
  ggtitle(paste0(selected_animal, " stimulus trajectory")) +
  global_facet_theme +
  theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text = element_text(size = 12),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.position = "none"
  )


plt_taject_ctrl_baseline <- coords_halo %>%
  dplyr::filter(
    animal == selected_control,
    intensity == "5 mW",
    stim == F,
    frame %% datapoint_to_plot == 0
  ) %>%
  ggplot(
    mapping = aes(
      x = X_interp, # / scale,
      y = Y_interp, # / scale,
      label = frame
    )
  ) +
  geom_path(
    aes(group = frame),
    arrow = grid::arrow(
      ends = "first",
      type = "closed",
      angle = 10,
      length = unit(3, "mm")
    )
  ) +
  xlim(c(0, 1280)) + # / scale)) +
  ylim(c(0, 720)) + # / scale)) +
  coord_fixed() +
  # geom_label(
  #   data = text_layer %>% dplyr::filter(int_label %in% selected_intensities),
  #   aes(
  #     x = Inf, y = -Inf,
  #     hjust = 1.1, vjust = -0.5,
  #     label = paste0("Intensity: ", int_label))) +
  labs(col = "Stimulus number") +
  xlab("X position [pixel]") +
  ylab("Y position [pixel]") +
  ggtitle(paste0(selected_control, " baseline trajectory")) +
  global_facet_theme +
  theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text = element_text(size = 12),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.position = "none"
  )


plt_taject_ctrl_stim <- coords_halo %>%
  dplyr::filter(
    animal == selected_control,
    intensity == "5 mW",
    stim == T,
    frame %% datapoint_to_plot == 0
  ) %>%
  ggplot(
    mapping = aes(
      x = X_interp, # / scale,
      y = Y_interp, # / scale,
      label = frame
    )
  ) +
  geom_path(
    aes(group = frame, col = as.character(stim_number)),
    arrow = grid::arrow(
      ends = "first",
      type = "closed",
      angle = 10,
      length = unit(3, "mm")
    )
  ) +
  xlim(c(0, 1280)) + # / scale)) +
  ylim(c(0, 720)) + # / scale)) +
  coord_fixed() +
  # geom_label(
  #   data = text_layer %>% dplyr::filter(int_label %in% selected_intensities),
  #   aes(
  #     x = Inf, y = -Inf,
  #     hjust = 1.1, vjust = -0.5,
  #     label = paste0("Intensity: ", int_label))) +
  labs(col = "Stimulus number") +
  xlab("X position [pixel]") +
  ylab("Y position [pixel]") +
  ggtitle(paste0(selected_control, " stim trajectory")) +
  global_facet_theme +
  theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text = element_text(size = 12),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.position = "none"
  )


#### with facet wrap

plt_taject_stim_wrap <- coords_halo %>%
  dplyr::filter(
    animal == selected_animal,
    intensity == "5 mW",
    frame %% datapoint_to_plot == 0
  ) %>%
  ggplot(
    mapping = aes(
      x = X_interp, # / scale,
      y = Y_interp, # / scale,
      label = frame
    )
  ) +
  geom_path(
    aes(group = frame),
    arrow = grid::arrow(
      ends = "first",
      type = "closed",
      angle = 10,
      length = unit(3, "mm")
    )
  ) +
  xlim(c(0, 1280)) + # / scale)) +
  ylim(c(0, 720)) + # / scale)) +
  coord_fixed() +
  # geom_label(
  #   data = text_layer %>% dplyr::filter(int_label %in% selected_intensities),
  #   aes(
  #     x = Inf, y = -Inf,
  #     hjust = 1.1, vjust = -0.5,
  #     label = paste0("Intensity: ", int_label))) +
  labs(col = "Stimulus number") +
  xlab("X position [pixel]") +
  ylab("Y position [pixel]") +
  ggtitle(paste0(selected_animal, " trajectory")) +
  facet_wrap(~stim) +
  global_facet_theme +
  theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text = element_text(size = 12),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.position = "none"
  )

plt_taject_ctrl_wrap <- coords_halo %>%
  dplyr::filter(
    animal == selected_control,
    intensity == "5 mW",
    frame %% datapoint_to_plot == 0
  ) %>%
  ggplot(
    mapping = aes(
      x = X_interp, # / scale,
      y = Y_interp, # / scale,
      label = frame
    )
  ) +
  geom_path(
    aes(group = frame),
    arrow = grid::arrow(
      ends = "first",
      type = "closed",
      angle = 10,
      length = unit(3, "mm")
    )
  ) +
  xlim(c(0, 1280)) + # / scale)) +
  ylim(c(0, 720)) + # / scale)) +
  coord_fixed() +
  # geom_label(
  #   data = text_layer %>% dplyr::filter(int_label %in% selected_intensities),
  #   aes(
  #     x = Inf, y = -Inf,
  #     hjust = 1.1, vjust = -0.5,
  #     label = paste0("Intensity: ", int_label))) +
  labs(col = "Stimulus number") +
  xlab("X position [pixel]") +
  ylab("Y position [pixel]") +
  ggtitle(paste0(selected_control, " trajectory")) +
  facet_wrap(~stim) +
  global_facet_theme +
  theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text = element_text(size = 12),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.position = "none"
  )
```

Baseline trajectory: only before and after the stimulus, not the whole session

```{r fig.width=15}
cowplot::plot_grid(plt_taject_stim_baseline, plt_taject_stim_stim, plt_taject_ctrl_baseline, plt_taject_ctrl_stim, nrow = 1)
```



## Recalculating distances between tracked points after leaving out frames

```{r fig.width=10, fig.asp=1, echo = FALSE}
plt_xlim <- coords_halo %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    # frame %% datapoint_to_plot == 0
  ) %>%
  dplyr::slice(1:11) %>%
  pull(X_interp) %>%
  range() + c(-1, 1)

plt_ylim <- coords_halo %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    # frame %% datapoint_to_plot == 0
  ) %>%
  dplyr::slice(1:11) %>%
  pull(Y_interp) %>%
  range() + c(-1, 1)


plt1_path <- coords_halo %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    session == "session_1"
  ) %>%
  dplyr::slice(1:6) %>%
  dplyr::arrange(frame) %>% ### to be used with geom_path
  ggplot(
    mapping = aes(x = X_interp, y = Y_interp)
  ) +
  geom_text(
    aes(
      color = frame %>% as.factor(),
      label = frame
    ),
    size = 6
  ) +
  geom_segment(
    aes(
      x = X_interp[1], xend = X_interp[2],
      y = Y_interp[1], yend = Y_interp[1]
    ),
    linetype = "dashed", col = "red"
  ) +
  geom_segment(
    aes(
      x = X_interp[2], xend = X_interp[2],
      y = Y_interp[1], yend = Y_interp[2]
    ),
    linetype = "dashed", col = "red"
  ) +
  geom_path(col = "gray", linetype = "dashed") +
  geom_label_repel(
    data = . %>% dplyr::slice(1:5),
    aes(
      x = X_interp + X_diff / 2,
      y = Y_interp + Y_diff / 2,
      label = d %>% round(4)
    ),
    direction = "x",
    nudge_x = -.7
  ) +
  theme(legend.position = "none") +
  xlim(plt_xlim) +
  ylim(plt_ylim) +
  coord_fixed(ratio = 1)


plt2_path <- coords_halo %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    session == "session_1",
    frame %% datapoint_to_plot == 0
  ) %>%
  ### recalculates distances after frames were removed
  dplyr::group_by(session) %>%
  dplyr::mutate(
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),
    X_diff = ifelse(
      test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
        X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
      yes = 0,
      no = X_diff
    ),
    Y_diff = ifelse(
      Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
        Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
      yes = 0,
      no = Y_diff
    ),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000
  ) %>%
  dplyr::slice(1:2) %>%
  dplyr::arrange(frame) %>% ### to be used with geom_path
  ggplot(
    mapping = aes(x = X_interp, y = Y_interp)
  ) +
  geom_text(
    aes(
      color = frame %>% as.factor(),
      label = frame
    ),
    size = 6
  ) +
  geom_segment(
    aes(
      x = X_interp[1], xend = X_interp[2],
      y = Y_interp[1], yend = Y_interp[1]
    ),
    linetype = "dashed", col = "red"
  ) +
  geom_segment(
    aes(
      x = X_interp[2], xend = X_interp[2],
      y = Y_interp[1], yend = Y_interp[2]
    ),
    linetype = "dashed", col = "red"
  ) +
  geom_path(col = "gray", linetype = "dashed") +
  geom_label_repel(
    data = . %>% dplyr::slice(1:1),
    aes(
      x = X_interp + X_diff / 2,
      y = Y_interp + Y_diff / 2,
      label = d %>% round(4)
    ),
    direction = "x",
    nudge_x = -.7
  ) +
  theme(legend.position = "none") +
  xlim(plt_xlim) +
  ylim(plt_ylim) +
  coord_fixed(ratio = 1)

library(cowplot)

cowplot::plot_grid(plt1_path, plt2_path, ncol = 2)
```





## Instantaneous traveled distance

Plotting the traveled distance based on one of the three tracked body parts during stimulus and non-stimulus periods at the rate of 6 data point/sec.

### Center

```{r fig.width=10, fig.height=10, echo = FALSE, warning=F}
coords_halo %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    frame %% datapoint_to_plot == 0
  ) %>%
  ### recalculates distances after frames were removed
  dplyr::group_by(session) %>%
  dplyr::mutate(
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),
    X_diff = ifelse(
      test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
        X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
      yes = 0,
      no = X_diff
    ),
    Y_diff = ifelse(
      Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
        Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
      yes = 0,
      no = Y_diff
    ),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000
  ) %>%
  ### plotting
  ggplot(mapping = aes(x = rec_time, y = d_mm)) +
  geom_line(aes(color = stim, group = 1)) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label))) +
  facet_wrap(~session, scales = "free", ncol = 1) +
  ggtitle(paste0(selected_animal, " instantaneous traveled distance ", "(center)")) +
  global_facet_theme
```

### Head

```{r fig.width=10, fig.height=10, echo = FALSE, warning=FALSE}
coords_halo %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "head",
    frame %% datapoint_to_plot == 0
  ) %>%
  ### recalculates distances after frames were removed
  dplyr::mutate(
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),
    X_diff = ifelse(
      test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
        X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
      yes = 0,
      no = X_diff
    ),
    Y_diff = ifelse(
      Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
        Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
      yes = 0,
      no = Y_diff
    ),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000
  ) %>%
  ### plotting
  ggplot(mapping = aes(x = rec_time, y = d_mm)) +
  geom_line(aes(color = stim, group = 1)) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label))) +
  facet_wrap(~session, scales = "free", ncol = 1) +
  ggtitle(paste0(selected_animal, " instantaneous traveled distance ", "(head)")) +
  global_facet_theme
```

## Rolling mean of traveled distance

Plotting the mean traveled distance calculated in a rolling window (1 sec). The mean was calculated separately during stimulus (rolling window restarts with the beginning of stimuli). Colors represent different periods of the recording (no-stimulus, before stimulus, during stimulus, after stimulus).

Defining line colors

```{r}
line_cols <- gg_color_hue(3)

group_colors <- c(
  "no stim" = "gray30", "before stim" = line_cols[1],
  "stim" = line_cols[3], "after stim" = line_cols[2]
)
group_colors2 <- c(
  "no stim" = "gray30", "right before" = line_cols[1],
  "stim" = line_cols[3], "right after" = line_cols[2]
)
```

### Example session

```{r message=F, fig.width=12, warning=F, echo = FALSE}
coords_halo %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    session == "session_3",
    frame %% datapoint_to_plot == 0
  ) %>%
  ### recalculates distances after frames were removed
  dplyr::group_by(session) %>%
  dplyr::mutate(
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),
    X_diff = ifelse(
      test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
        X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
      yes = 0,
      no = X_diff
    ),
    Y_diff = ifelse(
      Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
        Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
      yes = 0,
      no = Y_diff
    ),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000
  ) %>%
  dplyr::group_by(stim) %>%
  dplyr::mutate(mean_mps_roll = zoo::rollmean(x = d_mm, k = fps, fill = NA)) %>%
  ### plotting
  ggplot(aes(x = rec_time, y = d_mm)) +
  geom_point(aes(alpha = stim)) +
  geom_line(aes(x = rec_time, y = mean_mps_roll, col = stim_categ, group = 1), size = .8) +
  ggtitle(paste0(selected_animal, " mean traveled distance by stimulus period ", "(center)")) +
  scale_color_manual(values = group_colors)
```

### Center

```{r fig.width=12, fig.height=12, warning=FALSE, echo = FALSE}
coords_halo %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    frame %% datapoint_to_plot == 0
  ) %>%
  ### recalculates distances after frames were removed
  dplyr::group_by(session) %>%
  dplyr::mutate(
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),
    X_diff = ifelse(
      test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
        X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
      yes = 0,
      no = X_diff
    ),
    Y_diff = ifelse(
      Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
        Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
      yes = 0,
      no = Y_diff
    ),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000
  ) %>%
  dplyr::group_by(session, stim_categ) %>%
  dplyr::mutate(mean_mps_roll = zoo::rollmean(x = d_mm, k = fps, fill = NA)) %>%
  ### plotting
  ggplot(aes(x = rec_time, y = d_mm)) +
  geom_point(aes(alpha = stim)) +
  geom_line(aes(x = rec_time, y = mean_mps_roll, col = stim_categ, group = 1), size = 1) +
  facet_wrap(~session, scales = "free", ncol = 1) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label))) +
  ggtitle(paste0(selected_animal, " mean traveled distance by stimulus period ", "(center)")) +
  scale_color_manual(values = group_colors) +
  global_facet_theme
```

### Head

```{r fig.width=12, fig.height=12, warning=F, echo = FALSE}
coords_halo %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "head",
    frame %% datapoint_to_plot == 0
  ) %>%
  ### recalculates distances after frames were removed
  dplyr::group_by(session) %>%
  dplyr::mutate(
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),
    X_diff = ifelse(
      test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
        X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
      yes = 0,
      no = X_diff
    ),
    Y_diff = ifelse(
      Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
        Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
      yes = 0,
      no = Y_diff
    ),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000
  ) %>%
  dplyr::group_by(session, stim_categ) %>%
  dplyr::mutate(mean_mps_roll = zoo::rollmean(x = d_mm, k = fps, fill = NA)) %>%
  ### plotting
  ggplot(aes(x = rec_time, y = d_mm)) +
  geom_point(aes(alpha = stim)) +
  geom_line(aes(x = rec_time, y = mean_mps_roll, col = stim_categ, group = 1), size = 1) +
  facet_wrap(~session, scales = "free", ncol = 1) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label))) +
  ggtitle(paste0(selected_animal, " mean traveled distance by stimulus period ", "(head)")) +
  scale_color_manual(values = group_colors) +
  global_facet_theme
```


## Sum traveled distance by individual stimuli within session (full length before and after the stimulus)

Plotting traveled distance during individual stimuli (4 to 6 repeats) within sessions. Traveled distance is summed through the full duration of the stimulus (\~10s) and `r around_stim_length / fps`s "before stimulus". Traveled distance "after stimulus" is not included. <br>

The same data is shown on the plots with different groupings: <br>

-   intensities are grouped together (colors), stimulus numbers are separated (panels) <br>
-   stimulus numbers are grouped together (colors), intensities are separated (panels) <br>

```{r message=F, fig.width=12, fig.height=8, warning=F, echo = FALSE}
coords_halo %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    stim_categ %!in% c("no stim", "after stim"),
    intensity %in% selected_intensities,
    frame %% datapoint_to_plot == 0
  ) %>%
  ### recalculates distances after frames were removed
  dplyr::group_by(session) %>%
  dplyr::mutate(
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),
    X_diff = ifelse(
      test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
        X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
      yes = 0,
      no = X_diff
    ),
    Y_diff = ifelse(
      Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
        Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
      yes = 0,
      no = Y_diff
    ),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000
  ) %>%
  dplyr::group_by(intensity, stim_number, stim_categ) %>%
  dplyr::summarise(sum_d = sum(d, na.rm = T)) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim"),
      y = sum_d
    )
  ) +
  geom_point(aes(fill = factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))), shape = 21, size = 4) +
  facet_wrap(~stim_number) +
  geom_line(aes(group = intensity)) +
  ggtitle(paste0(selected_animal, " sum traveled distance by individual stimuli within session ", "(center)")) +
  labs(
    fill = "Intensity",
    x = "Stimulus period",
    y = "Sum traveled distance [pixel]"
  ) +
  global_facet_theme
```

```{r message=F, fig.width=12, fig.height=4, warning=F, echo = FALSE}
coords_halo %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    stim_categ %!in% c("no stim", "after stim"),
    intensity %in% selected_intensities,
    frame %% datapoint_to_plot == 0
  ) %>%
  ### recalculates distances after frames were removed
  dplyr::group_by(session) %>%
  dplyr::mutate(
    X_diff = c(diff(X_interp), NA) %>% round(4),
    Y_diff = c(diff(Y_interp), NA) %>% round(4),
    X_diff = ifelse(
      test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
        X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
      yes = 0,
      no = X_diff
    ),
    Y_diff = ifelse(
      Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
        Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
      yes = 0,
      no = Y_diff
    ),
    d = sqrt(X_diff^2 + Y_diff^2),
    d_mm = d / scale,
    speed_instant = d_mm / time_res,
    mmps = speed_instant * (1 / time_res),
    mps = (speed_instant * (1 / time_res)) / 1000
  ) %>%
  dplyr::group_by(intensity, stim_number, stim_categ) %>%
  dplyr::summarise(sum_d = sum(d, na.rm = T)) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim"),
      y = sum_d
    )
  ) +
  geom_point(aes(fill = stim_number), shape = 21, size = 4) +
  facet_wrap(~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))) +
  geom_line(aes(group = stim_number)) +
  ggtitle(paste0(selected_animal, " sum traveled distance by individual stimuli within session ", "(center)")) +
  labs(
    fill = "Stimulus number",
    x = "Stimulus period",
    y = "Sum traveled distance [pixel]"
  ) +
  global_facet_theme
```

## Sum traveled distance by individual stimuli within session (1s before and during the stimulus)

Plotting traveled distance during individual stimuli (4 to 6 repeats) within sessions. Traveled distance is summed through the last second of "before stimulus" category and through first second of the stimulus. Traveled distance "after stimulus" is not included. <br>

The same data is shown on the plots with different groupings: <br>

-   intensities are grouped together (colors), stimulus numbers are separated (panels) <br>
-   stimulus numbers are grouped together (colors), intensities are separated (panels) <br>

<br> The table shows the filtered data (1s before and 1s during stimulus) <br>

```{r message=F, warning=F, echo=F}
coords_halo_1s_window <- bind_rows(
  ### before stim
  coords_halo %>%
    dplyr::filter(
      frame %% datapoint_to_plot == 0,
      stim_categ == "before stim"
    ) %>%
    ### recalculates distances after frames were removed
    dplyr::group_by(animal, body_part, session) %>%
    dplyr::mutate(
      X_diff = c(diff(X_interp), NA) %>% round(4),
      Y_diff = c(diff(Y_interp), NA) %>% round(4),
      X_diff = ifelse(
        test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
          X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
        yes = 0,
        no = X_diff
      ),
      Y_diff = ifelse(
        Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
          Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
        yes = 0,
        no = Y_diff
      ),
      d = sqrt(X_diff^2 + Y_diff^2),
      d_mm = d / scale,
      speed_instant = d_mm / time_res,
      mmps = speed_instant * (1 / time_res),
      mps = (speed_instant * (1 / time_res)) / 1000
    ) %>%
    dplyr::group_by(animal, body_part, intensity, stim_side, stim_categ, stim_number) %>%
    # dplyr::top_n(6),
    dplyr::slice(tail(row_number(), 6)),
  ### stim
  coords_halo %>%
    dplyr::filter(
      frame %% datapoint_to_plot == 0,
      stim_categ == "stim"
    ) %>%
    ### recalculates distances after frames were removed
    dplyr::group_by(animal, body_part, session) %>%
    dplyr::mutate(
      X_diff = c(diff(X_interp), NA) %>% round(4),
      Y_diff = c(diff(Y_interp), NA) %>% round(4),
      X_diff = ifelse(
        test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
          X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
        yes = 0,
        no = X_diff
      ),
      Y_diff = ifelse(
        Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
          Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
        yes = 0,
        no = Y_diff
      ),
      d = sqrt(X_diff^2 + Y_diff^2),
      d_mm = d / scale,
      speed_instant = d_mm / time_res,
      mmps = speed_instant * (1 / time_res),
      mps = (speed_instant * (1 / time_res)) / 1000
    ) %>%
    dplyr::group_by(animal, body_part, intensity, stim_categ, stim_number) %>%
    dplyr::slice(1:6)
) %>% arrange(animal, body_part, session, stim_number, stim_categ)


coords_halo_1s_window %>%
  dplyr::filter(
    animal == selected_animal,
    intensity %in% selected_intensities
  ) %>%
  select(session, animal, frame, rec_time, stim_categ, d, stim_number, intensity, stim_side, body_part, X_diff, Y_diff) %>% 
  head(1000)
```

```{r message=F, warning=F, echo=F}
coords_halo_8s_window <- bind_rows(
  ### before stim
  coords_halo %>%
    dplyr::filter(
      frame %% datapoint_to_plot == 0,
      stim_categ == "before stim"
    ) %>%
    ### recalculates distances after frames were removed
    dplyr::group_by(animal, body_part, session) %>%
    dplyr::mutate(
      X_diff = c(diff(X_interp), NA) %>% round(4),
      Y_diff = c(diff(Y_interp), NA) %>% round(4),
      X_diff = ifelse(
        test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
          X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
        yes = 0,
        no = X_diff
      ),
      Y_diff = ifelse(
        Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
          Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
        yes = 0,
        no = Y_diff
      ),
      d = sqrt(X_diff^2 + Y_diff^2),
      d_mm = d / scale,
      speed_instant = d_mm / time_res,
      mmps = speed_instant * (1 / time_res),
      mps = (speed_instant * (1 / time_res)) / 1000
    ) %>%
    dplyr::group_by(animal, body_part, intensity, stim_side, stim_categ, stim_number) %>%
    # dplyr::top_n(41),
    dplyr::slice(tail(row_number(), 41)),
  ### stim
  coords_halo %>%
    dplyr::filter(
      frame %% datapoint_to_plot == 0,
      stim_categ == "stim"
    ) %>%
    ### recalculates distances after frames were removed
    dplyr::group_by(animal, body_part, session) %>%
    dplyr::mutate(
      X_diff = c(diff(X_interp), NA) %>% round(4),
      Y_diff = c(diff(Y_interp), NA) %>% round(4),
      X_diff = ifelse(
        test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
          X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
        yes = 0,
        no = X_diff
      ),
      Y_diff = ifelse(
        Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
          Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
        yes = 0,
        no = Y_diff
      ),
      d = sqrt(X_diff^2 + Y_diff^2),
      d_mm = d / scale,
      speed_instant = d_mm / time_res,
      mmps = speed_instant * (1 / time_res),
      mps = (speed_instant * (1 / time_res)) / 1000
    ) %>%
    dplyr::group_by(animal, body_part, intensity, stim_categ, stim_number) %>%
    dplyr::slice(1:41)
) %>% arrange(animal, body_part, session, stim_number, stim_categ)


coords_halo_8s_window %>%
  dplyr::filter(
    animal == selected_animal,
    intensity %in% selected_intensities
  ) %>%
  select(session, animal, frame, rec_time, stim_categ, d, stim_number, intensity, stim_side, body_part, X_diff, Y_diff) %>%
  head(200)
```

```{r message=F, fig.width=12, fig.height=8, warning=F, echo = FALSE}
coords_halo_1s_window %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    intensity %in% selected_intensities,
  ) %>%
  dplyr::group_by(intensity, stim_number, stim_categ) %>%
  dplyr::summarise(sum_d = sum(d, na.rm = T)) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim"),
      y = sum_d
    )
  ) +
  geom_point(aes(fill = factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))), shape = 21, size = 4) +
  facet_wrap(~stim_number) +
  geom_line(aes(group = intensity)) +
  ggtitle(paste0(selected_animal, " sum traveled distance by individual stimuli within session ", "(center)")) +
  labs(
    fill = "Intensity",
    x = "Stimulus period",
    y = "Sum traveled distance [pixel]"
  ) +
  global_facet_theme
```

```{r message=F, fig.width=12, fig.height=4, warning=F, echo = FALSE}
coords_halo_1s_window %>%
  dplyr::filter(
    animal == selected_animal,
    body_part == "center",
    intensity %in% selected_intensities
  ) %>%
  dplyr::group_by(intensity, stim_number, stim_categ) %>%
  dplyr::summarise(sum_d = sum(d, na.rm = T)) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim"),
      y = sum_d
    )
  ) +
  geom_point(aes(fill = stim_number %>% as.factor()), shape = 21, size = 4) +
  facet_wrap(~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))) +
  geom_line(aes(group = stim_number)) +
  ggtitle(paste0(selected_animal, " sum traveled distance by individual stimuli within session ", "(center)")) +
  labs(
    fill = "Stimulus number",
    x = "Stimulus period",
    y = "Sum traveled distance [pixel]"
  ) +
  global_facet_theme
```


## Calculating angles

### Real data (coords tibble)

#### First 10 head - center vectors

```{r echo = FALSE ,message=FALSE, warning=FALSE}
coords_halo %>%
  dplyr::filter(animal == selected_animal) %>%
  dplyr::group_by(body_part) %>%
  slice(1:10) %>%
  dplyr::filter(body_part != "tail") %>%
  ggplot(
    mapping = aes(x = X, y = Y)
  ) +
  geom_point(aes(shape = body_part), size = 2) +
  geom_line(aes(group = frame, color = as.character(frame))) +
  geom_text_repel(aes(label = paste0(X, ",", Y), col = as.character(frame))) +
  geom_segment(
    data = coords_halo %>%
      dplyr::filter(animal == selected_animal) %>%
      dplyr::group_by(body_part) %>%
      slice(1:10) %>%
      dplyr::filter(body_part != "tail", frame == 0),
    aes(
      x = X[1], xend = X[2],
      y = Y[1], yend = Y[1]
    ), linetype = "dashed", col = "red"
  ) +
  geom_segment(
    data = coords_halo %>%
      dplyr::filter(animal == selected_animal) %>%
      dplyr::group_by(body_part) %>%
      slice(1:10) %>%
      dplyr::filter(body_part != "tail", frame == 0),
    aes(
      x = X[2], xend = X[2],
      y = Y[1], yend = Y[2]
    ), linetype = "dashed", col = "red"
  )
```

```{r eval=FALSE}
coords_halo %>%
  dplyr::filter(animal == "FM1") %>%
  dplyr::group_by(body_part) %>%
  slice(1:3) %>%
  dplyr::filter(body_part != "tail", frame == 0) %>%
  pull(X)
```

#### Distribution of angles

Because of the periodicity of tangent function unrealistic angles were introduced (jumps in data). Angles greater than 180 or smaller than -180 were subtracted from 360 and -360 respectively to get the correct angle.

In the control animals (34, 35, 36, 37) there are unrealistically large angles between frames probably due to tracking problem (switch of head and tail/center coordinate). Those angles are replaced by 0!

mutate(signed_angle_corrected = ifelse(signed_angle_corrected %\>% abs() \> ang_treshold, 0, signed_angle_corrected))

```{r message=FALSE, fig.width=10, fig.height=10, warning=FALSE, echo = FALSE}
coords_halo %>%
  dplyr::filter(animal == selected_animal, body_part != "tail") %>%
  dplyr::filter(body_part != "tail") %>%
  dplyr::group_by(animal, session, frame) %>%
  summarise(
    vectx = diff(X_interp),
    vecty = diff(Y_interp)
  ) %>%
  mutate(
    leadx = lead(vectx),
    leady = lead(vecty)
  ) %>%
  mutate(
    signed_angle = (atan2(leadx, leady) - atan2(vectx, vecty)) * 180 / (pi)
  ) %>%
  mutate(
    signed_angle_corrected = case_when(
      signed_angle >= 180 ~ 360 - signed_angle,
      signed_angle %>% abs() < 180 ~ signed_angle,
      signed_angle <= -180 ~ -360 - signed_angle,
      signed_angle > -180 | signed_angle < 0 ~ signed_angle
    )
  ) %>%
  ### removing unrealistically large angles
  mutate(signed_angle_corrected = ifelse(signed_angle_corrected %>% abs() > ang_threshold, 0, signed_angle_corrected)) %>%
  ggplot(aes(x = signed_angle_corrected)) +
  geom_histogram() +
  facet_wrap(~session, scales = "free") +
  global_facet_theme
```

#### Calculating signed angles

```{r message=F, warning=F, echo = FALSE}

corrected_angles <- coords_halo %>%
  dplyr::filter(
    animal == selected_animal,
    # frame %% datapoint_to_plot == 0, ### here it's good to have all the data points to calculate the cumulative angles
    body_part != "tail"
  ) %>%
  dplyr::group_by(session, frame) %>%
  mutate(
    vectx = diff(X_interp),
    vecty = diff(Y_interp)
  ) %>%
  dplyr::group_by(session) %>%
  mutate(
    leadx = lead(vectx),
    leady = lead(vecty)
  ) %>%
  mutate(
    signed_angle = (atan2(leadx, leady) - atan2(vectx, vecty)) * 180 / (pi)
  ) %>%
  mutate(
    signed_angle_corrected = case_when(
      signed_angle >= 180 ~ 360 - signed_angle,
      signed_angle %>% abs() < 180 ~ signed_angle,
      signed_angle <= -180 ~ -360 - signed_angle,
      signed_angle > -180 | signed_angle < 0 ~ signed_angle
    )
  ) %>%
  ### removing unrealistically large angles
  mutate(signed_angle_corrected = ifelse(signed_angle_corrected %>% abs() > ang_threshold, 0, signed_angle_corrected))
```

```{r message=F, fig.width=10, fig.height=10, warning=FALSE}
corrected_angles %>%
  ggplot(aes(x = rec_time, y = signed_angle_corrected)) +
  geom_line(aes(col = stim, group = 1)) +
  facet_wrap(~session, scales = "free_x", ncol = 1) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label))) +
  ggtitle(paste0(selected_animal, " raw angles by stimulus period ")) +
  global_facet_theme
```

```{r message=F,  warning=FALSE}
corrected_angles %>%
  dplyr::filter(
    session == "session_3",
    body_part == "center",
    stim_number != "no stim"
  ) %>%
  dplyr::group_by(intensity, stim_number) %>% # View()
  dplyr::summarise(
    align_time = rec_time - rec_time[1],
    cumang = cumsum(signed_angle_corrected) %>% scale(),
    across(stim_categ)
  ) %>% # View()
  # dplyr::group_by(align_time) %>%
  # summarise(cumang = mean(cumang), across(stim_categ)) %>%
  ggplot(aes(x = align_time, y = cumang)) +
  geom_line(aes(group = stim_number, col = stim_categ))

#
# facet_wrap(~session, scales = "free_x", ncol = 1)
#
#
#   geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label))) +
#   ggtitle(paste0(selected_animal, " raw angles by stimulus period ")) +
#   global_facet_theme
```

#### Plotting cumulative angles

Cumulative signed rotation angles during the sessions.

```{r message=FALSE,fig.width=10, fig.height=10}
corrected_angles %>%
  group_by(session) %>%
  dplyr::filter(body_part == "center") %>%
  mutate(csum = cumsum(ifelse(is.na(signed_angle_corrected), 0, signed_angle_corrected)) %>% round(4)) %>%
  ggplot(
    mapping = aes(x = rec_time, y = csum %>% scale())
  ) +
  geom_line(aes(col = stim, group = 1)) +
  facet_wrap(~session, scales = "free_x", ncol = 1) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label))) +
  ggtitle(paste0(selected_animal, " cumulative angles by stimulus period ")) +
  global_facet_theme
```

```{r message=FALSE,fig.width=10, fig.height=10}
corrected_angles %>%
  dplyr::filter(body_part == "center") %>%
  group_by(session) %>%
  mutate(csum = cumsum(ifelse(is.na(signed_angle_corrected), 0, signed_angle_corrected)) %>% round(4)) %>%
  ggplot(
    mapping = aes(x = rec_time, y = csum %>% scale())
  ) +
  geom_line(aes(col = stim_categ, group = 1)) +
  facet_wrap(~session, scales = "free_x", ncol = 1) +
  geom_label(data = text_layer, aes(x = -Inf, y = Inf, hjust = -.2, vjust = 1.3, label = paste0("Intensity: ", int_label))) +
  scale_color_manual(values = group_colors) +
  global_facet_theme
```

# Population analysis

## Rotation

### Calculating signed population angles

```{r message=FALSE, warning=FALSE, echo = FALSE}
corrected_angles_population <- coords_halo %>%
  dplyr::filter(
    body_part != "tail"
  ) %>%
  dplyr::group_by(animal, session, frame) %>%
  mutate(
    vectx = diff(X_interp),
    vecty = diff(Y_interp),
  ) %>%
  group_by(animal, session) %>%
  mutate(
    leadx = lead(vectx),
    leady = lead(vecty)
  ) %>%
  mutate(
    signed_angle = (atan2(leadx, leady) - atan2(vectx, vecty)) * 180 / (pi)
  ) %>%
  mutate(
    signed_angle_corrected = case_when(
      signed_angle >= 180 ~ 360 - signed_angle,
      signed_angle %>% abs() < 180 ~ signed_angle,
      signed_angle <= -180 ~ -360 - signed_angle,
      signed_angle > -180 | signed_angle < 0 ~ signed_angle
    )
  ) %>%
  ### removing unrealistically large angles
  mutate(
    signed_angle_corrected = ifelse(
      signed_angle_corrected %>% abs() > ang_threshold,
      0,
      signed_angle_corrected
    )
  ) %>%
  ### adding ipsi or contra rotation variable
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::mutate(
    ipsicontra = case_when(
      sum(signed_angle_corrected, na.rm = T) > 0 & stim_side == "left" & stim_categ == "stim" ~ "ipsi",
      sum(signed_angle_corrected, na.rm = T) > 0 & stim_side == "right" & stim_categ == "stim" ~ "contra",
      sum(signed_angle_corrected, na.rm = T) < 0 & stim_side == "left" & stim_categ == "stim" ~ "contra",
      sum(signed_angle_corrected, na.rm = T) < 0 & stim_side == "right" & stim_categ == "stim" ~ "ipsi",
    )
  )
```

```{r message=FALSE,fig.width=15, fig.height=15, out.width="100%"}
corrected_angles_population %>%
  dplyr::filter(body_part == "head") %>%
  group_by(animal, session) %>%
  mutate(csum = cumsum(ifelse(is.na(signed_angle_corrected), 0, signed_angle_corrected)) %>% round(4)) %>%
  fill(intensity, .direction = "downup") %>%
  ggplot(
    mapping = aes(x = rec_time, y = csum %>% scale())
  ) +
  geom_line(aes(col = stim_categ, group = 1)) +
  # geom_text(
  #   data = coords$intensity %>% unique(),
  #   aes(label=intensity), check_overlap = T) +
  facet_grid(animal ~ session) + # factor(intensity, levels = gtools::mixedsort(intensity %>% unique())), scales = "free") +
  scale_color_manual(values = group_colors) +
  global_facet_theme +
  theme(
    axis.text.x = element_text(angle = 45),
  )
```

```{r message=F, fig.width=15, fig.height=15, warning=FALSE}
corrected_angles_population %>%
  dplyr::filter(
    animal %!in% c(control_animals),
    body_part == "center",
    stim_number != "no stim",
    intensity %in% selected_intensities,
    stim_categ != "after stim",
    stim_side == "right"
  ) %>%
  dplyr::group_by(animal, intensity, stim_number) %>%
  dplyr::summarise(
    align_time = rec_time - rec_time[1],
    cumang = cumsum(signed_angle_corrected) %>% scale(),
    across(stim_categ)
  ) %>%
  ggplot(aes(x = align_time, y = cumang)) +
  geom_line(aes(group = stim_number, col = stim_categ)) +
  facet_grid(animal ~ intensity, scales = "free_x")

```

Mean/sum rotation angle by session

```{r message=FALSE, fig.height=8, fig.width=10, echo = FALSE}
corrected_angles_population %>%
  dplyr::filter(
    body_part == "head",
    stim_categ != "no stim"
  ) %>%
  dplyr::group_by(animal, stim_side, stim_categ) %>%
  dplyr::summarise(
    sum_ang = sum(signed_angle_corrected, na.rm = T),
    mean_ang = mean(signed_angle_corrected, na.rm = T),
    med_ang = median(signed_angle_corrected, na.rm = T),
    sd_ang = sd(signed_angle_corrected, na.rm = T),
    sem_ang = sem(signed_angle_corrected)
  ) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      y = sum_ang %>% abs() / 360 # %>% scale()
    )
  ) +
  geom_point(aes(fill = animal), shape = 21, size = 4) +
  geom_line(aes(group = animal)) +
  facet_wrap(~stim_side, nrow = 1) +
  expand_limits(y = c(0, 15)) +
  global_facet_theme +
  xlab("State") +
  ylab("Scaled sum angle")
```

Mean/sum rotation angle by session (control)

```{r message=FALSE, fig.height=8, fig.width=10, echo = FALSE}
corrected_angles_population %>%
  dplyr::filter(
    animal %!in% control_animals,
    body_part == "head",
    stim_categ != "no stim",
  ) %>%
  dplyr::group_by(animal, stim_categ, stim_side) %>%
  dplyr::summarise(
    sum_ang = sum(signed_angle_corrected, na.rm = T),
    mean_ang = mean(signed_angle_corrected, na.rm = T),
    med_ang = median(signed_angle_corrected, na.rm = T),
    sd_ang = sd(signed_angle_corrected, na.rm = T),
    sem_ang = sem(signed_angle_corrected)
  ) %>%
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      y = sum_ang # %>% scale()
    )
  ) +
  geom_point(aes(fill = animal), shape = 21, size = 4) +
  geom_line(aes(group = animal)) +
  facet_wrap(~stim_side) +
  global_facet_theme +
  xlab("State") +
  ylab("Scaled sum angle")
```

Mean/sum rotation angle by intensity (stimulus and control)

```{r message=FALSE, fig.height=12, fig.width=15, echo = FALSE}
plt1_angle <- corrected_angles_population %>%
  dplyr::filter(
    body_part == "head",
    stim_categ != "no stim",
    stim_side == "left"
  ) %>%
  dplyr::filter(intensity %in% c(selected_intensities, "15 mW")) %>%
  dplyr::group_by(animal, stim_side, intensity, stim_categ) %>%
  dplyr::summarise(
    sum_ang = sum(signed_angle_corrected, na.rm = T),
    mean_ang = mean(signed_angle_corrected, na.rm = T),
    med_ang = median(signed_angle_corrected, na.rm = T),
    sd_ang = sd(signed_angle_corrected, na.rm = T),
    sem_ang = sem(signed_angle_corrected),
    all_stim_categ_length_row = length(signed_angle_corrected),
    mean_ang_manual = sum_ang / all_stim_categ_length_row
  ) %>%
  dplyr::mutate(
    ipsicontra = case_when(
      sum_ang > 0 & stim_side == "left" & stim_categ == "stim" ~ "ipsi",
      sum_ang > 0 & stim_side == "right" & stim_categ == "stim" ~ "contra",
      sum_ang < 0 & stim_side == "left" & stim_categ == "stim" ~ "contra",
      sum_ang < 0 & stim_side == "right" & stim_categ == "stim" ~ "ipsi",
    )
  ) %>%
  dplyr::group_by(animal, intensity) %>%
  fill(ipsicontra, .direction = "up") %>% 
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      # * 25: number of frames in a second. To get the mean rotation angle per second. /360: mean portion of one full circle per second
      y = ((mean_ang * 25) %>% abs()) / 360 # %>% abs() /360  # sum_ang %>% abs() # / max(sum_ang %>% abs()) # %>% scale()
    )
  ) +
  geom_point(aes(fill = animal), shape = 21, size = 4) +
  geom_line(aes(group = animal)) +
  ggpubr::stat_compare_means(
    method = "wilcox.test",
    paired = T,
    method.args = list(alternative = "less"),
    comparisons = list(c("before stim", "stim")),
    vjust = 1.5,
    hide.ns = F
    # label.y = 3000
  ) +
  ggpubr::stat_compare_means(
    method = "wilcox.test",
    paired = T,
    method.args = list(alternative = "greater"),
    comparisons = list(c("stim", "after stim")),
    vjust = 1.5,
    hide.ns = F
    # label.y = 3000
  ) +
  facet_grid(~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))) +
  global_facet_theme +
  expand_limits(y = c(0, 4 * 25 / 360)) +
  # xlab("State") +
  # ylab("Scaled sum angle") +
  ggtitle("Left side stimulus") +
  theme(aspect.ratio = 1) +
  theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text = element_text(size = 12),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black")
  )


plt2_angle <- corrected_angles_population %>%
  dplyr::filter(
    body_part == "head",
    stim_categ != "no stim",
    stim_side == "right"
  ) %>%
  dplyr::filter(intensity %in% c(selected_intensities, "15 mW")) %>%
  dplyr::group_by(animal, stim_side, intensity, stim_categ) %>%
  dplyr::summarise(
    sum_ang = sum(signed_angle_corrected, na.rm = T),
    max_sum_ang = sum_ang %>% max(),
    mean_ang = mean(signed_angle_corrected, na.rm = T),
    med_ang = median(signed_angle_corrected, na.rm = T),
    sd_ang = sd(signed_angle_corrected, na.rm = T),
    sem_ang = sem(signed_angle_corrected),
    all_stim_categ_length_row = length(signed_angle_corrected),
    mean_ang_manual = sum_ang / all_stim_categ_length_row
  ) %>%
  dplyr::mutate(
    max_sum_ang = replace(max_sum_ang, max_sum_ang == "stim", NA)
  ) %>%
  fill(max_sum_ang) %>% # write.csv(file = file.path("output_data","to_publish","Emivel","PnO_mean_No_rotation_per_second_control.csv"))
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      # * 25: number of frames in a second. To get the mean rotation angle per second. /360: mean portion of one full circle per second
      y = ((mean_ang * 25) %>% abs()) / 360 # %>% abs() / 360  # sum_ang %>% abs() # / max(sum_ang %>% abs())# %>% scale()
    )
  ) +
  geom_point(aes(fill = animal), shape = 21, size = 4) +
  geom_line(aes(group = animal)) +
  ggpubr::stat_compare_means(
    method = "wilcox.test",
    paired = T,
    method.args = list(alternative = "less"),
    comparisons = list(c("before stim", "stim")),
    vjust = 1.5,
    hide.ns = F
    # label.y = 3000
  ) +
  ggpubr::stat_compare_means(
    method = "wilcox.test",
    paired = T,
    method.args = list(alternative = "greater"),
    comparisons = list(c("stim", "after stim")),
    vjust = 1.5,
    hide.ns = F
    # label.y = 3000
  ) +
  facet_wrap(~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique())), ncol = 4) +
  global_facet_theme +
  expand_limits(y = c(0, 4 * 25 / 360)) +
  # xlab("State") +
  # ylab("Scaled sum angle") +
  ggtitle("Right side stimulus") +
  theme(aspect.ratio = 1) +
  theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text = element_text(size = 12),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black")
  )
cowplot::plot_grid(
  plt1_angle, plt2_angle, 
  nrow = 2,
  labels = paste0(title, ", ", "mean rotation angle by intensity")  )

```






```{r}
corrected_angles_population %>%
  dplyr::filter(
    animal %!in% c(control_animals),
    body_part == "head",
    stim_categ != "no stim",
    stim_side == "left"
  ) %>%
  dplyr::filter(intensity %in% c(selected_intensities, "15 mW")) %>%
  dplyr::group_by(animal, stim_side, stim_categ) %>%
  dplyr::summarise(
    sum_ang = sum(signed_angle_corrected, na.rm = T),
    mean_ang = mean(signed_angle_corrected, na.rm = T),
    med_ang = median(signed_angle_corrected, na.rm = T),
    sd_ang = sd(signed_angle_corrected, na.rm = T),
    sem_ang = sem(signed_angle_corrected)
  ) %>%
  dplyr::mutate(
    ipsicontra = case_when(
      sum_ang > 0 & stim_side == "left" & stim_categ == "stim" ~ "ipsi",
      sum_ang > 0 & stim_side == "right" & stim_categ == "stim" ~ "contra",
      sum_ang < 0 & stim_side == "left" & stim_categ == "stim" ~ "contra",
      sum_ang < 0 & stim_side == "right" & stim_categ == "stim" ~ "ipsi",
    )
  ) %>%
  dplyr::group_by(animal) %>%
  fill(ipsicontra, .direction = "up") %>%
  ungroup() %>%
  dplyr::mutate(
    sum_ang_ipsicontra = ifelse(ipsicontra == "contra", sum_ang %>% abs(), -(sum_ang %>% abs())),
    mean_ang_ipsicontra = ifelse(ipsicontra == "contra", mean_ang %>% abs(), -(mean_ang %>% abs()))
  ) %>% # write.csv(file = file.path("output_data","to_publish","Emivel","PnO_mean_No_rotation_per_second_all_intensities_ipsicontra.csv"))
  ggplot(
    mapping = aes(
      x = forcats::fct_relevel(stim_categ, "before stim", "stim", "after stim"),
      y = (mean_ang_ipsicontra * 25) / 360 # sum_ang %>% abs() /360  # sum_ang %>% abs() # / max(sum_ang %>% abs()) # %>% scale()
    )
  ) +
  geom_point(aes(fill = animal), shape = 21, size = 4) +
  geom_line(aes(group = animal)) +
  geom_hline(yintercept = 0, col = "gray") +
  annotate(geom = "text", x = 3, hjust = -0.15, y = -0.02, label = "ipsilateral", col = "gray") +
  annotate(geom = "text", x = 3, hjust = -0.15, y = 0.02, label = "contralateral", col = "gray") +
  global_facet_theme +
  expand_limits(y = c(-0.2, 0.2), x = c(0, 4)) +
  # xlab("State") +
  # ylab("Scaled sum angle") +
  ggtitle("Stimulus") +
  theme(aspect.ratio = 1) +
  theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text = element_text(size = 12),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black")
  )
```





```{r fig.width=15}
generate_angle_dose_plot <- function(stimside) {
  corrected_angles_population %>%
    dplyr::filter(
      body_part == "head",
      stim_categ != "no stim",
      if (stimside == "right") {
        stim_side == stimside
      } else {
        stim_side == "left"
      }
    ) %>%
    dplyr::filter(intensity %in% c(selected_intensities, "15 mW")) %>%
    dplyr::group_by(animal, intensity, stim_categ) %>%
    dplyr::summarise(
      sum_ang = sum(signed_angle_corrected, na.rm = T),
      mean_ang = mean(signed_angle_corrected, na.rm = T),
      med_ang = median(signed_angle_corrected, na.rm = T),
      sd_ang = sd(signed_angle_corrected, na.rm = T),
      sem_ang = sem(signed_angle_corrected)
    ) %>%
    dplyr::filter(
      stim_categ == "stim"
    ) %>% # write.csv(file = file.path("output_data","to_publish","Emivel","PnO_dose_intensity_rotation_control.csv"))

    ggplot(
      mapping = aes(
        x = forcats::fct_relevel(intensity, "1 mW", "5 mW", "10 mW", "15 mW"),
        y = ((mean_ang * 25) %>% abs()) / 360
      )
    ) +
    geom_point(aes(fill = animal), shape = 21, size = 4) +
    geom_boxplot(alpha = 0) +
    ggpubr::stat_compare_means(
      method = "wilcox.test",
      paired = F,
      method.args = list(alternative = "two.sided"),
      comparisons = list(c("1 mW", "5 mW"), c("1 mW", "10 mW"), c("1 mW", "15 mW")),
      vjust = 1.5,
      hide.ns = F
      # label.y = 3000
    ) +
    global_facet_theme +
    expand_limits(y = c(0, 0.2)) +
    # xlab("State") +
    # ylab("Scaled sum angle") +
    # ggtitle("Stimulus") +
    theme(aspect.ratio = 1) +
    theme(
      axis.title.x = element_text(size = 12),
      axis.title.y = element_text(size = 12),
      axis.text = element_text(size = 12),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(colour = "black")
    )
}

# Generate plots for both control and non-control groups
plt_ang_dose_right <- generate_angle_dose_plot(stimside = "right")
plt_ang_dose_left <- generate_angle_dose_plot(stimside = "left")


cowplot::plot_grid(
  plt_ang_dose_right, plt_ang_dose_left, 
  ncol = 2,
  labels = paste0(title, ", ", "mean rotation angle dose dependency")
)
```



Mean rotation angle before stimulus vs during stimulus

```{r message=FALSE, warning=FALSE, fig.width=17, fig.height=15, out.width="100%", echo = FALSE}
generate_angle_stim_plot <- function(stimside) {
  corrected_angles_population %>%
    dplyr::filter(
      body_part == "head",
      stim_categ != "no stim",
      intensity %in% c(selected_intensities, "15 mW"),
      if (stimside == "right") {
        stim_side == stimside
      } else {
        stim_side == "left"
      }
    ) %>%
    dplyr::group_by(animal, intensity, stim_categ, stim_number) %>%
    dplyr::summarise(
      sum_ang = sum(signed_angle_corrected, na.rm = T),
      # mean_ang = mean(signed_angle_corrected, na.rm = T),
      # med_ang = median(signed_angle_corrected, na.rm = T),
      # sd_ang = sd(signed_angle_corrected, na.rm = T),
      # sem_ang = sem(signed_angle_corrected)
    ) %>%
    tidyr::spread(
      key = stim_categ, value = sum_ang
    ) %>%
    ggplot(
      mapping = aes(x = `before stim`, y = stim)
    ) +
    xlim(-1200, 1200) +
    ylim(-1200, 1200) +
    coord_fixed() +
    geom_vline(xintercept = 0, alpha = .3) +
    geom_hline(yintercept = 0, alpha = .3) +
    geom_point(size = 3) +
    facet_grid(animal ~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))) +
    global_facet_theme +
    theme(
      axis.text.x = element_text(angle = 45)
    )
}

plt_ang_right <- generate_angle_stim_plot(stimside = "right")
plt_ang_left <- generate_angle_stim_plot(stimside = "left")

cowplot::plot_grid(plt_ang_right, plt_ang_left, ncol = 2)
```




## Traveled distance

```{r}
# saving the mean of the "before stim" "sum traveled distance" of all the animals (by intensity) for normalization

mean_sum_d_1mW <- coords_halo_1s_window %>%
  dplyr::filter(
    frame %% datapoint_to_plot == 0,
    body_part == "center",
    intensity %in% selected_intensities
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::summarise(sum_d = sum(d, na.rm = T)) %>%
  dplyr::group_by(intensity, stim_categ) %>%
  dplyr::summarise(mean_sum_d = mean(sum_d)) %>%
  dplyr::filter(
    stim_categ == "before stim",
    intensity == "1 mW"
  ) %>%
  pull(mean_sum_d)

mean_sum_d_5mW <- coords_halo_1s_window %>%
  dplyr::filter(
    frame %% datapoint_to_plot == 0,
    body_part == "center",
    intensity %in% selected_intensities
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::summarise(sum_d = sum(d, na.rm = T)) %>%
  dplyr::group_by(intensity, stim_categ) %>%
  dplyr::summarise(mean_sum_d = mean(sum_d)) %>%
  dplyr::filter(
    stim_categ == "before stim",
    intensity == "5 mW"
  ) %>%
  pull(mean_sum_d)

mean_sum_d_10mW <- coords_halo_1s_window %>%
  dplyr::filter(
    frame %% datapoint_to_plot == 0,
    body_part == "center",
    intensity %in% selected_intensities
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::summarise(sum_d = sum(d, na.rm = T)) %>%
  dplyr::group_by(intensity, stim_categ) %>%
  dplyr::summarise(mean_sum_d = mean(sum_d)) %>%
  dplyr::filter(
    stim_categ == "before stim",
    intensity == "10 mW"
  ) %>%
  pull(mean_sum_d)

mean_sum_d_15mW <- coords_halo_1s_window %>%
  dplyr::filter(
    frame %% datapoint_to_plot == 0,
    body_part == "center",
    intensity %in% c(selected_intensities, "15 mW")
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::summarise(sum_d = sum(d, na.rm = T)) %>%
  dplyr::group_by(intensity, stim_categ) %>%
  dplyr::summarise(mean_sum_d = mean(sum_d)) %>%
  dplyr::filter(
    stim_categ == "before stim",
    intensity == "15 mW"
  ) %>%
  pull(mean_sum_d)


coords_halo_1s_window %>%
  dplyr::filter(
    frame %% datapoint_to_plot == 0,
    body_part == "center",
    intensity %in% c(selected_intensities, "15 mW")
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ) %>%
  dplyr::summarise(sum_d = sum(d, na.rm = T)) %>%
  dplyr::group_by(intensity, stim_categ) %>%
  dplyr::summarise(
    mean_sum_d = mean(sum_d),
    sd_sum_d = sd(sum_d)
  )
```



Combining 1 sec before stim and stim division to 1st and last 9 sec tables. In control cases if I normalize with the period length the "last_part" drops. The reason is that the animal moves at a constant rate so dividing the mean traveled distance will decrease the mean.

```{r fig.width=15}
generate_pop_dist_summary_plot <- function(stimside) {
  bind_rows(
    ### before stim 1 sec
    coords_halo_1s_window %>%
      dplyr::filter(
        stim_categ == "before stim",
        body_part == "center"
      ) %>%
      dplyr::mutate(
        stim_division = "before_stim",
        stim_div_length = 1
      ),
    ### stim devided to first_part (1s) and last part (9s)
    coords_halo %>%
      dplyr::filter(
        frame %% datapoint_to_plot == 0,
        stim_categ == "stim",
        body_part == "center"
      ) %>%
      ### recalculates distances after frames were removed
      dplyr::group_by(animal, body_part, session) %>%
      dplyr::mutate(
        X_diff = c(diff(X_interp), NA) %>% round(4),
        Y_diff = c(diff(Y_interp), NA) %>% round(4),
        X_diff = ifelse(
          test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
            X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
          yes = 0,
          no = X_diff
        ),
        Y_diff = ifelse(
          Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
            Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
          yes = 0,
          no = Y_diff
        ),
        d = sqrt(X_diff^2 + Y_diff^2),
        d_mm = d / scale,
        speed_instant = d_mm / time_res,
        mmps = speed_instant * (1 / time_res),
        mps = (speed_instant * (1 / time_res)) / 1000
      ) %>%
      dplyr::ungroup() %>%
      dplyr::group_by(animal, body_part, session, stim_number) %>%
      dplyr::mutate(
        stim_division = ifelse(rec_time <= min(rec_time) + 1, yes = "first_part", no = "last_part"),
      )
  ) %>% 
    arrange(animal, session, stim_number, rec_time) %>%
    dplyr::group_by(animal, intensity, stim_categ, stim_division) %>%
    dplyr::mutate(
      stim_div_length_row = length(stim_division)
    ) %>%
    dplyr::group_by(
      animal, intensity, stim_categ, stim_side, stim_division, across(stim_div_length_row)
    ) %>% 
    dplyr::summarise(
      sum_d = sum(d, na.rm = T),
      mean_d = mean(d, na.rm = T),
      max_sum_d = sum_d %>% max()
    ) %>% 
    dplyr::mutate(
      max_sum_d = replace(max_sum_d, stim_categ == "stim", NA),
      mean_sum_d = case_when(
        intensity == "1 mW" ~ mean_sum_d_1mW,
        intensity == "5 mW" ~ mean_sum_d_5mW,
        intensity == "10 mW" ~ mean_sum_d_10mW,
        intensity == "15 mW" ~ mean_sum_d_15mW,
      )
    ) %>% 
    dplyr::filter(
      if (stimside == "right") {
        stim_side == "right"
      } else {
        stim_side == "left"
      },
      intensity %in% c(selected_intensities, "15 mW")
    ) %>% 
    ungroup() %>% 
    fill(max_sum_d, .direction = "down") %>% 
    ggplot(
      mapping = aes(
        x = forcats::fct_relevel(stim_division, "before_stim", "first_part", "last_part"),
        ### *6 to convert to mm/sec (6 rows represent one second)
        y = mean_d * 6 / scale # (sum_d/stim_div_length_row)/scale/10 # in [cm/sec] # mean_d/scale # / stim_div_length #/mean_sum_d
      )
    ) +
    geom_point(aes(fill = animal %>% as.factor()), shape = 21, size = 4) +
    facet_wrap(~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique())), nrow = 1) +
    # facet_grid(animal ~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))) +
    geom_line(aes(group = animal)) +
    ggpubr::stat_compare_means(
      method = "wilcox.test",
      paired = T,
      comparisons = list(c("before_stim", "first_part")),
      method.args = list(alternative = "less"),
      vjust = 1.6,
      hide.ns = F
    ) +
    ggpubr::stat_compare_means(
      method = "wilcox.test",
      paired = T,
      comparisons = list(c("first_part", "last_part")),
      method.args = list(alternative = "greater"),
      vjust = 1.6,
      hide.ns = F
    ) +
    ggpubr::stat_compare_means(
      method = "wilcox.test",
      label.y = 35 * 6,
      paired = T,
      comparisons = list(c("before_stim", "last_part")),
      method.args = list(alternative = "less"),
      vjust = 1.7,
      hide.ns = F
    ) +
    expand_limits(y = c(0, 40 * 6)) +
    global_facet_theme +
    theme(aspect.ratio = 1) +
    theme(
      axis.title.x = element_text(size = 12),
      axis.title.y = element_text(size = 12),
      axis.text = element_text(size = 12),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(colour = "black")
    ) +
    if (stimside == "right") {
      ggtitle("Right side")
    } else {
      ggtitle("Left side")
    }
}

plt_pop_dist_sum_left <- generate_pop_dist_summary_plot(stimside = "left")
plt_pop_dist_sum_right <- generate_pop_dist_summary_plot(stimside = "right")

cowplot::plot_grid(
  plt_pop_dist_sum_right, plt_pop_dist_sum_left, 
  nrow = 2,
  labels = paste0(title, ", " , "traveled distance")
  )
```



```{r fig.width=15}
generate_distance_dose_plot <- function(stimside) {
  coords_halo %>%
    dplyr::filter(
      frame %% datapoint_to_plot == 0,
      stim_categ == "stim",
      body_part == "center"
    ) %>%
    ### recalculates distances after frames were removed
    dplyr::group_by(animal, body_part, session) %>%
    dplyr::mutate(
      X_diff = c(diff(X_interp), NA) %>% round(4),
      Y_diff = c(diff(Y_interp), NA) %>% round(4),
      X_diff = ifelse(
        test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
          X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
        yes = 0,
        no = X_diff
      ),
      Y_diff = ifelse(
        Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
          Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
        yes = 0,
        no = Y_diff
      ),
      d = sqrt(X_diff^2 + Y_diff^2),
      d_mm = d / scale,
      speed_instant = d_mm / time_res,
      mmps = speed_instant * (1 / time_res),
      mps = (speed_instant * (1 / time_res)) / 1000
    ) %>%
   
    dplyr::filter(
      if (stimside == "right") {
        stim_side == stimside
      } else {
        stim_side == "left"
      },
      intensity %in% c(selected_intensities, "15 mW")
    ) %>%
    dplyr::group_by(animal, intensity) %>% # dplyr::filter(animal == "GIIFM18b", intensity == "1 mW") %>% pull(d) %>% sum(na.rm = T) / 250
    # dplyr::mutate(nrows=length(intensity)) %>%
    dplyr::summarise(
      mean_d = mean(d, na.rm = T),
      sum_d_norm = sum(d, na.rm = T) / 250,
      nrows = length(intensity)
    ) %>% # write.csv(file = file.path("output_data","to_publish","Emivel","dose_intensity_diff_trav_dist.csv"))
    ggplot(
      aes(x = forcats::fct_relevel(intensity, "1 mW", "5 mW", "10 mW", "15 mW"), y = mean_d * 6)
    ) +
    geom_point(aes(fill = animal), shape = 21, size = 4) +
    geom_boxplot(alpha = 0) +
    expand_limits(y = c(0, 60 * 6)) +
    ggpubr::stat_compare_means(
      method = "wilcox.test",
      paired = F,
      comparisons = list(c("1 mW", "5 mW"), c("1 mW", "10 mW"), c("1 mW", "15 mW")),
      method.args = list(alternative = "two.sided"),
      vjust = 1.6,
      hide.ns = F
    ) +
    global_facet_theme +
    theme(aspect.ratio = 1) +
    theme(
      axis.title.x = element_text(size = 12),
      axis.title.y = element_text(size = 12),
      axis.text = element_text(size = 12),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(colour = "black")
    ) +
    if (stimside == "right") {
      ggtitle("Right side")
    } else {
      ggtitle("Left side")
    }
}

plt_distance_dose_right <- generate_distance_dose_plot(stimside = "right")
plt_distance_dose_left <- generate_distance_dose_plot(stimside = "left")


cowplot::plot_grid(
  plt_distance_dose_right, plt_distance_dose_left, 
  ncol = 2,
  labels = paste0(title, ", " , "traveled distance dose dependency")
  )
```


```{r fig.width=15}
bind_rows(
  ### before stim 1 sec
  coords_halo_1s_window %>%
    dplyr::filter(
      stim_categ == "before stim",
      body_part == "center"
    ) %>%
    dplyr::mutate(
      stim_division = "before_stim",
      stim_div_length = 1
    ),
  ### stim devided to first_part (1s) and last part (9s)
  coords_halo %>%
    dplyr::filter(
      frame %% datapoint_to_plot == 0,
      stim_categ == "stim",
      body_part == "center"
      # animal %!in% control_animals,
      # body_part == "center",
      # intensity %in% selected_intensities
    ) %>%
    ### recalculates distances after frames were removed
    dplyr::group_by(animal, body_part, session) %>%
    dplyr::mutate(
      X_diff = c(diff(X_interp), NA) %>% round(4),
      Y_diff = c(diff(Y_interp), NA) %>% round(4),
      X_diff = ifelse(
        test = X_diff < quantile(X_diff, na.rm = T)["25%"] - 3 * IQR(X_diff, na.rm = T) |
          X_diff > quantile(X_diff, na.rm = T)["75%"] + 3 * IQR(X_diff, na.rm = T),
        yes = 0,
        no = X_diff
      ),
      Y_diff = ifelse(
        Y_diff < quantile(Y_diff, na.rm = T)["25%"] - 3 * IQR(Y_diff, na.rm = T) |
          Y_diff > quantile(Y_diff, na.rm = T)["75%"] + 3 * IQR(Y_diff, na.rm = T),
        yes = 0,
        no = Y_diff
      ),
      d = sqrt(X_diff^2 + Y_diff^2),
      d_mm = d / scale,
      speed_instant = d_mm / time_res,
      mmps = speed_instant * (1 / time_res),
      mps = (speed_instant * (1 / time_res)) / 1000
    ) %>%
    dplyr::ungroup() %>%
    dplyr::group_by(animal, body_part, session, stim_number) %>%
    dplyr::mutate(
      stim_division = ifelse(rec_time <= min(rec_time) + 1, yes = "first_part", no = "last_part"),
      stim_div_length = ifelse(rec_time <= min(rec_time) + 1, yes = 1, no = 9)
    )
) %>%
  dplyr::group_by(animal, body_part, session, stim_number, stim_division) %>%
  # dplyr::mutate(stim_div_length = length(stim_division)) %>%
  ungroup() %>%
  arrange(animal, session, stim_number, rec_time) %>%
  dplyr::group_by(animal, body_part, intensity, stim_categ) %>% # stim_number,
  dplyr::summarise(
    sum_d = sum(d, na.rm = T),
    mean_d = mean(d, na.rm = T),
    max_sum_d = sum_d %>% max()
  ) %>%
  dplyr::mutate(
    max_sum_d = replace(max_sum_d, stim_categ == "stim", NA),
    mean_sum_d = case_when(
      intensity == "1 mW" ~ mean_sum_d_1mW,
      intensity == "5 mW" ~ mean_sum_d_5mW,
      intensity == "10 mW" ~ mean_sum_d_10mW,
      intensity == "15 mW" ~ mean_sum_d_15mW,
    )
  ) %>%
  dplyr::filter(
    animal %!in% control_animals,
    intensity %in% c(selected_intensities, "15 mW"),
    # manually removing one line causing problem (in GIIFM20b 15 mW stim was repeated in two sessions, session 6 was not following protocol)
  ) %>%
  ungroup() %>%
  fill(max_sum_d, .direction = "down") %>%
  dplyr::filter(
    animal %!in% control_animals,
    intensity %in% c(selected_intensities, "15 mW"),
    stim_categ == "stim"
  )
# %>% View()
#   dplyr::group_by(animal, intensity) %>%
#   dplyr::summarise(
#     mean_d = mean(d,na.rm = T)
# ) %>%
```



<br> Traveled distance before stimulus vs during stimulus (starting or stopping signal). If the traveled distance is greater during the stimulus photoactivation initiates movement, if it is smaller it slows down the animal.

```{r message=FALSE, warning=FALSE, fig.width=15, fig.height=15, echo = FALSE}
coords_halo_1s_window %>%
  dplyr::filter(
    body_part == "center",
    stim_categ != "no stim",
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ, stim_number) %>%
  dplyr::summarise(sum_d = sum(d, na.rm = T)) %>%
  tidyr::spread(
    stim_categ, sum_d
  ) %>%
  dplyr::filter(intensity %in% c(selected_intensities, 15)) %>%
  ggplot(
    mapping = aes(x = `before stim`, y = stim)
  ) +
  xlim(-50, 300) +
  ylim(-50, 300) +
  coord_fixed() +
  geom_vline(xintercept = 5, alpha = .3) +
  geom_hline(yintercept = 5, alpha = .3) +
  # geom_rect(xmin = 0, xmax = 5, ymin = 5, ymax = 10, fill = "green", alpha = 0.03) +
  # geom_rect(xmin = 5, xmax = 10, ymin = 0, ymax = 5, fill = "red", alpha = 0.03) +

  # geom_abline(slope = 1, intercept = 0, alpha = .3) +
  geom_point(aes(col = factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))), size = 3) +
  facet_wrap(~animal) +
  global_facet_theme +
  theme(
    axis.text.x = element_text(angle = 45)
  )
```

```{r message=FALSE, warning=FALSE, fig.width=15, fig.height=10, echo = FALSE}
coords_halo_1s_window %>%
  dplyr::filter(
    body_part == "center",
    stim_categ != "no stim",
    intensity %in% selected_intensities
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ, stim_number) %>%
  summarise(sum_d = sum(d)) %>%
  group_by(animal) %>%
  spread(stim_categ, sum_d) %>%
  mutate(`stim-bstim` = stim - `before stim`) %>%
  ggplot(mapping = aes(x = `before stim`, y = `stim-bstim`)) +
  geom_point(aes(col = factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))), size = 3) +
  labs(col = "Intensity") +
  geom_hline(yintercept = 0, lty = "dashed", col = "gray30") +
  facet_wrap(~animal, scales = "free")
```

```{r message=FALSE, warning=FALSE, fig.width=15, fig.height=20 , echo = FALSE}
stim_bstim1 <- coords_halo_1s_window %>%
  dplyr::filter(
    body_part == "center",
    stim_categ != "no stim",
    intensity %in% c(selected_intensities, 15),
  ) %>%
  dplyr::group_by(animal, intensity, stim_categ, stim_number) %>%
  dplyr::summarise(sum_d = sum(d, na.rm = T)) %>%
  group_by(animal) %>%
  tidyr::spread(
    stim_categ, sum_d
  ) %>%
  ggplot(
    mapping = aes(x = `before stim`, y = stim)
  ) +
  xlim(0, 400) +
  ylim(0, 400) +
  coord_fixed() +
  geom_abline(slope = 1, intercept = 0, alpha = .3) +
  geom_point(size = 3) +
  facet_grid(animal ~ factor(intensity, levels = gtools::mixedsort(intensity %>% unique()))) +
  global_facet_theme +
  ggtitle("Stimulus") +
  theme(
    axis.text.x = element_text(angle = 45)
  )


stim_bstim1
```


